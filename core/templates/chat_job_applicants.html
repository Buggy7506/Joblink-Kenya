{% extends 'base.html' %}
{% load static %}
{% block title %}Applicants Room â€” {{ job.title }}{% endblock %}

{% block content %}
<div id="room-page">
<style>
#room-page {
  --chat-bg: linear-gradient(180deg, rgba(8, 47, 73, 0.16), rgba(8, 47, 73, 0.04));
  --chat-card: color-mix(in srgb, var(--bg-card) 92%, #0f172a 8%);
  --chat-surface: var(--bg-surface);
  --chat-surface-soft: var(--bg-surface-soft);
  --chat-text: var(--text-main);
  --chat-muted: var(--text-muted);
  --chat-border: rgba(148, 163, 184, 0.25);
  --chat-accent: #25d366;
  --chat-accent-dark: #128c7e;
  --chat-icon-filter: brightness(0) invert(1);
}
body.light-mode #room-page { --chat-icon-filter: none; }
#room-page .chat-wrap{display:flex;gap:16px;max-width:1200px;margin:22px auto;color:var(--chat-text)}
#room-page .sidebar{flex:0 0 280px;border:1px solid var(--chat-border);border-radius:20px;background:var(--chat-card);overflow:hidden}
#room-page .sidebar h3{padding:14px 16px;border-bottom:1px solid var(--chat-border);margin:0;color:var(--chat-accent-dark)}
#room-page .applicant{display:block;padding:11px 14px;border-bottom:1px solid var(--chat-border)}
#room-page .applicant small{display:block;color:var(--chat-muted)}
#room-page .chat-container{flex:1;display:flex;flex-direction:column;border:1px solid var(--chat-border);border-radius:20px;background:var(--chat-card);overflow:hidden;max-height:calc(100vh - 70px)}
#room-page .chat-head{padding:16px;border-bottom:1px solid var(--chat-border);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,var(--chat-surface),var(--chat-surface-soft))}
#room-page .chat-head a{text-decoration:none;color:var(--chat-accent-dark);font-weight:600}
#room-page .chat-box{flex:1;overflow:auto;padding:16px;background:var(--chat-bg);display:flex;flex-direction:column;gap:10px}
#room-page .bubble{max-width:72%;padding:8px 12px;border-radius:14px 14px 14px 4px;background:var(--chat-surface);border:1px solid var(--chat-border);position:relative;-webkit-user-select:none;user-select:none}
#room-page .bubble.me{margin-left:auto;background:rgba(34,197,94,.18);border-radius:14px 14px 4px 14px}
#room-page .bubble.selected-message{outline:2px solid var(--chat-accent-dark)}
#room-page .meta{font-size:11px;color:var(--chat-muted);margin-top:5px}
#room-page .reply-reference{border-left:3px solid var(--chat-accent);padding:4px 8px;margin-bottom:6px;background:rgba(18,140,126,.12);border-radius:8px;font-size:12px}
#room-page .reply-ref{border-left:3px solid var(--chat-accent);padding:4px 8px;margin-bottom:6px;background:rgba(18,140,126,.12);border-radius:8px;font-size:12px}
#room-page .bulk-actions{display:flex;align-items:center;gap:10px;padding:8px 14px;border-bottom:1px solid var(--chat-border);background:var(--chat-surface-soft)}
#room-page .bulk-actions-buttons{display:inline-flex;gap:8px}
#room-page .bulk-actions button{border:1px solid var(--chat-border);border-radius:999px;width:36px;height:36px;padding:0;background:var(--chat-surface);display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
#room-page .bulk-actions button img{width:18px;height:18px}
#room-page .reply-preview{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-top:1px solid var(--chat-border);background:var(--chat-surface-soft)}
#room-page .room-input{display:flex;gap:10px;padding:12px;border-top:1px solid var(--chat-border);background:var(--chat-surface);align-items:center}
#room-page .room-input input{flex:1;min-width:0;padding:12px 16px;border-radius:999px;border:1px solid var(--chat-border);background:var(--chat-surface-soft);color:var(--chat-text);outline:none}
#room-page .room-input input:focus{border-color:var(--chat-accent-dark);box-shadow:0 0 0 3px rgba(18,140,126,.15)}
#room-page .room-input button{padding:12px 18px;border:none;border-radius:999px;background:linear-gradient(135deg,var(--chat-accent),var(--chat-accent-dark));color:#fff;font-weight:700;cursor:pointer}
#room-page .room-input button:disabled,#room-page .room-input input:disabled{opacity:.6;cursor:not-allowed}
#room-page .theme-icon,#room-page .menu-svg-icon{width:18px;height:18px;filter:var(--chat-icon-filter);opacity:.8;display:block;object-fit:contain}

#room-page #room-menu{position:absolute;display:none;z-index:3000;background:var(--chat-surface);border:1px solid var(--chat-border);border-radius:12px;min-width:190px}
#room-page #room-menu ul{margin:0;padding:8px;list-style:none}
#room-page #room-menu li{padding:8px 10px;border-radius:8px;cursor:pointer}
#room-page .menu-item-content{display:inline-flex;align-items:center;gap:8px}
#room-page .menu-svg-icon{width:18px;height:18px}
#room-page #room-menu li:hover{background:rgba(37,211,102,.13)}
#room-page .forward-modal{position:fixed;inset:0;background:rgba(2,6,23,.6);display:none;align-items:center;justify-content:center;z-index:3200}
#room-page .forward-modal.show{display:flex}
#room-page .forward-panel{width:min(480px,100%);max-height:80vh;overflow:auto;background:var(--chat-surface);border:1px solid var(--chat-border);border-radius:16px;padding:12px}
#room-page .forward-target{display:block;width:100%;text-align:left;margin:8px 0;padding:10px;border:1px solid var(--chat-border);border-radius:10px;background:var(--chat-surface-soft);cursor:pointer}
@media(max-width:900px){#room-page .chat-wrap{flex-direction:column}}
</style>

<div class="chat-wrap">
  <aside class="sidebar">
    <h3>Applicants room</h3>
    {% for application in applicants %}
      <div class="applicant" data-app-id="{{ application.id }}" data-username="{{ application.applicant.username|escape }}">
        <strong>{{ application.applicant.username }}</strong>
        <small>{{ application.applicant.email }}</small>
      </div>
    {% empty %}
      <div class="applicant">No applicants found.</div>
    {% endfor %}
  </aside>

  <section class="chat-container">
    <div class="chat-head">
      <div>
        <strong>{{ job.title }}</strong>
        <div style="font-size:12px;color:var(--chat-muted)">Room chat for employer + all applicants</div>
      </div>
      <a href="{% if request.GET.app_id %}{% url 'employer_chat' job.id %}?app_id={{ request.GET.app_id }}{% elif request.GET.application_id %}{% url 'job_chat' request.GET.application_id %}{% else %}javascript:history.back(){% endif %}">Back to private chat</a>
    </div>

    <div class="bulk-actions" id="bulk-actions" hidden>
      <span id="selected-count">0 selected</span>
      <div class="bulk-actions-buttons">
        <button type="button" id="copy-selected-btn" title="Copy"><img src="{% static 'icons/content_copy.svg' %}" class="theme-icon" alt="Copy"></button>
        <button type="button" id="reply-selected-btn" title="Reply"><img src="{% static 'icons/reply.svg' %}" class="theme-icon" alt="Reply"></button>
        <button type="button" id="forward-selected-btn" title="Forward"><img src="{% static 'icons/forward.svg' %}" class="theme-icon" alt="Forward"></button>
        <button type="button" id="delete-selected-btn" title="Delete for me"><img src="{% static 'icons/delete_for_me.svg' %}" class="theme-icon" alt="Delete for me"></button>
        <button type="button" id="clear-selected-btn" title="Cancel selection"><img src="{% static 'icons/cancel.svg' %}" class="theme-icon" alt="Cancel"></button>
      </div>
    </div>
    <div class="chat-box" id="room-messages">
      {% for message in room_messages %}
        <div class="bubble {% if message.sender_id == request.user.id %}me{% endif %}" data-id="{{ message.id }}" data-sender="{{ message.sender.username|escape }}" data-text="{{ message.message|escape }}" {% if message.reply_to %}data-reply-id="{{ message.reply_to.id }}" data-reply-sender="{{ message.reply_to.sender.username|escape }}" data-reply-text="{{ message.reply_to.message|escape }}"{% endif %}>
          <div><strong>{{ message.sender.username }}</strong></div>
          {% if message.reply_to %}
          <div class="reply-reference"><strong>{{ message.reply_to.sender.username }}</strong><div>{{ message.reply_to.message|truncatechars:80 }}</div></div>
          {% endif %}
          <div class="message-text">{{ message.message }}</div>
          <div class="meta">{{ message.timestamp|date:'M d, Y H:i' }}</div>
        </div>
      {% empty %}
        <div id="room-empty" style="text-align:center;opacity:.7">No group messages yet. Start the conversation ðŸ‘‹</div>
      {% endfor %}
    </div>

    <div class="reply-preview" id="reply-preview" hidden>
      <div><strong>Replying to </strong><span id="reply-sender"></span><div id="reply-text" style="font-size:12px;color:var(--chat-muted)"></div></div>
      <button id="cancel-reply" type="button" style="padding:6px 10px">âœ•</button>
    </div>

    <form class="room-input" id="room-form" onsubmit="return false;">
      {% csrf_token %}
      <input id="room-input" type="text" placeholder="Type a messageâ€¦" maxlength="2000" autocomplete="off" {% if not seed_application %}disabled{% endif %}>
      <button id="room-send" type="button" {% if not seed_application %}disabled{% endif %}>Send</button>
    </form>
  </section>
</div>

<div id="room-menu">
  <ul>
    <li data-action="reply"><span class="menu-item-content"><img src="{% static 'icons/reply.svg' %}" class="menu-svg-icon" alt=""><span>Reply</span></span></li>
    <li data-action="copy"><span class="menu-item-content"><img src="{% static 'icons/content_copy.svg' %}" class="menu-svg-icon" alt=""><span>Copy</span></span></li>
    <li data-action="forward"><span class="menu-item-content"><img src="{% static 'icons/forward.svg' %}" class="menu-svg-icon" alt=""><span>Forward to applicant chat</span></span></li>
    <li data-action="delete-me"><span class="menu-item-content"><img src="{% static 'icons/delete_for_me.svg' %}" class="menu-svg-icon" alt=""><span>Delete for me</span></span></li>
    <li data-action="private"><span class="menu-item-content"><img src="{% static 'icons/reply.svg' %}" class="menu-svg-icon" alt=""><span>Reply privately</span></span></li>
  </ul>
</div>

<div id="forward-modal" class="forward-modal">
  <div class="forward-panel">
    <strong>Forward message to applicant chat</strong>
    <div id="forward-list"></div>
    <button id="close-forward" type="button" style="margin-top:8px">Close</button>
  </div>
</div>

{% if seed_application %}
<script>
(function(){
  const username = "{{ request.user.username|escapejs }}";
  const isEmployer = {{ job.employer_id }} === {{ request.user.id }};
  const viewerAppId = {% if viewer_application %}{{ viewer_application.id }}{% else %}null{% endif %};
  const appId = {{ seed_application.id }};
  const box = document.getElementById("room-messages");
  const input = document.getElementById("room-input");
  const menu = document.getElementById("room-menu");
  const forwardModal = document.getElementById("forward-modal");
  const forwardList = document.getElementById("forward-list");
  const closeForward = document.getElementById("close-forward");
  const replyPreview = document.getElementById("reply-preview");
  const replySender = document.getElementById("reply-sender");
  const replyText = document.getElementById("reply-text");
  const cancelReply = document.getElementById("cancel-reply");
  const bulkActions = document.getElementById("bulk-actions");
  const selectedCount = document.getElementById("selected-count");
  const clearSelectedBtn = document.getElementById("clear-selected-btn");
  const copySelectedBtn = document.getElementById("copy-selected-btn");
  const replySelectedBtn = document.getElementById("reply-selected-btn");
  const forwardSelectedBtn = document.getElementById("forward-selected-btn");
  const deleteSelectedBtn = document.getElementById("delete-selected-btn");

  let activeBubble = null;
  let forwardMessage = null;
  const selectedMessageIds = new Set();
  const hiddenMessagesStorageKey = `room_hidden_messages_${appId}_${username}`;

  function getHiddenMessageIds(){
    try {
      const raw = localStorage.getItem(hiddenMessagesStorageKey);
      const parsed = raw ? JSON.parse(raw) : [];
      return new Set(Array.isArray(parsed) ? parsed.map(String) : []);
    } catch (err) {
      return new Set();
    }
  }
  function persistHiddenMessageIds(hiddenIds){
    localStorage.setItem(hiddenMessagesStorageKey, JSON.stringify(Array.from(hiddenIds)));
  }
  function applyHiddenMessagesToDom(){
    const hiddenIds = getHiddenMessageIds();
    if(!hiddenIds.size) return;
    box.querySelectorAll('.bubble[data-id]').forEach((bubble)=>{
      if(hiddenIds.has(String(bubble.dataset.id))) bubble.remove();
    });
  }
  
  const applicantMap = {};
  document.querySelectorAll('.sidebar .applicant[data-app-id]').forEach((el)=>{
    applicantMap[(el.dataset.username || '').trim()] = el.dataset.appId;
  });

  const send = document.getElementById("room-send");
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${appId}/`);
  function scrollBottom(){ if(box) box.scrollTop = box.scrollHeight; }
  scrollBottom();
  applyHiddenMessagesToDom();
  
  function escapeHtml(text){ const d = document.createElement('div'); d.textContent = text || ''; return d.innerHTML; }

  function buildReplySnippet(replyData){
    if(!replyData) return '';
    return `<div class="reply-reference"><strong>${escapeHtml(replyData.sender || 'Unknown')}</strong><div>${escapeHtml(replyData.text || '')}</div></div>`;
  }

  function addMessage(data, forcedReplyTo){
    const el = document.createElement('div');
    const isMe = data.sender === username;
    el.className = `bubble ${isMe ? 'me' : ''}`;
    el.dataset.id = data.id;
    el.dataset.sender = data.sender;
    el.dataset.text = data.message;
    if(data.replyTo && data.replyTo.id){
      el.dataset.replyId = data.replyTo.id;
      el.dataset.replySender = data.replyTo.sender || '';
      el.dataset.replyText = data.replyTo.text || '';
    }
    const replyHtml = buildReplySnippet(forcedReplyTo || data.replyTo);
    el.innerHTML = `<div><strong>${escapeHtml(data.sender)}</strong></div>${replyHtml}<div class="message-text">${escapeHtml(data.message)}</div><div class="meta">${new Date(data.timestamp).toLocaleString()}</div>`;
    box.appendChild(el);
    const hiddenIds = getHiddenMessageIds();
    if(hiddenIds.has(String(data.id))){
      hiddenIds.delete(String(data.id));
      persistHiddenMessageIds(hiddenIds);
    }
    scrollBottom();
  }

  function sendMessage(){
    const text = input.value.trim();
    if(!text || socket.readyState !== 1) return;
    const payload = { action: 'job_message', message: text };
    if(input.dataset.replyId){ payload.reply_to = input.dataset.replyId; }
    socket.send(JSON.stringify(payload));
    input.value = '';
    delete input.dataset.replyId;
    replyPreview.hidden = true;
  }

  function openForwardByText(messageText){
    forwardMessage = messageText || '';
    if(!forwardMessage) return;
    forwardList.innerHTML = '';
    Object.entries(applicantMap).forEach(([name, targetId])=>{
      const btn = document.createElement('button');
      btn.className = 'forward-target';
      btn.type = 'button';
      btn.textContent = `${name}`;
      btn.addEventListener('click', ()=>{
        if(socket.readyState !== 1) return;
        socket.send(JSON.stringify({ action:'forward_text', message: forwardMessage, target_apps:[targetId] }));
        forwardModal.classList.remove('show');
      });
      forwardList.appendChild(btn);
    });
    forwardModal.classList.add('show');
  }

  function privateReply(bubble){
    const sender = (bubble.dataset.sender || '').trim();
    const targetApp = applicantMap[sender];
    if(isEmployer && targetApp){
      window.location.href = `{% url 'employer_chat' job.id %}?app_id=${targetApp}`;
      return;
    }
    if(!isEmployer && sender === "{{ job.employer.username|escapejs }}" && viewerAppId){
      window.location.href = `{% url 'job_chat' 0 %}`.replace('/0/', `/${viewerAppId}/`);
      return;
    }
    alert('Private reply is available between employer and applicant only.');
  }

  function showMenu(bubble){
    activeBubble = bubble;
    const rect = bubble.getBoundingClientRect();
    const menuHeight = menu.offsetHeight || 180;
    const menuWidth = menu.offsetWidth || 190;
    let x = rect.left;
    let y = rect.bottom + 6;
    if(y + menuHeight > window.innerHeight - 8){ y = rect.top - menuHeight - 6; }
    if(x + menuWidth > window.innerWidth - 8){ x = window.innerWidth - menuWidth - 8; }
    if(x < 8) x = 8;
    if(y < 8) y = 8;
    menu.style.position = 'fixed';
    menu.style.left = `${x}px`;
    menu.style.top = `${y}px`;
    menu.style.display = 'block';
  }
  function hideMenu(){ menu.style.display = 'none'; }

  function updateSelectionUi(){
    const count = selectedMessageIds.size;
    selectedCount.textContent = `${count} selected`;
    bulkActions.hidden = count === 0;
  }

  function getSelectedBubbles(){
    return Array.from(selectedMessageIds)
      .map(id => box.querySelector(`.bubble[data-id="${id}"]`))
      .filter(Boolean);
  }

  function toggleSelection(bubble){
    if(!bubble || !bubble.dataset.id) return;
    const id = String(bubble.dataset.id);
    if(selectedMessageIds.has(id)){
      selectedMessageIds.delete(id);
      bubble.classList.remove('selected-message');
    } else {
      selectedMessageIds.add(id);
      bubble.classList.add('selected-message');
    }
    updateSelectionUi();
  }

  function clearSelection(){
    selectedMessageIds.clear();
    box.querySelectorAll('.bubble.selected-message').forEach((el)=>el.classList.remove('selected-message'));
    updateSelectionUi();
  }

  function deleteForMe(bubble){
    if(!bubble) return;
    const messageId = bubble.dataset.id;
    if(messageId && socket.readyState === 1){
      socket.send(JSON.stringify({ action:'delete', id: messageId, mode:'me' }));
    }
    const hiddenIds = getHiddenMessageIds();
    hiddenIds.add(String(messageId));
    persistHiddenMessageIds(hiddenIds);
    bubble.remove();
    selectedMessageIds.delete(String(messageId));
    updateSelectionUi();
  }

  function onAction(action, bubble){
    if(!bubble) return;
    if(action === 'copy') navigator.clipboard.writeText(bubble.dataset.text || '');
    if(action === 'reply'){
      input.dataset.replyId = bubble.dataset.id;
      replySender.textContent = bubble.dataset.sender || '';
      replyText.textContent = bubble.dataset.text || '';
      replyPreview.hidden = false;
      input.focus();
    }
    if(action === 'forward') openForwardByText(bubble.dataset.text || '');
    if(action === 'delete-me') deleteForMe(bubble);
    if(action === 'private') privateReply(bubble);
    hideMenu();
  }

  send.addEventListener('click', sendMessage);
  input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); sendMessage(); } });
  cancelReply.addEventListener('click', ()=>{ delete input.dataset.replyId; replyPreview.hidden = true; });
  closeForward.addEventListener('click', ()=>forwardModal.classList.remove('show'));
  forwardModal.addEventListener('click', (e)=>{ if(e.target===forwardModal) forwardModal.classList.remove('show'); });

  clearSelectedBtn.addEventListener('click', clearSelection);
  copySelectedBtn.addEventListener('click', ()=>{
    const text = getSelectedBubbles().map((b)=>b.dataset.text || '').filter(Boolean).join('\n');
    if(text) navigator.clipboard.writeText(text);
  });
  replySelectedBtn.addEventListener('click', ()=>{
    const selected = getSelectedBubbles();
    const target = selected[selected.length - 1];
    if(!target) return;
    onAction('reply', target);
    clearSelection();
  });
  forwardSelectedBtn.addEventListener('click', ()=>{
    const text = getSelectedBubbles().map((b)=>b.dataset.text || '').filter(Boolean).join('\n');
    if(text) openForwardByText(text);
  });
  deleteSelectedBtn.addEventListener('click', ()=>{
    getSelectedBubbles().forEach((bubble)=>deleteForMe(bubble));
    clearSelection();
  });

  box.addEventListener('contextmenu', (e)=>{
    const bubble = e.target.closest('.bubble');
    if(!bubble) return;
    e.preventDefault();
    showMenu(bubble);
  });

  box.addEventListener('click', (e)=>{
    const bubble = e.target.closest('.bubble');
    if(!bubble) return;
    if(selectedMessageIds.size || e.ctrlKey || e.metaKey){
      e.preventDefault();
      toggleSelection(bubble);
    }
  });

  box.addEventListener('selectstart', (e)=>{
    if(e.target.closest('.bubble')) e.preventDefault();
  });

  box.addEventListener('dblclick', (e)=>{
    const bubble = e.target.closest('.bubble');
    if(!bubble) return;
    e.preventDefault();
    toggleSelection(bubble);
  });

  menu.querySelectorAll('li').forEach((item)=>{
    item.addEventListener('click', ()=>onAction(item.dataset.action, activeBubble));
  });

  document.addEventListener('click', (e)=>{ if(!menu.contains(e.target)) hideMenu(); });

  socket.onmessage = (e)=>{
    const data = JSON.parse(e.data);
    const type = data.type && data.type.startsWith('chat.') ? data.type.slice(5) : data.type;
    if(type === 'job_message'){
      let replyTo = null;
      if(data.reply_to){
        const replyElem = box.querySelector(`.bubble[data-id="${data.reply_to}"]`);
        replyTo = {
          id: data.reply_to,
          sender: replyElem ? replyElem.dataset.sender : 'Unknown',
          text: replyElem ? replyElem.dataset.text : '',
        };
      }
      addMessage(data, replyTo);
    }
    if(type === 'forward_done') alert(`Forwarded ${data.count} message(s).`);
  };
})();
</script>
{% endif %}
</div>
{% endblock %}
