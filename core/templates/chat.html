{% extends "base.html" %}
{% block title %}Chat{% if job %} â€” {{ job.title }}{% elif application %} â€” {{ application.job.title }}{% endif %}{% endblock %}
{% block content %}
{% load static %}

<div id="chat-page">
<style>
#chat-page {
  --chat-bg: linear-gradient(180deg, rgba(8, 47, 73, 0.16), rgba(8, 47, 73, 0.04));
  --chat-card: color-mix(in srgb, var(--bg-card) 92%, #0f172a 8%);
  --chat-surface: var(--bg-surface);
  --chat-surface-soft: var(--bg-surface-soft);
  --chat-text: var(--text-main);
  --chat-muted: var(--text-muted);
  --chat-border: rgba(148, 163, 184, 0.25);
  --chat-deleted: rgba(148, 163, 184, 0.2);
  --chat-accent: #25d366;
  --chat-accent-dark: #128c7e;
  --chat-shadow: var(--alien-shadow);
  --bubble-me: #1f7d4f;
  --bubble-them: var(--chat-surface);
  --bubble-border: var(--chat-border);
  --chat-icon-filter: brightness(0) invert(1);
}

body.light-mode #chat-page {
  --chat-bg: #efeae2;
  --chat-card: #ffffff;
  --chat-surface: #ffffff;
  --chat-surface-soft: #f7f8fa;
  --bubble-me: #dcf8c6;
  --bubble-them: #ffffff;
  --bubble-border: rgba(0, 0, 0, 0.08);
  --chat-border: rgba(0, 0, 0, 0.08);
  --chat-icon-filter: none;
}
  
/* --- Layout & Sidebar --- */
#chat-page .chat-wrap {
  display: flex;
  flex-wrap: nowrap;
  max-width: 1200px;
  margin: 20px auto 30px;
  gap: 16px;
  font-family: 'Poppins', sans-serif;
  position: relative;
  color: var(--chat-text);
  align-items: stretch;
}

#chat-page .sidebar {
  flex: 0 0 280px;
  background: var(--chat-card);
  border-radius: 20px;
  overflow: hidden;
  border: 1px solid var(--chat-border);
  box-shadow: 0 8px 24px var(--chat-shadow);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
  max-height: calc(100vh - 80px);
}
#chat-page .sidebar h3 {
  padding: 14px 16px;
  border-bottom: 1px solid var(--chat-border);
  color: var(--chat-accent-dark);
  font-weight: 600;
}
#chat-page .sidebar-content {
  overflow-y: auto;
  flex: 1 1 auto;
}
#chat-page .sidebar-section {
  display: flex;
  flex-direction: column;
}
#chat-page .applicant {
  padding: 12px 14px;
  cursor: pointer;
  border-bottom: 1px solid var(--chat-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: var(--chat-text);
  transition: all 0.2s ease-in-out;
}
#chat-page .applicant:hover {
  background: rgba(37, 211, 102, 0.12);
}
#chat-page .applicant.selected {
  background: rgba(37, 211, 102, 0.2);
  font-weight: 600;
}

#chat-page .badge {
  background: var(--chat-accent);
  color: #ffffff;
  border-radius: 999px;
  padding: 2px 8px;
  font-size: 12px;
  font-weight: 700;
}

/* Deleted applicants */
#chat-page .sidebar .applicant.deleted {
  opacity: 0.4;
  cursor: not-allowed;
  border-bottom: 1px solid var(--chat-border);
  background: none !important;
  box-shadow: none !important;
  transition: none;
}
#chat-page .sidebar .applicant.deleted:hover {
  background: none !important;
  box-shadow: none !important;
}
#chat-page .sidebar .applicant.deleted .badge {
  background: var(--text-danger);
  color: #ffffff;
}

/* --- Chat Container --- */
#chat-page .chat-container {
  flex: 1 1 auto;
  min-width: 0;
  display: flex;
  flex-direction: column;
  background: var(--chat-card);
  border-radius: 20px;
  border: 1px solid var(--chat-border);
  box-shadow: 0 18px 42px rgba(15, 23, 42, 0.25);
  overflow: hidden;
  max-height: calc(100vh - 60px);
}

#chat-page .chat-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--chat-border);
  color: var(--chat-text);
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 12px;
  background: linear-gradient(135deg, var(--chat-surface), var(--chat-surface-soft));
}
#chat-page .chat-header-actions {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
#chat-page .group-toggle-btn {
  border: 1px solid var(--chat-border);
  border-radius: 999px;
  padding: 8px 12px;
  background: var(--chat-surface-soft);
  color: var(--chat-accent-dark);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}
#chat-page #sidebar-toggle {
  display: none;
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  color: var(--chat-accent-dark);
  padding: 0;
}
#chat-page .chat-title {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
  flex: 1 1 auto;
}
#chat-page .chat-box {
  flex: 1;
  overflow-y: auto;
  padding: 18px 20px 84px 20px;
  background: var(--chat-bg);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#chat-page .pinned-bar {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 10px 16px;
  border-bottom: 1px solid var(--chat-border);
  background: var(--chat-surface);
}
#chat-page .pinned-head {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: var(--chat-accent-dark);
}
#chat-page .pinned-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
#chat-page .pinned-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 10px;
  border-radius: 12px;
  border: 1px solid var(--chat-border);
  background: var(--chat-surface-soft);
  cursor: pointer;
}
#chat-page .pinned-item span {
  display: block;
}
#chat-page .pinned-item .pinned-text {
  font-size: 13px;
  color: var(--chat-text);
}
#chat-page .pinned-item .pinned-meta {
  font-size: 11px;
  color: var(--chat-muted);
}

#chat-page .bubble {
  max-width: 72%;
  margin: 2px 0;
  padding: 8px 12px;
  border-radius: 14px 14px 14px 4px;
  word-wrap: break-word;
  position: relative;
  color: var(--chat-text);
  background: var(--bubble-them);
  border: 1px solid var(--bubble-border);
  box-shadow: 0 1px 1px rgba(0, 0, 0, 0.08);
  transition: all 0.2s ease-in-out;
}
#chat-page .bubble .message-text {
  white-space: pre-wrap;
  line-height: 1.45;
}
#chat-page .bubble strong {
  display: block;
  font-size: 0.78rem;
  color: var(--chat-muted);
  margin-bottom: 2px;
}
#chat-page .bubble:hover {
  transform: translateY(-1px);
}
#chat-page .me {
  margin-left: auto;
  background: var(--bubble-me);
  border-color: rgba(37, 211, 102, 0.35);
  text-align: right;
  border-radius: 14px 14px 4px 14px;
}
#chat-page .them {
  margin-right: auto;
}
#chat-page .me::after,
#chat-page .them::after {
  content: "";
  position: absolute;
  bottom: 0;
  width: 0;
  height: 0;
  border: 8px solid transparent;
}
#chat-page .me::after {
  right: -6px;
  border-left-color: var(--bubble-me);
  border-bottom-color: transparent;
}
#chat-page .them::after {
  left: -6px;
  border-right-color: var(--bubble-them);
  border-bottom-color: transparent;
}
#chat-page .bubble.deleted {
  background: var(--chat-deleted);
  border-color: var(--chat-border);
  color: var(--chat-muted);
  font-style: italic;
}
#chat-page .reply-reference {
  border-left: 3px solid var(--chat-accent);
  padding: 4px 8px;
  margin-bottom: 6px;
  background: rgba(18, 140, 126, 0.12);
  border-radius: 8px;
  text-align: left;
}
#chat-page .reply-reference .reply-sender {
  font-size: 11px;
  font-weight: 600;
  color: var(--chat-accent-dark);
}
#chat-page .reply-reference .reply-text {
  font-size: 12px;
  color: var(--chat-text);
  display: block;
}
#chat-page .meta {
  font-size: 11px;
  margin-top: 6px;
  color: var(--chat-muted);
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 6px;
}
#chat-page .bubble.pinned {
  border-color: var(--chat-accent-dark);
  box-shadow: 0 0 0 2px rgba(18, 140, 126, 0.18);
}
#chat-page .bubble.pinned::before {
  content: "ðŸ“Œ";
  position: absolute;
  top: -12px;
  right: 10px;
  font-size: 12px;
}
#chat-page .bubble.selected-message {
  outline: 2px solid var(--chat-accent-dark);
  outline-offset: 1px;
}
#chat-page .bulk-actions {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 8px 16px;
  border-bottom: 1px solid var(--chat-border);
  background: var(--chat-surface-soft);
}
#chat-page .bulk-actions-buttons {
  display: inline-flex;
  gap: 8px;
}
#chat-page .bulk-actions button {
  border: 1px solid var(--chat-border);
  border-radius: 999px;
  padding: 6px 12px;
  background: var(--chat-surface);
  color: var(--chat-text);
  cursor: pointer;
}
  
/* Reply preview */
#chat-page .reply-preview {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 10px 16px;
  background: var(--chat-surface-soft);
  border-top: 1px solid var(--chat-border);
}
#chat-page .reply-preview-body {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 13px;
  color: var(--chat-text);
}
#chat-page .reply-preview-label {
  font-weight: 600;
  color: var(--chat-accent-dark);
}
#chat-page .reply-cancel {
  border: none;
  background: transparent;
  font-size: 18px;
  cursor: pointer;
  color: var(--chat-muted);
}

/* Chat Input */
#chat-page .chat-input {
  display: flex;
  gap: 10px;
  padding: 12px 16px;
  border-top: 1px solid var(--chat-border);
  background: var(--chat-surface);
  flex-wrap: wrap;
}

#chat-page .chat-input input {
  flex: 1;
  min-width: 0;
  padding: 12px 16px;
  border-radius: 999px;
  border: 1px solid var(--chat-border);
  outline: none;
  background: var(--chat-surface-soft);
  color: var(--chat-text);
}

#chat-page .chat-input button {
  padding: 12px 20px;
  border: none;
  border-radius: 999px;
  font-weight: 700;
  cursor: pointer;
  background: linear-gradient(135deg, var(--chat-accent), var(--chat-accent-dark));
  color: #ffffff;
  box-shadow: 0 6px 18px rgba(18, 140, 126, 0.3);
  transition: all 0.2s ease;
  flex-shrink: 0;
}

#chat-page .chat-input button:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 24px rgba(18, 140, 126, 0.4);
}

/* Typing Indicator */
#chat-page .typing {
  display: flex;
  align-items: center;
  gap: 4px;
  max-width: 70px;
  padding: 10px 14px;
  border-radius: 14px;
  background: var(--bubble-them);
  border: 1px solid var(--chat-border);
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
}

#chat-page .dot {
  width: 6px;
  height: 6px;
  background: var(--chat-accent-dark);
  border-radius: 50%;
  animation: blink 1.4s infinite ease-in-out;
}

#chat-page .dot:nth-child(2) { animation-delay: 0.2s; }
#chat-page .dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes blink {
  0%, 80%, 100% { opacity: 0.2; transform: scale(1); }
  40% { opacity: 1; transform: scale(1.4); }
}

/* Context menu */
#chat-page #message-menu {
  position: absolute;
  background: var(--chat-surface);
  color: var(--chat-text);
  border-radius: 12px;
  border: 1px solid var(--chat-border);
  box-shadow: 0 12px 28px rgba(0, 0, 0, 0.2);
  z-index: 2000;
  display: none;
  opacity: 0;
  transform: translateY(-5px) scale(0.95);
  transition: opacity 0.2s ease, transform 0.2s ease;
  min-width: 180px;
}
#chat-page #message-menu.show { display: block; opacity: 1; transform: translateY(0) scale(1); }
#chat-page #message-menu ul { list-style: none; padding: 8px; margin: 0; }
#chat-page #message-menu li {
  padding: 8px 12px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
  border-radius: 8px;
}
#chat-page #message-menu li:hover {
  background: rgba(37, 211, 102, 0.12);
}
#chat-page .menu-item-content {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
#chat-page .menu-svg-icon {
  width: 18px;
  height: 18px;
  opacity: 0.8;
  filter: var(--chat-icon-filter);
  object-fit: contain;
}
#chat-page .theme-icon {
  width: 18px;
  height: 18px;
  filter: var(--chat-icon-filter);
  object-fit: contain;
}

/* Responsive Sidebar Drawer */
#chat-page #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(6px); z-index: 999; opacity: 0; transition: opacity 0.3s ease; }
@media (max-width: 900px) {
  #chat-page .chat-wrap { flex-direction: column; }
  #chat-page .sidebar {
    position: fixed;
    top: 0; left: 0;
    height: 100%;
    z-index: 1000;
    transform: translateX(-100%);
    border-radius: 0;
    width: 260px;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  #chat-page .sidebar.show { transform: translateX(0); }
  #chat-page #sidebar-toggle { display: block; }
  #chat-page #sidebar-overlay.show { display: block; opacity: 1; }
  #chat-page .chat-container { border-radius: 16px; }
}

@media (max-width: 600px) {
  #chat-page .chat-input { flex-direction: column; gap: 8px; }
  #chat-page .chat-input button { width: 100%; }
}
</style>


<div class="chat-wrap">
  {% if job %}
    <div class="sidebar" id="sidebar">
      <!-- Active Applicants -->
      <h3>Applicants</h3>
        <div class="sidebar-content">
        <div class="sidebar-section" id="active-applicants">
          {% for app in applications %}
            <a href="?app_id={{ app.id }}" 
               class="applicant {% if selected_app and app.id == selected_app.id %}selected{% endif %}" 
                data-app-id="{{ app.id }}">
              {{ app.applicant.username }}
              {% if app.unread_count %}<span class="badge">{{ app.unread_count }}</span>{% endif %}
            </a>
          {% empty %}
            <p style="padding:12px; opacity:.7;">No applicants yet</p>
          {% endfor %}
        </div>
      
        <!-- Deleted Applicants -->
        {% if deleted_applications %}
          <h3 class="text-danger" style="margin-top:20px;">Deleted Applicants</h3>
          <div class="sidebar-section" id="deleted-applicants">
            {% for app in deleted_applications %}
              <a href="javascript:void(0);" 
                 class="applicant deleted" 
                 data-app-id="{{ app.id }}">
                {{ app.applicant.username }}
                {% if app.unread_count %}<span class="badge">{{ app.unread_count }}</span>{% endif %}
              </a>
            {% empty %}
              <p style="padding:12px; opacity:.7;">No deleted applicants</p>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>

    <div id="sidebar-overlay"></div>
  {% endif %}

  <!-- Main chat -->
  <div class="chat-container">
    <div class="chat-header">
      {% if job %}
        <button id="sidebar-toggle">â˜°</button>
        <div class="chat-title"><strong>{{ job.title }}</strong>{% if job.company %} â€” {{ job.company }}{% endif %}<span style="font-size:12px;color:var(--chat-muted);font-weight:500;">Direct chat with applicants</span></div>
      {% else %}
        <div class="chat-title"><strong>{{ application.job.title }}</strong>{% if application.job.company %} â€” {{ application.job.company }}{% endif %}<span style="font-size:12px;color:var(--chat-muted);font-weight:500;">Direct chat</span></div>
      {% endif %}
      <div class="chat-header-actions">
        <a title="Open the shared room where employer and all applicants chat together" id="group-toggle-btn" class="group-toggle-btn" href="{% url "chat_job_applicants" %}?job_id={% if job %}{{ job.id }}{% elif application %}{{ application.job.id }}{% elif selected_app %}{{ selected_app.job.id }}{% endif %}{% if selected_app %}&app_id={{ selected_app.id }}{% elif application %}&application_id={{ application.id }}{% endif %}">Applicants Group</a>
      </div>
    </div>

    <div class="bulk-actions" id="bulk-actions" hidden>
      <span id="selected-count">0 selected</span>
      <div class="bulk-actions-buttons">
        <button type="button" id="forward-selected-btn">Forward</button>
        <button type="button" id="clear-selected-btn">Cancel</button>
      </div>
    </div>

    <div class="pinned-bar" id="pinned-bar" hidden>
      <div class="pinned-head">
        <img src="{% static 'icons/pin.svg' %}" class="theme-icon" alt="">
        <span>Pinned messages</span>
      </div>
      <div class="pinned-list" id="pinned-list"></div>
    </div>
    
    <div id="chat-box" class="chat-box">
      {% for m in messages %}
        <div class="bubble {% if m.sender_id == request.user.id %}me{% else %}them{% endif %} {% if m.is_pinned %}pinned{% endif %} {% if m.message == "This message was deleted" %}deleted{% endif %} pop"  
             data-id="{{ m.id }}" data-text="{{ m.message|escape }}" data-sender="{{ m.sender.username|escape }}"
             {% if m.reply_to %}data-reply-id="{{ m.reply_to.id }}" data-reply-text="{{ m.reply_to.message|escape }}" data-reply-sender="{{ m.reply_to.sender.username|escape }}"{% endif %}>
          <div><strong>{{ m.sender.username }}</strong></div>
          {% if m.reply_to %}
            <div class="reply-reference">
              <span class="reply-sender">{{ m.reply_to.sender.username }}</span>
              <span class="reply-text">{{ m.reply_to.message|truncatechars:80 }}</span>
            </div>
          {% endif %}
          <div class="message-text">{{ m.message }}</div>
          <div class="meta">{{ m.timestamp }}{% if m.is_edited %} (edited){% endif %}{% if m.is_read and m.sender_id == request.user.id %} âœ“{% endif %}</div>
      {% empty %}
        <p style="opacity:.7;text-align:center;margin-top:16px;">No messages yet. Say hi ðŸ‘‹</p>
      {% endfor %}
    </div>

      
    <div class="reply-preview" id="reply-preview" hidden>
      <div class="reply-preview-body">
        <span class="reply-preview-label">Replying to <span id="reply-preview-sender"></span></span>
        <span id="reply-preview-text"></span>
      </div>
      <button class="reply-cancel" id="reply-cancel" type="button" aria-label="Cancel reply">âœ•</button>
    </div>
    
    <form id="chat-form" class="chat-input" onsubmit="return false;">
      {% csrf_token %}
      <input id="msg-input" type="text" placeholder="Messageâ€¦" autocomplete="off" maxlength="2000" />
      <button id="send-btn" type="button">Send</button>
    </form>
  </div>
</div>

<!-- Context Menu -->
<div id="message-menu">
  <ul>
    <li data-action="reply">
      <span class="menu-item-content">
        <img src="{% static 'icons/reply.svg' %}" class="menu-svg-icon" alt="">
        <span>Reply</span>
      </span>
    </li>

    <li data-action="copy">
      <span class="menu-item-content">
        <img src="{% static 'icons/content_copy.svg' %}" class="menu-svg-icon" alt="">
        <span>Copy</span>
      </span>
    </li>

    <li data-action="edit">
      <span class="menu-item-content">
        <img src="{% static 'icons/edit.svg' %}" class="menu-svg-icon" alt="">
        <span>Edit</span>
      </span>
    </li>

    <li data-action="delete-me">
      <span class="menu-item-content">
        <img src="{% static 'icons/delete_for_me.svg' %}" class="menu-svg-icon" alt="">
        <span>Delete for Me</span>
      </span>
    </li>

    <li data-action="delete-everyone">
      <span class="menu-item-content">
        <img src="{% static 'icons/delete_forever.svg' %}" class="menu-svg-icon" alt="">
        <span>Delete for Everyone</span>
      </span>
    </li>

    <li data-action="forward">
      <span class="menu-item-content">
        <img src="{% static 'icons/forward.svg' %}" class="menu-svg-icon" alt="">
        <span>Forward</span>
      </span>
    </li>

    <li data-action="pin">
      <span class="menu-item-content">
        <img id="pin-action-icon" src="{% static 'icons/pin.svg' %}" class="menu-svg-icon" alt="">
        <span id="pin-label">Pin</span>
      </span>
    </li>
  </ul>
</div>

<script>
(function(){
  const sidebar = document.getElementById("sidebar");
  const toggleBtn = document.getElementById("sidebar-toggle");
  const overlay = document.getElementById("sidebar-overlay");

  if(sidebar && toggleBtn && overlay){
    // Toggle sidebar
    toggleBtn.addEventListener("click", ()=> {
      sidebar.classList.toggle("show");
      overlay.classList.toggle("show");
    });

    // Close sidebar on overlay click
    overlay.addEventListener("click", ()=> {
      sidebar.classList.remove("show");
      overlay.classList.remove("show");
    });

    // Auto close when resizing to desktop
    window.addEventListener("resize", ()=>{
      if(window.innerWidth > 900){
        sidebar.classList.remove("show");
        overlay.classList.remove("show");
      }
    });
  }

  // --- Your chat websocket, typing, context menu etc. can stay here ---
  const username = "{{ request.user.username|escapejs }}";
  const chatBox = document.getElementById("chat-box");
  const input = document.getElementById("msg-input");
  const sendBtn = document.getElementById("send-btn");
  const menu = document.getElementById("message-menu");
  const pinnedBar = document.getElementById("pinned-bar");
  const pinnedList = document.getElementById("pinned-list");
  const replyPreview = document.getElementById("reply-preview");
  const replyPreviewSender = document.getElementById("reply-preview-sender");
  const replyPreviewText = document.getElementById("reply-preview-text");
  const replyCancel = document.getElementById("reply-cancel");
  const bulkActions = document.getElementById("bulk-actions");
  const selectedCount = document.getElementById("selected-count");
  const clearSelectedBtn = document.getElementById("clear-selected-btn");
  const forwardSelectedBtn = document.getElementById("forward-selected-btn");
  
  // WebSocket setup
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const appId = {% if application %}{{ application.id }}{% elif selected_app %}{{ selected_app.id }}{% else %}null{% endif %};
  if(!appId) return;
  const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${appId}/`);

  function scrollBottom(el){ if(el) el.scrollTop = el.scrollHeight; }
  scrollBottom(chatBox);

  function normalizeType(type){
    if(!type) return type;
    return type.startsWith("chat.") ? type.slice(5) : type;
  }

  function escapeHtml(text){
    const div = document.createElement("div");
    div.textContent = text || "";
    return div.innerHTML;
  }

  function buildReplySnippet(replyData){
    if(!replyData) return "";
    const sender = escapeHtml(replyData.sender || "Unknown");
    const text = escapeHtml(replyData.text || "");
    return `<div class="reply-reference">
              <span class="reply-sender">${sender}</span>
              <span class="reply-text">${text}</span>
            </div>`;
  }

  function buildBubble(data){
    const bubble = document.createElement("div");
    const isMe = data.sender === username;
    bubble.className = `bubble ${isMe ? "me" : "them"} ${data.pinned ? "pinned" : ""} pop`;
    if(data.id) bubble.dataset.id = data.id;
    bubble.dataset.text = data.message || "";
    bubble.dataset.sender = data.sender || "";
    if(data.replyTo && data.replyTo.id){
      bubble.dataset.replyId = data.replyTo.id;
      bubble.dataset.replyText = data.replyTo.text || "";
      bubble.dataset.replySender = data.replyTo.sender || "";
    }

    const replyHtml = buildReplySnippet(data.replyTo);
    bubble.innerHTML = `
      <div><strong>${escapeHtml(data.sender || "")}</strong></div>
      ${replyHtml}
      <div class="message-text">${escapeHtml(data.message || "")}</div>
      <div class="meta">${data.meta || ""}</div>
    `;
    return bubble;
  }

  function showReplyPreview(replyData){
    if(!replyPreview || !input) return;
    replyPreview.hidden = false;
    replyPreviewSender.textContent = replyData.sender || "Unknown";
    replyPreviewText.textContent = replyData.text || "";
    input.dataset.replyId = replyData.id;
  }

  function clearReplyPreview(){
    if(!replyPreview || !input) return;
    replyPreview.hidden = true;
    replyPreviewSender.textContent = "";
    replyPreviewText.textContent = "";
    delete input.dataset.replyId;
  }

  if(replyCancel){
    replyCancel.addEventListener("click", clearReplyPreview);
  }

  // Typing indicator
  let typingIndicator = null;
  function showTyping(){
    if(!typingIndicator && chatBox){
      typingIndicator = document.createElement("div");
      typingIndicator.className = "bubble them typing";
      typingIndicator.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
      chatBox.appendChild(typingIndicator);
      scrollBottom(chatBox);
    }
  }
  function hideTyping(){ if(typingIndicator){ typingIndicator.remove(); typingIndicator=null; } }

  const pinnedCache = new Map();
  function renderPinnedList(pins){
    if(!pinnedBar || !pinnedList) return;
    pinnedList.innerHTML = "";
    pinnedCache.clear();
    pins.forEach(pin => {
      pinnedCache.set(String(pin.id), pin);
      const item = document.createElement("div");
      item.className = "pinned-item";
      item.dataset.id = pin.id;
      item.innerHTML = `
        <span class="pinned-text">${escapeHtml(pin.message || "")}</span>
        <span class="pinned-meta">${escapeHtml(pin.sender || "")}</span>
      `;
      item.addEventListener("click", ()=>{
        const target = chatBox ? chatBox.querySelector(`.bubble[data-id="${pin.id}"]`) : null;
        if(target){
          target.scrollIntoView({behavior:"smooth", block:"center"});
          target.classList.add("pinned");
        }
      });
      pinnedList.appendChild(item);
    });
    pinnedBar.hidden = pins.length === 0;
  }

  function updatePinnedState(id, pinned){
    const msg = chatBox ? chatBox.querySelector(`.bubble[data-id="${id}"]`) : null;
    if(pinned){
      if(chatBox){
        chatBox.querySelectorAll(".bubble.pinned").forEach(el => el.classList.remove("pinned"));
      }
      pinnedCache.clear();
    }
    if(msg){
      msg.classList.toggle("pinned", pinned);
    }
    if(pinned && msg){
      pinnedCache.set(String(id), {
        id: id,
        message: msg.dataset.text || "",
        sender: msg.dataset.sender || "",
      });
    } else if(!pinned) {
      pinnedCache.delete(String(id));
    }
    renderPinnedList(Array.from(pinnedCache.values()));
  }

  function initPinnedFromDom(){
    if(!chatBox) return;
    const pins = Array.from(chatBox.querySelectorAll(".bubble.pinned")).map(bubble => ({
      id: bubble.dataset.id,
      message: bubble.dataset.text,
      sender: bubble.dataset.sender,
    }));
    renderPinnedList(pins);
  }


  const selectedMessageIds = new Set();

  function updateSelectionUi(){
    if(!bulkActions || !selectedCount) return;
    const count = selectedMessageIds.size;
    selectedCount.textContent = `${count} selected`;
    bulkActions.hidden = count === 0;
  }

  function toggleMessageSelection(msgElem){
    if(!msgElem || !msgElem.dataset.id) return;
    const id = String(msgElem.dataset.id);
    if(selectedMessageIds.has(id)){
      selectedMessageIds.delete(id);
      msgElem.classList.remove("selected-message");
    } else {
      selectedMessageIds.add(id);
      msgElem.classList.add("selected-message");
    }
    updateSelectionUi();
  }

  function clearSelection(){
    selectedMessageIds.clear();
    if(chatBox){
      chatBox.querySelectorAll('.bubble.selected-message').forEach(el => el.classList.remove('selected-message'));
    }
    updateSelectionUi();
  }

  
  // Send message
  function sendMessage(msgInput=input){
    if(!msgInput) return;
    const text = msgInput.value.trim();
    if(!text) return;
    function actuallySend(){
      if(socket.readyState !== 1) return;
      if(msgInput.dataset.editId){
        socket.send(JSON.stringify({action:"edit", id: msgInput.dataset.editId, message: text}));
        delete msgInput.dataset.editId;
      } else if(msgInput.dataset.replyId){
        socket.send(JSON.stringify({action:"reply", reply_to: msgInput.dataset.replyId, message: text}));
        clearReplyPreview();
      } else {
        socket.send(JSON.stringify({action:"message", message: text}));
      }

      msgInput.value = "";
      if(sendBtn){ sendBtn.classList.add("send-effect"); setTimeout(()=>sendBtn.classList.remove("send-effect"),500); }
    }

    if(socket.readyState === 1){
      actuallySend();
    } else {
      socket.addEventListener("open", actuallySend, { once: true });
    }
  }

  // Event listeners
  if(sendBtn) sendBtn.addEventListener("click", ()=>sendMessage(input));
  if(input) input.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendMessage(input); } });

  let typingTimeout = null;
  function sendTyping(isTyping){
    if(socket.readyState !== 1) return;
    socket.send(JSON.stringify({action: "typing", typing: isTyping}));
  }
  if(input){
    input.addEventListener("input", ()=>{
      if(!input.value.trim()){
        sendTyping(false);
        return;
      }
      sendTyping(true);
      if(typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(()=>sendTyping(false), 1200);
    });
  }

  // Socket messages
  socket.onmessage = function(e){
    const data = JSON.parse(e.data);
    const eventType = normalizeType(data.type);
    if(eventType === "typing"){
      if(data.sender !== username){
        if(data.typing){ showTyping(); setTimeout(hideTyping,1500); }
        else { hideTyping(); }
      }
      return;
    }
    if(!chatBox) return;

    if(eventType === "message" || eventType === "reply"){
      const meta = new Date(data.timestamp).toLocaleString();
      let replyTo = null;
      if(eventType === "reply" && data.reply_to){
        const replyElem = chatBox.querySelector(`.bubble[data-id="${data.reply_to}"]`);
        replyTo = {
          id: data.reply_to,
          sender: (replyElem && replyElem.dataset.sender) ? replyElem.dataset.sender : "Unknown",
          text: (replyElem && replyElem.dataset.text) ? replyElem.dataset.text : "",
        };
      }
      const bubble = buildBubble({
        id: data.id,
        sender: data.sender,
        message: data.message,
        meta: meta,
        replyTo: replyTo,
      });
      chatBox.appendChild(bubble);
      scrollBottom(chatBox);
    } else if(eventType === "edit"){
      const msg = chatBox.querySelector(`.bubble[data-id="${data.id}"]`);
      if(msg){
        msg.dataset.text = data.message;
        const textEl = msg.querySelector(".message-text");
        if(textEl) textEl.innerText = data.message;
        const meta = msg.querySelector(".meta");
        if(meta){
          const readTick = meta.innerText.includes("âœ“") ? " âœ“" : "";
          const base = meta.innerText.replace(" (edited)", "").replace(" âœ“", "");
          meta.innerText = `${base} (edited)${readTick}`;
        }
      }
    } else if(eventType === "delete"){
      const msg = chatBox.querySelector(`.bubble[data-id="${data.id}"]`);
      if(msg){
        const wasPinned = msg.classList.contains("pinned");
        msg.classList.add("deleted");
        msg.dataset.text = "This message was deleted";
        const textEl = msg.querySelector(".message-text");
        if(textEl) textEl.innerText = "This message was deleted";
        if(wasPinned) updatePinnedState(data.id, false);
      }
    } else if(eventType === "pin"){
      updatePinnedState(data.id, data.pinned);
    } else if(eventType === "pins"){
      renderPinnedList(data.pins || []);
      } else if(eventType === "forward_done") {
      alert(`Forwarded ${data.count} message(s).`);
      clearSelection();
    }
  };

  socket.addEventListener("open", ()=>{
    socket.send(JSON.stringify({action:"get_pins"}));
  });
  if(socket.readyState === 1){
    socket.send(JSON.stringify({action:"get_pins"}));
  }

  initPinnedFromDom();

  // --- Context menu + long-press ---
  function showMenu(msgElem){
    if(!menu || !msgElem) return;

    const rect = msgElem.getBoundingClientRect();
    const container = msgElem.offsetParent || document.body;
    const containerRect = container.getBoundingClientRect();

    const menuHeight = menu.offsetHeight || 150;
    const menuWidth  = menu.offsetWidth  || 160;

    // Position relative to container
    let x = rect.left - containerRect.left + container.scrollLeft;
    let y = rect.bottom - containerRect.top + container.scrollTop;

    // Adjust vertical if overflow
    if(y + menuHeight > container.scrollHeight){
        y = rect.top - containerRect.top + container.scrollTop - menuHeight - 5;
    } else {
        y += 5; // small gap below bubble
    }

    // Adjust horizontal if overflow
    if(x + menuWidth > container.scrollWidth){
        x = rect.right - containerRect.left + container.scrollLeft - menuWidth;
    }

    menu.style.left = `${x}px`;
    menu.style.top  = `${y}px`;
    menu.style.display = "block";


    const isMe = msgElem.classList.contains("me");
    const isPinned = msgElem.classList.contains("pinned");
    const editItem = menu.querySelector('li[data-action="edit"]');
    const deleteEveryoneItem = menu.querySelector('li[data-action="delete-everyone"]');
    const pinItemLabel = document.getElementById("pin-label");
    const pinItemIcon = document.getElementById("pin-action-icon");

    if(editItem) editItem.style.display = isMe ? "" : "none";
    if(deleteEveryoneItem) deleteEveryoneItem.style.display = isMe ? "" : "none";
    if(pinItemLabel) pinItemLabel.textContent = isPinned ? "Unpin" : "Pin";
    if(pinItemIcon) {
      pinItemIcon.src = isPinned
        ? "{% static 'icons/unpin.svg' %}"
        : "{% static 'icons/pin.svg' %}";
    }

    void menu.offsetWidth; // trigger animation
    menu.classList.add("show");

    menu.querySelectorAll("li").forEach(item => {
        item.onclick = () => handleAction(item.dataset.action, msgElem);
    });
}

    // ---- ADD THIS FUNCTION BELOW ----
  // Function to move applicant to deleted section dynamically
  function moveToDeleted(appId) {
    const appLink = document.querySelector(`.sidebar .applicant[data-app-id="${appId}"]`);
    if(!appLink) return;

    // Remove selection & add deleted class
    appLink.classList.remove("selected");
    appLink.classList.add("deleted");

    // Move to deleted section
    const deletedContainer = document.getElementById("deleted-applicants");
    if(deletedContainer) deletedContainer.appendChild(appLink);

    // Disable click and add hover effect
    appLink.addEventListener('click', e => {
        e.preventDefault();
        alert("This application has been deleted and cannot be accessed.");
    });

    appLink.addEventListener('mouseenter', () => appLink.style.backgroundColor="rgba(255,0,0,0.05)");
    appLink.addEventListener('mouseleave', () => appLink.style.backgroundColor="transparent");
  }

  // Example: listen for WebSocket delete events for applications
  socket.addEventListener('message', function(e){
    const data = JSON.parse(e.data);
    if(data.type === "delete_applicant" && data.app_id){
        moveToDeleted(data.app_id);
    }
  });
  
  function hideMenu(){ if(menu) menu.classList.remove("show"); setTimeout(()=>{ if(menu && !menu.classList.contains("show")) menu.style.display="none"; },200); }

  function handleAction(action, msgElem){
    if(!socket || !msgElem) return;
    const msgId = msgElem.dataset.id;
    const text  = msgElem.dataset.text;
    const sender = msgElem.dataset.sender || "Unknown";

    if(action === "copy"){
        navigator.clipboard.writeText(text);
    }
    else if(action === "reply"){
        showReplyPreview({id: msgId, text: text, sender: sender});
        if(input) input.focus();
    }
    else if(action === "edit"){
        if(!msgElem.classList.contains("me")) {
          hideMenu();
          return;
        }
        input.value = text;
        input.dataset.editId = msgId;
        input.focus();
    }
    else if(action === "delete-me"){
        const wasPinned = msgElem.classList.contains("pinned");
        msgElem.remove();
        if(wasPinned) updatePinnedState(msgId, false);
    }
    else if(action === "delete-everyone"){
        if(!msgElem.classList.contains("me")) {
          hideMenu();
          return;
        }
        socket.send(JSON.stringify({action:"delete", id: msgId, mode:"everyone"}));
    }
    else if(action === "forward"){
        const targetAppsRaw = prompt("Enter target chat IDs separated by commas (example: 12,18):");
        if(targetAppsRaw){
            const targetApps = targetAppsRaw.split(",").map(v => v.trim()).filter(Boolean);
            if(targetApps.length){
              socket.send(JSON.stringify({
                  action: "forward",
                  message_ids: [msgId],
                  target_apps: targetApps
              }));
            }
        }
    }
    else if(action==="pin") {
      const isPinned = msgElem.classList.contains("pinned");
      socket.send(JSON.stringify({action:"pin", id: msgId, pin: !isPinned}));
    }

    hideMenu();
}


  if(chatBox){
    chatBox.addEventListener("click", e=>{
      const bubble = e.target.closest(".bubble");
      if(!bubble) return;
      if(selectedMessageIds.size || e.ctrlKey || e.metaKey){
        e.preventDefault();
        toggleMessageSelection(bubble);
      }
    });
  }

  
  if(chatBox){
    chatBox.addEventListener("dblclick", e=>{
      const bubble = e.target.closest(".bubble");
      if(!bubble) return;
      e.preventDefault();
      toggleMessageSelection(bubble);
    });
  }
  if(clearSelectedBtn){
    clearSelectedBtn.addEventListener("click", clearSelection);
  }

  if(forwardSelectedBtn){
    forwardSelectedBtn.addEventListener("click", ()=>{
      if(!selectedMessageIds.size) return;
      const targetAppsRaw = prompt("Enter target chat IDs separated by commas (example: 12,18):");
      if(!targetAppsRaw) return;
      const targetApps = targetAppsRaw.split(",").map(v => v.trim()).filter(Boolean);
      if(!targetApps.length) return;
      socket.send(JSON.stringify({
        action: "forward",
        message_ids: Array.from(selectedMessageIds),
        target_apps: targetApps
      }));
    });
  }
  
  
  // Right-click to open menu
  if(chatBox){
    chatBox.addEventListener("contextmenu", e=>{ e.preventDefault(); const t=e.target.closest(".bubble"); if(t) showMenu(t); });
  }

  // Long-press for touch
  function addLongPress(container){
    if(!container) return;
    container.style.touchAction="manipulation"; // disable default long-press

    let timer=null, target=null, startX=0, startY=0, pointerId=null;
    const LONG_MS=600, MOVE_TOL=10;
    const cancel = ()=>{ if(timer){ clearTimeout(timer); timer=null; } target=null; pointerId=null; };

    container.addEventListener("pointerdown", e=>{
      const t=e.target.closest(".bubble");
      if(!t) return;
      target=t; pointerId=e.pointerId; startX=e.clientX; startY=e.clientY;
      if(timer) clearTimeout(timer);
      timer=setTimeout(()=>{ if(target) toggleMessageSelection(target); }, LONG_MS);
    }, {passive:true});

    container.addEventListener("pointermove", e=>{
      if(pointerId!==e.pointerId || !timer) return;
      if(Math.abs(e.clientX-startX)>MOVE_TOL || Math.abs(e.clientY-startY)>MOVE_TOL) cancel();
    }, {passive:true});

    container.addEventListener("pointerup", cancel, {passive:true});
    container.addEventListener("pointercancel", cancel, {passive:true});
    container.addEventListener("mouseleave", cancel, {passive:true});
    window.addEventListener("blur", cancel);
  }

  addLongPress(chatBox);

  // Hide menu when clicking outside
  document.addEventListener("click", e=>{ if(!menu.contains(e.target)) hideMenu(); });

  // Disable clicks and hover effects for deleted applicants
document.addEventListener("DOMContentLoaded", function(){
    const deletedApps = document.querySelectorAll('.sidebar .applicant.deleted');

    deletedApps.forEach(app => {
        app.addEventListener('click', e => {
            e.preventDefault();
            alert("This application has been deleted and cannot be accessed.");
        });

        app.addEventListener('mouseenter', () => app.style.backgroundColor="rgba(255,0,0,0.05)");
        app.addEventListener('mouseleave', () => app.style.backgroundColor="transparent");
    });
});

})();
</script>

</div>

{% endblock %}  
