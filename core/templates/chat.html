{% extends "base.html" %}
{% block title %}Chat{% if job %} â€” {{ job.title }}{% elif application %} â€” {{ application.job.title }}{% endif %}{% endblock %}
{% block content %}
{% load static %}

<style>
:root {
  --chat-bg: var(--bg-main);
  --chat-card: var(--bg-card);
  --chat-surface: var(--bg-surface);
  --chat-surface-soft: var(--bg-surface-soft);
  --chat-text: var(--text-main);
  --chat-muted: var(--text-muted);
  --chat-border: rgba(148, 163, 184, 0.25);
  --chat-deleted: rgba(148, 163, 184, 0.2);
  --chat-accent: #25d366;
  --chat-accent-dark: #128c7e;
  --chat-shadow: var(--alien-shadow);
  --bubble-me: #1f7d4f;
  --bubble-them: var(--chat-surface);
  --bubble-border: var(--chat-border);
  --chat-icon-filter: brightness(0) invert(1);
}

body.light-mode .chat-wrap {
  --chat-bg: #efeae2;
  --chat-card: #ffffff;
  --chat-surface: #ffffff;
  --chat-surface-soft: #f7f8fa;
  --bubble-me: #dcf8c6;
  --bubble-them: #ffffff;
  --bubble-border: rgba(0, 0, 0, 0.08);
  --chat-border: rgba(0, 0, 0, 0.08);
  --chat-icon-filter: none;
}
  
/* --- Layout & Sidebar --- */
.chat-wrap {
  display: flex;
  flex-wrap: nowrap;
  max-width: 1200px;
  margin: 30px auto;
  gap: 18px;
  font-family: 'Poppins', sans-serif;
  position: relative;
  color: var(--chat-text);
  align-items: stretch;
}

.sidebar {
  flex: 0 0 280px;
  background: var(--chat-card);
  border-radius: 18px;
  overflow: hidden;
  border: 1px solid var(--chat-border);
  box-shadow: 0 8px 24px var(--chat-shadow);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
  max-height: calc(100vh - 80px);
}
.sidebar h3 {
  padding: 14px 16px;
  border-bottom: 1px solid var(--chat-border);
  color: var(--chat-accent-dark);
  font-weight: 600;
}
.sidebar-content {
  overflow-y: auto;
  flex: 1 1 auto;
}
.sidebar-section {
  display: flex;
  flex-direction: column;
}
.applicant {
  padding: 12px 14px;
  cursor: pointer;
  border-bottom: 1px solid var(--chat-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: var(--chat-text);
  transition: all 0.2s ease-in-out;
}
.applicant:hover {
  background: rgba(37, 211, 102, 0.12);
}
.applicant.selected {
  background: rgba(37, 211, 102, 0.2);
  font-weight: 600;
}

.badge {
  background: var(--chat-accent);
  color: #ffffff;
  border-radius: 999px;
  padding: 2px 8px;
  font-size: 12px;
  font-weight: 700;
}

/* Deleted applicants */
.sidebar .applicant.deleted {
  opacity: 0.4;
  cursor: not-allowed;
  border-bottom: 1px solid var(--chat-border);
  background: none !important;
  box-shadow: none !important;
  transition: none;
}
.sidebar .applicant.deleted:hover {
  background: none !important;
  box-shadow: none !important;
}
.sidebar .applicant.deleted .badge {
  background: var(--text-danger);
  color: #ffffff;
}

/* --- Chat Container --- */
.chat-container {
  flex: 1 1 auto;
  min-width: 0;
  display: flex;
  flex-direction: column;
  background: var(--chat-card);
  border-radius: 18px;
  border: 1px solid var(--chat-border);
  box-shadow: 0 12px 28px var(--chat-shadow);
  overflow: hidden;
  max-height: calc(100vh - 60px);
}

.chat-header {
  padding: 14px 18px;
  border-bottom: 1px solid var(--chat-border);
  color: var(--chat-text);
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 12px;
  background: var(--chat-surface);
}
.chat-header-actions {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.group-toggle-btn {
  border: 1px solid var(--chat-border);
  border-radius: 999px;
  padding: 8px 12px;
  background: var(--chat-surface-soft);
  color: var(--chat-accent-dark);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
}
#sidebar-toggle {
  display: none;
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  color: var(--chat-accent-dark);
  padding: 0;
}
.chat-title {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1 1 auto;
}
.chat-box {
  flex: 1;
  overflow-y: auto;
  padding: 18px 18px 80px 18px;
  background: var(--chat-bg);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.pinned-bar {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 10px 16px;
  border-bottom: 1px solid var(--chat-border);
  background: var(--chat-surface);
}
.pinned-head {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: var(--chat-accent-dark);
}
.pinned-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.pinned-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 10px;
  border-radius: 12px;
  border: 1px solid var(--chat-border);
  background: var(--chat-surface-soft);
  cursor: pointer;
}
.pinned-item span {
  display: block;
}
.pinned-item .pinned-text {
  font-size: 13px;
  color: var(--chat-text);
}
.pinned-item .pinned-meta {
  font-size: 11px;
  color: var(--chat-muted);
}

.bubble {
  max-width: 72%;
  margin: 2px 0;
  padding: 8px 12px;
  border-radius: 14px 14px 14px 4px;
  word-wrap: break-word;
  position: relative;
  color: var(--chat-text);
  background: var(--bubble-them);
  border: 1px solid var(--bubble-border);
  box-shadow: 0 1px 1px rgba(0, 0, 0, 0.08);
  transition: all 0.2s ease-in-out;
}
.bubble .message-text {
  white-space: pre-wrap;
  line-height: 1.45;
}
.bubble strong {
  display: block;
  font-size: 0.78rem;
  color: var(--chat-muted);
  margin-bottom: 2px;
}
.bubble:hover {
  transform: translateY(-1px);
}
.me {
  margin-left: auto;
  background: var(--bubble-me);
  border-color: rgba(37, 211, 102, 0.35);
  text-align: right;
  border-radius: 14px 14px 4px 14px;
}
.them {
  margin-right: auto;
}
.me::after,
.them::after {
  content: "";
  position: absolute;
  bottom: 0;
  width: 0;
  height: 0;
  border: 8px solid transparent;
}
.me::after {
  right: -6px;
  border-left-color: var(--bubble-me);
  border-bottom-color: transparent;
}
.them::after {
  left: -6px;
  border-right-color: var(--bubble-them);
  border-bottom-color: transparent;
}
.bubble.deleted {
  background: var(--chat-deleted);
  border-color: var(--chat-border);
  color: var(--chat-muted);
  font-style: italic;
}
.reply-reference {
  border-left: 3px solid var(--chat-accent);
  padding: 4px 8px;
  margin-bottom: 6px;
  background: rgba(18, 140, 126, 0.12);
  border-radius: 8px;
  text-align: left;
}
.reply-reference .reply-sender {
  font-size: 11px;
  font-weight: 600;
  color: var(--chat-accent-dark);
}
.reply-reference .reply-text {
  font-size: 12px;
  color: var(--chat-text);
  display: block;
}
.meta {
  font-size: 11px;
  margin-top: 6px;
  color: var(--chat-muted);
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 6px;
}
.bubble.pinned {
  border-color: var(--chat-accent-dark);
  box-shadow: 0 0 0 2px rgba(18, 140, 126, 0.18);
}
.bubble.pinned::before {
  content: "ðŸ“Œ";
  position: absolute;
  top: -12px;
  right: 10px;
  font-size: 12px;
}
.bubble.selected-message {
  outline: 2px solid var(--chat-accent-dark);
  outline-offset: 1px;
}
.bulk-actions {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 8px 16px;
  border-top: 1px solid var(--chat-border);
  background: var(--chat-surface-soft);
}
.bulk-actions-buttons {
  display: inline-flex;
  gap: 8px;
}
.bulk-actions button {
  border: 1px solid var(--chat-border);
  border-radius: 999px;
  padding: 6px 12px;
  background: var(--chat-surface);
  color: var(--chat-text);
  cursor: pointer;
}
.applicants-group-overlay {
  position: fixed;
  inset: 0;
  background: rgba(17, 27, 33, 0.55);
  backdrop-filter: blur(3px);
  z-index: 1400;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
.applicants-group-shell {
  width: min(900px, 100%);
  height: min(88vh, 760px);
  background: var(--chat-card);
  border: 1px solid var(--chat-border);
  border-radius: 18px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: 0 25px 60px rgba(0, 0, 0, 0.4);
}
.applicants-group-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #075e54;
  color: #fff;
  padding: 12px 16px;
}
.applicants-group-title {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.applicants-group-title small {
  opacity: 0.85;
  font-size: 12px;
}
.applicants-group-close {
  border: none;
  background: transparent;
  color: #fff;
  font-size: 22px;
  cursor: pointer;
}
.applicants-group-members {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 10px 16px;
  border-bottom: 1px solid var(--chat-border);
  background: var(--chat-surface);
}
.applicants-group-members span {
  border: 1px solid var(--chat-border);
  border-radius: 999px;
  padding: 4px 10px;
  font-size: 12px;
  background: var(--chat-surface-soft);
}
.applicants-group-feed {
  flex: 1;
  overflow-y: auto;
  padding: 14px;
  background: var(--chat-bg);
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.applicants-group-item {
  max-width: 75%;
  border: 1px solid var(--bubble-border);
  border-radius: 16px;
  padding: 8px 12px;
  background: var(--bubble-them);
}
.applicants-group-item.me {
  margin-left: auto;
  background: var(--bubble-me);
  border-radius: 16px 16px 4px 16px;
}
.applicants-group-item .sender {
  display: block;
  font-weight: 600;
  font-size: 11px;
  color: var(--chat-accent-dark);
}
.applicants-group-item .meta {
  justify-content: flex-end;
  margin-top: 4px;
}
.applicants-group-form {
  display: flex;
  gap: 8px;
  padding: 12px;
  border-top: 1px solid var(--chat-border);
  background: var(--chat-surface);
}
.applicants-group-form input {
  flex: 1;
  border: 1px solid var(--chat-border);
  border-radius: 999px;
  padding: 10px 14px;
  background: var(--chat-surface-soft);
  color: var(--chat-text);
}
.applicants-group-form button {
  border: none;
  border-radius: 999px;
  padding: 10px 14px;
  background: linear-gradient(135deg, var(--chat-accent), var(--chat-accent-dark));
  color: #fff;
}
/* Reply preview */
.reply-preview {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding: 10px 16px;
  background: var(--chat-surface-soft);
  border-top: 1px solid var(--chat-border);
}
.reply-preview-body {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 13px;
  color: var(--chat-text);
}
.reply-preview-label {
  font-weight: 600;
  color: var(--chat-accent-dark);
}
.reply-cancel {
  border: none;
  background: transparent;
  font-size: 18px;
  cursor: pointer;
  color: var(--chat-muted);
}

/* Chat Input */
.chat-input {
  display: flex;
  gap: 10px;
  padding: 12px 16px;
  border-top: 1px solid var(--chat-border);
  background: var(--chat-surface);
  flex-wrap: wrap;
}

.chat-input input {
  flex: 1;
  min-width: 0;
  padding: 12px 16px;
  border-radius: 999px;
  border: 1px solid var(--chat-border);
  outline: none;
  background: var(--chat-surface-soft);
  color: var(--chat-text);
}

.chat-input button {
  padding: 12px 20px;
  border: none;
  border-radius: 999px;
  font-weight: 700;
  cursor: pointer;
  background: linear-gradient(135deg, var(--chat-accent), var(--chat-accent-dark));
  color: #ffffff;
  box-shadow: 0 6px 18px rgba(18, 140, 126, 0.3);
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.chat-input button:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 24px rgba(18, 140, 126, 0.4);
}

/* Typing Indicator */
.typing {
  display: flex;
  align-items: center;
  gap: 4px;
  max-width: 70px;
  padding: 10px 14px;
  border-radius: 14px;
  background: var(--bubble-them);
  border: 1px solid var(--chat-border);
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
}

.dot {
  width: 6px;
  height: 6px;
  background: var(--chat-accent-dark);
  border-radius: 50%;
  animation: blink 1.4s infinite ease-in-out;
}

.dot:nth-child(2) { animation-delay: 0.2s; }
.dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes blink {
  0%, 80%, 100% { opacity: 0.2; transform: scale(1); }
  40% { opacity: 1; transform: scale(1.4); }
}

/* Context menu */
#message-menu {
  position: absolute;
  background: var(--chat-surface);
  color: var(--chat-text);
  border-radius: 12px;
  border: 1px solid var(--chat-border);
  box-shadow: 0 12px 28px rgba(0, 0, 0, 0.2);
  z-index: 2000;
  display: none;
  opacity: 0;
  transform: translateY(-5px) scale(0.95);
  transition: opacity 0.2s ease, transform 0.2s ease;
  min-width: 180px;
}
#message-menu.show { display: block; opacity: 1; transform: translateY(0) scale(1); }
#message-menu ul { list-style: none; padding: 8px; margin: 0; }
#message-menu li {
  padding: 8px 12px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
  border-radius: 8px;
}
#message-menu li:hover {
  background: rgba(37, 211, 102, 0.12);
}
.menu-item-content {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.menu-svg-icon {
  width: 18px;
  height: 18px;
  opacity: 0.8;
  filter: var(--chat-icon-filter);
  object-fit: contain;
}
.theme-icon {
  width: 18px;
  height: 18px;
  filter: var(--chat-icon-filter);
  object-fit: contain;
}

/* Responsive Sidebar Drawer */
#sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(6px); z-index: 999; opacity: 0; transition: opacity 0.3s ease; }
@media (max-width: 900px) {
  .chat-wrap { flex-direction: column; }
  .sidebar {
    position: fixed;
    top: 0; left: 0;
    height: 100%;
    z-index: 1000;
    transform: translateX(-100%);
    border-radius: 0;
    width: 260px;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .sidebar.show { transform: translateX(0); }
  #sidebar-toggle { display: block; }
  #sidebar-overlay.show { display: block; opacity: 1; }
  .chat-container { border-radius: 16px; }
}

@media (max-width: 600px) {
  .chat-input { flex-direction: column; gap: 8px; }
  .chat-input button { width: 100%; }
}
</style>


<div class="chat-wrap">
  {% if job %}
    <div class="sidebar" id="sidebar">
      <!-- Active Applicants -->
      <h3>Applicants</h3>
        <div class="sidebar-content">
        <div class="sidebar-section" id="active-applicants">
          {% for app in applications %}
            <a href="?app_id={{ app.id }}" 
               class="applicant {% if selected_app and app.id == selected_app.id %}selected{% endif %}" 
                data-app-id="{{ app.id }}">
              {{ app.applicant.username }}
              {% if app.unread_count %}<span class="badge">{{ app.unread_count }}</span>{% endif %}
            </a>
          {% empty %}
            <p style="padding:12px; opacity:.7;">No applicants yet</p>
          {% endfor %}
        </div>
      
        <!-- Deleted Applicants -->
        {% if deleted_applications %}
          <h3 class="text-danger" style="margin-top:20px;">Deleted Applicants</h3>
          <div class="sidebar-section" id="deleted-applicants">
            {% for app in deleted_applications %}
              <a href="javascript:void(0);" 
                 class="applicant deleted" 
                 data-app-id="{{ app.id }}">
                {{ app.applicant.username }}
                {% if app.unread_count %}<span class="badge">{{ app.unread_count }}</span>{% endif %}
              </a>
            {% empty %}
              <p style="padding:12px; opacity:.7;">No deleted applicants</p>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>

    <div id="sidebar-overlay"></div>
  {% endif %}

  <!-- Main chat -->
  <div class="chat-container">
    <div class="chat-header">
      {% if job %}
        <button id="sidebar-toggle">â˜°</button>
        <div class="chat-title"><strong>{{ job.title }}</strong>{% if job.company %} â€” {{ job.company }}{% endif %}</div>
        <div class="chat-header-actions">
          <button id="group-toggle-btn" class="group-toggle-btn" type="button">Applicants Group</button>
        </div>
      {% else %}
        <div class="chat-title"><strong>{{ application.job.title }}</strong>{% if application.job.company %} â€” {{ application.job.company }}{% endif %}</div>
      {% endif %}
    </div>

    <div class="pinned-bar" id="pinned-bar" hidden>
      <div class="pinned-head">
        <img src="{% static 'icons/pin.svg' %}" class="theme-icon" alt="">
        <span>Pinned messages</span>
      </div>
      <div class="pinned-list" id="pinned-list"></div>
    </div>
    
    <div id="chat-box" class="chat-box">
      {% for m in messages %}
        <div class="bubble {% if m.sender_id == request.user.id %}me{% else %}them{% endif %} {% if m.is_pinned %}pinned{% endif %} pop" 
             data-id="{{ m.id }}" data-text="{{ m.message|escape }}" data-sender="{{ m.sender.username|escape }}"
             {% if m.reply_to %}data-reply-id="{{ m.reply_to.id }}" data-reply-text="{{ m.reply_to.message|escape }}" data-reply-sender="{{ m.reply_to.sender.username|escape }}"{% endif %}>
          <div><strong>{{ m.sender.username }}</strong></div>
          {% if m.reply_to %}
            <div class="reply-reference">
              <span class="reply-sender">{{ m.reply_to.sender.username }}</span>
              <span class="reply-text">{{ m.reply_to.message|truncatechars:80 }}</span>
            </div>
          {% endif %}
          <div class="message-text">{{ m.message }}</div>
          <div class="meta">{{ m.timestamp }}{% if m.edited_at %} (edited){% endif %}{% if m.is_read and m.sender_id == request.user.id %} âœ“{% endif %}</div>
        </div>
      {% empty %}
        <p style="opacity:.7;text-align:center;margin-top:16px;">No messages yet. Say hi ðŸ‘‹</p>
      {% endfor %}
    </div>

    <div class="bulk-actions" id="bulk-actions" hidden>
      <span id="selected-count">0 selected</span>
      <div class="bulk-actions-buttons">
        <button type="button" id="forward-selected-btn">Forward selected</button>
        <button type="button" id="clear-selected-btn">Clear</button>
      </div>
    </div>

    <div class="applicants-group-overlay" id="applicants-group-panel" hidden>
      <div class="applicants-group-shell">
        <div class="applicants-group-header">
          <div class="applicants-group-title">
            <strong>Applicants Group</strong>
            <small id="applicants-group-subtitle">All applicants in this job</small>
          </div>
          <button id="applicants-group-close" class="applicants-group-close" type="button" aria-label="Close group chat">âœ•</button>
        </div>
        <div class="applicants-group-members" id="applicants-group-members"></div>
        <div class="applicants-group-feed" id="applicants-group-feed"></div>
        <div class="applicants-group-form">
          <input id="applicants-group-input" type="text" placeholder="Type a message" maxlength="500" />
          <button id="applicants-group-send" type="button">Send</button>
        </div>
      </div>
    </div>

      <div class="reply-preview" id="reply-preview" hidden>
      <div class="reply-preview-body">
        <span class="reply-preview-label">Replying to <span id="reply-preview-sender"></span></span>
        <span id="reply-preview-text"></span>
      </div>
      <button class="reply-cancel" id="reply-cancel" type="button" aria-label="Cancel reply">âœ•</button>
    </div>
    
    <form id="chat-form" class="chat-input" onsubmit="return false;">
      {% csrf_token %}
      <input id="msg-input" type="text" placeholder="Messageâ€¦" autocomplete="off" maxlength="2000" />
      <button id="send-btn" type="button">Send</button>
    </form>
  </div>
</div>

<!-- Context Menu -->
<div id="message-menu">
  <ul>
    <li data-action="reply">
      <span class="menu-item-content">
        <img src="{% static 'icons/reply.svg' %}" class="menu-svg-icon" alt="">
        <span>Reply</span>
      </span>
    </li>

    <li data-action="copy">
      <span class="menu-item-content">
        <img src="{% static 'icons/content_copy.svg' %}" class="menu-svg-icon" alt="">
        <span>Copy</span>
      </span>
    </li>

    <li data-action="edit">
      <span class="menu-item-content">
        <img src="{% static 'icons/edit.svg' %}" class="menu-svg-icon" alt="">
        <span>Edit</span>
      </span>
    </li>

    <li data-action="delete-me">
      <span class="menu-item-content">
        <img src="{% static 'icons/delete_for_me.svg' %}" class="menu-svg-icon" alt="">
        <span>Delete for Me</span>
      </span>
    </li>

    <li data-action="delete-everyone">
      <span class="menu-item-content">
        <img src="{% static 'icons/delete_forever.svg' %}" class="menu-svg-icon" alt="">
        <span>Delete for Everyone</span>
      </span>
    </li>

    <li data-action="forward">
      <span class="menu-item-content">
        <img src="{% static 'icons/forward.svg' %}" class="menu-svg-icon" alt="">
        <span>Forward</span>
      </span>
    </li>

    <li data-action="pin">
      <span class="menu-item-content">
        <img id="pin-action-icon" src="{% static 'icons/pin.svg' %}" class="menu-svg-icon" alt="">
        <span id="pin-label">Pin</span>
      </span>
    </li>
  </ul>
</div>

<script>
(function(){
  const username = "{{ request.user.username|escapejs }}";
  const chatBox = document.getElementById("chat-box");
  const input = document.getElementById("msg-input");
  const sendBtn = document.getElementById("send-btn");
  const menu = document.getElementById("message-menu");
  const pinnedBar = document.getElementById("pinned-bar");
  const pinnedList = document.getElementById("pinned-list");
  const replyPreview = document.getElementById("reply-preview");
  const replyPreviewSender = document.getElementById("reply-preview-sender");
  const replyPreviewText = document.getElementById("reply-preview-text");
  const replyCancel = document.getElementById("reply-cancel");
  const groupToggleBtn = document.getElementById("group-toggle-btn");
  const applicantsGroupPanel = document.getElementById("applicants-group-panel");
  const applicantsGroupMembers = document.getElementById("applicants-group-members");
  const applicantsGroupFeed = document.getElementById("applicants-group-feed");
  const applicantsGroupInput = document.getElementById("applicants-group-input");
  const applicantsGroupSend = document.getElementById("applicants-group-send");
  const applicantsGroupClose = document.getElementById("applicants-group-close");
  const sidebar = document.getElementById("sidebar");
  const toggleBtn = document.getElementById("sidebar-toggle");
  const overlay = document.getElementById("sidebar-overlay");

  if(sidebar && toggleBtn && overlay){
    toggleBtn.addEventListener("click", ()=>{
      sidebar.classList.toggle("show");
      overlay.classList.toggle("show");
    });
    overlay.addEventListener("click", ()=>{
      sidebar.classList.remove("show");
      overlay.classList.remove("show");
    });
    window.addEventListener("resize", ()=>{
      if(window.innerWidth > 900){
        sidebar.classList.remove("show");
        overlay.classList.remove("show");
      }
    });
  }

  let activeMessage = null;
  let typingIndicator = null;
  let socket = null;
  let currentAppId = {% if application %}{{ application.id }}{% elif selected_app %}{{ selected_app.id }}{% else %}null{% endif %};
  const pinnedCache = new Map();

  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  
  function normalizeType(type){
    if(!type) return type;
    return type.startsWith("chat.") ? type.slice(5) : type;
  }

  function scrollBottom(el){ if(el) el.scrollTop = el.scrollHeight; }
  function normalizeType(type){ return type && type.startsWith("chat.") ? type.slice(5) : type; }
  
  function escapeHtml(text){
    const div = document.createElement("div");
    div.textContent = text || "";
    return div.innerHTML;
  }

  function buildReplySnippet(replyData){
    if(!replyData) return "";
    return `<div class="reply-reference"><span class="reply-sender">${escapeHtml(replyData.sender || "Unknown")}</span><span class="reply-text">${escapeHtml(replyData.text || "")}</span></div>`;
  }

  function buildBubble(data){
    const bubble = document.createElement("div");
    const isMe = data.sender === username;
    bubble.className = `bubble ${isMe ? "me" : "them"} ${data.pinned ? "pinned" : ""} ${data.deleted ? "deleted" : ""} pop`;
    bubble.dataset.id = data.id || "";
    bubble.dataset.text = data.message || "";
    bubble.dataset.sender = data.sender || "";
    if(data.pinnedBy){
      bubble.dataset.pinnedBy = data.pinnedBy;
    }
    if(data.replyTo && data.replyTo.id){
      bubble.dataset.replyId = data.replyTo.id;
      bubble.dataset.replyText = data.replyTo.text || "";
      bubble.dataset.replySender = data.replyTo.sender || "";
    }
    bubble.innerHTML = `
      <div><strong>${escapeHtml(data.sender || "")}</strong></div>
      ${buildReplySnippet(data.replyTo)}
      <div class="message-text">${escapeHtml(data.message || "")}</div>
      <div class="meta">${data.meta || ""}</div>
    `;
    return bubble;
  }

  function setChatMessages(rows){
    if(!chatBox) return;
    chatBox.innerHTML = "";
    if(!rows.length){
      chatBox.innerHTML = '<p style="opacity:.7;text-align:center;margin-top:16px;">No messages yet. Say hi ðŸ‘‹</p>';
      return;
    }
    rows.forEach(row => {
      const bubble = buildBubble({
        id: row.id,
        sender: row.sender,
        message: row.text,
        meta: row.created,
        replyTo: row.reply_to,
        pinned: !!row.pinned,
        pinnedBy: row.pinned_by,
      });
      chatBox.appendChild(bubble);
    });
    scrollBottom(chatBox);
  }

  function showTyping(){
    if(typingIndicator || !chatBox) return;
    typingIndicator = document.createElement("div");
    typingIndicator.className = "bubble them typing";
    typingIndicator.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
    chatBox.appendChild(typingIndicator);
    scrollBottom(chatBox);
  }
  function hideTyping(){ if(typingIndicator){ typingIndicator.remove(); typingIndicator = null; } }

  function renderPinnedList(pins){
    if(!pinnedBar || !pinnedList) return;
    pinnedList.innerHTML = "";
    pinnedCache.clear();
    pins.forEach(pin => {
      pinnedCache.set(String(pin.id), pin);
      const item = document.createElement("div");
      item.className = "pinned-item";
      item.dataset.id = pin.id;
      item.innerHTML = `<span class="pinned-text">${escapeHtml(pin.message || "")}</span><span class="pinned-meta">Pinned by ${escapeHtml(pin.pinned_by || "")}</span>`;
      item.addEventListener("click", ()=>{
        const target = chatBox ? chatBox.querySelector(`.bubble[data-id="${pin.id}"]`) : null;
        if(target){ target.scrollIntoView({behavior:"smooth", block:"center"}); }
        }
      });
      pinnedList.appendChild(item);
    });
    pinnedBar.hidden = pins.length === 0;
  }

  function updatePinnedState(id, pinned, pinnedBy){
    const msg = chatBox ? chatBox.querySelector(`.bubble[data-id="${id}"]`) : null;
    if(msg){
      msg.classList.toggle("pinned", !!pinned);
      if(pinned && pinnedBy){ msg.dataset.pinnedBy = pinnedBy; }
      if(!pinned){ delete msg.dataset.pinnedBy; }
    }
    if(pinned){
      pinnedCache.clear();
      if(msg){
        pinnedCache.set(String(id), {id, message: msg.dataset.text || "", sender: msg.dataset.sender || "", pinned_by: pinnedBy || ""});
      }
    } else {
      pinnedCache.delete(String(id));
    }
    renderPinnedList(Array.from(pinnedCache.values()));
  }

  function showReplyPreview(replyData){
    if(!replyPreview || !input) return;
    replyPreview.hidden = false;
    replyPreviewSender.textContent = replyData.sender || "Unknown";
    replyPreviewText.textContent = replyData.text || "";
    input.dataset.replyId = replyData.id;
  }
  function clearReplyPreview(){
    if(!replyPreview || !input) return;
    replyPreview.hidden = true;
    replyPreviewSender.textContent = "";
    replyPreviewText.textContent = "";
    delete input.dataset.replyId;
  }
  
  function connectSocket(appId){
    if(!appId) return;
    if(socket){ socket.close(); }
    socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${appId}/`);

    socket.onopen = () => socket.send(JSON.stringify({action:"get_pins"}));
    socket.onmessage = function(e){
      const data = JSON.parse(e.data);
      const eventType = normalizeType(data.type);

      if(eventType === "typing"){
        if(data.sender !== username){ data.typing ? showTyping() : hideTyping(); }
        return;
      }
      if(eventType === "message" || eventType === "reply"){
        const replyTo = data.reply_to ? {id:data.reply_to, sender:"", text:""} : null;
        const bubble = buildBubble({id:data.id, sender:data.sender, message:data.message, meta:new Date(data.timestamp).toLocaleString(), replyTo});
        chatBox.appendChild(bubble);
        scrollBottom(chatBox);
      } else if(eventType === "edit"){
        const msg = chatBox.querySelector(`.bubble[data-id="${data.id}"]`);
        if(msg){ msg.dataset.text = data.message; const t = msg.querySelector('.message-text'); if(t) t.innerText = data.message; }
      } else if(eventType === "delete"){
        const msg = chatBox.querySelector(`.bubble[data-id="${data.id}"]`);
        if(msg){ msg.classList.add("deleted"); msg.querySelector('.message-text').innerText = "This message was deleted"; msg.dataset.text = ""; }
        updatePinnedState(data.id, false);
      } else if(eventType === "pin"){
        updatePinnedState(data.id, data.pinned, data.pinned_by);
      } else if(eventType === "pins"){
        renderPinnedList(data.pins || []);
      } else if(eventType === "pin_denied"){
        alert(data.reason || "You are not allowed to unpin this message.");
      } else if(eventType === "job_message"){
        appendGroupMessage(data.sender || "Unknown", data.message || "", data.timestamp);
      }
    };
  }

  function sendMessage(){
    if(!input || !socket || socket.readyState !== 1) return;
    const text = input.value.trim();
    if(!text) return;
    if(input.dataset.editId){
      socket.send(JSON.stringify({action:"edit", id: input.dataset.editId, message: text}));
      delete input.dataset.editId;
    } else if(input.dataset.replyId){
      socket.send(JSON.stringify({action:"reply", reply_to: input.dataset.replyId, message: text}));
      clearReplyPreview();
    } else {
      socket.send(JSON.stringify({action:"message", message: text}));
    }
    input.value = "";
  }

  async function loadApplication(appId){
    if(!appId) return;
    const url = new URL(window.location.href);
    url.searchParams.set("app_id", appId);
    const res = await fetch(url.toString(), {headers: {"x-requested-with": "XMLHttpRequest"}});
    if(!res.ok) return;
    const data = await res.json();
    const rows = (data.messages || []).map(msg => ({
      id: msg.id,
      sender: msg.sender,
      text: msg.text,
      created: msg.created,
      reply_to: msg.reply_to,
      pinned: msg.pinned,
      pinned_by: msg.pinned_by,
    }));
    setChatMessages(rows);
    connectSocket(appId);
    currentAppId = appId;
    document.querySelectorAll("#active-applicants .applicant").forEach(node => {
      node.classList.toggle("selected", String(node.dataset.appId) === String(appId));
    });
    history.replaceState({}, "", url.pathname + url.search);
  }

  function showMenu(msgElem){
    if(!menu) return;
    activeMessage = msgElem;
    const rect = msgElem.getBoundingClientRect();
    menu.style.left = `${window.scrollX + rect.left}px`;
    menu.style.top = `${window.scrollY + rect.bottom + 4}px`;
    const isMe = msgElem.classList.contains("me");
    const isPinned = msgElem.classList.contains("pinned");
    const pinnedBy = msgElem.dataset.pinnedBy || "";
    const pinItem = menu.querySelector('li[data-action="pin"]');
    const pinLabel = document.getElementById("pin-label");
    const pinIcon = document.getElementById("pin-action-icon");
    menu.querySelector('li[data-action="edit"]').style.display = isMe ? "" : "none";
    menu.querySelector('li[data-action="delete-everyone"]').style.display = isMe ? "" : "none";
    if(pinLabel){
      if(isPinned && pinnedBy && pinnedBy !== username){
        pinLabel.textContent = `Pinned by ${pinnedBy}`;
      } else {
        pinLabel.textContent = isPinned ? "Unpin" : "Pin";
      }
    }
    if(pinIcon){ pinIcon.src = isPinned ? "{% static 'icons/unpin.svg' %}" : "{% static 'icons/pin.svg' %}"; }
    if(pinItem){ pinItem.style.opacity = (isPinned && pinnedBy && pinnedBy !== username) ? "0.5" : "1"; }
    menu.classList.add("show");
  }
  function hideMenu(){ menu.classList.remove("show"); }

  function handleAction(action, msgElem){
    if(!msgElem || !socket || socket.readyState !== 1) return;
    const id = msgElem.dataset.id;
    const text = msgElem.dataset.text || "";
    if(action === "copy"){ navigator.clipboard.writeText(text); }
    else if(action === "reply"){ showReplyPreview({id, sender: msgElem.dataset.sender, text}); }
    else if(action === "edit" && msgElem.classList.contains("me")){ input.value = text; input.dataset.editId = id; input.focus(); }
    else if(action === "delete-me"){ msgElem.remove(); }
    else if(action === "delete-everyone" && msgElem.classList.contains("me")){ socket.send(JSON.stringify({action:"delete", id, mode:"everyone"})); }
    else if(action === "pin"){
      const isPinned = msgElem.classList.contains("pinned");
      const pinnedBy = msgElem.dataset.pinnedBy || "";
      if(isPinned && pinnedBy && pinnedBy !== username){
        alert(`Only ${pinnedBy} can unpin this message.`);
      } else {
        socket.send(JSON.stringify({action:"pin", id, pin: !isPinned}));
      }
    }
    hideMenu();
  }

  function buildApplicantsGroup(){
    if(!applicantsGroupMembers) return;
    applicantsGroupMembers.innerHTML = "";
    const applicants = Array.from(document.querySelectorAll("#active-applicants .applicant"));
    applicants.forEach(applicant => {
      const chip = document.createElement("span");
      chip.textContent = applicant.textContent.trim();
      applicantsGroupMembers.appendChild(chip);
    });
  }
  function appendGroupMessage(sender, message, timestamp){
    if(!applicantsGroupFeed) return;
    const row = document.createElement("div");
    const mine = sender === username;
    row.className = `applicants-group-item ${mine ? "me" : ""}`;
    row.innerHTML = `<span class="sender">${escapeHtml(sender)}</span><div>${escapeHtml(message)}</div><div class="meta">${new Date(timestamp || Date.now()).toLocaleTimeString()}</div>`;
    applicantsGroupFeed.appendChild(row);
    applicantsGroupFeed.scrollTop = applicantsGroupFeed.scrollHeight;
  }

  if(sendBtn){ sendBtn.addEventListener("click", sendMessage); }
  if(input){
    input.addEventListener("keydown", e => { if(e.key === "Enter"){ e.preventDefault(); sendMessage(); } });
    let typingTimeout = null;
    input.addEventListener("input", ()=>{
      if(!socket || socket.readyState !== 1) return;
      socket.send(JSON.stringify({action: "typing", typing: !!input.value.trim()}));
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(()=> socket.send(JSON.stringify({action:"typing", typing:false})), 900);
    });
  }
  if(replyCancel){ replyCancel.addEventListener("click", clearReplyPreview); }

  if(chatBox){
    chatBox.addEventListener("contextmenu", e => {
      const bubble = e.target.closest('.bubble');
      if(!bubble) return;
      e.preventDefault();
      showMenu(bubble);
      }
    });
  }

  if(menu){
    menu.querySelectorAll("li").forEach(item => item.addEventListener("click", ()=>handleAction(item.dataset.action, activeMessage)));
    document.addEventListener("click", e=>{ if(!menu.contains(e.target)) hideMenu(); });
  }

  document.querySelectorAll("#active-applicants .applicant").forEach(link => {
    link.addEventListener("click", async e => {
      e.preventDefault();
      await loadApplication(link.dataset.appId);
    });
});

  if(groupToggleBtn && applicantsGroupPanel){
    groupToggleBtn.addEventListener("click", ()=>{
      applicantsGroupPanel.hidden = false;
      buildApplicantsGroup();
    });
  }
  if(applicantsGroupClose && applicantsGroupPanel){
    applicantsGroupClose.addEventListener("click", ()=>{ applicantsGroupPanel.hidden = true; });
  }
  if(applicantsGroupPanel){
    applicantsGroupPanel.addEventListener("click", e => { if(e.target === applicantsGroupPanel){ applicantsGroupPanel.hidden = true; } });
  }
  if(applicantsGroupSend && applicantsGroupInput){
    applicantsGroupSend.addEventListener("click", ()=>{
      const message = applicantsGroupInput.value.trim();
      if(!message || !socket || socket.readyState !== 1) return;
      socket.send(JSON.stringify({action: "job_message", message}));
      applicantsGroupInput.value = "";
    });
    applicantsGroupInput.addEventListener("keydown", e=>{ if(e.key === "Enter"){ e.preventDefault(); applicantsGroupSend.click(); } });
  }

  if(currentAppId){ connectSocket(currentAppId); }
  scrollBottom(chatBox);
})();
</script>

{% endblock %}  
