{% extends "base.html" %}
{% block title %}Chat{% if job %} â€” {{ job.title }}{% elif application %} â€” {{ application.job.title }}{% endif %}{% endblock %}
{% block content %}

<style>
/* --- Layout & Sidebar --- */
.chat-wrap {
  display: flex;
  flex-wrap: nowrap; /* keep sidebar and chat side by side */
  max-width: 1200px;
  margin: 30px auto;
  gap: 20px;
  font-family: 'Poppins', sans-serif;
}

/* Sidebar */
.sidebar {
  flex: 0 0 280px; /* fixed width but wonâ€™t shrink below 280px */
  max-width: 280px;
  min-width: 220px;
  background: linear-gradient(135deg, rgba(10,10,25,0.95), rgba(20,20,40,0.95));
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 0 15px rgba(0,255,200,0.3);
}

/* Sidebar header */
.sidebar h3 {
  padding: 14px;
  border-bottom: 1px solid rgba(0,255,200,0.2);
  color: #00ffc6;
  text-shadow: 0 0 5px #00ffc6;
}

/* Applicant list container */
.applicant-list {
  max-height: calc(100vh - 100px); /* leaves room for header and margin */
  overflow-y: auto;
  padding: 0;
  margin: 0;
  list-style: none;
}

/* Individual applicant */
.applicant {
  padding: 12px 14px;
  cursor: pointer;
  border-bottom: 1px solid rgba(0,255,200,0.05);
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: #fff;
  transition: all 0.2s ease-in-out;
}

.applicant:hover {
  background: rgba(0,255,200,0.05);
  box-shadow: 0 0 8px #00ffc6;
}

.applicant.selected {
  background: rgba(0,255,200,0.15);
  font-weight: bold;
  box-shadow: 0 0 10px #00ffc6;
}

.badge {
  background: #00ffc6;
  color: #111;
  border-radius: 50%;
  padding: 2px 8px;
  font-size: 12px;
  font-weight: 700;
}

/* Scrollbar styling for applicant list */
.applicant-list::-webkit-scrollbar {
  width: 6px;
}
.applicant-list::-webkit-scrollbar-track {
  background: rgba(0,255,200,0.05);
  border-radius: 3px;
}
.applicant-list::-webkit-scrollbar-thumb {
  background: rgba(0,255,200,0.3);
  border-radius: 3px;
}

/* --- Chat Container --- */
.chat-container {
  flex: 1 1 0; /* flexible width */
  display: flex;
  flex-direction: column;
  background: linear-gradient(135deg, rgba(15,15,30,0.95), rgba(20,20,40,0.95));
  border-radius: 16px;
  box-shadow: 0 0 20px rgba(0,255,200,0.25);
  overflow: hidden;
  min-width: 300px;
}

.chat-header {
  padding: 14px 18px;
  border-bottom: 1px solid rgba(0,255,200,0.2);
  color: #00ffc6;
  text-shadow: 0 0 6px #00ffc6;
  font-weight: bold;
}

.chat-box {
  flex: 1;
  overflow-y: auto;
  padding: 14px;
  background: rgba(10,10,20,0.9);
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.bubble {
  max-width: 70%;
  margin: 4px 0;
  padding: 12px 16px;
  border-radius: 20px;
  word-wrap: break-word;
  position: relative;
  color: #fff;
  box-shadow: 0 0 8px rgba(0,255,200,0.2);
  transition: all 0.2s ease-in-out;
}

.bubble:hover { box-shadow: 0 0 12px #00ffc6; }
.me { margin-left: auto; background: linear-gradient(135deg, rgba(0,255,200,0.2), rgba(0,255,150,0.2)); border:1px solid #00ffc6; text-align: right; }
.them { margin-right: auto; background: rgba(255,255,255,0.05); border:1px solid rgba(0,255,200,0.15); }

.meta { font-size: 11px; opacity: .6; margin-top: 4px; color: #00ffc6; text-shadow: 0 0 4px #00ffc6; }

.chat-input { display: flex; gap: 10px; padding: 12px; border-top: 1px solid rgba(0,255,200,0.2); background: rgba(10,10,20,0.95); }
.chat-input input { flex: 1; padding: 12px; border-radius: 10px; border: none; outline: none; background: #111; color: #fff; box-shadow: 0 0 6px rgba(0,255,200,0.3); }
.chat-input button { padding: 12px 18px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; background: linear-gradient(135deg,#00ffc6,#00ff88); color: #111; box-shadow: 0 0 10px #00ffc6; transition: all 0.2s ease; }
.chat-input button:hover { transform: scale(1.05); box-shadow: 0 0 20px #00ffc6; }

/* --- Pop-in animation for messages --- */
@keyframes popIn { 0% { transform: scale(0.8); opacity:0; } 50% { transform: scale(1.05); opacity:1; } 100% { transform: scale(1); } }
.bubble.pop { animation: popIn 0.3s ease forwards; }

/* --- Typing indicator --- */
.typing { display: flex; align-items: center; gap: 4px; max-width: 60px; padding: 10px 14px; border-radius: 20px; background: rgba(255,255,255,0.08); border: 1px solid rgba(0,255,200,0.15); box-shadow: 0 0 8px rgba(0,255,200,0.2); }
.dot { width: 6px; height: 6px; background: #00ffc6; border-radius: 50%; animation: blink 1.2s infinite; }
.dot:nth-child(2) { animation-delay: 0.2s; }
.dot:nth-child(3) { animation-delay: 0.4s; }
@keyframes blink { 0%, 80%, 100% { opacity: 0.2; transform: scale(1); } 40% { opacity: 1; transform: scale(1.3); } }

/* --- Send button glow --- */
@keyframes sendGlow { 0% { box-shadow:0 0 10px #00ffc6; transform: scale(1); } 50% { box-shadow: 0 0 18px #00ffc6,0 0 25px rgba(0,255,200,0.5); transform: scale(1.1); } 100% { box-shadow: 0 0 10px #00ffc6; transform: scale(1); } }
.send-effect { animation: sendGlow 0.5s ease-out; }

/* --- Floating Chat Popup --- */
#chat-popup-button { position: fixed; bottom: 20px; right: 20px; z-index: 999; }
#chat-popup-button button { padding: 14px 16px; border-radius: 50%; background: #00ffc6; border: none; cursor: pointer; font-size: 22px; box-shadow: 0 0 12px #00ffc6, 0 0 25px rgba(0,255,200,0.3); transition: all .2s; }
#chat-popup-button button:hover { transform: scale(1.1); box-shadow: 0 0 18px #00ffc6, 0 0 35px rgba(0,255,200,0.5); }
#chat-popup { display: none; position: fixed; bottom: 90px; right: 20px; width: 100%; max-width: 400px; max-height: calc(100vh - 140px); background: linear-gradient(135deg, rgba(15,15,30,0.95), rgba(20,20,40,0.95)); border-radius: 16px; box-shadow: 0 0 22px rgba(0,255,200,0.3); overflow: hidden; z-index: 999; flex-direction: column; }
#chat-popup-header { padding: 12px; background: #00ffc6; color: #111; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
#chat-popup-body { flex: 1; overflow-y: auto; padding: 12px; background: rgba(10,10,20,0.9); display: flex; flex-direction: column; gap: 8px; }
#chat-popup-form { display: flex; padding: 8px; border-top: 1px solid rgba(0,255,200,0.2); background: rgba(10,10,20,0.95); gap: 8px; }
#chat-popup-form input { flex: 1; padding: 10px; border-radius: 8px; border: none; background: #111; color: #fff; box-shadow: 0 0 6px rgba(0,255,200,0.3); }
#chat-popup-form button { padding: 10px 14px; border: none; border-radius: 8px; font-weight: 700; background: linear-gradient(135deg,#00ffc6,#00ff88); color: #111; box-shadow: 0 0 10px #00ffc6; cursor: pointer; }

/* --- Context Menu with animation --- */
#message-menu {
  position: absolute;
  background: #111;
  color: #00ffc6;
  border-radius: 8px;
  border: 1px solid rgba(0,255,200,0.4);
  box-shadow: 0 2px 12px rgba(0,255,200,0.5);
  z-index: 2000;
  display: none;
  opacity: 0;
  transform: translateY(-5px) scale(0.95);
  transition: opacity 0.2s ease, transform 0.2s ease;
}
#message-menu.show {
  display: block;
  opacity: 1;
  transform: translateY(0) scale(1);
}
#message-menu ul { list-style: none; padding: 6px; margin: 0; }
#message-menu li { padding: 6px 12px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
#message-menu li:hover { background: rgba(0,255,200,0.15); }

/* --- Responsive layout --- */
@media (max-width: 768px) {
  .chat-wrap { flex-direction: column; }
  .sidebar { max-width: 100%; width: 100%; min-width: unset; margin-bottom: 15px; }
  .chat-container { min-width: unset; width: 100%; }
}
</style>

<div class="chat-wrap">
  <!-- Sidebar if recruiter -->
  {% if job %}
    <div class="sidebar">
      <h3>Applicants</h3>
      {% for app in applications %}
        <a href="?app_id={{ app.id }}" class="applicant {% if selected_app and app.id == selected_app.id %}selected{% endif %}">
          {{ app.applicant.username }}
          {% if app.unread_count %}
            <span class="badge">{{ app.unread_count }}</span>
          {% endif %}
        </a>
      {% empty %}
        <p style="padding:12px; opacity:.7;">No applicants yet</p>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Main chat -->
  <div class="chat-container">
    <div class="chat-header">
      {% if job %}
        <div><strong>{{ job.title }}</strong>{% if job.company %} â€” {{ job.company }}{% endif %}</div>
      {% else %}
        <div><strong>{{ application.job.title }}</strong>{% if application.job.company %} â€” {{ application.job.company }}{% endif %}</div>
      {% endif %}
    </div>

    <div id="chat-box" class="chat-box">
      {% for m in messages %}
        <div class="bubble {% if m.sender_id == request.user.id %}me{% else %}them{% endif %} pop" 
             data-id="{{ m.id }}" data-text="{{ m.message }}">
          <div><strong>{{ m.sender.username }}</strong></div>
          <div>{{ m.message }}</div>
          <div class="meta">{{ m.timestamp }}{% if m.edited_at %} (edited){% endif %}{% if m.is_read and m.sender_id == request.user.id %} âœ“{% endif %}</div>
        </div>
      {% empty %}
        <p style="opacity:.7;text-align:center;margin-top:16px;">No messages yet. Say hi ðŸ‘‹</p>
      {% endfor %}
    </div>

    <form id="chat-form" class="chat-input" onsubmit="return false;">
      {% csrf_token %}
      <input id="msg-input" type="text" placeholder="Type a messageâ€¦" autocomplete="off" maxlength="2000" />
      <button id="send-btn" type="button">Send</button>
    </form>
  </div>
</div>

<!-- Floating Chat Popup -->
<div id="chat-popup">
  <div id="chat-popup-header">
    Chat
    <span id="close-chat" style="cursor:pointer;">âœ–</span>
  </div>
  <div id="chat-popup-body">
    <p style="opacity:.7;text-align:center;margin-top:16px;">No messages yet. Say hi ðŸ‘‹</p>
  </div>
  <form id="chat-popup-form">
    {% csrf_token %}
    <input id="chat-popup-input" type="text" placeholder="Type a messageâ€¦" />
    <button type="button" id="chat-popup-send">Send</button>
  </form>
</div>
<button id="chat-popup-button"><span>ðŸ’¬</span></button>

<!-- Context Menu -->
<div id="message-menu">
  <ul>
    <li data-action="reply">Reply</li>
    <li data-action="copy">Copy</li>
    <li data-action="edit">Edit</li>
    <li data-action="delete-me">Delete for Me</li>
    <li data-action="delete-everyone">Delete for Everyone</li>
    <li data-action="forward">Forward</li>
    <li data-action="pin">Pin</li>
  </ul>
</div>

<script>
(function(){
  const username = "{{ request.user.username|escapejs }}";
  const chatBox = document.getElementById("chat-box");
  const input = document.getElementById("msg-input");
  const sendBtn = document.getElementById("send-btn");
  const menu = document.getElementById("message-menu");

  // Popup chat elements
  const chatButton = document.getElementById("chat-popup-button");
  const chatPopup  = document.getElementById("chat-popup");
  const chatClose  = document.getElementById("close-chat");
  const popupInput = document.getElementById("chat-popup-input");
  const popupSend  = document.getElementById("chat-popup-send");
  const popupBody  = document.getElementById("chat-popup-body");

  // WebSocket setup
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const appId = {% if application %}{{ application.id }}{% elif selected_app %}{{ selected_app.id }}{% else %}null{% endif %};
  if(!appId) return;
  const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${appId}/`);

  function scrollBottom(el){ if(el) el.scrollTop = el.scrollHeight; }
  scrollBottom(chatBox);

  // Typing indicator
  let typingIndicator = null;
  function showTyping(){
    if(!typingIndicator && chatBox){
      typingIndicator = document.createElement("div");
      typingIndicator.className = "bubble them typing";
      typingIndicator.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
      chatBox.appendChild(typingIndicator);
      scrollBottom(chatBox);
    }
  }
  function hideTyping(){ if(typingIndicator){ typingIndicator.remove(); typingIndicator=null; } }

  // Send message
  function sendMessage(msgInput=input, targetBody=chatBox){
    if(!msgInput) return;
    const text = msgInput.value.trim();
    if(!text) return;

    function reallySend(){
      if(socket.readyState !== 1) return;
      const payload = msgInput.dataset.editId
        ? {action:"edit", id: msgInput.dataset.editId, message: text}
        : {action:"message", message: text};
      socket.send(JSON.stringify(payload));
      if(msgInput.dataset.editId) delete msgInput.dataset.editId;
      msgInput.value = "";
      if(sendBtn){ sendBtn.classList.add("send-effect"); setTimeout(()=>sendBtn.classList.remove("send-effect"),500); }

      // Append bubble
      if(targetBody){
        const bubble = document.createElement("div");
        bubble.className = `bubble me pop`;
        bubble.dataset.text = text;
        bubble.innerHTML = `<div><strong>${username}</strong></div>
                            <div>${text}</div>
                            <div class="meta">just now</div>`;
        targetBody.appendChild(bubble);
        scrollBottom(targetBody);
      }
    }

    if(socket.readyState === 1){
      reallySend();
    } else {
      socket.addEventListener("open", reallySend, { once:true });
    }
  }

  // Event listeners
  if(sendBtn) sendBtn.addEventListener("click", ()=>sendMessage(input, chatBox));
  if(input) input.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendMessage(input, chatBox); } });
  if(popupSend && popupInput) popupSend.addEventListener("click", ()=>sendMessage(popupInput, popupBody));
  if(popupInput) popupInput.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); popupSend.click(); } });

  // Popup toggle
  if(chatPopup) chatPopup.style.display="none";
  if(chatButton && chatPopup) chatButton.addEventListener("click", ()=>{
    chatPopup.style.display = (chatPopup.style.display==="flex")?"none":"flex";
    if(chatPopup.style.display==="flex") chatPopup.style.flexDirection="column";
  });
  if(chatClose && chatPopup) chatClose.addEventListener("click", ()=>chatPopup.style.display="none");

  // Socket messages
  socket.onmessage = function(e){
    const data = JSON.parse(e.data);
    if(data.type==="typing"){ showTyping(); setTimeout(hideTyping,1500); }
    else if(["message","edit","delete"].includes(data.type)){
      [chatBox,popupBody].forEach(c=>{
        if(!c) return;
        if(data.type==="message"){
          const bubble=document.createElement("div");
          bubble.className=`bubble ${data.sender===username?"me":"them"} pop`;
          bubble.dataset.id=data.id;
          bubble.dataset.text=data.message;
          bubble.innerHTML=`<div><strong>${data.sender}</strong></div>
                            <div>${data.message}</div>
                            <div class="meta">${new Date(data.timestamp).toLocaleString()}</div>`;
          c.appendChild(bubble);
          scrollBottom(c);
        } else if(data.type==="edit"){
          const msg = c.querySelector(`.bubble[data-id="${data.id}"]`);
          if(msg){ msg.dataset.text=data.message; msg.querySelector("div:nth-child(2)").innerText=data.message;
            const meta=msg.querySelector(".meta"); if(!meta.innerText.includes("(edited)")) meta.innerText+=" (edited)";
          }
        } else if(data.type==="delete"){
          const msg = c.querySelector(`.bubble[data-id="${data.id}"]`);
          if(msg) data.mode==="everyone"?msg.remove():msg.style.display="none";
        }
      });
    }
  };

  // --- Context menu + long-press ---
  function showMenu(msgElem){
    if(!menu || !msgElem) return;

    const rect = msgElem.getBoundingClientRect();
    const container = msgElem.offsetParent || document.body;
    const containerRect = container.getBoundingClientRect();

    const menuHeight = menu.offsetHeight || 150;
    const menuWidth  = menu.offsetWidth  || 160;

    // Position relative to container
    let x = rect.left - containerRect.left + container.scrollLeft;
    let y = rect.bottom - containerRect.top + container.scrollTop;

    // Adjust vertical if overflow
    if(y + menuHeight > container.scrollHeight){
        y = rect.top - containerRect.top + container.scrollTop - menuHeight - 5;
    } else {
        y += 5; // small gap below bubble
    }

    // Adjust horizontal if overflow
    if(x + menuWidth > container.scrollWidth){
        x = rect.right - containerRect.left + container.scrollLeft - menuWidth;
    }

    menu.style.left = `${x}px`;
    menu.style.top  = `${y}px`;
    menu.style.display = "block";

    void menu.offsetWidth; // trigger animation
    menu.classList.add("show");

    menu.querySelectorAll("li").forEach(item => {
        item.onclick = () => handleAction(item.dataset.action, msgElem);
    });
}

  function hideMenu(){ if(menu) menu.classList.remove("show"); setTimeout(()=>{ if(menu && !menu.classList.contains("show")) menu.style.display="none"; },200); }

  function handleAction(action, msgElem){
    if(!socket || !msgElem) return;
    const msgId = msgElem.dataset.id;
    const text  = msgElem.dataset.text;

    if(action === "copy"){
        navigator.clipboard.writeText(text);
    }
    else if(action === "reply"){
        input.value = "Replying to: " + text + "\n";
        input.focus();
    }
    else if(action === "edit"){
        input.value = text;
        input.dataset.editId = msgId;
        input.focus();
    }
    else if(action === "delete-me"){
        socket.send(JSON.stringify({action:"delete", id: msgId, mode:"me"}));
        msgElem.style.display = "none";
    }
    else if(action === "delete-everyone"){
        socket.send(JSON.stringify({action:"delete", id: msgId, mode:"everyone"}));
    }
    else if(action === "forward"){
        // --- Forward implementation ---
        const targetAppId = prompt("Enter the target chat/app ID to forward this message:");
        if(targetAppId){
            socket.send(JSON.stringify({
                action: "forward",
                message: text,
                target_app: targetAppId
            }));
            alert("Message forwarded!");
        }
    }
    else if(action==="pin") {
    if(!msgElem) return;
    msgElem.classList.add("pinned"); // optional: add special styling
    // Move message to top
    [chatBox, popupBody].forEach(c=>{
        if(c && c.contains(msgElem)) {
            c.prepend(msgElem);
        }
    });
    alert("Pinned: " + text);
}

    hideMenu();
}

  // Right-click to open menu
  [chatBox, popupBody].forEach(c=>{
    if(!c) return;
    c.addEventListener("contextmenu", e=>{ e.preventDefault(); const t=e.target.closest(".bubble"); if(t) showMenu(t); });
  });

  // Long-press for touch
  function addLongPress(container){
    if(!container) return;
    container.style.touchAction="manipulation"; // disable default long-press

    let timer=null, target=null, startX=0, startY=0, pointerId=null;
    const LONG_MS=600, MOVE_TOL=10;
    const cancel = ()=>{ if(timer){ clearTimeout(timer); timer=null; } target=null; pointerId=null; };

    container.addEventListener("pointerdown", e=>{
      const t=e.target.closest(".bubble");
      if(!t) return;
      target=t; pointerId=e.pointerId; startX=e.clientX; startY=e.clientY;
      if(timer) clearTimeout(timer);
      timer=setTimeout(()=>{ if(target) showMenu(target); }, LONG_MS);
    }, {passive:true});

    container.addEventListener("pointermove", e=>{
      if(pointerId!==e.pointerId || !timer) return;
      if(Math.abs(e.clientX-startX)>MOVE_TOL || Math.abs(e.clientY-startY)>MOVE_TOL) cancel();
    }, {passive:true});

    container.addEventListener("pointerup", cancel, {passive:true});
    container.addEventListener("pointercancel", cancel, {passive:true});
    container.addEventListener("mouseleave", cancel, {passive:true});
    window.addEventListener("blur", cancel);
  }

  addLongPress(chatBox);
  addLongPress(popupBody);

  // Hide menu when clicking outside
  document.addEventListener("click", e=>{ if(!menu.contains(e.target)) hideMenu(); });

})();
</script>

{% endblock %} 
