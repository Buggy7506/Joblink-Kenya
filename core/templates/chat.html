{% extends "base.html" %}
{% block title %}Chat{% if job %} ‚Äî {{ job.title }}{% elif application %} ‚Äî {{ application.job.title }}{% endif %}{% endblock %}
{% block content %}

<style>
:root {
  --chat-bg: var(--bg-main);
  --chat-card: var(--bg-card);
  --chat-surface: var(--bg-surface);
  --chat-surface-soft: var(--bg-surface-soft);
  --chat-text: var(--text-main);
  --chat-muted: var(--text-muted);
  --chat-accent: #25d366;
  --chat-accent-dark: #128c7e;
  --chat-shadow: var(--alien-shadow);
  --bubble-me: rgba(37, 211, 102, 0.18);
  --bubble-them: rgba(148, 163, 184, 0.16);
  --bubble-border: rgba(148, 163, 184, 0.25);
}

body.light-mode .chat-wrap {
  --chat-bg: #efeae2;
  --chat-card: #ffffff;
  --chat-surface: #ffffff;
  --chat-surface-soft: #f7f8fa;
  --bubble-me: #dcf8c6;
  --bubble-them: #ffffff;
  --bubble-border: rgba(0, 0, 0, 0.08);
}
  
/* --- Layout & Sidebar --- */
.chat-wrap {
  display: flex;
  flex-wrap: nowrap;
  max-width: 1200px;
  margin: 30px auto;
  gap: 18px;
  font-family: 'Poppins', sans-serif;
  position: relative;
  color: var(--chat-text);
  align-items: stretch;
}

.sidebar {
  flex: 0 0 280px;
  background: var(--chat-card);
  border-radius: 18px;
  overflow: hidden;
  border: 1px solid var(--bubble-border);
  box-shadow: 0 8px 24px var(--chat-shadow);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
  max-height: calc(100vh - 80px);
}
.sidebar h3 {
  padding: 14px 16px;
  border-bottom: 1px solid var(--bubble-border);
  color: var(--chat-accent-dark);
  font-weight: 600;
}
.sidebar-content {
  overflow-y: auto;
  flex: 1 1 auto;
}
.sidebar-section {
  display: flex;
  flex-direction: column;
}
.applicant {
  padding: 12px 14px;
  cursor: pointer;
  border-bottom: 1px solid var(--bubble-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: var(--chat-text);
  transition: all 0.2s ease-in-out;
}
.applicant:hover {
  background: rgba(37, 211, 102, 0.12);
}
.applicant.selected {
  background: rgba(37, 211, 102, 0.2);
  font-weight: 600;
}

.badge {
  background: var(--chat-accent);
  color: #ffffff;
  border-radius: 999px;
  padding: 2px 8px;
  font-size: 12px;
  font-weight: 700;
}

/* Deleted applicants */
.sidebar .applicant.deleted {
  opacity: 0.4;
  cursor: not-allowed;
  border-bottom: 1px solid rgba(255, 0, 0, 0.05);
  background: none !important;
  box-shadow: none !important;
  transition: none;
}
.sidebar .applicant.deleted:hover {
  background: none !important;
  box-shadow: none !important;
}
.sidebar .applicant.deleted .badge {
  background: var(--text-danger);
  color: #ffffff;
}

/* --- Chat Container --- */
.chat-container {
  flex: 1 1 auto;
  min-width: 0;
  display: flex;
  flex-direction: column;
  background: var(--chat-card);
  border-radius: 18px;
  border: 1px solid var(--bubble-border);
  box-shadow: 0 12px 28px var(--chat-shadow);
  overflow: hidden;
  max-height: calc(100vh - 60px);
}

.chat-header {
  padding: 14px 18px;
  border-bottom: 1px solid var(--bubble-border);
  color: var(--chat-text);
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 12px;
  background: var(--chat-surface);
}
#sidebar-toggle {
  display: none;
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  color: var(--chat-accent-dark);
  padding: 0;
}
.chat-title {
  display: flex;
  align-items: center;
  gap: 8px;
  flex: 1 1 auto;
}
.chat-box {
  flex: 1;
  overflow-y: auto;
  padding: 18px 18px 80px 18px;
  background: var(--chat-bg);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.bubble {
  max-width: 72%;
  margin: 2px 0;
  padding: 10px 14px;
  border-radius: 14px;
  word-wrap: break-word;
  position: relative;
  color: var(--chat-text);
  background: var(--bubble-them);
  border: 1px solid var(--bubble-border);
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
  transition: all 0.2s ease-in-out;
}
.bubble strong {
  display: block;
  font-size: 0.78rem;
  color: var(--chat-muted);
  margin-bottom: 4px;
}
.bubble:hover {
  transform: translateY(-1px);
}
.me {
  margin-left: auto;
  background: var(--bubble-me);
  border-color: rgba(37, 211, 102, 0.35);
  text-align: right;
}
.them {
  margin-right: auto;
}
.me::after,
.them::after {
  content: "";
  position: absolute;
  bottom: 0;
  width: 0;
  height: 0;
  border: 8px solid transparent;
}
.me::after {
  right: -6px;
  border-left-color: var(--bubble-me);
  border-bottom-color: transparent;
}
.them::after {
  left: -6px;
  border-right-color: var(--bubble-them);
  border-bottom-color: transparent;
}
.meta {
  font-size: 11px;
  margin-top: 6px;
  color: var(--chat-muted);
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 6px;
}
.bubble.pinned {
  border-color: var(--chat-accent-dark);
  box-shadow: 0 0 0 2px rgba(18, 140, 126, 0.18);
}
.bubble.pinned::before {
  content: "üìå";
  position: absolute;
  top: -12px;
  right: 10px;
  font-size: 12px;
}

/* Chat Input */
.chat-input {
  display: flex;
  gap: 10px;
  padding: 12px 16px;
  border-top: 1px solid var(--bubble-border);
  background: var(--chat-surface);
  flex-wrap: wrap;
}

.chat-input input {
  flex: 1;
  min-width: 0;
  padding: 12px 16px;
  border-radius: 999px;
  border: 1px solid var(--bubble-border);
  outline: none;
  background: var(--chat-surface-soft);
  color: var(--chat-text);
}

.chat-input button {
  padding: 12px 20px;
  border: none;
  border-radius: 999px;
  font-weight: 700;
  cursor: pointer;
  background: linear-gradient(135deg, var(--chat-accent), var(--chat-accent-dark));
  color: #ffffff;
  box-shadow: 0 6px 18px rgba(18, 140, 126, 0.3);
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.chat-input button:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 24px rgba(18, 140, 126, 0.4);
}

/* Typing Indicator */
.typing {
  display: flex;
  align-items: center;
  gap: 4px;
  max-width: 70px;
  padding: 10px 14px;
  border-radius: 14px;
  background: var(--bubble-them);
  border: 1px solid var(--bubble-border);
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
}

.dot {
  width: 6px;
  height: 6px;
  background: var(--chat-accent-dark);
  border-radius: 50%;
  animation: blink 1.4s infinite ease-in-out;
}

.dot:nth-child(2) { animation-delay: 0.2s; }
.dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes blink {
  0%, 80%, 100% { opacity: 0.2; transform: scale(1); }
  40% { opacity: 1; transform: scale(1.4); }
}

/* Context menu */
#message-menu {
  position: absolute;
  background: var(--chat-surface);
  color: var(--chat-text);
  border-radius: 12px;
  border: 1px solid var(--bubble-border);
  box-shadow: 0 12px 28px rgba(0, 0, 0, 0.2);
  z-index: 2000;
  display: none;
  opacity: 0;
  transform: translateY(-5px) scale(0.95);
  transition: opacity 0.2s ease, transform 0.2s ease;
  min-width: 180px;
}
#message-menu.show { display: block; opacity: 1; transform: translateY(0) scale(1); }
#message-menu ul { list-style: none; padding: 8px; margin: 0; }
#message-menu li {
  padding: 8px 12px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
  border-radius: 8px;
}
#message-menu li:hover {
  background: rgba(37, 211, 102, 0.12);
}

/* Responsive Sidebar Drawer */
#sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(6px); z-index: 999; opacity: 0; transition: opacity 0.3s ease; }
@media (max-width: 900px) {
  .chat-wrap { flex-direction: column; }
  .sidebar {
    position: fixed;
    top: 0; left: 0;
    height: 100%;
    z-index: 1000;
    transform: translateX(-100%);
    border-radius: 0;
    width: 260px;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .sidebar.show { transform: translateX(0); }
  #sidebar-toggle { display: block; }
  #sidebar-overlay.show { display: block; opacity: 1; }
  .chat-container { border-radius: 16px; }
}

@media (max-width: 600px) {
  .chat-input { flex-direction: column; gap: 8px; }
  .chat-input button { width: 100%; }
}
</style>


<div class="chat-wrap">
  {% if job %}
    <div class="sidebar" id="sidebar">
      <!-- Active Applicants -->
      <h3>Applicants</h3>
        <div class="sidebar-content">
        <div class="sidebar-section" id="active-applicants">
          {% for app in applications %}
            <a href="?app_id={{ app.id }}" 
               class="applicant {% if selected_app and app.id == selected_app.id %}selected{% endif %}" 
                data-app-id="{{ app.id }}">
              {{ app.applicant.username }}
              {% if app.unread_count %}<span class="badge">{{ app.unread_count }}</span>{% endif %}
            </a>
          {% empty %}
            <p style="padding:12px; opacity:.7;">No applicants yet</p>
          {% endfor %}
        </div>
      
        <!-- Deleted Applicants -->
        {% if deleted_applications %}
          <h3 class="text-danger" style="margin-top:20px;">Deleted Applicants</h3>
          <div class="sidebar-section" id="deleted-applicants">
            {% for app in deleted_applications %}
              <a href="javascript:void(0);" 
                 class="applicant deleted" 
                 data-app-id="{{ app.id }}">
                {{ app.applicant.username }}
                {% if app.unread_count %}<span class="badge">{{ app.unread_count }}</span>{% endif %}
              </a>
            {% empty %}
              <p style="padding:12px; opacity:.7;">No deleted applicants</p>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>

    <div id="sidebar-overlay"></div>
  {% endif %}

  <!-- Main chat -->
  <div class="chat-container">
    <div class="chat-header">
      {% if job %}
        <button id="sidebar-toggle">‚ò∞</button>
        <div class="chat-title"><strong>{{ job.title }}</strong>{% if job.company %} ‚Äî {{ job.company }}{% endif %}</div>
      {% else %}
        <div class="chat-title"><strong>{{ application.job.title }}</strong>{% if application.job.company %} ‚Äî {{ application.job.company }}{% endif %}</div>
      {% endif %}
    </div>

    <div id="chat-box" class="chat-box">
      {% for m in messages %}
        <div class="bubble {% if m.sender_id == request.user.id %}me{% else %}them{% endif %} pop" 
             data-id="{{ m.id }}" data-text="{{ m.message }}">
          <div><strong>{{ m.sender.username }}</strong></div>
          <div>{{ m.message }}</div>
          <div class="meta">{{ m.timestamp }}{% if m.edited_at %} (edited){% endif %}{% if m.is_read and m.sender_id == request.user.id %} ‚úì{% endif %}</div>
        </div>
      {% empty %}
        <p style="opacity:.7;text-align:center;margin-top:16px;">No messages yet. Say hi üëã</p>
      {% endfor %}
    </div>

    <form id="chat-form" class="chat-input" onsubmit="return false;">
      {% csrf_token %}
      <input id="msg-input" type="text" placeholder="Message‚Ä¶" autocomplete="off" maxlength="2000" />
      <button id="send-btn" type="button">Send</button>
    </form>
  </div>
</div>

<!-- Context Menu -->
<div id="message-menu">
  <ul>
    <li data-action="reply">‚Ü©Ô∏è Reply</li>
    <li data-action="copy">üìã Copy</li>
    <li data-action="edit">‚úèÔ∏è Edit</li>
    <li data-action="delete-me">üóëÔ∏è Delete for Me</li>
    <li data-action="delete-everyone">üö´ Delete for Everyone</li>
    <li data-action="forward">üì§ Forward</li>
    <li data-action="pin">üìå Pin</li>
  </ul>
</div>

<script>
(function(){
  const sidebar = document.getElementById("sidebar");
  const toggleBtn = document.getElementById("sidebar-toggle");
  const overlay = document.getElementById("sidebar-overlay");

  if(sidebar && toggleBtn && overlay){
    // Toggle sidebar
    toggleBtn.addEventListener("click", ()=> {
      sidebar.classList.toggle("show");
      overlay.classList.toggle("show");
    });

    // Close sidebar on overlay click
    overlay.addEventListener("click", ()=> {
      sidebar.classList.remove("show");
      overlay.classList.remove("show");
    });

    // Auto close when resizing to desktop
    window.addEventListener("resize", ()=>{
      if(window.innerWidth > 900){
        sidebar.classList.remove("show");
        overlay.classList.remove("show");
      }
    });
  }

  // --- Your chat websocket, typing, context menu etc. can stay here ---
  const username = "{{ request.user.username|escapejs }}";
  const chatBox = document.getElementById("chat-box");
  const input = document.getElementById("msg-input");
  const sendBtn = document.getElementById("send-btn");
  const menu = document.getElementById("message-menu");

  // WebSocket setup
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const appId = {% if application %}{{ application.id }}{% elif selected_app %}{{ selected_app.id }}{% else %}null{% endif %};
  if(!appId) return;
  const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${appId}/`);

  function scrollBottom(el){ if(el) el.scrollTop = el.scrollHeight; }
  scrollBottom(chatBox);

  // Typing indicator
  let typingIndicator = null;
  function showTyping(){
    if(!typingIndicator && chatBox){
      typingIndicator = document.createElement("div");
      typingIndicator.className = "bubble them typing";
      typingIndicator.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
      chatBox.appendChild(typingIndicator);
      scrollBottom(chatBox);
    }
  }
  function hideTyping(){ if(typingIndicator){ typingIndicator.remove(); typingIndicator=null; } }

  // Send message
  function sendMessage(msgInput=input, targetBody=chatBox){
    if(!msgInput) return;
    const text = msgInput.value.trim();
    if(!text) return;

    function reallySend(){
      if(socket.readyState !== 1) return;
      const payload = msgInput.dataset.editId
        ? {action:"edit", id: msgInput.dataset.editId, message: text}
        : {action:"message", message: text};
      socket.send(JSON.stringify(payload));
      if(msgInput.dataset.editId) delete msgInput.dataset.editId;
      msgInput.value = "";
      if(sendBtn){ sendBtn.classList.add("send-effect"); setTimeout(()=>sendBtn.classList.remove("send-effect"),500); }

      // Append bubble
      if(targetBody){
        const bubble = document.createElement("div");
        bubble.className = `bubble me pop`;
        bubble.dataset.text = text;
        bubble.innerHTML = `<div><strong>${username}</strong></div>
                            <div>${text}</div>
                            <div class="meta">just now</div>`;
        targetBody.appendChild(bubble);
        scrollBottom(targetBody);
      }
    }

    if(socket.readyState === 1){
      reallySend();
    } else {
      socket.addEventListener("open", reallySend, { once:true });
    }
  }

  // Event listeners
  if(sendBtn) sendBtn.addEventListener("click", ()=>sendMessage(input, chatBox));
  if(input) input.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendMessage(input, chatBox); } });

  // Socket messages
  socket.onmessage = function(e){
    const data = JSON.parse(e.data);
    if(data.type==="typing"){ showTyping(); setTimeout(hideTyping,1500); }
    else if(["message","edit","delete"].includes(data.type)){
      if(!chatBox) return;
      if(data.type==="message"){
        const bubble=document.createElement("div");
        bubble.className=`bubble ${data.sender===username?"me":"them"} pop`;
        bubble.dataset.id=data.id;
        bubble.dataset.text=data.message;
        bubble.innerHTML=`<div><strong>${data.sender}</strong></div>
                          <div>${data.message}</div>
                          <div class="meta">${new Date(data.timestamp).toLocaleString()}</div>`;
        chatBox.appendChild(bubble);
        scrollBottom(chatBox);
      } else if(data.type==="edit"){
        const msg = chatBox.querySelector(`.bubble[data-id="${data.id}"]`);
        if(msg){ msg.dataset.text=data.message; msg.querySelector("div:nth-child(2)").innerText=data.message;
          const meta=msg.querySelector(".meta"); if(!meta.innerText.includes("(edited)")) meta.innerText+=" (edited)";
        }
      } else if(data.type==="delete"){
        const msg = chatBox.querySelector(`.bubble[data-id="${data.id}"]`);
        if(msg) data.mode==="everyone"?msg.remove():msg.style.display="none";
      }
    }
  };

  // --- Context menu + long-press ---
  function showMenu(msgElem){
    if(!menu || !msgElem) return;

    const rect = msgElem.getBoundingClientRect();
    const container = msgElem.offsetParent || document.body;
    const containerRect = container.getBoundingClientRect();

    const menuHeight = menu.offsetHeight || 150;
    const menuWidth  = menu.offsetWidth  || 160;

    // Position relative to container
    let x = rect.left - containerRect.left + container.scrollLeft;
    let y = rect.bottom - containerRect.top + container.scrollTop;

    // Adjust vertical if overflow
    if(y + menuHeight > container.scrollHeight){
        y = rect.top - containerRect.top + container.scrollTop - menuHeight - 5;
    } else {
        y += 5; // small gap below bubble
    }

    // Adjust horizontal if overflow
    if(x + menuWidth > container.scrollWidth){
        x = rect.right - containerRect.left + container.scrollLeft - menuWidth;
    }

    menu.style.left = `${x}px`;
    menu.style.top  = `${y}px`;
    menu.style.display = "block";

    void menu.offsetWidth; // trigger animation
    menu.classList.add("show");

    menu.querySelectorAll("li").forEach(item => {
        item.onclick = () => handleAction(item.dataset.action, msgElem);
    });
}

    // ---- ADD THIS FUNCTION BELOW ----
  // Function to move applicant to deleted section dynamically
  function moveToDeleted(appId) {
    const appLink = document.querySelector(`.sidebar .applicant[data-app-id="${appId}"]`);
    if(!appLink) return;

    // Remove selection & add deleted class
    appLink.classList.remove("selected");
    appLink.classList.add("deleted");

    // Move to deleted section
    const deletedContainer = document.getElementById("deleted-applicants");
    if(deletedContainer) deletedContainer.appendChild(appLink);

    // Disable click and add hover effect
    appLink.addEventListener('click', e => {
        e.preventDefault();
        alert("This application has been deleted and cannot be accessed.");
    });

    appLink.addEventListener('mouseenter', () => appLink.style.backgroundColor="rgba(255,0,0,0.05)");
    appLink.addEventListener('mouseleave', () => appLink.style.backgroundColor="transparent");
  }

  // Example: listen for WebSocket delete events for applications
  socket.addEventListener('message', function(e){
    const data = JSON.parse(e.data);
    if(data.type === "delete_applicant" && data.app_id){
        moveToDeleted(data.app_id);
    }
  });
  
  function hideMenu(){ if(menu) menu.classList.remove("show"); setTimeout(()=>{ if(menu && !menu.classList.contains("show")) menu.style.display="none"; },200); }

  function handleAction(action, msgElem){
    if(!socket || !msgElem) return;
    const msgId = msgElem.dataset.id;
    const text  = msgElem.dataset.text;

    if(action === "copy"){
        navigator.clipboard.writeText(text);
    }
    else if(action === "reply"){
        input.value = "Replying to: " + text + "\n";
        input.focus();
    }
    else if(action === "edit"){
        input.value = text;
        input.dataset.editId = msgId;
        input.focus();
    }
    else if(action === "delete-me"){
        socket.send(JSON.stringify({action:"delete", id: msgId, mode:"me"}));
        msgElem.style.display = "none";
    }
    else if(action === "delete-everyone"){
        socket.send(JSON.stringify({action:"delete", id: msgId, mode:"everyone"}));
    }
    else if(action === "forward"){
        // --- Forward implementation ---
        const targetAppId = prompt("Enter the target chat/app ID to forward this message:");
        if(targetAppId){
            socket.send(JSON.stringify({
                action: "forward",
                message: text,
                target_app: targetAppId
            }));
            alert("Message forwarded!");
        }
    }
    else if(action==="pin") {
    if(!msgElem) return;
    msgElem.classList.add("pinned"); // optional: add special styling
    // Move message to top
    [chatBox, popupBody].forEach(c=>{
        if(c && c.contains(msgElem)) {
            c.prepend(msgElem);
        }
    });
    alert("Pinned: " + text);
}

    hideMenu();
}

  // Right-click to open menu
  if(chatBox){
    chatBox.addEventListener("contextmenu", e=>{ e.preventDefault(); const t=e.target.closest(".bubble"); if(t) showMenu(t); });
  }

  // Long-press for touch
  function addLongPress(container){
    if(!container) return;
    container.style.touchAction="manipulation"; // disable default long-press

    let timer=null, target=null, startX=0, startY=0, pointerId=null;
    const LONG_MS=600, MOVE_TOL=10;
    const cancel = ()=>{ if(timer){ clearTimeout(timer); timer=null; } target=null; pointerId=null; };

    container.addEventListener("pointerdown", e=>{
      const t=e.target.closest(".bubble");
      if(!t) return;
      target=t; pointerId=e.pointerId; startX=e.clientX; startY=e.clientY;
      if(timer) clearTimeout(timer);
      timer=setTimeout(()=>{ if(target) showMenu(target); }, LONG_MS);
    }, {passive:true});

    container.addEventListener("pointermove", e=>{
      if(pointerId!==e.pointerId || !timer) return;
      if(Math.abs(e.clientX-startX)>MOVE_TOL || Math.abs(e.clientY-startY)>MOVE_TOL) cancel();
    }, {passive:true});

    container.addEventListener("pointerup", cancel, {passive:true});
    container.addEventListener("pointercancel", cancel, {passive:true});
    container.addEventListener("mouseleave", cancel, {passive:true});
    window.addEventListener("blur", cancel);
  }

  addLongPress(chatBox);

  // Hide menu when clicking outside
  document.addEventListener("click", e=>{ if(!menu.contains(e.target)) hideMenu(); });

  // Disable clicks and hover effects for deleted applicants
document.addEventListener("DOMContentLoaded", function(){
    const deletedApps = document.querySelectorAll('.sidebar .applicant.deleted');

    deletedApps.forEach(app => {
        app.addEventListener('click', e => {
            e.preventDefault();
            alert("This application has been deleted and cannot be accessed.");
        });

        app.addEventListener('mouseenter', () => app.style.backgroundColor="rgba(255,0,0,0.05)");
        app.addEventListener('mouseleave', () => app.style.backgroundColor="transparent");
    });
});

})();
</script>

{% endblock %}  
