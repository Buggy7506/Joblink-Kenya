{% extends "base.html" %}
{% block title %}Chat{% if job %} ‚Äî {{ job.title }}{% elif application %} ‚Äî {{ application.job.title }}{% endif %}{% endblock %}
{% block content %}

<style>
/* ===== WhatsApp Web - Inspired Styling =====
   Keep the original JS/WebSocket logic intact. This CSS focuses on layout, spacing, and colors.
   ===== */
:root{
  --bg:#e5ddd5;           /* chat wallpaper base */
  --sidebar-bg:#f8f9fa;
  --panel:#ffffff;
  --muted:#8696a0;
  --accent:#25d366;       /* WhatsApp green */
  --accent-dark:#128C7E;
  --text:#111;
  --glass: rgba(0,0,0,0.04);
  --radius:12px;
  --max-width:1200px;
}

/* page layout */
.chat-wrap{
  display:flex;
  gap:20px;
  max-width:var(--max-width);
  margin:18px auto;
  height:78vh;
  font-family: "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

/* ---------- SIDEBAR ---------- */
.sidebar{
  width:320px;
  background:var(--sidebar-bg);
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,0.06);
  display:flex;
  flex-direction:column;
  overflow:hidden;
  border:1px solid rgba(0,0,0,0.04);
}

.sidebar-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 14px;
  gap:12px;
  border-bottom:1px solid rgba(0,0,0,0.04);
  background:linear-gradient(180deg, #fbfcfc, #f6f7f7);
}
.sidebar-header .left{ display:flex; align-items:center; gap:10px; }
.sidebar-header .avatar{
  width:44px; height:44px; border-radius:50%; background:#ddd; display:flex; align-items:center; justify-content:center; font-weight:700; color:#666;
  flex-shrink:0;
}
.sidebar-header h3{ margin:0; font-size:15px; color:var(--text); }

/* search */
.sidebar-search{ padding:10px 14px; border-bottom:1px solid rgba(0,0,0,0.03); background:#fff; }
.sidebar-search input{
  width:100%; padding:10px 12px; border-radius:20px; border:1px solid rgba(0,0,0,0.06); outline:none;
  font-size:14px; color:var(--text); background:#fafafa;
}

/* list */
.applicants-list{ overflow:auto; }
.applicant{
  display:flex; align-items:center; gap:12px; padding:12px 14px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.03);
  background:transparent; transition:background .12s ease;
}
.applicant:hover{ background:rgba(0,0,0,0.02); }
.applicant .meta{ margin-left:auto; text-align:right; color:var(--muted); font-size:12px; }
.applicant .title{ font-weight:600; color:var(--text); font-size:14px; }
.applicant .subtitle{ margin-top:2px; font-size:13px; color:var(--muted); }

/* selected applicant */
.applicant.selected{ background:linear-gradient(90deg, rgba(37,211,102,0.07), rgba(18,140,126,0.03)); border-left:4px solid var(--accent); }

/* badge */
.badge{ background:var(--accent); color:#fff; padding:4px 8px; border-radius:999px; font-weight:700; font-size:12px; }

/* ---------- CHAT PANEL ---------- */
.chat-container{
  flex:1; display:flex; flex-direction:column; border-radius:14px; overflow:hidden; border:1px solid rgba(0,0,0,0.04);
  background:linear-gradient(180deg,#ffffff,#fafafa);
  box-shadow:0 6px 18px rgba(0,0,0,0.04);
}

/* header */
.chat-header{
  display:flex; align-items:center; gap:12px; padding:12px 16px; border-bottom:1px solid rgba(0,0,0,0.04);
  background:linear-gradient(180deg,#ffffff,#f7f7f7);
}
.chat-header .left{ display:flex; align-items:center; gap:12px; }
.chat-header .avatar{ width:44px; height:44px; border-radius:50%; background:#dfe6e9; display:flex; align-items:center; justify-content:center; font-weight:700; color:#666; }
.chat-header .title{ font-weight:700; color:var(--text); }
.chat-header .sub{ color:var(--muted); font-size:13px; }

/* chat wallpaper / messages area */
.chat-box{
  flex:1; overflow:auto; background-image:url('https://i.imgur.com/3ZQ3ZQj.png'); /* subtle pattern */
  background-repeat:repeat;
  padding:22px;
  display:flex; flex-direction:column; gap:10px;
}

/* message bubble base */
.bubble{
  max-width:66%;
  padding:10px 12px;
  border-radius:12px;
  word-wrap:break-word;
  position:relative;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);
  line-height:1.35;
  font-size:14px;
}

/* incoming (left) */
.them{
  margin-right:auto;
  background:var(--panel);
  color:var(--text);
  border-top-left-radius:6px;
}

/* outgoing (right) */
.me{
  margin-left:auto;
  background:linear-gradient(180deg,var(--accent),var(--accent-dark));
  color:#fff;
  border-top-right-radius:6px;
}

/* small metadata/timestamp & ticks */
.meta{
  font-size:11px; color:rgba(0,0,0,0.45); margin-top:6px; display:flex; gap:8px; align-items:center; justify-content:flex-end;
}
.meta .tick{ font-size:12px; color:rgba(255,255,255,0.9); margin-left:6px; }

/* for outgoing ticks override color */
.me .meta{ color:rgba(255,255,255,0.9); }

/* message sender (small on top) */
.bubble .sender{ font-weight:700; font-size:13px; margin-bottom:6px; color:rgba(0,0,0,0.7); }
.me .sender{ color:rgba(255,255,255,0.92); }

/* reply preview (when user clicks Reply) */
.reply-preview{
  display:none; /* toggled via JS when replying */
  border-left:4px solid rgba(0,0,0,0.06);
  padding:6px 10px; margin-bottom:8px; border-radius:8px; background:rgba(0,0,0,0.03);
  font-size:13px; color:var(--muted);
}

/* typing bubble */
.typing{ display:inline-flex; gap:6px; align-items:center; padding:8px 10px; border-radius:20px; background:rgba(0,0,0,0.05); }

/* pop animation */
@keyframes popIn { from{ transform:scale(.98); opacity:0 } to{ transform:none; opacity:1 } }
.bubble.pop{ animation:popIn .12s ease; }

/* input area */
.chat-input{
  padding:10px 14px; display:flex; gap:10px; align-items:center; border-top:1px solid rgba(0,0,0,0.04);
  background:linear-gradient(180deg,#fafafa,#ffffff);
}
.chat-input .left-tools{ display:flex; gap:8px; align-items:center; }
.chat-input input{
  flex:1; padding:12px 14px; border-radius:20px; border:1px solid rgba(0,0,0,0.06); outline:none; font-size:14px; background:#fff;
}
.chat-input button.send{
  background:var(--accent); border:none; color:#fff; padding:10px 14px; border-radius:20px; font-weight:700; cursor:pointer;
  box-shadow:0 6px 14px rgba(37,211,102,0.18);
}
.chat-input button.send:active{ transform:translateY(1px); }

/* context menu (WhatsApp-like) */
#message-menu{
  position:absolute;
  background: #fff;
  color: var(--text);
  border-radius:10px;
  border:1px solid rgba(0,0,0,0.06);
  box-shadow:0 6px 18px rgba(0,0,0,0.12);
  z-index:3000; display:none; min-width:180px; overflow:hidden;
}
#message-menu ul{ list-style:none; padding:6px 0; margin:0; }
#message-menu li{ padding:10px 14px; font-size:14px; cursor:pointer; color:var(--text); display:flex; align-items:center; gap:8px; }
#message-menu li:hover{ background:rgba(0,0,0,0.03); }

/* responsive: mobile-like narrow width -> sidebar becomes drawer */
@media (max-width:900px){
  .chat-wrap{ flex-direction:column; height:auto; margin:10px; }
  .sidebar{ position:fixed; left:0; top:0; bottom:0; width:260px; transform:translateX(-100%); transition:transform .25s ease; z-index:2500; }
  .sidebar.show{ transform:translateX(0); }
  #sidebar-overlay{ display:block; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:2400; opacity:0; pointer-events:none; transition:opacity .2s ease; }
  #sidebar-overlay.show{ opacity:1; pointer-events:auto; }
  .chat-container{ border-radius:10px; margin-left:0; }
  .chat-box{ padding:12px; }
}

/* small util */
.hidden{ display:none !important; }
</style>

<div class="chat-wrap">
  {% if job %}
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="left">
        <div class="avatar">{{ request.user.username|first|upper }}</div>
        <div>
          <h3>Applicants</h3>
          <div style="font-size:12px;color:var(--muted)">Manage conversations</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <button id="sidebar-toggle" aria-label="Toggle" style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted)">‚ò∞</button>
      </div>
    </div>

    <div class="sidebar-search">
      <input id="sidebar-search-input" placeholder="Search applicants" />
    </div>

    <div class="applicants-list" id="applicants-list">
      {% for app in applications %}
      <a href="?app_id={{ app.id }}" class="applicant {% if selected_app and app.id == selected_app.id %}selected{% endif %}">
        <div style="display:flex;flex-direction:column;">
          <div class="title">{{ app.applicant.username }}</div>
          <div class="subtitle">{{ app.job.title|default:"Applicant" }}</div>
        </div>
        <div class="meta">
          {% if app.unread_count %}
            <span class="badge">{{ app.unread_count }}</span>
          {% else %}
            <span style="font-size:12px;color:var(--muted)">now</span>
          {% endif %}
        </div>
      </a>
      {% empty %}
      <p style="padding:16px;color:var(--muted)">No applicants yet</p>
      {% endfor %}
    </div>
  </div>
  <div id="sidebar-overlay"></div>
  {% endif %}

  <!-- CHAT PANEL -->
  <div class="chat-container" role="main" aria-label="Chat panel">
    <div class="chat-header">
      <div class="left">
        <div class="avatar">{{ (selected_app.applicant.username|default:application.job.title)|first|upper }}</div>
        <div>
          {% if job %}
            <div class="title">{{ job.title }}</div>
            <div class="sub">{% if job.company %}{{ job.company }}{% else %}Hiring chat{% endif %}</div>
          {% else %}
            <div class="title">{{ application.job.title }}</div>
            <div class="sub">{% if application.job.company %}{{ application.job.company }}{% endif %}</div>
          {% endif %}
        </div>
      </div>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <!-- Optionally add icons/buttons here -->
        <button title="Search" style="background:none;border:none;cursor:pointer;color:var(--muted)">üîç</button>
        <button title="More" style="background:none;border:none;cursor:pointer;color:var(--muted)">‚ãØ</button>
      </div>
    </div>

    <!-- Reply preview slot (hidden by default, toggled by JS when using Reply) -->
    <div id="reply-preview" class="reply-preview hidden"></div>

    <div id="chat-box" class="chat-box" tabindex="0" aria-live="polite">
      {% for m in messages %}
        <div class="bubble {% if m.sender_id == request.user.id %}me{% else %}them{% endif %} pop"
             data-id="{{ m.id }}" data-text="{{ m.message }}">
          <div class="sender">{{ m.sender.username }}</div>
          <div class="text">{{ m.message|linebreaksbr }}</div>
          <div class="meta">
            <span>{{ m.timestamp }}</span>
            {% if m.sender_id == request.user.id %}
              {% if m.is_read %}
                <span class="tick">‚úì‚úì</span>
              {% else %}
                <span class="tick">‚úì</span>
              {% endif %}
            {% endif %}
          </div>
        </div>
      {% empty %}
        <div style="margin:auto; text-align:center; color:var(--muted); padding:18px;">
          <strong>No messages yet</strong><br/>
          Say hi üëã
        </div>
      {% endfor %}
    </div>

    <form id="chat-form" class="chat-input" onsubmit="return false;">
      {% csrf_token %}
      <div class="left-tools" aria-hidden="true">
        <!-- future: attachments, emoji -->
        <button type="button" title="Attach" style="background:none;border:none;cursor:pointer;font-size:18px;color:var(--muted)">üìé</button>
        <button type="button" title="Emoji" style="background:none;border:none;cursor:pointer;font-size:18px;color:var(--muted)">üòä</button>
      </div>

      <input id="msg-input" type="text" placeholder="Type a message‚Ä¶" autocomplete="off" maxlength="2000" />
      <button id="send-btn" class="send" type="button">Send</button>
    </form>
  </div>
</div>

<!-- CONTEXT MENU (WhatsApp-like) -->
<div id="message-menu" role="menu" aria-hidden="true">
  <ul>
    <li data-action="reply">Reply</li>
    <li data-action="copy">Copy</li>
    <li data-action="edit">Edit</li>
    <li data-action="delete-me">Delete for Me</li>
    <li data-action="delete-everyone">Delete for Everyone</li>
    <li data-action="forward">Forward</li>
    <li data-action="pin">Pin</li>
  </ul>
</div>

<script>
/* --------------- Behavior (keeps your existing logic, adjusted to new classes/IDs) --------------- */

(function(){
  const sidebar = document.getElementById("sidebar");
  const toggleBtn = document.getElementById("sidebar-toggle");
  const overlay = document.getElementById("sidebar-overlay");
  const chatBox = document.getElementById("chat-box");
  const input = document.getElementById("msg-input");
  const sendBtn = document.getElementById("send-btn");
  const menu = document.getElementById("message-menu");
  const replyPreview = document.getElementById("reply-preview");

  // sidebar toggle for mobile
  if(toggleBtn && sidebar && overlay){
    toggleBtn.addEventListener('click', ()=> {
      sidebar.classList.toggle('show');
      overlay.classList.toggle('show');
    });
    overlay.addEventListener('click', ()=> {
      sidebar.classList.remove('show');
      overlay.classList.remove('show');
    });
  }

  // scrolling helper
  function scrollBottom(el){ if(!el) return; el.scrollTop = el.scrollHeight + 200; }
  scrollBottom(chatBox);

  // WebSocket preserved from your original ‚Äî only minor var name changes allowed
  const username = "{{ request.user.username|escapejs }}";
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const appId = {% if application %}{{ application.id }}{% elif selected_app %}{{ selected_app.id }}{% else %}null{% endif %};
  if(!appId) return;
  const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${appId}/`);

  // typing indicator
  let typingIndicator = null;
  function showTyping(){
    if(typingIndicator || !chatBox) return;
    typingIndicator = document.createElement('div');
    typingIndicator.className = 'bubble them typing';
    typingIndicator.innerHTML = `<div class="dot"></div><div class="dot"></div><div class="dot"></div>`;
    chatBox.appendChild(typingIndicator);
    scrollBottom(chatBox);
  }
  function hideTyping(){ if(typingIndicator){ typingIndicator.remove(); typingIndicator=null; } }

  // send message (keeps prior behaviors)
  function sendMessage(msgInput=input, targetBody=chatBox){
    if(!msgInput) return;
    const text = msgInput.value.trim();
    if(!text) return;

    function reallySend(){
      if(socket.readyState !== 1) return;
      const payload = msgInput.dataset.editId
        ? {action:"edit", id: msgInput.dataset.editId, message: text}
        : {action:"message", message: text, reply_to: msgInput.dataset.replyTo || null};
      socket.send(JSON.stringify(payload));
      delete msgInput.dataset.editId;
      delete msgInput.dataset.replyTo;
      msgInput.value = '';
      if(sendBtn){ sendBtn.classList.add('send-effect'); setTimeout(()=>sendBtn.classList.remove('send-effect'),300); }

      // append to DOM (optimistic)
      if(targetBody){
        const bubble = document.createElement('div');
        bubble.className = 'bubble me pop';
        bubble.dataset.text = text;
        bubble.innerHTML = `<div class="sender">${username}</div>
                            <div class="text">${text}</div>
                            <div class="meta"><span>just now</span><span class="tick">‚úì</span></div>`;
        targetBody.appendChild(bubble);
        scrollBottom(targetBody);
      }
      // hide reply preview if present
      if(replyPreview) { replyPreview.classList.add('hidden'); replyPreview.innerHTML=''; }
    }

    if(socket.readyState === 1) reallySend();
    else socket.addEventListener('open', reallySend, { once:true });
  }

  if(sendBtn) sendBtn.addEventListener('click', ()=> sendMessage(input, chatBox));
  if(input) input.addEventListener('keydown', e => { if(e.key === 'Enter'){ e.preventDefault(); sendMessage(input, chatBox); } });

  // socket incoming messages handling
  socket.onmessage = function(e){
    const data = JSON.parse(e.data);
    if(data.type === 'typing'){ showTyping(); setTimeout(hideTyping,1500); }
    else if(['message','edit','delete'].includes(data.type)){
      [chatBox].forEach(c=>{
        if(!c) return;
        if(data.type === 'message'){
          const bubble = document.createElement('div');
          bubble.className = `bubble ${data.sender === username ? 'me' : 'them'} pop`;
          bubble.dataset.id = data.id;
          bubble.dataset.text = data.message;
          bubble.innerHTML = `<div class="sender">${data.sender}</div>
                              <div class="text">${data.message}</div>
                              <div class="meta"><span>${new Date(data.timestamp).toLocaleString()}</span>${data.sender === username ? (data.is_read ? '<span class="tick">‚úì‚úì</span>' : '<span class="tick">‚úì</span>') : ''}</div>`;
          c.appendChild(bubble);
          scrollBottom(c);
        } else if(data.type === 'edit'){
          const msg = c.querySelector(`.bubble[data-id="${data.id}"]`);
          if(msg){
            msg.dataset.text = data.message;
            const txt = msg.querySelector('.text'); if(txt) txt.innerHTML = data.message;
            const meta = msg.querySelector('.meta'); if(meta && !meta.innerText.includes('(edited)')) meta.innerText += ' (edited)';
          }
        } else if(data.type === 'delete'){
          const msg = c.querySelector(`.bubble[data-id="${data.id}"]`);
          if(msg) data.mode === 'everyone' ? msg.remove() : msg.style.display = 'none';
        }
      });
    }
  };

  /* ---------- Context menu + long-press (keeps your actions) ---------- */
  function showMenu(msgElem){
    if(!menu || !msgElem) return;
    const rect = msgElem.getBoundingClientRect();
    const bodyRect = document.body.getBoundingClientRect();
    let x = rect.left - bodyRect.left + window.scrollX;
    let y = rect.top - bodyRect.top + window.scrollY - (menu.offsetHeight || 150) - 6;

    // prefer above the message; if no room, show below
    if(y < 6) y = rect.bottom - bodyRect.top + window.scrollY + 6;

    menu.style.left = `${x}px`;
    menu.style.top = `${y}px`;
    menu.style.display = 'block';
    menu.classList.add('show');

    // wire actions
    menu.querySelectorAll('li').forEach(item => {
      item.onclick = () => {
        handleAction(item.dataset.action, msgElem);
      };
    });
  }

  function hideMenu(){ if(menu){ menu.classList.remove('show'); setTimeout(()=>{ if(menu) menu.style.display='none'; },140); } }

  function handleAction(action, msgElem){
    if(!msgElem) return;
    const msgId = msgElem.dataset.id;
    const text = msgElem.dataset.text || msgElem.innerText || '';

    if(action === 'copy'){ navigator.clipboard.writeText(text); }
    else if(action === 'reply'){
      // show reply preview
      if(replyPreview){
        replyPreview.innerHTML = `<strong>Replying to</strong><div style="font-weight:600;margin-top:4px;">${msgElem.querySelector('.sender')?.innerText || ''}</div><div style="font-size:13px;margin-top:6px;color:var(--muted)">${text.length>180?text.slice(0,180)+'‚Ä¶':text}</div>`;
        replyPreview.classList.remove('hidden');
        input.dataset.replyTo = msgId;
        input.focus();
      }
    }
    else if(action === 'edit'){
      input.value = text;
      input.dataset.editId = msgId;
      input.focus();
    }
    else if(action === 'delete-me'){
      socket.send(JSON.stringify({ action:'delete', id: msgId, mode:'me' }));
      msgElem.style.display = 'none';
    }
    else if(action === 'delete-everyone'){
      socket.send(JSON.stringify({ action:'delete', id: msgId, mode:'everyone' }));
    }
    else if(action === 'forward'){
      const target = prompt('Forward to chat id:');
      if(target) socket.send(JSON.stringify({ action:'forward', message:text, target_app: target }));
    }
    else if(action === 'pin'){
      msgElem.classList.add('pinned');
      alert('Pinned message');
    }

    hideMenu();
  }

  // right-click opens menu
  chatBox.addEventListener('contextmenu', e=>{
    e.preventDefault();
    const t = e.target.closest('.bubble');
    if(t) showMenu(t);
  });

  // long-press for touch
  function addLongPress(container){
    if(!container) return;
    container.style.touchAction = 'manipulation';
    let timer=null, target=null, startX=0, startY=0, pointerId=null;
    const LONG_MS = 600, MOVE_TOL = 10;
    const cancel = ()=>{ if(timer) clearTimeout(timer); timer=null; target=null; pointerId=null; };

    container.addEventListener('pointerdown', e=>{
      const t = e.target.closest('.bubble');
      if(!t) return;
      target = t; pointerId = e.pointerId; startX = e.clientX; startY = e.clientY;
      if(timer) clearTimeout(timer);
      timer = setTimeout(()=>{ if(target) showMenu(target); }, LONG_MS);
    }, {passive:true});

    container.addEventListener('pointermove', e=>{
      if(pointerId !== e.pointerId || !timer) return;
      if(Math.abs(e.clientX - startX) > MOVE_TOL || Math.abs(e.clientY - startY) > MOVE_TOL) cancel();
    }, {passive:true});

    container.addEventListener('pointerup', cancel, {passive:true});
    container.addEventListener('pointercancel', cancel, {passive:true});
    container.addEventListener('mouseleave', cancel, {passive:true});
    window.addEventListener('blur', cancel);
  }

  addLongPress(chatBox);

  // hide menu when clicking outside
  document.addEventListener('click', e=>{
    if(menu && !menu.contains(e.target)) hideMenu();
  });

})();
</script>

{% endblock %}
