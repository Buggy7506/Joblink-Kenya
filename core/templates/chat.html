{% extends "base.html" %}
{% block title %}Chat{% if job %} â€” {{ job.title }}{% elif application %} â€” {{ application.job.title }}{% endif %}{% endblock %}
{% block content %}

<style>
/* Layout */
.chat-wrap { display:flex; max-width:1200px; margin:30px auto; gap:20px; }
.sidebar { width:260px; background:rgba(15,15,30,0.95); border-radius:16px; overflow:hidden; }
.sidebar h3 { padding:14px; border-bottom:1px solid rgba(0,255,200,0.2); }
.applicant { padding:12px 14px; cursor:pointer; border-bottom:1px solid rgba(0,255,200,0.1); display:flex; justify-content:space-between; align-items:center; }
.applicant.selected { background:rgba(0,255,200,0.15); font-weight:bold; }
.badge { background:#00ffc6; color:#111; border-radius:50%; padding:2px 8px; font-size:12px; }
.chat-container { flex:1; display:flex; flex-direction:column; background:rgba(15,15,30,0.95); border-radius:16px; }
.chat-header { padding:14px 18px; border-bottom:1px solid rgba(0,255,200,0.2); }
.chat-box { flex:1; overflow-y:auto; padding:14px; }
.bubble { max-width:70%; margin:8px 0; padding:10px 12px; border-radius:12px; word-wrap:break-word; animation:fadeIn 0.2s ease-in; position:relative; }
.me { margin-left:auto; background:rgba(0,255,200,0.18); border:1px solid rgba(0,255,200,0.4); }
.them { margin-right:auto; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); }
.meta { font-size:11px; opacity:.7; margin-top:4px; }
.chat-input { display:flex; gap:10px; padding:12px; border-top:1px solid rgba(0,255,200,0.2); background:rgba(9,12,20,0.9); }
.chat-input input { flex:1; padding:12px; border-radius:10px; border:none; outline:none; background:#111; color:#fff; }
.chat-input button { padding:12px 18px; border:none; border-radius:10px; font-weight:700; cursor:pointer; background:linear-gradient(135deg,#00ffc6,#00ff88); color:#111; }
@keyframes fadeIn { from {opacity:0; transform:translateY(4px);} to {opacity:1; transform:none;} }

/* Floating Chat Popup */
#chat-popup-button { position:fixed; bottom:20px; right:20px; z-index:999; }
#chat-popup-button button { padding:12px 16px; border-radius:50%; background:#00ffc6; border:none; cursor:pointer; font-size:18px; }
#chat-popup { display:none; position:fixed; bottom:70px; right:20px; width:400px; max-height:500px; background:rgba(15,15,30,0.95); border-radius:16px; box-shadow:0 0 22px rgba(0,255,200,0.25); overflow:hidden; z-index:999; }
#chat-popup-header { padding:12px; background:#111; color:#fff; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
#chat-popup-body { padding:12px; overflow-y:auto; height:350px; }
#chat-popup-form { display:flex; padding:12px; border-top:1px solid rgba(0,255,200,0.2); }
#chat-popup-form input { flex:1; padding:8px; border-radius:10px; border:none; outline:none; background:#111; color:#fff; }
#chat-popup-form button { padding:8px 12px; border:none; border-radius:10px; background:#00ffc6; color:#111; cursor:pointer; }

/* Context Menu */
#message-menu {
  position:absolute;
  background:#111;
  color:#fff;
  border-radius:8px;
  border:1px solid rgba(0,255,200,0.2);
  box-shadow:0 2px 8px rgba(0,0,0,0.4);
  z-index:2000;
  display:none;
}
#message-menu ul { list-style:none; padding:6px; margin:0; }
#message-menu li {
  padding:6px 12px;
  cursor:pointer;
  font-size:14px;
}
#message-menu li:hover { background:rgba(0,255,200,0.2); }
</style>

<div class="chat-wrap">
  {% if job %}
    <!-- Employer Sidebar -->
    <div class="sidebar">
      <h3>Applicants</h3>
      {% for app in applications %}
        <a href="?app_id={{ app.id }}" class="applicant {% if selected_app and app.id == selected_app.id %}selected{% endif %}">
          {{ app.applicant.username }}
          {% if app.unread_count %}
            <span class="badge">{{ app.unread_count }}</span>
          {% endif %}
        </a>
      {% empty %}
        <p style="padding:12px; opacity:.7;">No applicants yet</p>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Chat Container -->
  <div class="chat-container">
    <div class="chat-header">
      {% if job %}
        <div><strong>{{ job.title }}</strong>{% if job.company %} â€” {{ job.company }}{% endif %}</div>
      {% else %}
        <div><strong>{{ application.job.title }}</strong>{% if application.job.company %} â€” {{ application.job.company }}{% endif %}</div>
      {% endif %}
    </div>

    <div id="chat-box" class="chat-box">
      {% for m in messages %}
        <div class="bubble {% if m.sender_id == request.user.id %}me{% else %}them{% endif %}" data-id="{{ m.id }}" data-text="{{ m.message }}">
          <div><strong>{{ m.sender.username }}</strong></div>
          <div>{{ m.message }}</div>
          <div class="meta">{{ m.timestamp }}{% if m.edited_at %} (edited){% endif %}{% if m.is_read and m.sender_id == request.user.id %} âœ“{% endif %}</div>
        </div>
      {% empty %}
        <p style="opacity:.7;text-align:center;margin-top:16px;">No messages yet. Say hi ðŸ‘‹</p>
      {% endfor %}
    </div>

    <form id="chat-form" class="chat-input" onsubmit="return false;">
      {% csrf_token %}
      <input id="msg-input" type="text" placeholder="Type a messageâ€¦" autocomplete="off" maxlength="2000" />
      <button id="send-btn" type="button">Send</button>
    </form>
  </div>
</div>

<!-- Floating Chat Popup -->
<div id="chat-popup">
  <div id="chat-popup-header">
    Chat
    <span id="close-chat" style="cursor:pointer;">âœ–</span>
  </div>
  <div id="chat-popup-body">
    <p style="opacity:.7;text-align:center;margin-top:16px;">No messages yet. Say hi ðŸ‘‹</p>
  </div>
  <form id="chat-popup-form">
    {% csrf_token %}
    <input id="chat-popup-input" type="text" placeholder="Type a messageâ€¦" />
    <button type="button" id="chat-popup-send">Send</button>
  </form>
</div>
<button id="chat-popup-button"><span>ðŸ’¬</span></button>

<!-- Context Menu -->
<div id="message-menu">
  <ul>
    <li data-action="reply">Reply</li>
    <li data-action="copy">Copy</li>
    <li data-action="edit">Edit</li>
    <li data-action="delete-me">Delete for Me</li>
    <li data-action="delete-everyone">Delete for Everyone</li>
    <li data-action="forward">Forward</li>
    <li data-action="pin">Pin</li>
  </ul>
</div>

<script>
(function(){
  const username = "{{ request.user.username|escapejs }}";
  const chatBox = document.getElementById("chat-box");
  const input = document.getElementById("msg-input");
  const sendBtn = document.getElementById("send-btn");
  const menu = document.getElementById("message-menu");

  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const appId = {% if application %}{{ application.id }}{% elif selected_app %}{{ selected_app.id }}{% else %}null{% endif %};
  if(!appId) return;

  const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${appId}/`);

  function scrollBottom(el){ el.scrollTop = el.scrollHeight; }
  scrollBottom(chatBox);

  function sendMessage(msgInput=input){
    const text = msgInput.value.trim();
    if(!text || socket.readyState!==1) return;

    if(msgInput.dataset.editId){
      socket.send(JSON.stringify({
        type:"edit",
        id: msgInput.dataset.editId,
        message:text
      }));
      delete msgInput.dataset.editId;
    } else {
      socket.send(JSON.stringify({
        type:"message",
        message:text
      }));
    }
    msgInput.value = "";
  }

  sendBtn.addEventListener("click", ()=>sendMessage());
  input.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendMessage(); } });

  // Popup logic
  const chatButton = document.getElementById("chat-popup-button");
  const chatPopup = document.getElementById("chat-popup");
  const chatClose = document.getElementById("close-chat");
  const popupInput = document.getElementById("chat-popup-input");
  const popupSend = document.getElementById("chat-popup-send");
  const popupBody = document.getElementById("chat-popup-body");

  chatButton.addEventListener("click", ()=>chatPopup.style.display="block");
  chatClose.addEventListener("click", ()=>chatPopup.style.display="none");
  popupSend.addEventListener("click", ()=>sendMessage(popupInput));
  popupInput.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); popupSend.click(); } });

  socket.onmessage = function(e){
    const data = JSON.parse(e.data);

    if(data.type==="message"){
      const bubble = document.createElement("div");
      bubble.className = `bubble ${data.sender===username?"me":"them"}`;
      bubble.dataset.id = data.id;
      bubble.dataset.text = data.message;
      bubble.innerHTML = `<div><strong>${data.sender}</strong></div>
                          <div>${data.message}</div>
                          <div class="meta">${new Date(data.timestamp).toLocaleString()}</div>`;
      chatBox.appendChild(bubble);
      popupBody.appendChild(bubble.cloneNode(true));
      scrollBottom(chatBox);
      scrollBottom(popupBody);
    }
    else if(data.type==="edit"){
      [chatBox, popupBody].forEach(container=>{
        const msgElem = container.querySelector(`.bubble[data-id="${data.id}"]`);
        if(msgElem){
          msgElem.dataset.text = data.message;
          msgElem.querySelector("div:nth-child(2)").innerText = data.message;
          const meta = msgElem.querySelector(".meta");
          if(!meta.innerText.includes("(edited)")){
            meta.innerText += " (edited)";
          }
        }
      });
    }
    else if(data.type==="delete"){
      if(data.mode==="everyone"){
        [chatBox, popupBody].forEach(container=>{
          const msgElem = container.querySelector(`.bubble[data-id="${data.id}"]`);
          if(msgElem) msgElem.remove();
        });
      } else if(data.mode==="me"){
        const msgElem = chatBox.querySelector(`.bubble[data-id="${data.id}"]`);
        if(msgElem) msgElem.style.display="none";
      }
    }
  };

  // Long press detection
  let pressTimer;
  chatBox.addEventListener("mousedown", e=>{
    const target = e.target.closest(".bubble");
    if(!target) return;
    pressTimer = setTimeout(()=>showMenu(e, target), 500);
  });
  chatBox.addEventListener("mouseup", ()=>clearTimeout(pressTimer));
  chatBox.addEventListener("mouseleave", ()=>clearTimeout(pressTimer));

  function showMenu(e, msgElem){
    e.preventDefault();
    menu.style.left = e.pageX+"px";
    menu.style.top = e.pageY+"px";
    menu.style.display="block";

    menu.querySelectorAll("li").forEach(item=>{
      item.onclick = ()=>handleAction(item.dataset.action, msgElem);
    });
  }

  function handleAction(action, msgElem){
    const msgId = msgElem.dataset.id;
    const text = msgElem.dataset.text;

    if(action==="copy"){
      navigator.clipboard.writeText(text);
    } else if(action==="reply"){
      input.value = "Replying to: " + text + "\n";
    } else if(action==="edit"){
      input.value = text;
      input.dataset.editId = msgId;
      input.focus();
    } else if(action==="delete-me"){
      socket.send(JSON.stringify({ type:"delete", id: msgId, mode:"me" }));
      msgElem.style.display="none";
    } else if(action==="delete-everyone"){
      socket.send(JSON.stringify({ type:"delete", id: msgId, mode:"everyone" }));
    } else if(action==="forward"){
      alert("Forward not yet implemented");
    } else if(action==="pin"){
      alert("Pinned: " + text);
    }
    menu.style.display="none";
  }

  document.addEventListener("click", ()=>menu.style.display="none");
})();
</script>

{% endblock %}
