{% extends "base.html" %}
{% block title %}Chat{% if job %} â€” {{ job.title }}{% elif application %} â€” {{ application.job.title }}{% endif %}{% endblock %}
{% block content %}

<style>
/* --- Layout --- */
.chat-wrap { display:flex; max-width:1200px; margin:30px auto; gap:20px; font-family:'Poppins',sans-serif; position:relative; }
.sidebar { flex:0 0 260px; background:linear-gradient(135deg,rgba(10,10,25,.95),rgba(20,20,40,.95)); border-radius:16px; overflow:hidden; box-shadow:0 0 15px rgba(0,255,200,.3); transition:transform .3s ease; }
.sidebar h3 { padding:14px; border-bottom:1px solid rgba(0,255,200,.2); color:#00ffc6; text-shadow:0 0 5px #00ffc6; }
.applicant { padding:12px 14px; cursor:pointer; border-bottom:1px solid rgba(0,255,200,.05); display:flex; justify-content:space-between; align-items:center; color:#fff; transition:.2s; }
.applicant:hover { background:rgba(0,255,200,.05); box-shadow:0 0 8px #00ffc6; }
.applicant.selected { background:rgba(0,255,200,.15); font-weight:bold; box-shadow:0 0 10px #00ffc6; }
.badge { background:#00ffc6; color:#111; border-radius:50%; padding:2px 8px; font-size:12px; font-weight:700; }

/* --- Chat Container --- */
.chat-container { flex:1; display:flex; flex-direction:column; background:linear-gradient(135deg,rgba(15,15,30,.95),rgba(20,20,40,.95)); border-radius:16px; box-shadow:0 0 20px rgba(0,255,200,.25); overflow:hidden; }
.chat-header { padding:14px 18px; border-bottom:1px solid rgba(0,255,200,.2); color:#00ffc6; text-shadow:0 0 6px #00ffc6; font-weight:bold; display:flex; align-items:center; justify-content:space-between; }
#sidebar-toggle { display:none; background:none; border:none; font-size:22px; cursor:pointer; color:#00ffc6; }

.chat-box { flex:1; overflow-y:auto; padding:14px; background:rgba(10,10,20,.9); display:flex; flex-direction:column; gap:8px; }
.bubble { max-width:70%; margin:4px 0; padding:12px 16px; border-radius:20px; word-wrap:break-word; position:relative; color:#fff; box-shadow:0 0 8px rgba(0,255,200,.2); transition:.2s; }
.bubble:hover { box-shadow:0 0 12px #00ffc6; }
.me { margin-left:auto; background:linear-gradient(135deg,rgba(0,255,200,.2),rgba(0,255,150,.2)); border:1px solid #00ffc6; text-align:right; }
.them { margin-right:auto; background:rgba(255,255,255,.05); border:1px solid rgba(0,255,200,.15); }
.meta { font-size:11px; opacity:.6; margin-top:4px; color:#00ffc6; text-shadow:0 0 4px #00ffc6; }

.chat-input { display:flex; gap:10px; padding:12px; border-top:1px solid rgba(0,255,200,.2); background:rgba(10,10,20,.95); }
.chat-input input { flex:1; padding:12px; border-radius:10px; border:none; outline:none; background:#111; color:#fff; box-shadow:0 0 6px rgba(0,255,200,.3); }
.chat-input button { padding:12px 18px; border:none; border-radius:10px; font-weight:700; cursor:pointer; background:linear-gradient(135deg,#00ffc6,#00ff88); color:#111; box-shadow:0 0 10px #00ffc6; transition:.2s; }
.chat-input button:hover { transform:scale(1.05); box-shadow:0 0 20px #00ffc6; }

/* --- Animations --- */
@keyframes popIn { 0%{transform:scale(.8);opacity:0;}50%{transform:scale(1.05);opacity:1;}100%{transform:scale(1);} }
.bubble.pop { animation:popIn .3s ease forwards; }

.typing { display:flex; align-items:center; gap:4px; max-width:60px; padding:10px 14px; border-radius:20px; background:rgba(255,255,255,.08); border:1px solid rgba(0,255,200,.15); box-shadow:0 0 8px rgba(0,255,200,.2); }
.dot { width:6px; height:6px; background:#00ffc6; border-radius:50%; animation:blink 1.2s infinite; }
.dot:nth-child(2){animation-delay:.2s;} .dot:nth-child(3){animation-delay:.4s;}
@keyframes blink {0%,80%,100%{opacity:.2;transform:scale(1);}40%{opacity:1;transform:scale(1.3);} }

@keyframes sendGlow {0%{box-shadow:0 0 10px #00ffc6;}50%{box-shadow:0 0 18px #00ffc6,0 0 25px rgba(0,255,200,.5);transform:scale(1.1);}100%{box-shadow:0 0 10px #00ffc6;}}
.send-effect { animation:sendGlow .5s ease-out; }

/* --- Floating Popup --- */
#chat-popup-button { position:fixed; bottom:20px; right:20px; z-index:999; }
#chat-popup-button button { padding:14px; border-radius:50%; background:#00ffc6; border:none; cursor:pointer; font-size:22px; box-shadow:0 0 12px #00ffc6,0 0 25px rgba(0,255,200,.3); transition:.2s; }
#chat-popup-button button:hover { transform:scale(1.1); box-shadow:0 0 18px #00ffc6,0 0 35px rgba(0,255,200,.5); }

#chat-popup { display:none; position:fixed; bottom:90px; right:20px; width:100%; max-width:400px; max-height:calc(100vh - 140px); background:linear-gradient(135deg,rgba(15,15,30,.95),rgba(20,20,40,.95)); border-radius:16px; box-shadow:0 0 22px rgba(0,255,200,.3); overflow:hidden; z-index:999; flex-direction:column; }
#chat-popup-header { padding:12px; background:#00ffc6; color:#111; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
#chat-popup-body { flex:1; overflow-y:auto; padding:12px; background:rgba(10,10,20,.9); display:flex; flex-direction:column; gap:8px; }
#chat-popup-form { display:flex; padding:8px; border-top:1px solid rgba(0,255,200,.2); background:rgba(10,10,20,.95); gap:8px; }
#chat-popup-form input { flex:1; padding:10px; border-radius:8px; border:none; background:#111; color:#fff; }
#chat-popup-form button { padding:10px 14px; border:none; border-radius:8px; font-weight:700; background:linear-gradient(135deg,#00ffc6,#00ff88); color:#111; box-shadow:0 0 10px #00ffc6; cursor:pointer; }

/* --- Context Menu --- */
#message-menu { position:absolute; background:#111; color:#00ffc6; border-radius:8px; border:1px solid rgba(0,255,200,.4); box-shadow:0 2px 12px rgba(0,255,200,.5); z-index:2000; display:none; opacity:0; transform:translateY(-5px) scale(.95); transition:.2s; }
#message-menu.show { display:block; opacity:1; transform:translateY(0) scale(1); }
#message-menu ul { list-style:none; padding:6px; margin:0; }
#message-menu li { padding:6px 12px; cursor:pointer; font-size:14px; transition:.2s; }
#message-menu li:hover { background:rgba(0,255,200,.15); }

/* --- Responsive --- */
#sidebar-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.4); backdrop-filter:blur(6px); z-index:999; opacity:0; transition:.3s; }
@media(max-width:900px){
  .chat-wrap { flex-direction:column; }
  .sidebar { position:fixed; top:0; left:0; height:100%; z-index:1000; transform:translateX(-100%); border-radius:0; transition:.3s; }
  .sidebar.show { transform:translateX(0); }
  #sidebar-toggle { display:block; }
  #sidebar-overlay.show { display:block; opacity:1; }
}
</style>

<div class="chat-wrap">

  <!-- Jobs Sidebar -->
  <div class="sidebar" id="jobs-sidebar">
    <h3>Jobs</h3>
    {% for j in jobs %}
      <a href="{% url 'employer_chat' j.id %}" class="applicant {% if job and j.id == job.id %}selected{% endif %}">
        {{ j.title }}
      </a>
    {% empty %}
      <p style="padding:12px; opacity:.7;">No jobs posted</p>
    {% endfor %}
  </div>

  <!-- Applicants Sidebar -->
  {% if job %}
  <div class="sidebar" id="sidebar">
    <h3>Applicants</h3>
    {% for app in applications %}
      <a href="?app_id={{ app.id }}" class="applicant {% if selected_app and app.id == selected_app.id %}selected{% endif %}">
        {{ app.applicant.username }}
        {% if app.unread_count %}<span class="badge">{{ app.unread_count }}</span>{% endif %}
      </a>
    {% empty %}
      <p style="padding:12px; opacity:.7;">No applicants yet</p>
    {% endfor %}
  </div>
  <div id="sidebar-overlay"></div>
  {% endif %}

  <!-- Chat Container -->
  <div class="chat-container">
    <div class="chat-header">
      {% if job %}
        <strong>{{ job.title }}</strong>{% if job.company %} â€” {{ job.company }}{% endif %}
      {% elif application %}
        <strong>{{ application.job.title }}</strong>{% if application.job.company %} â€” {{ application.job.company }}{% endif %}
      {% endif %}
      {% if job %}<button id="sidebar-toggle">â˜°</button>{% endif %}
    </div>

    <div id="chat-box" class="chat-box">
      {% for m in messages %}
        <div class="bubble {% if m.sender_id == request.user.id %}me{% else %}them{% endif %} pop" 
             data-id="{{ m.id }}" data-text="{{ m.message }}">
          <div><strong>{{ m.sender.username }}</strong></div>
          <div>{{ m.message }}</div>
          <div class="meta">{{ m.timestamp }}{% if m.edited_at %} (edited){% endif %}{% if m.is_read and m.sender_id == request.user.id %} âœ“{% endif %}</div>
        </div>
      {% empty %}
        <p style="opacity:.7;text-align:center;margin-top:16px;">No messages yet. Say hi ðŸ‘‹</p>
      {% endfor %}
    </div>

    <form id="chat-form" class="chat-input" onsubmit="return false;">
      {% csrf_token %}
      <input id="msg-input" type="text" placeholder="Type a messageâ€¦" autocomplete="off" maxlength="2000" />
      <button id="send-btn" type="button">Send</button>
    </form>
  </div>
</div>

<!-- Floating Chat Popup -->
<div id="chat-popup">
  <div id="chat-popup-header">Chat <span id="close-chat" style="cursor:pointer;">âœ–</span></div>
  <div id="chat-popup-body"><p style="opacity:.7;text-align:center;margin-top:16px;">No messages yet. Say hi ðŸ‘‹</p></div>
  <form id="chat-popup-form">{% csrf_token %}<input id="chat-popup-input" type="text" placeholder="Type a messageâ€¦"/><button type="button" id="chat-popup-send">Send</button></form>
</div>
<button id="chat-popup-button"><span>ðŸ’¬</span></button>

<!-- Context Menu -->
<div id="message-menu">
  <ul>
    <li data-action="reply">Reply</li>
    <li data-action="copy">Copy</li>
    <li data-action="edit">Edit</li>
    <li data-action="delete-me">Delete for Me</li>
    <li data-action="delete-everyone">Delete for Everyone</li>
    <li data-action="forward">Forward</li>
    <li data-action="pin">Pin</li>
  </ul>
</div>

<script>
(function(){
  const sidebar=document.getElementById("sidebar"), toggle=document.getElementById("sidebar-toggle"), overlay=document.getElementById("sidebar-overlay");
  if(sidebar && toggle && overlay){
    toggle.addEventListener("click",()=>{sidebar.classList.toggle("show");overlay.classList.toggle("show");});
    overlay.addEventListener("click",()=>{sidebar.classList.remove("show");overlay.classList.remove("show");});
    window.addEventListener("resize",()=>{if(window.innerWidth>900){sidebar.classList.remove("show");overlay.classList.remove("show");}});
  }
  const username="{{ request.user.username|escapejs }}";
  const chatBox=document.getElementById("chat-box"), input=document.getElementById("msg-input"), sendBtn=document.getElementById("send-btn");
  const popupInput=document.getElementById("chat-popup-input"), popupSend=document.getElementById("chat-popup-send"), popupBody=document.getElementById("chat-popup-body");

  const wsScheme=location.protocol==="https:"?"wss":"ws";
  const appId={% if application %}{{ application.id }}{% elif selected_app %}{{ selected_app.id }}{% else %}null{% endif %};
  if(!appId) return;
  const socket=new WebSocket(`${wsScheme}://${location.host}/ws/chat/${appId}/`);

  function scrollBottom(el){if(el) el.scrollTop=el.scrollHeight;}
  function sendMessage(msgInput=input,targetBody=chatBox){
    const text=msgInput.value.trim(); if(!text) return;
    const payload=msgInput.dataset.editId?{action:"edit",id:msgInput.dataset.editId,message:text}:{action:"message",message:text};
    socket.send(JSON.stringify(payload)); if(msgInput.dataset.editId) delete msgInput.dataset.editId; msgInput.value="";
    if(sendBtn){sendBtn.classList.add("send-effect");setTimeout(()=>sendBtn.classList.remove("send-effect"),500);}
    const bubble=document.createElement("div"); bubble.className="bubble me pop"; bubble.innerHTML=`<div><strong>${username}</strong></div><div>${text}</div><div class="meta">just now</div>`; targetBody.appendChild(bubble); scrollBottom(targetBody);
  }
  sendBtn?.addEventListener("click",()=>sendMessage(input,chatBox));
  input?.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();sendMessage(input,chatBox);}});
  popupSend?.addEventListener("click",()=>sendMessage(popupInput,popupBody));
  popupInput?.addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault();popupSend.click();}});

  let typingIndicator=null;
  function showTyping(){ if(!typingIndicator){ typingIndicator=document.createElement("div"); typingIndicator.className="bubble them typing"; typingIndicator.innerHTML='<div class="dot"></div><div class="dot"></div><div class="dot"></div>'; chatBox.appendChild(typingIndicator); scrollBottom(chatBox);} }
  function hideTyping(){typingIndicator?.remove();typingIndicator=null;}

  socket.onmessage=e=>{
    const d=JSON.parse(e.data);
    if(d.type==="typing"){showTyping();setTimeout(hideTyping,1500);}
    else if(d.type==="message"){const b=document.createElement("div");b.className=`bubble ${d.sender===username?"me":"them"} pop`;b.dataset.id=d.id;b.dataset.text=d.message;b.innerHTML=`<div><strong>${d.sender}</strong></div><div>${d.message}</div><div class="meta">${new Date(d.timestamp).toLocaleString()}</div>`;[chatBox,popupBody].forEach(c=>c?.appendChild(b.cloneNode(true)));scrollBottom(chatBox);}
    else if(d.type==="edit"){document.querySelectorAll(`.bubble[data-id="${d.id}"]`).forEach(m=>{m.dataset.text=d.message;m.querySelector("div:nth-child(2)").innerText=d.message;m.querySelector(".meta").innerText+=" (edited)";});}
    else if(d.type==="delete"){
  document.querySelectorAll(`.bubble[data-id="${d.id}"]`).forEach(m => {
    m.classList.add("deleted");
    m.querySelector("div:nth-child(2)").innerText = "ðŸ—‘ï¸ Message deleted";
  });
}
};

// Typing notification when user is typing
const msgInput = document.querySelector("input[name='message']");
msgInput?.addEventListener("input", () => {
  if(socket && socket.readyState === WebSocket.OPEN){
    socket.send(JSON.stringify({type:"typing", sender: username}));
  }
});

// Send message form
document.querySelector(".chat-form")?.addEventListener("submit", e => {
  e.preventDefault();
  const text = msgInput.value.trim();
  if(text && socket && socket.readyState === WebSocket.OPEN){
    socket.send(JSON.stringify({
      type: "message",
      sender: username,
      message: text,
      timestamp: new Date().toISOString()
    }));
    msgInput.value = "";
  }
});

// Scroll helper
function scrollBottom(container){
  container.scrollTop = container.scrollHeight;
}
                                                                                               
</script>                                                                                    

{% endblock %}
