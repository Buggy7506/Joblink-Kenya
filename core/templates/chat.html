{% extends "base.html" %}
{% block title %}Chat{% endblock %}

{% block content %}
<div id="chat-container">
  <div id="chat-box">
    {% for message in messages %}
      <div class="bubble {% if message.sender == request.user %}me{% else %}them{% endif %}" 
           data-id="{{ message.id }}" 
           data-text="{{ message.message }}">
        <div><strong>{{ message.sender.username }}</strong></div>
        <div>{{ message.message }}</div>
        <div class="meta">{{ message.timestamp|date:"Y-m-d H:i" }}</div>
      </div>
    {% endfor %}
  </div>

  <div id="chat-input">
    <input type="text" id="msg-input" placeholder="Type a message...">
    <button id="send-btn">Send</button>
  </div>
</div>

<!-- Floating chat button -->
<button id="chat-popup-button">üí¨</button>

<!-- Floating chat popup -->
<div id="chat-popup">
  <div id="chat-popup-header">
    <span>Chat</span>
    <button id="close-chat">‚úñ</button>
  </div>
  <div id="chat-popup-body"></div>
  <div id="chat-popup-input-box">
    <input type="text" id="chat-popup-input" placeholder="Type a message...">
    <button id="chat-popup-send">Send</button>
  </div>
</div>

<!-- Action Menu for Long-Press -->
<div id="action-menu" style="display:none;">
  <button id="copy-msg">üìã Copy</button>
  <button id="edit-msg">‚úèÔ∏è Edit</button>
  <button id="delete-msg">üóë Delete</button>
</div>

<style>
  #chat-container { max-width: 600px; margin: auto; padding: 10px; font-family: Arial, sans-serif; }
  #chat-box { height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f5f5f5; }
  .bubble { padding: 8px 12px; margin: 5px 0; border-radius: 10px; position: relative; cursor: pointer; }
  .me { background: #dcf8c6; text-align: right; margin-left: auto; max-width: 80%; }
  .them { background: #fff; text-align: left; margin-right: auto; max-width: 80%; }
  .bubble.selected { border: 2px solid #3399ff; background:#cce5ff; }
  .meta { font-size: 11px; color: #666; margin-top: 3px; }
  #chat-input { display: flex; gap: 5px; margin-top: 10px; }
  #msg-input { flex: 1; padding: 5px; }
  #send-btn { padding: 5px 10px; }

  #chat-popup-button { position: fixed; bottom: 20px; right: 20px; padding: 15px; border-radius: 50%; background: #007bff; color: #fff; border: none; cursor: pointer; }

  #chat-popup { display:none; position:fixed; bottom:80px; right:20px; width:300px; background:#fff; border:1px solid #ccc; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
  #chat-popup-header { display:flex; justify-content:space-between; padding:10px; background:#007bff; color:#fff; border-radius:10px 10px 0 0; }
  #chat-popup-body { height:200px; overflow-y:auto; padding:10px; }
  #chat-popup-input-box { display:flex; gap:5px; padding:10px; }
  #chat-popup-input { flex:1; padding:5px; }

  #action-menu { position:absolute; background:#fff; border:1px solid #ccc; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,0.2); padding:5px; z-index:1000; }
  #action-menu button { display:block; width:100%; padding:5px; background:none; border:none; text-align:left; cursor:pointer; }
  #action-menu button:hover { background:#f0f0f0; }
</style>

<script>
(function(){
  const username = "{{ request.user.username|escapejs }}";
  const chatBox = document.getElementById("chat-box");
  const input = document.getElementById("msg-input");
  const sendBtn = document.getElementById("send-btn");
  const actionMenu = document.getElementById("action-menu");
  let pressTimer, currentBubble, editTarget=null;

  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const appId = {% if application %}{{ application.id }}{% elif selected_app %}{{ selected_app.id }}{% else %}null{% endif %};
  if(!appId) return;

  const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${appId}/`);

  function scrollBottom(el){ el.scrollTop = el.scrollHeight; }
  scrollBottom(chatBox);

  function sendMessage(msgInput=input){
    const text = msgInput.value.trim();
    if(!text || socket.readyState!==1) return;

    if(editTarget){
      socket.send(JSON.stringify({ action:"edit", id: editTarget.dataset.id, message: text }));
      editTarget = null;
    } else {
      socket.send(JSON.stringify({ action:"message", message:text }));
    }
    msgInput.value = "";
  }

  sendBtn.addEventListener("click", ()=>sendMessage());
  input.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendMessage(); } });

  // Floating chat popup
  const chatButton = document.getElementById("chat-popup-button");
  const chatPopup = document.getElementById("chat-popup");
  const chatClose = document.getElementById("close-chat");
  const popupInput = document.getElementById("chat-popup-input");
  const popupSend = document.getElementById("chat-popup-send");
  const popupBody = document.getElementById("chat-popup-body");

  chatButton.addEventListener("click", ()=>chatPopup.style.display="block");
  chatClose.addEventListener("click", ()=>chatPopup.style.display="none");
  popupSend.addEventListener("click", ()=>sendMessage(popupInput));
  popupInput.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); popupSend.click(); } });

  socket.onmessage = function(e){
    const data = JSON.parse(e.data);

    if(data.type==="message" || data.type==="edit"){
      addBubble(data, data.type==="edit");
    }
    if(data.type==="deleted"){
      const bubble = document.querySelector(`.bubble[data-id='${data.id}']`);
      if(bubble) bubble.remove();
    }
  };

  function addBubble(data, isEdit=false){
    let bubble;
    if(isEdit){
      bubble = document.querySelector(`.bubble[data-id='${data.id}']`);
      if(bubble){
        bubble.dataset.text = data.message;
        bubble.querySelector("div:nth-child(2)").innerText = data.message;
        return;
      }
    } else {
      bubble = document.createElement("div");
      bubble.className = `bubble ${data.sender===username?"me":"them"}`;
      bubble.dataset.id = data.id;
      bubble.dataset.text = data.message;
      bubble.innerHTML = `<div><strong>${data.sender}</strong></div>
                          <div>${data.message}</div>
                          <div class="meta">${new Date(data.timestamp).toLocaleString()}</div>`;
      chatBox.appendChild(bubble);
      popupBody.appendChild(bubble.cloneNode(true));
      attachLongPress(bubble);
      scrollBottom(chatBox);
      scrollBottom(popupBody);
    }
  }

  // Long-press & selection
  function showMenu(bubble, x, y){
    currentBubble = bubble;
    actionMenu.style.left = x+"px";
    actionMenu.style.top = y+"px";
    actionMenu.style.display = "block";
  }
  function hideMenu(){ actionMenu.style.display = "none"; }

  function attachLongPress(bubble){
    function startPress(e){
      e.preventDefault();
      const touch = e.touches ? e.touches[0] : e;
      pressTimer = setTimeout(()=>showMenu(bubble, touch.pageX, touch.pageY), 600);
    }
    function cancelPress(){ clearTimeout(pressTimer); }

    bubble.addEventListener("mousedown", startPress);
    bubble.addEventListener("mouseup", cancelPress);
    bubble.addEventListener("mouseleave", cancelPress);
    bubble.addEventListener("touchstart", startPress);
    bubble.addEventListener("touchend", cancelPress);
  }

  document.querySelectorAll(".bubble").forEach(b=>attachLongPress(b));

  // Action menu buttons
  document.getElementById("copy-msg").addEventListener("click", ()=>{
    if(currentBubble){
      navigator.clipboard.writeText(currentBubble.dataset.text);
      alert("Copied!");
      hideMenu();
    }
  });

  document.getElementById("edit-msg").addEventListener("click", ()=>{
    if(currentBubble){
      input.value = currentBubble.dataset.text;
      input.focus();
      editTarget = currentBubble;
      hideMenu();
    }
  });

  document.getElementById("delete-msg").addEventListener("click", ()=>{
    if(currentBubble && socket.readyState===1){
      socket.send(JSON.stringify({ action:"delete", id: currentBubble.dataset.id }));
      hideMenu();
    }
  });

  document.addEventListener("click", e=>{
    if(!actionMenu.contains(e.target)) hideMenu();
  });

})();
</script>
{% endblock %}
