{% extends "base.html" %}
{% block title %}Chat{% endblock %}

{% block content %}
<div id="chat-container">
  <div id="chat-box">
    {% for message in messages %}
      <div class="bubble {% if message.sender == request.user %}me{% else %}them{% endif %}" 
           data-id="{{ message.id }}" 
           data-text="{{ message.message }}"
           data-sender="{{ message.sender.username }}">
        <div><strong>{{ message.sender.username }}</strong></div>
        <div>{{ message.message }}</div>
        <div class="meta">{{ message.timestamp|date:"Y-m-d H:i" }}</div>
      </div>
    {% endfor %}
  </div>

  <div id="chat-input">
    <input type="text" id="msg-input" placeholder="Type a message...">
    <button id="send-btn">Send</button>
  </div>
</div>

<!-- Floating chat button -->
<button id="chat-popup-button">💬</button>

<!-- Floating chat popup -->
<div id="chat-popup">
  <div id="chat-popup-header">
    <span>Chat</span>
    <button id="close-chat">✖</button>
  </div>
  <div id="chat-popup-body"></div>
  <div id="chat-popup-input-box">
    <input type="text" id="chat-popup-input" placeholder="Type a message...">
    <button id="chat-popup-send">Send</button>
  </div>
</div>

<!-- Action Menu for Long-Press -->
<div id="action-menu" style="display:none;">
  <button id="copy-msg">📋 Copy</button>
  <button id="edit-msg">✏️ Edit</button>
  <button id="delete-msg">🗑 Delete</button>
</div>

<style>
  /* ... same styles as before ... */
</style>

<script>
(function(){
  const username = "{{ request.user.username|escapejs }}";
  const chatBox = document.getElementById("chat-box");
  const input = document.getElementById("msg-input");
  const sendBtn = document.getElementById("send-btn");
  const actionMenu = document.getElementById("action-menu");
  let pressTimer, currentBubble, editTarget=null;

  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const appId = {% if application %}{{ application.id }}{% elif selected_app %}{{ selected_app.id }}{% else %}null{% endif %};
  if(!appId) return;

  const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${appId}/`);

  function scrollBottom(el){ el.scrollTop = el.scrollHeight; }
  scrollBottom(chatBox);

  function sendMessage(msgInput=input){
    const text = msgInput.value.trim();
    if(!text || socket.readyState!==1) return;

    if(editTarget){
      socket.send(JSON.stringify({ action:"edit", id: editTarget.dataset.id, message: text }));
      editTarget = null;
    } else {
      socket.send(JSON.stringify({ action:"message", message:text }));
    }
    msgInput.value = "";
  }

  sendBtn.addEventListener("click", ()=>sendMessage());
  input.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendMessage(); } });

  const chatButton = document.getElementById("chat-popup-button");
  const chatPopup = document.getElementById("chat-popup");
  const chatClose = document.getElementById("close-chat");
  const popupInput = document.getElementById("chat-popup-input");
  const popupSend = document.getElementById("chat-popup-send");
  const popupBody = document.getElementById("chat-popup-body");

  chatButton.addEventListener("click", ()=>chatPopup.style.display="block");
  chatClose.addEventListener("click", ()=>chatPopup.style.display="none");
  popupSend.addEventListener("click", ()=>sendMessage(popupInput));
  popupInput.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); popupSend.click(); } });

  socket.onmessage = function(e){
    const data = JSON.parse(e.data);

    if(data.type==="message" || data.type==="edit"){
      addBubble(data, data.type==="edit");
    }
    if(data.type==="deleted"){
      const bubble = document.querySelector(`.bubble[data-id='${data.id}']`);
      if(bubble) bubble.remove();
    }
  };

  function addBubble(data, isEdit=false){
    let bubble;
    if(isEdit){
      bubble = document.querySelector(`.bubble[data-id='${data.id}']`);
      if(bubble){
        bubble.dataset.text = data.message;
        bubble.querySelector("div:nth-child(2)").innerText = data.message;
        return;
      }
    } else {
      bubble = document.createElement("div");
      bubble.className = `bubble ${data.sender===username?"me":"them"}`;
      bubble.dataset.id = data.id;
      bubble.dataset.text = data.message;
      bubble.dataset.sender = data.sender; // important for edit check
      bubble.innerHTML = `<div><strong>${data.sender}</strong></div>
                          <div>${data.message}</div>
                          <div class="meta">${new Date(data.timestamp).toLocaleString()}</div>`;
      chatBox.appendChild(bubble);
      popupBody.appendChild(bubble.cloneNode(true));
      attachLongPress(bubble);
      scrollBottom(chatBox);
      scrollBottom(popupBody);
    }
  }

  function showMenu(bubble, x, y){
    currentBubble = bubble;
    // Only allow edit if sender is current user
    const editBtn = document.getElementById("edit-msg");
    if(bubble.dataset.sender === username){
      editBtn.style.display = "block";
    } else {
      editBtn.style.display = "none";
    }
    actionMenu.style.left = x+"px";
    actionMenu.style.top = y+"px";
    actionMenu.style.display = "block";
  }

  function hideMenu(){ actionMenu.style.display = "none"; }

  function attachLongPress(bubble){
    function startPress(e){
      e.preventDefault();
      const touch = e.touches ? e.touches[0] : e;
      pressTimer = setTimeout(()=>showMenu(bubble, touch.pageX, touch.pageY), 600);
    }
    function cancelPress(){ clearTimeout(pressTimer); }

    bubble.addEventListener("mousedown", startPress);
    bubble.addEventListener("mouseup", cancelPress);
    bubble.addEventListener("mouseleave", cancelPress);
    bubble.addEventListener("touchstart", startPress);
    bubble.addEventListener("touchend", cancelPress);
  }

  document.querySelectorAll(".bubble").forEach(b=>attachLongPress(b));

  document.getElementById("copy-msg").addEventListener("click", ()=>{
    if(currentBubble){
      navigator.clipboard.writeText(currentBubble.dataset.text);
      alert("Copied!");
      hideMenu();
    }
  });

  document.getElementById("edit-msg").addEventListener("click", ()=>{
    if(currentBubble && currentBubble.dataset.sender === username){
      input.value = currentBubble.dataset.text;
      input.focus();
      editTarget = currentBubble;
      hideMenu();
    }
  });

  document.getElementById("delete-msg").addEventListener("click", ()=>{
    if(currentBubble && socket.readyState===1){
      socket.send(JSON.stringify({ action:"delete", id: currentBubble.dataset.id }));
      hideMenu();
    }
  });

  document.addEventListener("click", e=>{
    if(!actionMenu.contains(e.target)) hideMenu();
  });

})();
</script>
{% endblock %}
