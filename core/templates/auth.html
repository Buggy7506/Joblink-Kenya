{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Sign In or Sign Up{% endblock %}

{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* =========================================================
   LOGIN/SIGNUP FORM (THEME-AWARE & NAMESPACE-WRAPPED)
========================================================= */

.auth-page * {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.auth-page body,
.auth-page .auth-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}

.auth-page body {
  background: var(--bg-main);
  color: var(--text-main);
  transition: background 0.4s ease, color 0.4s ease;
}

.auth-page .auth-wrapper {
  min-height: 100vh;
  display: grid;
  place-items: center;
}

/* AUTH BOX */
.auth-page .auth-box {
  background: var(--bg-card);
  padding: 2rem;
  border-radius: 1rem;
  box-shadow: 0 10px 25px rgba(0,0,0,0.25);
  backdrop-filter: blur(14px);
  transition: background 0.4s ease, color 0.4s ease;
  width: min(100%, 460px);
  max-height: 80vh; /* Prevents box from being too long */
  height: auto;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

/* LOGO */
.auth-page .auth-logo {
  display: grid;
  place-items: center;
  margin-bottom: 1rem;
}

.auth-page .auth-logo svg {
  width: 38px;
  height: 38px;
  stroke: var(--text-accent);
  filter: drop-shadow(0 0 8px var(--glow-accent));
}

/* HEADINGS */
.auth-page .auth-box h1,
.auth-page .auth-box h2 {
  text-align: center;
  margin-bottom: 0.8rem;
  font-weight: 600;
  font-size: 1.5rem;
  color: var(--text-main);
}

.auth-page .auth-box p {
  text-align: center;
  margin-bottom: 1.5rem;
  color: var(--text-muted);
  font-size: 0.9rem;
}

/* INPUTS */
.auth-page .auth-box input:not(.phone-number-input) {
  width: 100%;
  padding: 0.6rem 0.75rem;
  margin-bottom: 1rem;
  border: 1px solid var(--text-muted);
  border-radius: 0.75rem;
  font-size: 0.95rem;
  background: var(--bg-surface);
  color: var(--text-main);
  transition: border 0.25s ease, box-shadow 0.25s ease;
}
.auth-page .auth-box select.auth-input {
  appearance: none;
  background: var(--bg-surface);
  cursor: pointer;
}
/* PHONE GROUP CONTAINER */
.auth-page .phone-group {
  display: flex;
  gap: 0;
  align-items: stretch;
  margin-bottom: 1rem;
  position: relative;
  width: 100%;
  max-width: 100%;
  --country-select-width: 64px;
  border: 1px solid var(--text-muted);
  border-radius: 0.75rem;
  background: linear-gradient(180deg, var(--bg-surface), var(--bg-surface-soft));
  overflow: hidden;
  transition: border 0.25s ease, box-shadow 0.25s ease;
}

/* COUNTRY FLAG */
.auth-page .country-flag {
  position: absolute;
  left: 0.6rem;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1.2rem;
  line-height: 1;
  pointer-events: none;
  z-index: 3;
  display: inline-flex;
}

/* =========================================
   COUNTRY SELECT ‚Äî DESKTOP & MOBILE FIX
   (Emoji flags visible everywhere)
========================================= */

.auth-page .country-select {
  flex: 0 0 var(--country-select-width);
  width: var(--country-select-width);
  max-width: var(--country-select-width);
  min-width: 0;

  border: none;
  border-right: 1px solid color-mix(in srgb, var(--text-muted), transparent 45%);
  border-radius: 0;

  background: transparent;
  padding: 0.55rem 1.6rem 0.55rem 2.2rem;

  /* Keep selected flag visible on desktop and mobile */
  font-size: 0.85rem;
  color: var(--text-main);
  -webkit-text-fill-color: var(--text-main);
  caret-color: transparent;

  text-indent: 0;
  text-indent: -999px;         /* hide text without breaking emojis */
  white-space: nowrap;
  overflow: hidden;

  position: relative;
  z-index: 1;
}

/* Dropdown options MUST render text + emoji */
.auth-page .country-select option {
  font-size: 0.95rem;
  color: var(--text-main);
  background: var(--bg-surface-soft);
}

/* When user interacts, allow visibility (accessibility) */
.auth-page .country-select:focus,
.auth-page .country-select:active {
  color: var(--text-main);
}

/* DROPDOWN ARROW */
.auth-page .phone-group::after {
  content: "‚ñæ";
  position: absolute;
  left: calc(var(--country-select-width) - 1.3rem);
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  font-size: 0.9rem;
  pointer-events: none;
  z-index: 2;
}

/* PHONE INPUT WRAPPER */
.auth-page .phone-input-wrapper {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 0.3rem;
  padding: 0.55rem 0.7rem;
  min-width: 0;
}

/* DIAL CODE */
.auth-page .phone-dial {
  color: var(--text-muted);
  font-weight: 600;
  font-size: 0.9rem;
  white-space: nowrap;
  margin-right: 0.35rem;
}

/* PHONE NUMBER INPUT */
.auth-page .phone-number-input {
  flex: 1;
  min-width: 0;
  margin-bottom: 0;
  padding: 0.55rem 0;
  border: none;
  border-radius: 0;
  background: transparent;
  font-size: 0.95rem;
  color: var(--text-main);
  outline: none;
}

/* FOCUS STATE */
.auth-page .phone-group:focus-within {
  border-color: var(--text-accent);
  box-shadow: 0 0 0 2px var(--glow-accent);
}

/* COUNTRY SELECT OPTIONS */
.auth-page .country-select option {
  background: var(--bg-surface-soft);
  color: var(--text-main);
  font-size: 0.95rem;
  padding: 0.4rem 0.6rem;
}

/* FOCUS ON SELECT */
.auth-page .country-select:focus {
  outline: none;
  background: rgba(255, 255, 255, 0.04);
}
   
.auth-page .auth-box input::placeholder {
  color: var(--text-muted);
}

.auth-page .auth-box input:not(.phone-number-input):focus {
  outline: none;
  border-color: var(--text-accent);
  box-shadow: 0 0 8px var(--glow-accent);
}

/* BUTTONS */
.auth-page .auth-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 0.6rem;
  margin-bottom: 0.8rem;
  border: 1px solid var(--text-muted);
  border-radius: 0.6rem;
  cursor: pointer;
  font-weight: 500;
  background: transparent;
  color: var(--text-main);
  transition: all 0.25s ease;
}

.auth-page .auth-btn:hover {
  border-color: var(--text-accent);
  color: var(--text-accent);
  box-shadow: 0 0 8px var(--glow-accent);
}

/* PRIMARY BUTTON */
.auth-page .auth-btn.primary {
  background: linear-gradient(135deg, var(--text-accent), var(--glow-accent));
  color: var(--text-main);
  border: none;
  font-weight: 600;
}

.auth-page .auth-btn.primary:hover {
  filter: brightness(1.1);
  box-shadow: 0 0 14px var(--glow-accent);
}

/* LINKS */
.auth-page .auth-link {
  background: none;
  border: none;
  color: var(--text-link);
  font-size: 0.85rem;
  cursor: pointer;
  transition: color 0.25s ease;
}

.auth-page .auth-link:hover {
  color: var(--text-accent);
}

/* DIVIDER */
.auth-page .divider {
  display: flex;
  align-items: center;
  text-align: center;
  margin: 1rem 0;
  font-size: 0.75rem;
  color: var(--text-muted);
}

.auth-page .divider::before,
.auth-page .divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--text-muted);
}

.auth-page .divider:not(:empty)::before { margin-right: .5em; }
.auth-page .divider:not(:empty)::after { margin-left: .5em; }

/* ROW (FOR PASSWORD STEP) */
.auth-page .row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.85rem;
}

/* HIDDEN ELEMENTS */
.auth-page .hidden {
  display: none;
}

/* =========================================
   RESEND OTP BUTTON (COOLDOWN-AWARE)
========================================= */

.auth-page .resend-btn {
  margin-top: 0.75rem;
  width: 100%;
  border-radius: 0.6rem;
  border: 1px solid var(--text-muted);
  background: var(--bg-surface);
  padding: 0.55rem 0.7rem;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-muted);
  cursor: not-allowed;
  transition: all 0.25s ease;
}

/* Enabled state */
.auth-page .resend-btn:not(:disabled) {
  color: var(--text-link);
  cursor: pointer;
  border-color: var(--text-link);
  background: color-mix(in srgb, var(--bg-surface), var(--glow-accent) 14%);
}

/* Hover when enabled */
.auth-page .resend-btn:not(:disabled):hover {
  color: var(--text-accent);
  border-color: var(--text-accent);
  box-shadow: 0 0 10px var(--glow-accent);
}

/* Disabled state */
.auth-page .resend-btn:disabled {
  opacity: 0.55;
}

/* =========================================
   OTP CHANNEL SELECTOR (EMAIL / SMS / WHATSAPP)
========================================= */

.auth-page .channel-group {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.auth-page .channel-group label {
  flex: 1;
  cursor: pointer;
}

.auth-page .channel-group input {
  display: none;
}

.auth-page .channel-group span {
  display: block;
  padding: 0.5rem 0.4rem;
  text-align: center;
  font-size: 0.8rem;
  font-weight: 500;

  border-radius: 0.6rem;
  border: 1px solid var(--text-muted);

  color: var(--text-muted);
  background: transparent;

  transition: all 0.25s ease;
}

/* Selected state */
.auth-page .channel-group input:checked + span {
  border-color: var(--text-accent);
  color: var(--text-main);
  box-shadow: 0 0 6px var(--glow-accent);
}

/* WhatsApp highlight */
.auth-page .channel-group .whatsapp input:checked + span {
  background: var(--bg-success-soft);
  border-color: var(--text-success);
  box-shadow: 0 0 8px var(--text-success);
}

/* SMS highlight */
.auth-page .channel-group .sms input:checked + span {
  background: var(--bg-info-soft);
  border-color: var(--text-info);
  box-shadow: 0 0 8px var(--text-info);
}

/* =========================================
   PHONE INPUT (SMS / WHATSAPP)
========================================= */

.auth-page #phoneGroup {
  display: none;
  animation: fadeSlideIn 0.25s ease forwards;
}

@keyframes fadeSlideIn {
  from {
    opacity: 0;
    transform: translateY(-6px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* =========================================
   SMALL UX POLISH
========================================= */

/* Make OTP input feel intentional */
.auth-page input[name="code"] {
  letter-spacing: 0.35em;
  text-align: center;
  font-weight: 600;
}

/* Disabled resend clarity */
.auth-page .resend-btn:disabled {
  opacity: 0.45;
  text-decoration: none;
}
.auth-page .google-btn {
  background: var(--bg-surface);
  color: var(--text-main);
  border: 1px solid var(--text-muted);
}

.auth-page .google-btn:hover {
  background: var(--bg-surface-soft);
  border-color: var(--text-muted);
  box-shadow: 0 2px 8px rgba(0,0,0,0.12);
}

.auth-page .google-btn svg {
  flex-shrink: 0;
}
.auth-logo-img {
  width: 48px;
  height: auto;
  display: block;
  margin: 0 auto;

  /* subtle glow to match your theme */
  filter: drop-shadow(0 0 6px var(--glow-accent));
}
/* =========================================
   ROLE SELECTOR (APPLICANT / EMPLOYER)
========================================= */

.auth-page .role-group {
  display: flex;
  gap: 0.5rem;
  margin: 1rem 0;
}

.auth-page .role-option {
  flex: 1;
  cursor: pointer;
}

.auth-page .role-option input {
  display: none;
}

.auth-page .role-option span {
  display: block;
  padding: 0.6rem 0.5rem;
  text-align: center;

  font-size: 0.85rem;
  font-weight: 600;

  border-radius: 0.6rem;
  border: 1px solid var(--text-muted);

  background: transparent;
  color: var(--text-muted);

  transition: all 0.25s ease;
}

/* Selected */
.auth-page .role-option input:checked + span {
  color: var(--text-main);
  border-color: var(--text-accent);
  box-shadow: 0 0 8px var(--glow-accent);
}

/* Applicant accent */
.auth-page .role-option.applicant input:checked + span {
  background: rgba(34, 211, 238, 0.15);
  border-color: var(--text-accent);
}

/* Employer accent */
.auth-page .role-option.employer input:checked + span {
  background: var(--bg-warning-soft);
  border-color: var(--text-warning);
  box-shadow: 0 0 8px var(--bg-warning);
}
.auth-page .field-error {
  color: var(--text-danger);
  font-size: 0.9rem;
  margin-top: 6px;
  display: none;
}

.auth-page .field-error.show {
  display: block;
}

.auth-page .role-selection {
  display: flex;
  flex-direction: column;
  gap: 14px;
  margin: 18px 0 8px;
}

.auth-page .role-card {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  background: var(--bg-surface-soft);
  border: 2px solid var(--text-muted);
  border-radius: 16px;
  padding: 16px 20px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
}

.auth-page .role-card:hover {
  background: var(--bg-info-soft);
  border-color: var(--text-accent);
  transform: translateY(-2px);
}

.auth-page .role-card input {
  display: none;
}

.auth-page .role-card input:checked + span {
  background: var(--bg-info-soft);
  border-radius: 14px;
  padding: 6px 10px;
  box-shadow: 0 0 16px var(--glow-accent);
}
/* ===== AUTH PROVIDER BUTTONS (NORMAL) ===== */

.auth-provider-wrapper .auth-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  justify-content: center;
   
  width: 100%;
  padding: 10px 14px;

  border: 1px solid #e5e7eb;
  border-radius: 999px;
  background: #ffffff;

  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  text-align: center;
  color: #111827;
}

/* SVG sizing */
.auth-provider-wrapper .auth-btn svg {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
}

/* Apple button */
.auth-provider-wrapper .apple-btn {
  background: #ffffff;
  color: #111827;
}
.auth-provider-wrapper .apple-btn svg {
  padding-left: 2px;
}
.auth-provider-wrapper .apple-btn svg path {
  fill: currentColor;
}

/* Main row (icon + text) */
.auth-provider-wrapper .auth-main {
  display: flex;
  align-items: center;
  gap: 10px;
  justify-content: center;
}

/* ===== DISABLED PROVIDERS (Apple & Microsoft) ===== */

.auth-provider-wrapper .disabled-btn {
  opacity: 0.6;
  cursor: not-allowed;
  display: flex;
  align-items: center;
  gap: 6px;
}
/* Force ONE ROW for disabled buttons */
.auth-provider-wrapper .disabled-btn {
  flex-wrap: nowrap;
  white-space: nowrap;
}

/* Prevent text from breaking */
.auth-provider-wrapper .auth-main span,
.auth-provider-wrapper .coming-soon {
  white-space: nowrap;
}
/* Main content stays inline */
.auth-provider-wrapper .disabled-btn .auth-main {
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Dot separator before "Coming soon" */
.auth-provider-wrapper .coming-soon::before {
  content: "¬∑";
  margin: 0 6px;
  color: var(--text-muted);
  font-weight: 700;
}

/* Coming soon INLINE */
.auth-provider-wrapper .coming-soon {
  display: inline;
  font-size: 12px;
  color: var(--text-muted);
  font-weight: 500;
  white-space: nowrap;
}

/* Microsoft text color */
.auth-provider-wrapper .microsoft-btn,
.auth-provider-wrapper .microsoft-btn span {
  color: #111827;
}
.auth-provider-wrapper .apple-btn,
.auth-provider-wrapper .apple-btn span {
  color: #111827;
}
/* Disable ALL interaction */
.auth-provider-wrapper .disabled-btn,
.auth-provider-wrapper .disabled-btn * {
  pointer-events: none;
}
/* ========================================
   AUTH PAGE ‚Äî ChatGPT-like inline spinner
======================================== */
.auth-page .spinner {
  display: inline-flex;
  gap: 4px;
  align-items: center;
}

.auth-page .spinner span {
  width: 4px;
  height: 4px;
  background: currentColor;
  border-radius: 50%;
  animation: auth-blink 1.4s infinite both;
}

.auth-page .spinner span:nth-child(2) {
  animation-delay: .2s;
}

.auth-page .spinner span:nth-child(3) {
  animation-delay: .4s;
}

@keyframes auth-blink {
  0% { opacity: .2; }
  20% { opacity: 1; }
  100% { opacity: .2; }
}

.auth-page .btn-loading {
  pointer-events: none;
  opacity: .85;
}
/* ========================================
   AUTH PAGE ‚Äî Show / Hide password (FIXED)
======================================== */

.auth-page .password-wrapper {
  position: relative;
  width: 100%;
}

/* Password input needs right padding for the eye */
.auth-page .password-wrapper input {
  padding-right: 2.8rem; /* space for the eye */
}

/* Eye button */
.auth-page .auth-eye {
  position: absolute;
  right: 0.65rem;               /* inside the input */
  top: 50%;
  transform: translateY(-50%);

  background: none;
  border: none;
  padding: 0;

  cursor: pointer;
  font-size: 16px;
  line-height: 1;

  opacity: 0.65;
  color: inherit;

  display: flex;
  align-items: center;
  justify-content: center;
}

/* Hover polish */
.auth-page .auth-eye:hover {
  opacity: 1;
}

/* Disabled state */
.auth-page .auth-eye:disabled {
  cursor: default;
  opacity: 0.4;
}
.auth-page .password-wrapper input:placeholder-shown + .auth-eye {
  opacity: 0.35;
}
.auth-page .auth-eye:hover {
  background: rgba(255,255,255,0.08);
  border-radius: 50%;
}
@media (hover: hover) {
  .auth-page .auth-eye:hover {
    background: rgba(255,255,255,0.08);
    border-radius: 50%;
  }
}
/* =========================================
   MOBILE OPTIMIZATIONS
========================================= */
@media (max-width: 480px) {
  /* Auth box keeps a stable size while allowing scroll */
  .auth-page .auth-box {
    width: 100%;
    max-width: 100%;
    padding: 1.5rem 1rem;
    height: calc(100dvh - 1rem);
    min-height: 0;
    max-height: 90vh; /* Adjusted for mobile view */
  }

    /* Prevent mobile browsers from zooming inputs on focus */
  .auth-page .auth-box input,
  .auth-page .auth-box select {
    font-size: 16px;
  }
   
   /* Headings scale down */
  .auth-page .auth-box h1,
  .auth-page .auth-box h2 {
    font-size: 1.3rem;
  }

  /* Paragraphs scale down */
  .auth-page .auth-box p {
    font-size: 0.85rem;
  }

  /* Buttons slightly taller and bigger for tap */
  .auth-page .auth-btn {
    padding: 0.55rem;
    font-size: 0.95rem;
  }

  /* OTP input spacing adjusted */
  .auth-page input[name="code"] {
    letter-spacing: 0.25em;
  }

  /* Channel selector: wrap on small screens */
  .auth-page .channel-group {
    flex-wrap: wrap;
    gap: 0.4rem;
  }
  .auth-page .channel-group label {
    flex: 1 1 100%;
  }

  /* Row items stack vertically */
  .auth-page .row {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.4rem;
  }

  /* Role selector wraps */
  .auth-page .role-group {
    flex-wrap: wrap;
    gap: 0.4rem;
  }
  .auth-page .role-option {
    flex: 1 1 48%;
    margin-bottom: 0.4rem;
  }

  /* Eye button remains accessible */
  .auth-page .auth-eye {
    font-size: 18px;
  }
   
  .auth-page .phone-group {
    --country-select-width: 108px;
  }
  .auth-page .country-select {
    font-size: 0.85rem;
    text-indent: -999px;
    color: var(--text-main);
    -webkit-text-fill-color: var(--text-main);
    padding: 0.55rem 1.8rem 0.55rem 2.1rem;
  }
}
/* =========================================
   PHONE GROUP ‚Äî ISOLATION FIX (FINAL)
========================================= */

.auth-page .phone-group input,
.auth-page .phone-group select {
  border: none !important;
  border-radius: 0 !important;
  box-shadow: none !important;
  background: transparent !important;
  outline: none !important;
  margin-bottom: 0;
}

/* Prevent global focus glow leakage */
.auth-page .phone-group input:focus,
.auth-page .phone-group select:focus {
  box-shadow: none !important;
}
</style>

<body data-new-user="{{ is_new_user|yesno:'true,false' }}">
<div class="auth-page">
  <div class="auth-wrapper">
    <div class="auth-box">

      <!-- LOGO -->
      <div class="auth-logo">
        <img
          src="https://res.cloudinary.com/dc6z1giw2/image/upload/v1769179808/ChatGPT_Image_Jan_23_2026_05_49_37_PM_j0ocdp.png"
          alt="Joblink Kenya"
          class="auth-logo-img"
        />
      </div>

      <form method="POST" action="{% url 'unified_auth' %}" novalidate>
         <input type="hidden" name="next" value="{{ next }}">
        {% csrf_token %}

        <!-- PHASE 1: UI STEP SOURCE OF TRUTH -->
        <input
          type="hidden"
          name="ui_step"
          id="uiStep"
          value="{{ ui_step|default:'email' }}"
        >

        <!-- ================= STEP 1: IDENTIFIER ================= -->
        <section
           id="step-email"
           data-step="email"
           class="{% if ui_step != 'email' %}hidden{% endif %}"
         >

          <h2>Log in or Sign up</h2>
          <p>Sign up and connect to job opportunities.</p>
           
         <div class="auth-provider-wrapper">
          <!-- GOOGLE LOGIN -->
          <button
            type="button"
            class="auth-btn google-btn"
            onclick="window.location.href='{% url 'google_login' %}';"
          >
            <span class="auth-main">
              <svg width="18" height="18" viewBox="0 0 533.5 544.3" aria-hidden="true">
                <path d="M533.5 278.4c0-17.7-1.5-34.8-4.3-51.4H272v97.4h146.9c-6.4 34.9-25.7 64.5-54.8 84.2v69h88.6c51.9-47.9 81.8-118.5 81.8-199.2z" fill="#4285F4"/>
                <path d="M272 544.3c73.7 0 135.6-24.5 180.8-66.7l-88.6-69c-24.7 16.6-56.4 26.3-92.2 26.3-70.9 0-131-47.9-152.5-112.1H31v70.3C76.1 478.5 168 544.3 272 544.3z" fill="#34A853"/>
                <path d="M119.5 323.8c-5.7-16.6-9-34.2-9-52.3s3.3-35.7 9-52.3V149H31c-18.5 36.3-29 77.2-29 122.5s10.5 86.2 29 122.5l88.5-70.2z" fill="#FBBC05"/>
                <path d="M272 107.7c39.9-.6 75.5 13.8 103.7 40.8l77.7-77.7C403.2 24.5 341.3 0 272 0 168 0 76.1 65.8 31 149l88.5 70.3C141 155.6 201.1 107.7 272 107.7z" fill="#EA4335"/>
              </svg>
              <span>Continue with Google</span>
            </span>
          </button>
  
            <!-- APPLE LOGIN -->
            <button
              type="button"
              class="auth-btn apple-btn disabled-btn"
              disabled
            >
              <span class="auth-main">
                <svg
                  width="18"
                  height="18"
                  viewBox="0 0 384 512"
                  aria-hidden="true"
                >
                  <path
                    fill="currentColor"
                    d="M318.7 268.6c-.3-37.2 16.4-65.3 51.5-86.5-19.6-28-49.1-43.4-88-46.4-37.1-3-77.6 21.6-92.5 21.6-15.3 0-51.2-20.6-79.3-20-40.8.6-78.7 23.7-99.7 60.2-42.5 73.7-10.8 182.6 30.5 242.4 20.2 29.2 44.3 62 76 60.8 30.3-1.2 41.8-19.5 78.5-19.5 36.4 0 47 19.5 79.1 18.8 32.8-.6 53.5-29.9 73.5-59.2 23.2-33.9 32.8-66.8 33.1-68.5-.7-.3-63.4-24.3-63.7-96.7z"
                  />
                  <path
                    fill="currentColor"
                    d="M256.6 76.8c17.1-20.7 28.6-49.5 25.5-78.8-24.6 1-54.3 16.4-72 36.9-15.8 18.3-29.7 47.5-26 75.6 27.4 2.1 55.3-13.9 72.5-33.7z"
                  />
                </svg>
            
                <span>Continue with Apple</span>
              </span>
            
              <span class="coming-soon">Coming soon</span>
            </button>

           <!-- MICROSOFT LOGIN -->
            <button
              type="button"
              class="auth-btn microsoft-btn disabled-btn"
              disabled
            >
              <span class="auth-main">
                <svg width="18" height="18" viewBox="0 0 23 23" aria-hidden="true">
                  <rect x="1" y="1" width="9" height="9" fill="#F25022"/>
                  <rect x="13" y="1" width="9" height="9" fill="#7FBA00"/>
                  <rect x="1" y="13" width="9" height="9" fill="#00A4EF"/>
                  <rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                </svg>
                <span>Continue with Microsoft</span>
              </span>
            
              <span class="coming-soon">Coming soon</span>
            </button>
            
          <div class="divider">OR</div>

          <!-- EMAIL -->
          <input
            type="email"
            id="emailInput"
            name="identifier"
            value="{{ request.session.auth_email|default:'' }}"
            placeholder="Email address"
            class="auth-input"
            autocomplete="email"
            required
          />
         <div class="field-error" id="emailError">Please enter a valid email address.</div>

          <!-- OTP CHANNEL -->
          <div class="channel-group">
            <label>
              <input type="radio" name="channel" value="email" checked>
              <span>Email</span>
            </label>

            <label class="sms">
              <input type="radio" name="channel" value="sms">
              <span>SMS</span>
            </label>

            <label class="whatsapp">
              <input type="radio" name="channel" value="whatsapp">
              <span>WhatsApp</span>
            </label>
          </div>

            <!-- PHONE -->
            <div class="phone-group" id="phoneGroup" style="display:none;">
              <!-- Country flag -->
              <span class="country-flag" id="countryFlag" aria-hidden="true">üá∞üá™</span>
            
              <!-- Country select -->
              <select
                id="countrySelect"
                class="auth-input country-select"
                data-default="KE"
                disabled
                aria-label="Select country"
              >
                <option value="" selected disabled>Loading countries...</option>
              </select>
            
              <!-- Phone input wrapper -->
              <div class="phone-input-wrapper">
                <span class="phone-dial" id="phoneDial">+254</span>
                <input
                  type="tel"
                  id="phoneInput"
                  name="phone"
                  value="{{ request.session.auth_phone|default:'' }}"
                  placeholder="Phone number"
                  class="auth-input phone-number-input"
                  autocomplete="tel"
                  inputmode="numeric"
                  disabled
                >
              </div>
            </div>
           
          <button
            type="submit"
            name="action"
            value="send_code"
            class="auth-btn primary"
            id="continueBtn"
            disabled
          >
            Continue
          </button>

          {% include "form_errors.html" %}
        </section>

        <!-- ================= STEP 2: OTP ================= -->
        <section
           id="step-code"
           data-step="code"
           class="{% if ui_step != 'code' %}hidden{% endif %}"
         >

          <h2>Check your messages</h2>
          <p>
            Enter the code sent to
            <b>{{ request.session.auth_identifier }}</b>
          </p>

          <input
            type="text"
            name="code"
            maxlength="6"
            placeholder="6-digit code"
            class="auth-input"
            autocomplete="one-time-code"
          >

          <button
            type="submit"
            name="action"
            value="verify_code"
            class="auth-btn primary"
          >
            Verify
          </button>

          <button
            type="submit"
            name="action"
            value="resend_code"
            id="resendBtn"
            class="resend-btn"
            disabled
          >
            Resend code (<span id="countdown">30</span>s)
          </button>
           
        {% if request.session.auth_user_exists %}
          <div class="divider">OR</div>

          <button type="submit" name="action" value="switch_to_password" class="auth-btn">
             Continue with password
           </button>
        {% endif %}
      </section>

         <!-- ================= STEP 3: PASSWORD ================= -->
         <section
           id="step-password"
           data-step="password"
           class="{% if ui_step != 'password' %}hidden{% endif %}"
         >
         
           <h2>Enter your password</h2>
         
           <p><b>
             {% if request.session.otp_channel == "email" %}
               {{ request.session.auth_email|slice:":3" }}***@***
             {% elif request.session.auth_phone and request.session.auth_phone|length >= 8 %}
               {{ request.session.auth_phone|slice:":5" }}***{{ request.session.auth_phone|slice:"-3:" }}
             {% else %}
               your phone number
             {% endif %}
           </b></p>
            
            {% if is_new_user %}
           <div class="role-selection">
             {% include "partials/role_toggle.html" with role_required=True %}
           </div>
           {% endif %}
         
           <div class="password-field">
         
             <!-- PASSWORD -->
             <div class="password-wrapper">
               <input
                 type="password"
                 name="password"
                 placeholder="Password"
                 class="auth-input js-auth-password"
                 autocomplete="current-password"
                 required
               >
               <button
                 type="button"
                 class="auth-eye"
                 aria-label="Show password"
               >
                 üëÅÔ∏è
               </button>
             </div>
         
             {% if is_new_user %}
             <!-- CONFIRM PASSWORD -->
             <div class="password-wrapper">
               <input
                 type="password"
                 name="confirm_password"
                 placeholder="Confirm password"
                 class="auth-input js-auth-password"
                 autocomplete="new-password"
                 required
               >
               <button
                 type="button"
                 class="auth-eye"
                 aria-label="Show password"
               >
                 üëÅÔ∏è
               </button>
             </div>
             {% endif %}
         
           </div>
         
           <button
             type="submit"
             name="action"
             value="{% if is_new_user %}set_password{% else %}login_password{% endif %}"
             class="auth-btn primary"
           >
             {% if is_new_user %}Create account{% else %}Continue{% endif %}
           </button>
            
            {% if not is_new_user %}
           <a href="{% url 'password_reset' %}" class="auth-link">
             Forgot password?
           </a>
         
           <div class="divider">OR</div>
         
           <button
             type="submit"
             name="action"
             value="magic_link"
             class="auth-btn"
           >
             Log in with one-time code
           </button>
            {% endif %}
            
         </section>

      </form>
    </div>
  </div>
</div>
</body>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // =========================
  // CONFIG
  // =========================
  const RESEND_COOLDOWN = 30;
  let resendTimer = null;

  // =========================
  // ELEMENTS
  // =========================
  const form = document.querySelector("form");
  if (!form) return;

  form.setAttribute("novalidate", "true");

  const uiStepInput = document.getElementById("uiStep");

  const steps = {
    email: document.getElementById("step-email"),
    code: document.getElementById("step-code"),
    password: document.getElementById("step-password"),
  };

  const emailInput = document.getElementById("emailInput");
  const emailError = document.getElementById("emailError");
  const phoneInput = document.getElementById("phoneInput");
  const phoneGroup = document.getElementById("phoneGroup");
  const countrySelect = document.getElementById("countrySelect");
  const countryFlag = document.getElementById("countryFlag");
  const phoneDial = document.getElementById("phoneDial");
  const continueBtn = document.getElementById("continueBtn");
  const channelRadios = document.querySelectorAll('input[name="channel"]');

  // =========================
  // STEP CONTROL
  // =========================
  function setStep(step) {
    Object.values(steps).forEach(el => el && el.classList.add("hidden"));
    steps[step]?.classList.remove("hidden");
  }

  if (uiStepInput?.value && steps[uiStepInput.value]) {
    setStep(uiStepInput.value);
    if (uiStepInput.value === "code") {
      startResendCooldown();
    }
  } else {
    setStep("email");
  }

  // =========================
  // SHOW / HIDE PASSWORD
  // =========================
  document.querySelector('.auth-page')?.addEventListener('click', e => {
    const eye = e.target.closest('.auth-eye');
    if (!eye) return;

    const wrapper = eye.closest('.password-wrapper');
    const input = wrapper.querySelector('input');

    if (!input) return;

    const hidden = input.type === 'password';
    input.type = hidden ? 'text' : 'password';
    eye.textContent = hidden ? 'üôà' : 'üëÅÔ∏è';
  });

  // =========================
  // RESEND COOLDOWN
  // =========================
  function startResendCooldown() {
    const resendBtn = document.getElementById("resendBtn");
    const countdown = document.getElementById("countdown");
    if (!resendBtn || !countdown) return;

    let remaining = RESEND_COOLDOWN;
    resendBtn.disabled = true;
    countdown.textContent = remaining;

    clearInterval(resendTimer);
    resendTimer = setInterval(() => {
      remaining--;
      countdown.textContent = remaining;

      if (remaining <= 0) {
        clearInterval(resendTimer);
        resendBtn.disabled = false;
        countdown.textContent = RESEND_COOLDOWN;
      }
    }, 1000);
  }

  // =========================
  // CHANNEL TOGGLE
  // =========================
  function syncChannelFields() {
    const checked = document.querySelector('input[name="channel"]:checked');
    if (!checked) return;

    const email = checked.value === "email";

    emailInput.disabled = !email;
    emailInput.style.display = email ? "block" : "none";
    if (!email) emailInput.value = "";
    if (emailError) emailError.classList.remove("show");

    if (phoneGroup) {
      phoneGroup.style.display = email ? "none" : "flex";
    }
    if (countrySelect) {
      countrySelect.disabled = email;
    }
    if (phoneInput) {
      phoneInput.disabled = email;
      if (email) phoneInput.value = "";
    }
    updatePhoneState();
    updateContinueState();
  }

  channelRadios.forEach(r => r.addEventListener("change", syncChannelFields));
  syncChannelFields();

  function isValidEmail(value) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
  }

  if (emailInput) {
    emailInput.addEventListener("input", () => {
      if (emailError) emailError.classList.remove("show");
             updateContinueState();
    });
  }

  function getCountryMeta() {
    const option = countrySelect?.selectedOptions?.[0];
    if (!option) return { dial: "", max: 0 };
    return {
      dial: option.dataset.dial || "",
      max: parseInt(option.dataset.max || "0", 10),
    };
  }

   function updateCountryFlag() {
    if (!countryFlag || !countrySelect) return;
    const option = countrySelect.selectedOptions?.[0];
    if (!option) return;
    const emoji = option.dataset.flagEmoji || option.textContent?.trim().split(" ")[0] || "üè≥Ô∏è";
    countryFlag.textContent = emoji;
    countrySelect.setAttribute(
      "aria-label",
      option.dataset.label || option.textContent || "Select country"
    );
  }
   
   function sanitizeDigits(value) {
    return value.replace(/\D/g, "");
  }

  function updatePhoneState() {
    if (!phoneInput || !countrySelect) return;
    const { dial, max } = getCountryMeta();
    const digits = sanitizeDigits(phoneInput.value);
    const trimmed = max ? digits.slice(0, max) : digits;
    if (digits !== trimmed) phoneInput.value = trimmed;
    if (max) phoneInput.maxLength = max;
    phoneInput.dataset.full = trimmed ? `+${dial}${trimmed}` : "";
    if (phoneDial) {
      phoneDial.textContent = dial ? `+${dial}` : "";
    }
     updateCountryFlag();
  }

  function updatePhonePlaceholder() {
    if (!phoneInput) return;
    const { max } = getCountryMeta();
    phoneInput.placeholder = max
      ? `Phone number (${max} digits)`
      : "Phone number";
  }

  function isValidPhone() {
    if (!phoneInput || !countrySelect) return false;
    const { max } = getCountryMeta();
    const digits = sanitizeDigits(phoneInput.value);
    if (max) return digits.length === max;
    return digits.length >= 6 && digits.length <= 15;
  }

  function updateContinueState() {
    if (!continueBtn) return;
    const channel = document.querySelector('input[name="channel"]:checked')?.value;
    const emailValid = channel === "email" && isValidEmail(emailInput?.value.trim() || "");
    const phoneValid = (channel === "sms" || channel === "whatsapp") && isValidPhone();
    continueBtn.disabled = !(emailValid || phoneValid);
  }

  function prefillPhoneFromStored() {
    if (!phoneInput || !countrySelect) return;
    const stored = phoneInput.value;
    if (!stored) return;
    const digits = sanitizeDigits(stored);
    if (!digits) return;
    let matchedOption = null;
    let matchedDial = "";
    Array.from(countrySelect.options).forEach(option => {
      const dial = option.dataset.dial || "";
      if (dial && digits.startsWith(dial) && dial.length > matchedDial.length) {
        matchedDial = dial;
        matchedOption = option;
      }
    });
    if (matchedOption) {
      countrySelect.value = matchedOption.value;
      phoneInput.value = digits.slice(matchedDial.length);
    } else {
      phoneInput.value = digits;
    }
    updatePhonePlaceholder();
    updatePhoneState();
  }

  if (phoneInput) {
    phoneInput.addEventListener("input", () => {
      updatePhoneState();
      updateContinueState();
    });
  }

   if (countrySelect) {
    countrySelect.addEventListener("change", () => {
      updatePhonePlaceholder();
      updatePhoneState();
      updateContinueState();
    });
  }

  const COUNTRY_PHONE_MAX = {
    KE: 9,
    UG: 9,
    TZ: 9,
    RW: 9,
    ET: 9,
    ZA: 9,
    NG: 10,
    GH: 9,
    EG: 10,
    GB: 10,
    US: 10,
    IN: 10,
  };

  async function loadCountries() {
    if (!countrySelect) return;
    try {
      const response = await fetch(
        "https://restcountries.com/v3.1/all?fields=cca2,name,idd,flags,flag"
      );
      if (!response.ok) throw new Error("Failed to fetch countries.");
      const data = await response.json();

      const countries = data
        .map(country => {
          const root = country.idd?.root || "";
          const suffix = Array.isArray(country.idd?.suffixes)
            ? country.idd.suffixes[0]
            : "";
          const dial = root && suffix ? `${root}${suffix}` : root;
          return {
            code: country.cca2,
            name: country.name?.common || country.cca2,
            dial: dial.replace(/\D/g, ""),
            flag: country.flag || "",
            flagEmoji: country.flag || "",
            flagLabel: `${country.name?.common || country.cca2} (+${dial.replace(/\D/g, "")})`,
          };
        })
        .filter(country => country.code && country.dial)
        .sort((a, b) => a.name.localeCompare(b.name));

      countrySelect.innerHTML = "";
      countries.forEach(country => {
        const option = document.createElement("option");
        option.value = country.code;
        option.dataset.dial = country.dial;
        if (COUNTRY_PHONE_MAX[country.code]) {
          option.dataset.max = COUNTRY_PHONE_MAX[country.code];
        }
        option.textContent = `${country.flag} ${country.name} (+${country.dial})`;
        option.dataset.flagEmoji = country.flagEmoji;
        option.dataset.label = country.flagLabel;
        countrySelect.appendChild(option);
      });

      const defaultCode = countrySelect.dataset.default;
      if (defaultCode) {
        countrySelect.value = defaultCode;
      }
    } catch (error) {
      console.error(error);
      countrySelect.innerHTML = `
        <option value="KE" data-dial="254" data-max="9" data-flag-emoji="üá∞üá™" data-label="Kenya (+254)">üá∞üá™ Kenya (+254)</option>
        <option value="UG" data-dial="256" data-max="9" data-flag-emoji="üá∫üá¨" data-label="Uganda (+256)">üá∫üá¨ Uganda (+256)</option>
        <option value="TZ" data-dial="255" data-max="9" data-flag-emoji="üáπüáø" data-label="Tanzania (+255)">üáπüáø Tanzania (+255)</option>
      `;
    }
  }

  loadCountries().finally(() => {
    prefillPhoneFromStored();
    updatePhonePlaceholder();
    updatePhoneState();
    updateContinueState();
  });
   
   // =========================
  // LOADING HELPERS
  // =========================
  function disableAllButtons(except) {
    document.querySelectorAll("button").forEach(btn => {
      if (btn !== except) btn.disabled = true;
    });
  }

  function startLoading(btn) {
    if (!btn) return;
    btn.dataset.originalText = btn.innerHTML;
    btn.innerHTML = `
      <span class="spinner">
        <span></span><span></span><span></span>
      </span>
    `;
    btn.classList.add("btn-loading");
    disableAllButtons(btn);
  }

  // =========================
  // FORM SUBMIT LOGIC
  // =========================
  form.addEventListener("submit", e => {
    const action = e.submitter?.value;
    const channel = document.querySelector('input[name="channel"]:checked')?.value;

    // ---------- SEND CODE ----------
    if (action === "send_code") {
      updatePhoneState();
       
      if (channel === "email" && !emailInput.value.trim()) {
        e.preventDefault();
         if (emailError) {
          emailError.textContent = "Email is required.";
          emailError.classList.add("show");
        }
        return;
      }
      if (channel === "email" && !isValidEmail(emailInput.value.trim())) {
        e.preventDefault();
        if (emailError) {
          emailError.textContent = "Please enter a valid email address.";
          emailError.classList.add("show");
        }
        return;
      }

      if ((channel === "sms" || channel === "whatsapp") && !phoneInput.value.trim()) {
        e.preventDefault();
        alert("Phone number is required.");
        return;
      }
      if ((channel === "sms" || channel === "whatsapp") && !isValidPhone()) {
        e.preventDefault();
        alert("Enter a valid phone number for the selected country.");
        return;
      }
      
      if (phoneInput?.dataset.full) {
        phoneInput.value = phoneInput.dataset.full;
      }
       
      startLoading(e.submitter);
      return;
    }

    // ---------- VERIFY CODE ----------
    if (action === "verify_code") {
      const code = form.querySelector('input[name="code"]');
      if (!code?.value.trim()) {
        e.preventDefault();
        alert("Enter the 6-digit code.");
        return;
      }
      startLoading(e.submitter);
      return;
    }

    // ---------- SWITCH TO PASSWORD ----------
    if (action === "switch_to_password") {
      startLoading(e.submitter);
      return;
    }

    // ---------- RESEND CODE ----------
    if (action === "resend_code") {
      startLoading(e.submitter);
      return;
    }
     
   // ---------- MAGIC LINK ----------
    if (action === "magic_link") {
      startLoading(e.submitter);
      return;
    }

    // ---------- PASSWORD LOGIN / SIGNUP ----------
    if (action === "login_password" || action === "set_password") {
      const pass = form.querySelector('input[name="password"]');
      const confirm = form.querySelector('input[name="confirm_password"]');

      if (!pass?.value.trim()) {
        e.preventDefault();
        alert("Enter your password.");
        return;
      }

      if (confirm && pass.value !== confirm.value) {
        e.preventDefault();
        alert("Passwords do not match.");
        return;
      }

      startLoading(e.submitter);
    }
  });

// =========================
// OTP AUTO VERIFY (FIXED)
// =========================
const otpInput = document.querySelector('input[name="code"]');
const verifyBtn = document.querySelector('button[value="verify_code"]');

if (otpInput && verifyBtn) {
  otpInput.addEventListener("input", () => {
    otpInput.value = otpInput.value.replace(/\D/g, "");

    if (otpInput.value.length === 6) {
      startLoading(verifyBtn);

      // ‚úÖ MUST click the button, not form.submit()
      verifyBtn.click();
    }
  });
}

});
</script>

{% endblock %}
