{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Sign In or Sign Up{% endblock %}

{% block content %}
<style>
.auth-page {
  width: 100%;
  min-height: 100svh;
  margin: 0;
}

.auth-page * {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
}

.auth-page .auth-wrapper {
  width: 100%;
  min-height: 100svh;
  display: grid;
  place-items: center;
  box-sizing: border-box;
  padding: 1.5rem;
}

.auth-page .auth-box {
  width: min(100%, 410px);
  max-width: 410px;
  margin-inline: auto;
  max-height: none;
  overflow: visible;
  position: relative;
  padding: 2rem;
  border-radius: 1rem;
  background: var(--bg-card);
  box-shadow: 0 16px 40px rgba(0, 0, 0, 0.24);
  border: 1px solid color-mix(in srgb, var(--text-muted), transparent 55%);
}

.auth-page .auth-logo {
  display: grid;
  place-items: center;
  margin-bottom: 1rem;
}

.auth-page .auth-logo-img {
  width: 52px;
  height: auto;
  display: block;
  filter: drop-shadow(0 0 6px var(--glow-accent));
}

.auth-page .auth-box h2 {
  text-align: center;
  margin-bottom: 0.65rem;
  font-size: 1.45rem;
  font-weight: 650;
  color: var(--text-main);
}

.auth-page .auth-box p {
  text-align: center;
  margin-bottom: 1.35rem;
  color: var(--text-muted);
  font-size: 0.92rem;
}

.auth-page .auth-box input:not(.phone-number-input),
.auth-page .auth-box select.auth-input {
  width: 100%;
  padding: 0.65rem 0.75rem;
  margin-bottom: 0.9rem;
  border: 1px solid var(--text-muted);
  border-radius: 0.75rem;
  font-size: 0.95rem;
  background: var(--bg-surface);
  color: var(--text-main);
  transition: border-color .2s ease, box-shadow .2s ease;
}

.auth-page .auth-box input::placeholder {
  color: var(--text-muted);
}

.auth-page .auth-box input:not(.phone-number-input):focus,
.auth-page .auth-box select.auth-input:focus {
  outline: none;
  border-color: var(--text-accent);
  box-shadow: 0 0 0 3px color-mix(in srgb, var(--glow-accent), transparent 45%);
}

.auth-page .phone-group {
  display: flex;
  align-items: stretch;
  width: 100%;
  min-width: 0;
  margin-bottom: 0.9rem;
  --country-select-width: 76px;
  border: 1px solid var(--text-muted);
  border-radius: 0.75rem;
  overflow: visible;
  background: linear-gradient(180deg, var(--bg-surface), var(--bg-surface-soft));
  position: relative;
}

.auth-page .phone-group:focus-within {
  border-color: var(--text-accent);
  box-shadow: 0 0 0 3px color-mix(in srgb, var(--glow-accent), transparent 45%);
}

.auth-page .country-select {
  flex: 0 0 var(--country-select-width);
  width: var(--country-select-width);
  display: none;
}

.auth-page .country-trigger {
  flex: 0 0 var(--country-select-width);
  width: var(--country-select-width);
  border: none;
  border-right: 1px solid color-mix(in srgb, var(--text-muted), transparent 45%);
  margin-bottom: 0;
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.35rem;
  cursor: pointer;
  color: var(--text-main);
}
  
.auth-page .country-trigger:focus-visible {
  outline: 2px solid color-mix(in srgb, var(--glow-accent), transparent 35%);
  outline-offset: -2px;
}
  
.auth-page .country-flag {
  width: 22px;
  height: 16px;
  object-fit: cover;
  border-radius: 2px;
  box-shadow: 0 0 0 1px color-mix(in srgb, #fff, transparent 85%);
}

.auth-page .country-caret {
  color: var(--text-muted);
  font-size: 0.82rem;
}

.auth-page .phone-input-wrapper {
  flex: 1;
  display: flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.55rem 0.7rem;
  min-width: 0;
}

.auth-page .phone-dial {
  color: var(--text-muted);
  font-weight: 600;
  font-size: 0.9rem;
}

.auth-page .phone-number-input {
  flex: 1;
  min-width: 0;
  border: none;
  border-radius: 0;
  margin-bottom: 0;
  background: transparent;
  font-size: 0.95rem;
  color: var(--text-main);
  outline: none;
  letter-spacing: 0.09em;
  font-variant-numeric: tabular-nums;
}

.auth-page .country-menu {
  position: absolute;
  top: calc(100% + 0.45rem);
  left: 0;
  right: 0;
  z-index: 40;
  border: 1px solid color-mix(in srgb, var(--text-muted), transparent 30%);
  border-radius: 0.95rem;
  background: var(--bg-card);
  box-shadow: 0 16px 35px rgba(0, 0, 0, 0.35);
  max-height: min(280px, 45vh);
  overflow-y: auto;
  overflow-x: hidden;
  box-sizing: border-box;
}

.auth-page .country-menu.hidden {
  display: none;
}

.auth-page .country-option {
  width: 100%;
  border: none;
  background: transparent;
  color: var(--text-main);
  text-align: left;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.7rem;
  padding: 0.65rem 0.85rem;
  cursor: pointer;
}

.auth-page .country-option:hover,
.auth-page .country-option:focus-visible {
  background: var(--bg-surface-soft);
}

.auth-page .country-option-main {
  display: flex;
  align-items: center;
  gap: 0.55rem;
  min-width: 0;
}

.auth-page .country-option-label {
  white-space: normal;
  overflow: visible;
  text-overflow: unset;
  font-size: 0.9rem;
}

.auth-page .country-option-check {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 2px solid var(--text-muted);
  flex-shrink: 0;
}

.auth-page .country-option.active .country-option-check {
  border-color: var(--text-accent);
  box-shadow: inset 0 0 0 4px color-mix(in srgb, var(--glow-accent), transparent 15%);
}
/* FIX WHITE BACKGROUND ON PHONE INPUT (ANDROID / CHROME) */
.auth-page .phone-number-input,
.auth-page .phone-number-input:focus,
.auth-page .phone-number-input:active {
  background: transparent !important;
  box-shadow: none !important;
}

/* Chrome / Android autofill fix */
.auth-page .phone-number-input:-webkit-autofill,
.auth-page .phone-number-input:-webkit-autofill:hover,
.auth-page .phone-number-input:-webkit-autofill:focus {
  -webkit-text-fill-color: var(--text-main);
  -webkit-box-shadow: 0 0 0px 1000px transparent inset !important;
  transition: background-color 9999s ease-out 0s;
}

.auth-page .auth-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 0.62rem;
  margin-bottom: 0.75rem;
  border: 1px solid var(--text-muted);
  border-radius: 0.7rem;
  cursor: pointer;
  font-weight: 550;
  background: transparent;
  color: var(--text-main);
  transition: all .2s ease;
}

.auth-page .auth-btn:hover {
  border-color: var(--text-accent);
  box-shadow: 0 0 10px var(--glow-accent);
}

.auth-page .auth-btn.primary {
  border: none;
  background: linear-gradient(135deg, var(--text-accent), var(--glow-accent));
  color: var(--text-main);
  font-weight: 650;
}

.auth-page .auth-btn.primary:hover {
  filter: brightness(1.08);
}

.auth-page .auth-link {
  background: none;
  border: none;
  color: var(--text-link);
  font-size: 0.85rem;
}

.auth-page .divider {
  display: flex;
  align-items: center;
  text-align: center;
  margin: 1rem 0;
  font-size: 0.75rem;
  color: var(--text-muted);
}

.auth-page .divider::before,
.auth-page .divider::after {
  content: "";
  flex: 1;
  height: 1px;
  background: var(--text-muted);
}

.auth-page .divider:not(:empty)::before { margin-right: .5em; }
.auth-page .divider:not(:empty)::after { margin-left: .5em; }

.auth-page .hidden { display: none; }
   
.auth-page .resend-btn {
  margin-top: .7rem;
  width: 100%;
  border-radius: .65rem;
  border: 1px solid var(--text-muted);
  background: var(--bg-surface);
  padding: .55rem .7rem;
  color: var(--text-muted);
  cursor: not-allowed;
}

.auth-page .resend-btn:not(:disabled) {
  color: var(--text-link);
  cursor: pointer;
  border-color: var(--text-link);
}
   
.auth-page .channel-group {
  display: flex;
  flex-wrap: wrap;
  gap: .5rem;
  margin-bottom: .95rem;
}

.auth-page .channel-group label {
  flex: 1 1 0;
  min-width: 0;
  cursor: pointer;
}
.auth-page .channel-group input { display: none; }
   
.auth-page .channel-group span {
  display: block;
  text-align: center;
  padding: .55rem .4rem;
  border-radius: .6rem;
  border: 1px solid var(--text-muted);
  color: var(--text-muted);
  font-size: .82rem;
  white-space: nowrap;
}

.auth-page .channel-group input:checked + span {
  border-color: var(--text-accent);
  color: var(--text-main);
  box-shadow: 0 0 8px var(--glow-accent);
}

.auth-page .channel-group .whatsapp input:checked + span {
  background: var(--bg-success-soft);
  border-color: var(--text-success);
}

.auth-page .channel-group .sms input:checked + span {
  background: var(--bg-info-soft);
  border-color: var(--text-info);
}

.auth-page input[name="code"] {
  letter-spacing: .35em;
  text-align: center;
  font-weight: 650;
}

.auth-page .google-btn {
  background: var(--bg-surface);
}

.auth-page .google-btn:hover {
  background: var(--bg-surface-soft);
  border-color: var(--text-muted);
}

.auth-page .field-error {
  display: none;
  color: var(--text-danger);
  font-size: .88rem;
  margin-top: -.35rem;
  margin-bottom: .8rem;
}

.auth-page .field-error.show { display: block; }
   
.auth-page .role-selection {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin: 16px 0 10px;
}

.auth-page .role-card {
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--bg-surface-soft);
  border: 1px solid var(--text-muted);
  border-radius: 14px;
  padding: 14px 18px;
  cursor: pointer;
  font-weight: 600;
  transition: all .2s ease;
}

.auth-page .role-card:hover {
  border-color: var(--text-accent);
  background: var(--bg-info-soft);
}

.auth-page .role-card input { display: none; }
   
.auth-page .role-card input:checked + span {
  box-shadow: 0 0 14px var(--glow-accent);
  border-radius: 10px;
  padding: 4px 8px;
}

.auth-provider-wrapper .auth-btn {
  border-radius: 999px;
  background: #fff;
  color: #111827;
  border: 1px solid #e5e7eb;
  padding: 10px 14px;
}

.auth-provider-wrapper .auth-btn svg {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
}

.auth-provider-wrapper .auth-main {
  display: flex;
  align-items: center;
  gap: 10px;
  justify-content: center;
}

.auth-provider-wrapper .disabled-btn,
.auth-provider-wrapper .disabled-btn * {
  pointer-events: none;
}

.auth-provider-wrapper .disabled-btn {
  opacity: 0.6;
  cursor: not-allowed;
  white-space: nowrap;
}

.auth-provider-wrapper .coming-soon {
  display: inline;
  font-size: 12px;
  color: var(--text-muted);
}

.auth-provider-wrapper .coming-soon::before {
  content: "¬∑";
  margin: 0 6px;
}

.auth-page .spinner {
  display: inline-flex;
  gap: 4px;
}

.auth-page .spinner span {
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background: currentColor;
  animation: auth-blink 1.4s infinite both;
}

.auth-page .spinner span:nth-child(2) { animation-delay: .2s; }
.auth-page .spinner span:nth-child(3) { animation-delay: .4s; }

@keyframes auth-blink {
  0%,100% { opacity: .2; }
  20% { opacity: 1; }
}

.auth-page .btn-loading {
  pointer-events: none;
  opacity: .85;
}

.auth-page .password-wrapper {
  position: relative;
  width: 100%;
}

.auth-page .password-wrapper input {
  padding-right: 2.8rem;
}

.auth-page .auth-eye {
  position: absolute;
  top: 50%;
  right: 0.65rem;
  transform: translateY(-50%);
  border: none;
  background: none;
  cursor: pointer;
  font-size: 16px;
  opacity: .65;
}

.auth-page .auth-eye:hover {
  opacity: 1;
}

@media (max-width: 480px) {
  .auth-page .auth-wrapper { padding: .75rem; }

  .auth-page .auth-box {
    width: min(100%, 410px);
    max-width: 410px;
    padding: 1.25rem 1rem;
    max-height: none;
    overflow: visible;
  }
   
  .auth-page .auth-box input,
  .auth-page .auth-box select { font-size: 16px; }

  .auth-page .auth-box h2 { font-size: 1.25rem; }
  
  .auth-page .channel-group { gap: .4rem; }

  .auth-page .channel-group label { flex: 1 1 100%; }

  .auth-page .phone-group { --country-select-width: 82px; }
}
</style>

<div class="auth-page" data-new-user="{{ is_new_user|yesno:'true,false' }}">
  <div class="auth-wrapper">
    <div class="auth-box">

      <!-- LOGO -->
      <div class="auth-logo">
        <img
          src="https://res.cloudinary.com/dc6z1giw2/image/upload/v1769179808/ChatGPT_Image_Jan_23_2026_05_49_37_PM_j0ocdp.png"
          alt="Joblink Kenya"
          class="auth-logo-img"
        />
      </div>

      <form method="POST" action="{% url 'unified_auth' %}" novalidate>
         <input type="hidden" name="next" value="{{ next }}">
        {% csrf_token %}

        <!-- PHASE 1: UI STEP SOURCE OF TRUTH -->
        <input
          type="hidden"
          name="ui_step"
          id="uiStep"
          value="{{ ui_step|default:'email' }}"
        >

        <!-- ================= STEP 1: IDENTIFIER ================= -->
        <section
           id="step-email"
           data-step="email"
           class="{% if ui_step != 'email' %}hidden{% endif %}"
         >

          <h2>Log in or Sign up</h2>
          <p>Sign up and connect to job opportunities.</p>
           
         <div class="auth-provider-wrapper">
          <!-- GOOGLE LOGIN -->
          <button
            type="button"
            class="auth-btn google-btn"
            onclick="window.location.href='{% url 'google_login' %}';"
          >
            <span class="auth-main">
              <svg width="18" height="18" viewBox="0 0 533.5 544.3" aria-hidden="true">
                <path d="M533.5 278.4c0-17.7-1.5-34.8-4.3-51.4H272v97.4h146.9c-6.4 34.9-25.7 64.5-54.8 84.2v69h88.6c51.9-47.9 81.8-118.5 81.8-199.2z" fill="#4285F4"/>
                <path d="M272 544.3c73.7 0 135.6-24.5 180.8-66.7l-88.6-69c-24.7 16.6-56.4 26.3-92.2 26.3-70.9 0-131-47.9-152.5-112.1H31v70.3C76.1 478.5 168 544.3 272 544.3z" fill="#34A853"/>
                <path d="M119.5 323.8c-5.7-16.6-9-34.2-9-52.3s3.3-35.7 9-52.3V149H31c-18.5 36.3-29 77.2-29 122.5s10.5 86.2 29 122.5l88.5-70.2z" fill="#FBBC05"/>
                <path d="M272 107.7c39.9-.6 75.5 13.8 103.7 40.8l77.7-77.7C403.2 24.5 341.3 0 272 0 168 0 76.1 65.8 31 149l88.5 70.3C141 155.6 201.1 107.7 272 107.7z" fill="#EA4335"/>
              </svg>
              <span>Continue with Google</span>
            </span>
          </button>
  
            <!-- APPLE LOGIN -->
            <button
              type="button"
              class="auth-btn apple-btn disabled-btn"
              disabled
            >
              <span class="auth-main">
                <svg
                  width="18"
                  height="18"
                  viewBox="0 0 384 512"
                  aria-hidden="true"
                >
                  <path
                    fill="currentColor"
                    d="M318.7 268.6c-.3-37.2 16.4-65.3 51.5-86.5-19.6-28-49.1-43.4-88-46.4-37.1-3-77.6 21.6-92.5 21.6-15.3 0-51.2-20.6-79.3-20-40.8.6-78.7 23.7-99.7 60.2-42.5 73.7-10.8 182.6 30.5 242.4 20.2 29.2 44.3 62 76 60.8 30.3-1.2 41.8-19.5 78.5-19.5 36.4 0 47 19.5 79.1 18.8 32.8-.6 53.5-29.9 73.5-59.2 23.2-33.9 32.8-66.8 33.1-68.5-.7-.3-63.4-24.3-63.7-96.7z"
                  />
                  <path
                    fill="currentColor"
                    d="M256.6 76.8c17.1-20.7 28.6-49.5 25.5-78.8-24.6 1-54.3 16.4-72 36.9-15.8 18.3-29.7 47.5-26 75.6 27.4 2.1 55.3-13.9 72.5-33.7z"
                  />
                </svg>
            
                <span>Continue with Apple</span>
              </span>
            
              <span class="coming-soon">Coming soon</span>
            </button>

           <!-- MICROSOFT LOGIN -->
            <button
              type="button"
              class="auth-btn microsoft-btn disabled-btn"
              disabled
            >
              <span class="auth-main">
                <svg width="18" height="18" viewBox="0 0 23 23" aria-hidden="true">
                  <rect x="1" y="1" width="9" height="9" fill="#F25022"/>
                  <rect x="13" y="1" width="9" height="9" fill="#7FBA00"/>
                  <rect x="1" y="13" width="9" height="9" fill="#00A4EF"/>
                  <rect x="13" y="13" width="9" height="9" fill="#FFB900"/>
                </svg>
                <span>Continue with Microsoft</span>
              </span>
            
              <span class="coming-soon">Coming soon</span>
            </button>
            
          <div class="divider">OR</div>

          <!-- EMAIL -->
          <input
            type="email"
            id="emailInput"
            name="identifier"
            value="{{ request.session.auth_email|default:'' }}"
            placeholder="Email address"
            class="auth-input"
            autocomplete="email"
            required
          />
         <div class="field-error" id="emailError">Please enter a valid email address.</div>

          <!-- OTP CHANNEL -->
          <div class="channel-group">
            <label>
              <input type="radio" name="channel" value="email" checked>
              <span>Email</span>
            </label>

            <label class="sms">
              <input type="radio" name="channel" value="sms">
              <span>SMS</span>
            </label>

            <label class="whatsapp">
              <input type="radio" name="channel" value="whatsapp">
              <span>WhatsApp</span>
            </label>
          </div>

            <!-- PHONE -->
            <div class="phone-group" id="phoneGroup" style="display:none;">
              <button
                type="button"
                class="country-trigger"
                id="countryTrigger"
                aria-haspopup="listbox"
                aria-expanded="false"
                aria-label="Select country"
                disabled
              >
                <img
                  src=""
                  alt=""
                  class="country-flag"
                  id="countryFlag"
                  loading="lazy"
                >
                <span class="country-caret" aria-hidden="true">‚ñæ</span>
              </button>
              
              <select
                id="countrySelect"
                class="auth-input country-select"
                data-default="KE"
                disabled
                aria-label="Select country"
              >
                <option value="" selected disabled>Loading countries...</option>
              </select>

              <div class="phone-input-wrapper">
                <span class="phone-dial" id="phoneDial">+254</span>
                <input
                  type="tel"
                  id="phoneInput"
                  name="phone"
                  value="{{ request.session.auth_phone|default:'' }}"
                  placeholder="Phone number"
                  class="auth-input phone-number-input"
                  autocomplete="tel"
                  inputmode="numeric"
                  disabled
                >
              </div>
              
              <div class="country-menu hidden" id="countryMenu" role="listbox" aria-label="Country list"></div>
            </div>
           
          <button
            type="submit"
            name="action"
            value="send_code"
            class="auth-btn primary"
            id="continueBtn"
            disabled
          >
            Continue
          </button>

          {% include "form_errors.html" %}
        </section>

        <!-- ================= STEP 2: OTP ================= -->
        <section
           id="step-code"
           data-step="code"
           class="{% if ui_step != 'code' %}hidden{% endif %}"
         >

          <h2>Check your messages</h2>
          <p>
            Enter the code sent to
            <b>{{ request.session.auth_identifier }}</b>
          </p>

          <input
            type="text"
            name="code"
            maxlength="6"
            placeholder="6-digit code"
            class="auth-input"
            autocomplete="one-time-code"
          >

          <button
            type="submit"
            name="action"
            value="verify_code"
            class="auth-btn primary"
          >
            Verify
          </button>

          <button
            type="submit"
            name="action"
            value="resend_code"
            id="resendBtn"
            class="resend-btn"
            disabled
          >
            Resend code (<span id="countdown">30</span>s)
          </button>
           
        {% if request.session.auth_user_exists %}
          <div class="divider">OR</div>

          <button type="submit" name="action" value="switch_to_password" class="auth-btn">
             Continue with password
           </button>
        {% endif %}
      </section>

         <!-- ================= STEP 3: PASSWORD ================= -->
         <section
           id="step-password"
           data-step="password"
           class="{% if ui_step != 'password' %}hidden{% endif %}"
         >
         
           <h2>Enter your password</h2>
         
           <p><b>
             {% if request.session.otp_channel == "email" %}
               {{ request.session.auth_email|slice:":3" }}***@***
             {% elif request.session.auth_phone and request.session.auth_phone|length >= 8 %}
               {{ request.session.auth_phone|slice:":5" }}***{{ request.session.auth_phone|slice:"-3:" }}
             {% else %}
               your phone number
             {% endif %}
           </b></p>
            
            {% if is_new_user %}
           <div class="role-selection">
             {% include "partials/role_toggle.html" with role_required=True %}
           </div>
           {% endif %}
         
           <div class="password-field">
         
             <!-- PASSWORD -->
             <div class="password-wrapper">
               <input
                 type="password"
                 name="password"
                 placeholder="Password"
                 class="auth-input js-auth-password"
                 autocomplete="current-password"
                 required
               >
               <button
                 type="button"
                 class="auth-eye"
                 aria-label="Show password"
               >
                 üëÅÔ∏è
               </button>
             </div>
         
             {% if is_new_user %}
             <!-- CONFIRM PASSWORD -->
             <div class="password-wrapper">
               <input
                 type="password"
                 name="confirm_password"
                 placeholder="Confirm password"
                 class="auth-input js-auth-password"
                 autocomplete="new-password"
                 required
               >
               <button
                 type="button"
                 class="auth-eye"
                 aria-label="Show password"
               >
                 üëÅÔ∏è
               </button>
             </div>
             {% endif %}
         
           </div>
         
           <button
             type="submit"
             name="action"
             value="{% if is_new_user %}set_password{% else %}login_password{% endif %}"
             class="auth-btn primary"
           >
             {% if is_new_user %}Create account{% else %}Continue{% endif %}
           </button>
            
            {% if not is_new_user %}
           <a href="{% url 'password_reset' %}" class="auth-link">
             Forgot password?
           </a>
         
           <div class="divider">OR</div>
         
           <button
             type="submit"
             name="action"
             value="magic_link"
             class="auth-btn"
           >
             Log in with one-time code
           </button>
            {% endif %}
            
         </section>

      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // =========================
  // CONFIG
  // =========================
  const RESEND_COOLDOWN = 30;
  let resendTimer = null;

  // =========================
  // ELEMENTS
  // =========================
  const form = document.querySelector("form");
  if (!form) return;

  form.setAttribute("novalidate", "true");

  const uiStepInput = document.getElementById("uiStep");

  const steps = {
    email: document.getElementById("step-email"),
    code: document.getElementById("step-code"),
    password: document.getElementById("step-password"),
  };

  const emailInput = document.getElementById("emailInput");
  const emailError = document.getElementById("emailError");
  const phoneInput = document.getElementById("phoneInput");
  const phoneGroup = document.getElementById("phoneGroup");
  const countrySelect = document.getElementById("countrySelect");
  const countryFlag = document.getElementById("countryFlag");
  const countryTrigger = document.getElementById("countryTrigger");
  const countryMenu = document.getElementById("countryMenu");
  const phoneDial = document.getElementById("phoneDial");
  const continueBtn = document.getElementById("continueBtn");
  const channelRadios = document.querySelectorAll('input[name="channel"]');

  // =========================
  // STEP CONTROL
  // =========================
  function setStep(step) {
    Object.values(steps).forEach(el => el && el.classList.add("hidden"));
    steps[step]?.classList.remove("hidden");
  }

  if (uiStepInput?.value && steps[uiStepInput.value]) {
    setStep(uiStepInput.value);
    if (uiStepInput.value === "code") {
      startResendCooldown();
    }
  } else {
    setStep("email");
  }

  // =========================
  // SHOW / HIDE PASSWORD
  // =========================
  document.querySelector('.auth-page')?.addEventListener('click', e => {
    const eye = e.target.closest('.auth-eye');
    if (!eye) return;

    const wrapper = eye.closest('.password-wrapper');
    const input = wrapper.querySelector('input');

    if (!input) return;

    const hidden = input.type === 'password';
    input.type = hidden ? 'text' : 'password';
    eye.textContent = hidden ? 'üôà' : 'üëÅÔ∏è';
  });

  // =========================
  // RESEND COOLDOWN
  // =========================
  function startResendCooldown() {
    const resendBtn = document.getElementById("resendBtn");
    const countdown = document.getElementById("countdown");
    if (!resendBtn || !countdown) return;

    let remaining = RESEND_COOLDOWN;
    resendBtn.disabled = true;
    countdown.textContent = remaining;

    clearInterval(resendTimer);
    resendTimer = setInterval(() => {
      remaining--;
      countdown.textContent = remaining;

      if (remaining <= 0) {
        clearInterval(resendTimer);
        resendBtn.disabled = false;
        countdown.textContent = RESEND_COOLDOWN;
      }
    }, 1000);
  }

  // =========================
  // CHANNEL TOGGLE
  // =========================
  function renderCountryMenu() {
    if (!countryMenu || !countrySelect) return;
    const selectedCode = countrySelect.value;
    countryMenu.innerHTML = "";

    Array.from(countrySelect.options).forEach(option => {
      const item = document.createElement("button");
      item.type = "button";
      item.className = "country-option";
      item.setAttribute("role", "option");
      item.dataset.code = option.value;
      if (option.value === selectedCode) {
        item.classList.add("active");
        item.setAttribute("aria-selected", "true");
      } else {
        item.setAttribute("aria-selected", "false");
      }

      const flagSrc = getFlagSrc(option.value, option.dataset.flagSrc || "");
      item.innerHTML = `
        <span class="country-option-main">
          <img src="${flagSrc}" alt="" class="country-flag" loading="lazy">
          <span class="country-option-label">${option.dataset.label || option.textContent}</span>
        </span>
        <span class="country-option-check" aria-hidden="true"></span>
      `;

      item.addEventListener("click", () => {
        countrySelect.value = option.value;
        countrySelect.dispatchEvent(new Event("change"));
        closeCountryMenu();
      });

      countryMenu.appendChild(item);
    });
  }

  function openCountryMenu() {
    if (!countryMenu || !countryTrigger || countryTrigger.disabled) return;
    countryMenu.classList.remove("hidden");
    countryTrigger.setAttribute("aria-expanded", "true");
  }

  function closeCountryMenu() {
    if (!countryMenu || !countryTrigger) return;
    countryMenu.classList.add("hidden");
    countryTrigger.setAttribute("aria-expanded", "false");
  }

  if (countryTrigger) {
    countryTrigger.addEventListener("click", () => {
      if (countryMenu?.classList.contains("hidden")) {
        openCountryMenu();
      } else {
        closeCountryMenu();
      }
    });
  }

  document.addEventListener("click", event => {
    if (!countryMenu || !countryTrigger || !phoneGroup) return;
    if (!phoneGroup.contains(event.target)) {
      closeCountryMenu();
    }
  });
  
  function syncChannelFields() {
    const checked = document.querySelector('input[name="channel"]:checked');
    if (!checked) return;

    const email = checked.value === "email";

    emailInput.disabled = !email;
    emailInput.style.display = email ? "block" : "none";
    if (!email) emailInput.value = "";
    if (emailError) emailError.classList.remove("show");

    if (phoneGroup) {
      phoneGroup.style.display = email ? "none" : "flex";
    }
    if (countrySelect) {
      countrySelect.disabled = email;
    }
    if (countryTrigger) {
      countryTrigger.disabled = email;
      if (email) closeCountryMenu();
    }
    if (phoneInput) {
      phoneInput.disabled = email;
      if (email) phoneInput.value = "";
    }
    updatePhoneState();
    updateContinueState();
  }

  channelRadios.forEach(r => r.addEventListener("change", syncChannelFields));
  syncChannelFields();

  function isValidEmail(value) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
  }

  if (emailInput) {
    emailInput.addEventListener("input", () => {
      if (emailError) emailError.classList.remove("show");
             updateContinueState();
    });
  }

  function getCountryMeta() {
    const option = countrySelect?.selectedOptions?.[0];
    if (!option) return { dial: "", max: 0 };
    return {
      dial: option.dataset.dial || "",
      max: parseInt(option.dataset.max || "0", 10),
    };
  }

  function getFlagSrc(code, source) {
    if (source) return source;
    if (!code || code.length !== 2) return "";
    return `https://flagsapi.com/${code.toUpperCase()}/flat/64.png`;
  }
  
  function updateCountryFlag() {
    if (!countryFlag || !countrySelect) return;
    const option = countrySelect.selectedOptions?.[0];
    if (!option) return;
    const label = option.dataset.label || option.textContent || "Select country";
    const flagSrc = getFlagSrc(option.value, option.dataset.flagSrc || "");
    countryFlag.src = flagSrc;
    countryFlag.alt = label;
    if (countryTrigger) {
      countryTrigger.setAttribute("aria-label", label);
    }
    countrySelect.setAttribute("aria-label", label);
    renderCountryMenu();
  }

  function sanitizeDigits(value) {
    return value.replace(/\D/g, "");
  }

  function formatPhoneDisplay(value) {
    return value.replace(/(\d{3})(?=\d)/g, "$1 ").trim();
  }

  function updatePhoneState() {
    if (!phoneInput || !countrySelect) return;
    const { dial, max } = getCountryMeta();
    const digits = sanitizeDigits(phoneInput.value);
    const trimmed = max ? digits.slice(0, max) : digits;
    const formatted = formatPhoneDisplay(trimmed);
    if (phoneInput.value !== formatted) phoneInput.value = formatted;
    if (max) {
      phoneInput.maxLength = max + Math.floor((max - 1) / 3);
    }
    phoneInput.dataset.full = trimmed ? `+${dial}${trimmed}` : "";
    if (phoneDial) {
      phoneDial.textContent = dial ? `+${dial}` : "";
    }
     updateCountryFlag();
  }

  function updatePhonePlaceholder() {
    if (!phoneInput) return;
    const { max } = getCountryMeta();
    phoneInput.placeholder = max
      ? `Phone number (${max} digits)`
      : "Phone number";
  }

  function isValidPhone() {
    if (!phoneInput || !countrySelect) return false;
    const { max } = getCountryMeta();
    const digits = sanitizeDigits(phoneInput.value);
    if (max) return digits.length === max;
    return digits.length >= 6 && digits.length <= 15;
  }

  function updateContinueState() {
    if (!continueBtn) return;
    const channel = document.querySelector('input[name="channel"]:checked')?.value;
    const emailValid = channel === "email" && isValidEmail(emailInput?.value.trim() || "");
    const phoneValid = (channel === "sms" || channel === "whatsapp") && isValidPhone();
    continueBtn.disabled = !(emailValid || phoneValid);
  }

  function prefillPhoneFromStored() {
    if (!phoneInput || !countrySelect) return;
    const stored = phoneInput.value;
    if (!stored) return;
    const digits = sanitizeDigits(stored);
    if (!digits) return;
    let matchedOption = null;
    let matchedDial = "";
    Array.from(countrySelect.options).forEach(option => {
      const dial = option.dataset.dial || "";
      if (dial && digits.startsWith(dial) && dial.length > matchedDial.length) {
        matchedDial = dial;
        matchedOption = option;
      }
    });
    if (matchedOption) {
      countrySelect.value = matchedOption.value;
      phoneInput.value = digits.slice(matchedDial.length);
    } else {
      phoneInput.value = digits;
    }
    updatePhonePlaceholder();
    updatePhoneState();
  }

  if (phoneInput) {
    phoneInput.addEventListener("input", () => {
      updatePhoneState();
      updateContinueState();
    });
  }

   if (countrySelect) {
    countrySelect.addEventListener("change", () => {
      updatePhonePlaceholder();
      updatePhoneState();
      updateContinueState();
    });
  }

  const COUNTRY_PHONE_MAX = {
    KE: 9,
    UG: 9,
    TZ: 9,
    RW: 9,
    ET: 9,
    ZA: 9,
    NG: 10,
    GH: 9,
    EG: 10,
    GB: 10,
    US: 10,
    IN: 10,
  };

  async function loadCountries() {
    if (!countrySelect) return;
    try {
      const response = await fetch(
        "https://restcountries.com/v3.1/all?fields=cca2,name,idd,flags,flag"
      );
      if (!response.ok) throw new Error("Failed to fetch countries.");
      const data = await response.json();

      const countries = data
        .map(country => {
          const root = country.idd?.root || "";
          const suffix = Array.isArray(country.idd?.suffixes)
            ? country.idd.suffixes[0]
            : "";
          const dial = root && suffix ? `${root}${suffix}` : root;
          return {
            code: country.cca2,
            name: country.name?.common || country.cca2,
            dial: dial.replace(/\D/g, ""),
            flagLabel: `${country.name?.common || country.cca2} (+${dial.replace(/\D/g, "")})`,
            flagSrc: country.flags?.png || country.flags?.svg || "",
          };
        })
        .filter(country => country.code && country.dial)
        .sort((a, b) => a.name.localeCompare(b.name));

      countrySelect.innerHTML = "";
      countries.forEach(country => {
        const option = document.createElement("option");
        option.value = country.code;
        option.dataset.dial = country.dial;
        if (COUNTRY_PHONE_MAX[country.code]) {
          option.dataset.max = COUNTRY_PHONE_MAX[country.code];
        }
        option.textContent = `${country.name} (+${country.dial})`;
        option.dataset.flagSrc = getFlagSrc(country.code, country.flagSrc);
        option.dataset.label = country.flagLabel;
        countrySelect.appendChild(option);
      });

      const defaultCode = countrySelect.dataset.default;
      if (defaultCode) {
        countrySelect.value = defaultCode;
      }
    } catch (error) {
      console.error(error);
      countrySelect.innerHTML = `
        <option value="KE" data-dial="254" data-max="9" data-label="Kenya (+254)">Kenya (+254)</option>
        <option value="UG" data-dial="256" data-max="9" data-label="Uganda (+256)">Uganda (+256)</option>
        <option value="TZ" data-dial="255" data-max="9" data-label="Tanzania (+255)">Tanzania (+255)</option>
      `;
    }
  }

  loadCountries().finally(() => {
    prefillPhoneFromStored();
    updatePhonePlaceholder();
    updatePhoneState();
    updateContinueState();
  });
   
   // =========================
  // LOADING HELPERS
  // =========================
  function disableAllButtons(except) {
    document.querySelectorAll("button").forEach(btn => {
      if (btn !== except) btn.disabled = true;
    });
  }

  function startLoading(btn) {
    if (!btn) return;
    btn.dataset.originalText = btn.innerHTML;
    btn.innerHTML = `
      <span class="spinner">
        <span></span><span></span><span></span>
      </span>
    `;
    btn.classList.add("btn-loading");
    disableAllButtons(btn);
  }

  // =========================
  // FORM SUBMIT LOGIC
  // =========================
  form.addEventListener("submit", e => {
    const action = e.submitter?.value;
    const channel = document.querySelector('input[name="channel"]:checked')?.value;

    // ---------- SEND CODE ----------
    if (action === "send_code") {
      updatePhoneState();
       
      if (channel === "email" && !emailInput.value.trim()) {
        e.preventDefault();
         if (emailError) {
          emailError.textContent = "Email is required.";
          emailError.classList.add("show");
        }
        return;
      }
      if (channel === "email" && !isValidEmail(emailInput.value.trim())) {
        e.preventDefault();
        if (emailError) {
          emailError.textContent = "Please enter a valid email address.";
          emailError.classList.add("show");
        }
        return;
      }

      if ((channel === "sms" || channel === "whatsapp") && !phoneInput.value.trim()) {
        e.preventDefault();
        alert("Phone number is required.");
        return;
      }
      if ((channel === "sms" || channel === "whatsapp") && !isValidPhone()) {
        e.preventDefault();
        alert("Enter a valid phone number for the selected country.");
        return;
      }
      
      if (phoneInput?.dataset.full) {
        phoneInput.value = phoneInput.dataset.full;
      }
       
      startLoading(e.submitter);
      return;
    }

    // ---------- VERIFY CODE ----------
    if (action === "verify_code") {
      const code = form.querySelector('input[name="code"]');
      if (!code?.value.trim()) {
        e.preventDefault();
        alert("Enter the 6-digit code.");
        return;
      }
      startLoading(e.submitter);
      return;
    }

    // ---------- SWITCH TO PASSWORD ----------
    if (action === "switch_to_password") {
      startLoading(e.submitter);
      return;
    }

    // ---------- RESEND CODE ----------
    if (action === "resend_code") {
      startLoading(e.submitter);
      return;
    }
     
   // ---------- MAGIC LINK ----------
    if (action === "magic_link") {
      startLoading(e.submitter);
      return;
    }

    // ---------- PASSWORD LOGIN / SIGNUP ----------
    if (action === "login_password" || action === "set_password") {
      const pass = form.querySelector('input[name="password"]');
      const confirm = form.querySelector('input[name="confirm_password"]');

      if (!pass?.value.trim()) {
        e.preventDefault();
        alert("Enter your password.");
        return;
      }

      if (confirm && pass.value !== confirm.value) {
        e.preventDefault();
        alert("Passwords do not match.");
        return;
      }

      startLoading(e.submitter);
    }
  });

// =========================
// OTP AUTO VERIFY (FIXED)
// =========================
const otpInput = document.querySelector('input[name="code"]');
const verifyBtn = document.querySelector('button[value="verify_code"]');

if (otpInput && verifyBtn) {
  otpInput.addEventListener("input", () => {
    otpInput.value = otpInput.value.replace(/\D/g, "");

    if (otpInput.value.length === 6) {
      startLoading(verifyBtn);

      // ‚úÖ MUST click the button, not form.submit()
      verifyBtn.click();
    }
  });
}

});
</script>

{% endblock %}
