{% extends 'base.html' %}
{% load humanize %}
{% load widget_tweaks %}

{% block title %}Available Jobs{% endblock %}

{% block content %}
<div class="available-jobs-page">

<style>
/* =========================================================
   BASE
========================================================= */
.available-jobs-page {
  background: var(--bg-main);
  color: var(--text-main);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
}

.available-jobs-page .container {
  max-width: 1100px;
  margin: 30px auto;
  padding: 16px;
}

/* =========================================================
   SECTION TITLES
========================================================= */
.available-jobs-page h2 {
  font-size: 20px;
  font-weight: 700;
  margin: 28px 0 14px;
  color: var(--accent);
  border-bottom: 1px solid var(--accent-glow);
  padding-bottom: 6px;
}

/* =========================================================
   JOB CARDS (COMMON)
========================================================= */
.available-jobs-page .job-card {
  background: var(--bg-card);
  padding: 18px;
  border-radius: 14px;
  margin-bottom: 18px;
  border-left: 4px solid var(--accent);
  box-shadow: 0 6px 22px rgba(0,0,0,0.08);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.available-jobs-page .job-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.12);
}

/* =========================================================
   PREMIUM JOBS
========================================================= */
.available-jobs-page .premium-job {
  border-left-color: gold;
  background: linear-gradient(180deg, rgba(255,215,0,0.08), var(--bg-card));
}

/* =========================================================
   JOB CONTENT
========================================================= */
.available-jobs-page .job-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 6px;
  color: var(--accent);
}

.available-jobs-page .premium-job .job-title {
  color: #b8860b;
}

.available-jobs-page .job-meta,
.available-jobs-page .job-category,
.available-jobs-page .job-salary,
.available-jobs-page .job-expiry,
.available-jobs-page .job-posted {
  font-size: 14px;
  color: var(--text-muted);
  margin: 4px 0;
}

.available-jobs-page .icon {
  margin-right: 4px;
}

/* =========================================================
   PREMIUM BADGE
========================================================= */
.available-jobs-page .premium-badge {
  background: gold;
  color: #000;
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 14px;
  margin-left: 8px;
  font-weight: 600;
  vertical-align: middle;
}

/* =========================================================
   APPLY BUTTON
========================================================= */
.available-jobs-page .apply-link {
  display: inline-block;
  margin-top: 14px;
  padding: 10px 22px;
  border-radius: 22px;
  background: var(--accent);
  color: #fff;
  font-weight: 600;
  font-size: 14px;
  text-decoration: none;
  transition: background 0.2s ease, transform 0.2s ease;
}

.available-jobs-page .apply-link:hover {
  background: var(--accent-dark, var(--accent));
  transform: translateY(-1px);
}

/* =========================================================
   FILTER BAR
========================================================= */
.available-jobs-page .filter-bar {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  background: var(--bg-card);
  padding: 14px;
  border-radius: 14px;
  box-shadow: 0 6px 22px rgba(0,0,0,0.08);
  margin-bottom: 24px;
}

.available-jobs-page .filter-bar input,
.available-jobs-page .filter-bar select,
.available-jobs-page .filter-bar button {
  padding: 11px 12px;
  border-radius: 10px;
  border: 1px solid var(--accent-glow);
  background: var(--bg-main);
  color: var(--text-main);
  font-size: 15px;
}

.available-jobs-page .filter-bar input {
  flex: 2 1 260px;
}

.available-jobs-page .filter-bar select {
  flex: 1 1 160px;
}

.available-jobs-page .filter-bar button {
  background: var(--accent);
  color: #fff;
  border: none;
  font-weight: 600;
  cursor: pointer;
}

.available-jobs-page .filter-bar button:hover {
  opacity: 0.9;
}

/* =========================================================
   MESSAGES
========================================================= */
.available-jobs-page .messages {
  text-align: center;
  margin-bottom: 20px;
}

.available-jobs-page .message-text {
  display: inline-block;
  padding: 10px 20px;
  border-radius: 20px;
  font-weight: 600;
  color: #fff;
  font-size: 14px;
  margin-bottom: 10px;
}

.available-jobs-page .message-text.success {
  background: #16a34a;
}

.available-jobs-page .message-text.error {
  background: #dc2626;
}

/* =========================================================
   EMPTY STATES
========================================================= */
.available-jobs-page .no-jobs,
.available-jobs-page .no-jobs-message {
  color: var(--text-muted);
  font-style: italic;
  margin-top: 12px;
}

/* =========================================================
   COMPANY LOGO
========================================================= */
.available-jobs-page .company-logo-img {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  border: 1px solid #ddd;
  object-fit: cover;
}

/* =========================================================
   LOADER
========================================================= */
.available-jobs-page .loader {
  text-align: center;
  padding: 16px;
  font-size: 14px;
  color: var(--text-muted);
}

/* =========================================================
   MOBILE
========================================================= */
@media (max-width: 640px) {
  .available-jobs-page .filter-bar {
    flex-direction: column;
  }

  .available-jobs-page .job-title {
    font-size: 17px;
  }
}
</style>

<div class="container">

  <!-- PAGE TITLE -->
  <h1>Available Jobs in Kenya</h1>

  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <p class="message-text {% if message.tags %}{{ message.tags }}{% endif %}">
          {{ message }}
        </p>
      {% endfor %}
    </div>
  {% endif %}

  <!-- üîç UNIFIED SEARCH BAR -->
  <form method="get" class="filter-bar" id="filterForm" novalidate>

    <!-- Unified search input -->
    <input
      type="text"
      name="q"
      id="searchInput"
      list="searchSuggestions"
      placeholder="Search job title, category, or location‚Ä¶"
      value="{{ q|default:'' }}"
      autocomplete="off"
      aria-label="Search jobs"
    >

    <datalist id="searchSuggestions"></datalist>

    <!-- Sort -->
    <select name="sort" id="sortSelect" aria-label="Sort jobs">
      <option value="">Sort results</option>
      <option value="newest" {% if sort == "newest" %}selected{% endif %}>
        Newest first
      </option>
      <option value="expiry_asc" {% if sort == "expiry_asc" %}selected{% endif %}>
        Expiring soon
      </option>
      <option value="expiry_desc" {% if sort == "expiry_desc" %}selected{% endif %}>
        Expiring later
      </option>
    </select>

    <!-- Fallback submit (hidden but accessible) -->
    <button type="submit" class="sr-only">
      Search
    </button>

  </form>

  <!-- ‚≠ê FEATURED JOBS -->
  <h2>Featured Jobs</h2>

  {% for job in premium_jobs %}
    <div class="job-card premium-job">

      <div class="job-title">
        {{ job.title }}
        <span class="premium-badge">Featured</span>
      </div>

      <p class="job-meta">
        üè¢ {{ job.company }} &nbsp; | &nbsp; üìç {{ job.location }}
      </p>

      {% if job.category %}
        <p class="job-category">
          Category: {{ job.category.name }}
        </p>
      {% endif %}

      {% if job.salary %}
        <p class="job-salary">
          Salary: KES {{ job.salary|intcomma }}
        </p>
      {% endif %}

      {% if job.expiry_date %}
        <p class="job-expiry">
          Expires: {{ job.expiry_date|date:"M d, Y" }}
        </p>
      {% endif %}

      <p class="job-posted">
        Posted: {{ job.posted_on|date:"M d, Y" }}
      </p>

      <a href="{% url 'apply_job' job.id %}" class="apply-link">
        Apply Now
      </a>
    </div>
  {% empty %}
    <p class="no-jobs">
      No featured jobs available at the moment.
    </p>
  {% endfor %}

  <!-- üíº REGULAR JOBS -->
  <h2>Available Jobs</h2>

  {% for job in jobs %}
    <div class="job-card normal-job">

      <div class="job-title">
        {{ job.title }}
      </div>

      <p class="job-meta">
        üè¢ {{ job.company }} &nbsp; | &nbsp; üìç {{ job.location }}
      </p>

      {% if job.category %}
        <p class="job-category">
          Category: {{ job.category.name }}
        </p>
      {% endif %}

      {% if job.salary %}
        <p class="job-salary">
          Salary: KES {{ job.salary|intcomma }}
        </p>
      {% endif %}

      {% if job.expiry_date %}
        <p class="job-expiry">
          Expires: {{ job.expiry_date|date:"M d, Y" }}
        </p>
      {% endif %}

      <p class="job-posted">
        Posted: {{ job.posted_on|date:"M d, Y" }}
      </p>

      <a href="{% url 'apply_job' job.id %}" class="apply-link">
        Apply Now
      </a>
    </div>
  {% empty %}
    <p class="no-jobs">
      No jobs found. Try adjusting your search.
    </p>
  {% endfor %}

</div>
  
<script>
document.addEventListener("DOMContentLoaded", () => {

  /* =====================================================
     1. AUTO-DISMISS FLASH MESSAGES
  ===================================================== */
  const msgs = document.querySelectorAll('.available-jobs-page .message-text');
  if (msgs.length) {
    setTimeout(() => {
      msgs.forEach((msg, index) => {
        setTimeout(() => {
          msg.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
          msg.style.opacity = '0';
          msg.style.transform = 'translateY(-12px)';
          setTimeout(() => msg.remove(), 700);
        }, index * 120);
      });
    }, 3500);
  }

  /* =====================================================
     2. UNIFIED SEARCH AUTOCOMPLETE
        (Job Titles + Categories + Locations)
  ===================================================== */
  const searchInput = document.getElementById("searchInput");
  const searchData  = document.getElementById("searchSuggestions");
  let searchTimer;

  if (searchInput && searchData) {
    searchInput.addEventListener("keyup", e => {
      const q = e.target.value.trim();
      if (q.length < 2) return; // minimum 2 chars to trigger
      clearTimeout(searchTimer);

      searchTimer = setTimeout(async () => {
        searchData.innerHTML = "";
        try {
          const [titlesRes, categoriesRes, locationsRes] = await Promise.all([
            fetch("{% url 'api_job_titles' %}?q=" + encodeURIComponent(q)),
            fetch("{% url 'api_categories' %}?q=" + encodeURIComponent(q)),
            fetch("{% url 'api_locations' %}?q=" + encodeURIComponent(q))
          ]);

          const [titlesData, categoriesData, locationsData] = await Promise.all([
            titlesRes.json(),
            categoriesRes.json(),
            locationsRes.json()
          ]);

          const suggestions = [
            ...(titlesData.titles || []),
            ...(categoriesData.categories || []),
            ...(locationsData.locations || [])
          ];

          // Remove duplicates
          const uniqueSuggestions = [...new Set(suggestions)];

          uniqueSuggestions.forEach(item => {
            const option = document.createElement("option");
            option.value = item;
            searchData.appendChild(option);
          });

        } catch (err) {
          console.warn("Unified search autocomplete failed:", err);
        }
      }, 300);
    });
  }

  /* =====================================================
     3. FILTER SUBMISSION (AJAX SAFE)
  ===================================================== */
  async function submitFilters() {
    const form = document.getElementById("filterForm");
    const url = new URL(window.location.href);
    const fd = new FormData(form);

    url.search = ""; // reset old query params
    fd.forEach((v, k) => {
      if (v) url.searchParams.append(k, v);
    });

    try {
      const res = await fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } });
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, "text/html");
      const newCards = doc.querySelectorAll(".job-card");
      const container = document.querySelector(".available-jobs-page .container");

      // Remove old job cards
      container.querySelectorAll(".job-card").forEach(c => c.remove());
      // Append new job cards
      newCards.forEach(c => container.appendChild(c));

      // Update next-page-link for infinite scroll
      const next = document.getElementById("next-page-link");
      const newNext = doc.getElementById("next-page-link");
      if (next) {
        if (newNext) next.href = newNext.href;
        else next.remove();
      }

    } catch (err) {
      console.error("Filter submission failed:", err);
    }
  }

  /* =====================================================
     4. TRIGGERS
  ===================================================== */
  ["searchInput", "sortSelect"]
    .forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("change", submitFilters);
    });

  // Live submit while typing (debounced)
  let typing;
  if (searchInput) {
    searchInput.addEventListener("keyup", () => {
      clearTimeout(typing);
      typing = setTimeout(submitFilters, 500);
    });
  }

});
</script>

{% endblock %}
