{% extends 'base.html' %}

{% block title %}Available Jobs{% endblock %}

{% block content %}
<div class="available-jobs-page">

<style>
.available-jobs-page body {
  background: var(--bg-main);
  font-family: Arial, sans-serif;
  color: var(--text-main);
}

/* Layout */
.available-jobs-page .container {
  margin-top: 40px;
  padding: 20px;
}

/* Section titles */
.available-jobs-page h2 {
  font-size: 24px;
  margin-bottom: 16px;
  color: var(--accent);
  border-bottom: 2px solid var(--accent);
  padding-bottom: 6px;
}

/* Job cards */
.available-jobs-page .premium-job,
.available-jobs-page .normal-job {
  padding: 20px;
  border-radius: 14px;
  margin-bottom: 20px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.2);
  border-left: 5px solid;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

/* Premium */
.available-jobs-page .premium-job {
  background: linear-gradient(135deg, #6a00ff, #4b0082);
  border-color: gold;
  box-shadow: 0 0 25px rgba(255,215,0,0.35);
}

/* Normal */
.available-jobs-page .normal-job {
  background: var(--bg-card);
  border-color: var(--accent);
}

/* Hover */
.available-jobs-page .premium-job:hover,
.available-jobs-page .normal-job:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 35px var(--accent-glow);
}

/* Titles */
.available-jobs-page .job-title {
  font-size: 20px;
  font-weight: bold;
  margin-bottom: 6px;
  color: gold;
}
.available-jobs-page .normal-job .job-title {
  color: var(--accent);
}

/* Meta */
.available-jobs-page .job-meta {
  font-size: 14px;
  margin: 3px 0;
  color: var(--text-muted);
}

/* Apply link */
.available-jobs-page .apply-link {
  display: inline-block;
  margin-top: 10px;
  color: var(--accent);
  text-decoration: none;
  border-bottom: 1px dashed var(--accent);
  transition: all 0.3s ease;
}

.available-jobs-page .apply-link:hover {
  color: var(--text-main);
  border-color: var(--text-main);
}

/* Premium badge */
.available-jobs-page .premium-badge {
  background: gold;
  color: #000;
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 20px;
  margin-left: 10px;
  font-weight: bold;
}

/* Empty state */
.available-jobs-page .no-jobs {
  color: var(--text-muted);
  font-style: italic;
}

/* Messages */
.available-jobs-page .messages {
  margin-bottom: 20px;
  text-align: center;
}

.available-jobs-page .message-text {
  display: inline-block;
  padding: 12px 22px;
  border-radius: 25px;
  font-weight: bold;
  color: #fff;
  font-size: 1rem;
  transition: opacity 1s ease, transform 0.3s ease;
  box-shadow: 0 0 15px var(--accent-glow);
  margin-bottom: 10px;
}

.available-jobs-page .message-text.success {
  background: linear-gradient(90deg, var(--success), #00cc66);
}

.available-jobs-page .message-text.error {
  background: linear-gradient(90deg, var(--error), #ff2a39);
}

/* Company real image */
.available-jobs-page .company-logo-img {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  border: 1px solid #ddd;
  object-fit: cover;
}

/* Icons alignment */
.available-jobs-page .icon {
  margin-right: 4px;
}

/* Infinite scroll loader */
.available-jobs-page .loader {
  text-align: center;
  padding: 15px;
  font-size: 14px;
  color: #888;
}
</style>

<div class="container">

  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <p class="message-text {% if message.tags %}{{ message.tags }}{% endif %}">{{ message }}</p>
      {% endfor %}
    </div>
  {% endif %}

  {# üîç SEARCH + FILTER CONTROLS #}
  <form method="get" class="mb-3" id="filterForm" style="margin-bottom:20px;">
    <input type="text" name="search" placeholder="Search by title" value="{{ search }}">

    <select name="category">
      <option value="">All Categories</option>
      <option value="IT" {% if category == "IT" %}selected{% endif %}>IT</option>
      <option value="Marketing" {% if category == "Marketing" %}selected{% endif %}>Marketing</option>
      <option value="Finance" {% if category == "Finance" %}selected{% endif %}>Finance</option>
    </select>

    <select name="location">
      <option value="">Anywhere</option>
      <option value="Nairobi" {% if location == "Nairobi" %}selected{% endif %}>Nairobi</option>
      <option value="Remote" {% if location == "Remote" %}selected{% endif %}>Remote</option>
    </select>

    <button type="submit">Search</button>
  </form>

  <h2>üåü Featured Jobs</h2>
  {% for job in premium_jobs %}
    <div class="premium-job job-card">
      <div class="company-row">
        {% if job.logo %}
          <img src="{{ job.logo.url }}" class="company-logo-img" alt="{{ job.company }}">
        {% else %}
          <div class="company-logo"></div>
        {% endif %}
        <p>{{ job.company }}</p>
      </div>

      <div class="job-title">
        {{ job.title }} <span class="premium-badge">Premium</span>
      </div>

      <p class="job-meta">
        <span class="icon">üìç</span> {{ job.location }}
      </p>

      <div class="apply-info">
        <span class="deadline" data-deadline="{{ job.deadline|date:'Y-m-d' }}">Loading‚Ä¶</span>
        <span class="posted"><span class="icon">üïí</span> Posted: {{ job.posted_date|date:"M d, Y" }}</span>
      </div>

      <a href="{% url 'apply_job' job.id %}" class="apply-link">Apply Now</a>
    </div>
  {% empty %}
    <p class="no-jobs">No premium jobs at the moment.</p>
  {% endfor %}

  <h2>üíº Free Jobs</h2>
  {% for job in jobs %}
    <div class="normal-job job-card">
      <div class="company-row">
        {% if job.logo %}
          <img src="{{ job.logo.url }}" class="company-logo-img" alt="{{ job.company }}">
        {% else %}
          <div class="company-logo"></div>
        {% endif %}
        <p>{{ job.company }}</p>
      </div>

      <div class="job-title">{{ job.title }}</div>

      <p class="job-meta">
        <span class="icon">üìç</span> {{ job.location }}
      </p>

      <div class="apply-info">
        <span class="deadline" data-deadline="{{ job.deadline|date:'Y-m-d' }}">Loading‚Ä¶</span>
        <span class="posted"><span class="icon">üïí</span> Posted: {{ job.posted_date|date:"M d, Y" }}</span>
      </div>

      <a href="{% url 'apply_job' job.id %}" class="apply-link">Apply Now</a>
    </div>
  {% empty %}
    <p class="no-jobs">No jobs found at the moment.</p>
  {% endfor %}
</div>

{# üìÑ infinite scroll paging link (includes filters!) #}
{% if jobs.has_next %}
  <a id="next-page-link"
     href="?page={{ jobs.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if category %}&category={{ category }}{% endif %}{% if location %}&location={{ location }}{% endif %}"
     hidden></a>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", () => {
  /* -----------------------------
     1) AUTO-DISMISS FLASH MESSAGES
  ------------------------------ */
  const msgs = document.querySelectorAll('.available-jobs-page .message-text');
  if (msgs.length) {
    setTimeout(() => {
      msgs.forEach((msg, index) => {
        setTimeout(() => {
          msg.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
          msg.style.opacity = '0';
          msg.style.transform = 'translateY(-12px)';
          setTimeout(() => msg.remove(), 700);
        }, index * 120);
      });
    }, 3500);
  }

  /* -----------------------------
     2) DEADLINE COUNTDOWN
  ------------------------------ */
  function updateDeadlines() {
    const elements = document.querySelectorAll('.available-jobs-page .deadline');
    elements.forEach(el => {
      const dateStr = el.dataset.deadline;
      if (!dateStr) return;

      const deadline = new Date(dateStr);
      const today = new Date();
      const diff = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));

      if (diff > 1) el.textContent = `${diff} days left to apply`;
      else if (diff === 1) el.textContent = `1 day left to apply`;
      else if (diff === 0) el.textContent = `Last day to apply`;
      else el.textContent = `Closed`;
    });
  }
  updateDeadlines();

  /* -----------------------------
     3) INFINITE SCROLL LOADER
  ------------------------------ */
  let loading = false;
  window.addEventListener('scroll', () => {
    if (loading) return;
    if ((window.innerHeight + window.scrollY) < document.body.offsetHeight - 300) return;

    const next = document.querySelector('#next-page-link');
    if (!next) return;
    loading = true;

    fetch(next.href)
      .then(r => r.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        const cards = doc.querySelectorAll('.job-card');
        const container = document.querySelector('.available-jobs-page .container');
        cards.forEach(card => container.appendChild(card));

        const newNext = doc.querySelector('#next-page-link');
        if (newNext) next.href = newNext.href;
        else next.remove();

        loading = false;
        updateDeadlines(); // refresh countdown for newly loaded cards
      })
      .catch(() => loading = false);
  });
});
</script>

</div><!-- /.available-jobs-page -->
{% endblock %}
