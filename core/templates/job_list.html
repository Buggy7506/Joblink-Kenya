{% extends 'base.html' %}
{% load humanize %}
{% load widget_tweaks %}

{% block title %}Available Jobs{% endblock %}

{% block content %}
<div class="available-jobs-page">

<style>
.available-jobs-page body {
  background: var(--bg-main);
  font-family: Arial, sans-serif;
  color: var(--text-main);
}

/* Layout */
.available-jobs-page .container {
  margin-top: 40px;
  padding: 20px;
}

/* Section titles */
.available-jobs-page h2 {
  font-size: 24px;
  margin-bottom: 16px;
  color: var(--accent);
  border-bottom: 2px solid var(--accent);
  padding-bottom: 6px;
}

/* Job cards */
.available-jobs-page .premium-job,
.available-jobs-page .normal-job {
  padding: 20px;
  border-radius: 14px;
  margin-bottom: 20px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.2);
  border-left: 5px solid;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

/* Premium */
.available-jobs-page .premium-job {
  background: linear-gradient(135deg, #6a00ff, #4b0082);
  border-color: gold;
  box-shadow: 0 0 25px rgba(255,215,0,0.35);
}

/* Normal */
.available-jobs-page .normal-job {
  background: var(--bg-card);
  border-color: var(--accent);
}

/* Hover */
.available-jobs-page .premium-job:hover,
.available-jobs-page .normal-job:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 35px var(--accent-glow);
}

/* Titles */
.available-jobs-page .job-title {
  font-size: 20px;
  font-weight: bold;
  margin-bottom: 6px;
  color: gold;
}
.available-jobs-page .normal-job .job-title {
  color: var(--accent);
}

/* Meta */
.available-jobs-page .job-meta {
  font-size: 14px;
  margin: 3px 0;
  color: var(--text-muted);
}

/* Apply link */
.available-jobs-page .apply-link {
  display: inline-block;
  margin-top: 10px;
  color: var(--accent);
  text-decoration: none;
  border-bottom: 1px dashed var(--accent);
  transition: all 0.3s ease;
}

.available-jobs-page .apply-link:hover {
  color: var(--text-main);
  border-color: var(--text-main);
}

/* Premium badge */
.available-jobs-page .premium-badge {
  background: gold;
  color: #000;
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 20px;
  margin-left: 10px;
  font-weight: bold;
}

/* Empty state */
.available-jobs-page .no-jobs {
  color: var(--text-muted);
  font-style: italic;
}

/* Messages */
.available-jobs-page .messages {
  margin-bottom: 20px;
  text-align: center;
}

.available-jobs-page .message-text {
  display: inline-block;
  padding: 12px 22px;
  border-radius: 25px;
  font-weight: bold;
  color: #fff;
  font-size: 1rem;
  transition: opacity 1s ease, transform 0.3s ease;
  box-shadow: 0 0 15px var(--accent-glow);
  margin-bottom: 10px;
}

.available-jobs-page .message-text.success {
  background: linear-gradient(90deg, var(--success), #00cc66);
}

.available-jobs-page .message-text.error {
  background: linear-gradient(90deg, var(--error), #ff2a39);
}

/* Company real image */
.available-jobs-page .company-logo-img {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  border: 1px solid #ddd;
  object-fit: cover;
}

/* Icons alignment */
.available-jobs-page .icon {
  margin-right: 4px;
}

/* Infinite scroll loader */
.available-jobs-page .loader {
  text-align: center;
  padding: 15px;
  font-size: 14px;
  color: #888;
}

/* ------------------------------------
   CLEAN RESPONSIVE FILTER BAR
------------------------------------ */
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  background: var(--bg-card);
  padding: 14px;
  border-radius: 14px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.18);
  margin-bottom: 18px;
}

.filter-bar input,
.filter-bar select,
.filter-bar button {
  flex: 1 1 180px;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid var(--accent-glow);
  background: var(--bg-main);
  color: var(--text-main);
  font-size: 15px;
}

.filter-bar button {
  background: var(--accent);
  color: #fff;
  border: none;
  font-weight: bold;
  cursor: pointer;
  flex: 1 1 120px;
}

.filter-bar button:hover {
  opacity: .85;
}

/* Mobile control */
@media(max-width: 600px){
  .filter-bar {
    flex-direction: column;
  }
}
/* Apply Now Button Styling */
.apply-link {
    display: inline-block;
    padding: 10px 25px;
    border-radius: 25px;
    background: var(--text-accent); /* Use your accent color */
    color: var(--text-main);
    font-weight: bold;
    font-size: 1rem;
    text-decoration: none;
    text-align: center;
    transition: all 0.3s ease;
    box-shadow: 0 0 15px var(--glow-accent, rgba(0,255,200,0.5)), 
                0 0 30px var(--glow-accent, rgba(0,255,200,0.3));
}

.apply-link:hover {
    background: var(--glow-accent, #00ffc6);
    color: #000; /* Dark text on glow background */
    box-shadow: 0 0 25px var(--glow-accent), 
                0 0 50px var(--glow-accent);
    transform: translateY(-2px);
}

.job-card .apply-link {
    margin-top: 15px;
    display: inline-block;
}
</style>

<div class="container">

  <!-- üîπ SEO INTRO (CRITICAL FOR GOOGLE ‚Äì DO NOT REMOVE) -->
  <section class="jobs-intro">
    <h1>Available Jobs in Kenya</h1>

    <p>
      Browse the latest job opportunities across Kenya on Joblink Kenya.
      We connect job seekers with employers offering opportunities in
      various industries including technology, healthcare, education,
      business, and skilled trades.
    </p>

    <p>
      Use the search and filter options below to find jobs by title,
      category, location, or expiry date. New jobs are added regularly.
    </p>
  </section>

  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <p class="message-text {% if message.tags %}{{ message.tags }}{% endif %}">
          {{ message }}
        </p>
      {% endfor %}
    </div>
  {% endif %}

  <!-- üîç Search & Filter Bar -->
  <form method="get" class="filter-bar" id="filterForm">

    <!-- Search by title -->
    <input type="text" id="searchInput" name="search"
           placeholder="üîç Search job title‚Ä¶" value="{{ search }}">

    <!-- Category -->
    <input type="text"
           name="category"
           id="categoryInput"
           list="categoryData"
           placeholder="Select or type category‚Ä¶"
           value="{{ category }}">
    <datalist id="categoryData"></datalist>

    <!-- Location -->
    <input type="text"
           name="location"
           id="locationInput"
           list="locationData"
           placeholder="Search location‚Ä¶"
           value="{{ location }}">
    <datalist id="locationData"></datalist>

    <!-- Sort -->
    <select name="sort" id="sortSelect">
      <option value="">Sort by</option>
      <option value="newest" {% if sort == "newest" %}selected{% endif %}>Newest First</option>
      <option value="expiry_asc" {% if sort == "expiry_asc" %}selected{% endif %}>Expiry Soonest</option>
      <option value="expiry_desc" {% if sort == "expiry_desc" %}selected{% endif %}>Expiry Latest</option>
    </select>

    <button type="submit">Apply</button>
  </form>

  <!-- üåü Premium Jobs -->
  <h2>üåü Featured Jobs</h2>
  {% for job in premium_jobs %}
    <div class="job-card premium-job">
      <div class="company-row">
        <p>{{ job.company }}</p>
      </div>

      <div class="job-title">
        {{ job.title }} <span class="premium-badge">Premium</span>
      </div>

      {% if job.category %}
        <p class="job-category">Category: {{ job.category.name }}</p>
      {% endif %}

      <p class="job-meta">
        <span class="icon">üìç</span> {{ job.location }}
      </p>

      {% if job.salary %}
        <p class="job-salary">Salary: KES {{ job.salary|intcomma }}</p>
      {% endif %}

      {% if job.expiry_date %}
        <p class="job-expiry">Expires on: {{ job.expiry_date|date:"M d, Y" }}</p>
      {% endif %}

      <p class="job-posted">Posted: {{ job.posted_on|date:"M d, Y" }}</p>

      <a href="{% url 'apply_job' job.id %}" class="apply-link">Apply Now</a>
    </div>
  {% empty %}
    <div class="no-jobs-message">
      <h3>No Featured Jobs Available Right Now</h3>
      <p>
        There are currently no premium job listings. Please check back later
        or browse the free job listings below.
      </p>
    </div>
  {% endfor %}

  <!-- üíº Regular Jobs -->
  <h2>üíº Free Jobs</h2>
  {% for job in jobs %}
    <div class="job-card normal-job">
      <div class="company-row">
        <p>{{ job.company }}</p>
      </div>

      <div class="job-title">{{ job.title }}</div>

      {% if job.category %}
        <p class="job-category">Category: {{ job.category.name }}</p>
      {% endif %}

      <p class="job-meta">
        <span class="icon">üìç</span> {{ job.location }}
      </p>

      {% if job.salary %}
        <p class="job-salary">Salary: KES {{ job.salary|intcomma }}</p>
      {% endif %}

      {% if job.expiry_date %}
        <p class="job-expiry">Expires on: {{ job.expiry_date|date:"M d, Y" }}</p>
      {% endif %}

      <p class="job-posted">Posted: {{ job.posted_on|date:"M d, Y" }}</p>

      <a href="{% url 'apply_job' job.id %}" class="apply-link">Apply Now</a>
    </div>
  {% empty %}
    <div class="no-jobs-message">
      <h3>No Jobs Available at the Moment</h3>
      <p>
        We are currently updating our listings. New jobs are added frequently,
        so please check back soon or try adjusting your search filters.
      </p>
    </div>
  {% endfor %}

</div>
  
<script>
document.addEventListener("DOMContentLoaded", () => {
  /* -----------------------------
     1) AUTO-DISMISS FLASH MESSAGES
  ------------------------------ */
  const msgs = document.querySelectorAll('.available-jobs-page .message-text');
  if (msgs.length) {
    setTimeout(() => {
      msgs.forEach((msg, index) => {
        setTimeout(() => {
          msg.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
          msg.style.opacity = '0';
          msg.style.transform = 'translateY(-12px)';
          setTimeout(() => msg.remove(), 700);
        }, index * 120);
      });
    }, 3500);
  }

  /* -----------------------------
     2) DEADLINE COUNTDOWN
  ------------------------------ */
  function updateDeadlines() {
    const elements = document.querySelectorAll('.available-jobs-page .deadline');
    elements.forEach(el => {
      const dateStr = el.dataset.deadline;
      if (!dateStr) return;

      const deadline = new Date(dateStr);
      const today = new Date();
      const diff = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));

      if (diff > 1) el.textContent = `${diff} days left to apply`;
      else if (diff === 1) el.textContent = `1 day left to apply`;
      else if (diff === 0) el.textContent = `Last day to apply`;
      else el.textContent = `Closed`;
    });
  }
  updateDeadlines();

  /* -----------------------------
     3) INFINITE SCROLL LOADER
  ------------------------------ */
  let loading = false;
  window.addEventListener('scroll', () => {
    if (loading) return;
    if ((window.innerHeight + window.scrollY) < document.body.offsetHeight - 300) return;

    const next = document.querySelector('#next-page-link');
    if (!next) return;
    loading = true;

    fetch(next.href)
      .then(r => r.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        const cards = doc.querySelectorAll('.job-card');
        const container = document.querySelector('.available-jobs-page .container');
        cards.forEach(card => container.appendChild(card));

        const newNext = doc.querySelector('#next-page-link');
        if (newNext) next.href = newNext.href;
        else next.remove();

        loading = false;
        updateDeadlines(); // refresh countdown for newly loaded cards
      })
      .catch(() => loading = false);
  });
});

/* Live filtering + AJAX */
function submitFilters() {
  const form = document.querySelector("#filterForm");
  const url = new URL(window.location.href);
  const fd = new FormData(form);

  // convert multi selects to multiple params
  url.search = "";
  fd.forEach((val, key) => url.searchParams.append(key, val));

  fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
    .then(r => r.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");

      const cards = doc.querySelectorAll(".job-card");
      const container = document.querySelector('.available-jobs-page .container');

      // Remove old jobs, keep form + headings
      container.querySelectorAll(".job-card").forEach(el => el.remove());

      cards.forEach(card => container.appendChild(card));

      // Update next-page-link
      const next = document.querySelector("#next-page-link");
      const newNext = doc.querySelector("#next-page-link");
      if (newNext) next.href = newNext.href;
      else next.remove();

      updateDeadlines();
    });
}

/* LIVE search debounce */
let typing;
document.querySelector("#searchInput").addEventListener("keyup", () => {
  clearTimeout(typing);
  typing = setTimeout(submitFilters, 400);
});

/* CHANGE on select/ sort trigger */
["sortSelect"]
  .forEach(id => document.getElementById(id).addEventListener("change", submitFilters));

/* Load job categories once on page load */
fetch("{% url 'api_categories' %}")
  .then(r => r.json())
  .then(data => {
    const box = document.querySelector("#categoryData");
    box.innerHTML = "";
    data.categories.forEach(c => {
      const o = document.createElement("option");
      o.value = c;
      box.appendChild(o);
    });
  })
  .catch(() => console.log("Category API failed"));

/* Location autocomplete from OSM */
let lookup;
document.querySelector("#locationInput").addEventListener("keyup", e => {
  const term = e.target.value.trim();

  if (term.length < 3) return;   // wait until user types 3+ chars

  clearTimeout(lookup);
  lookup = setTimeout(() => {
    fetch("{% url 'api_locations' %}?q=" + encodeURIComponent(term))
      .then(r => r.json())
      .then(data => {
        const box = document.querySelector("#locationData");
        box.innerHTML = "";
        data.locations.forEach(loc => {
          const o = document.createElement("option");
          o.value = loc;
          box.appendChild(o);
        });
      })
      .catch(() => console.log("OSM request failed"));
  }, 300);
});
</script>

</div><!-- /.available-jobs-page -->
{% endblock %}
