{% extends 'base.html' %}
{% load humanize %}
{% load widget_tweaks %}

{% block title %}Available Jobs{% endblock %}

{% block content %}
<div class="available-jobs-page">

<style>
/* =========================================================
   BASE
========================================================= */
.available-jobs-page {
  background: var(--bg-main);
  color: var(--text-main);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
}

.available-jobs-page .container {
  max-width: 1100px;
  margin: 30px auto;
  padding: 16px;
}

/* =========================================================
   SECTION TITLES
========================================================= */
.available-jobs-page h2 {
  font-size: 20px;
  font-weight: 700;
  margin: 28px 0 14px;
  color: var(--text-accent);
  border-bottom: 1px solid var(--glow-accent);
  padding-bottom: 6px;
}

/* =========================================================
   JOB CARDS (COMMON)
========================================================= */
.available-jobs-page .job-card {
  background: var(--bg-card);
  padding: 18px;
  border-radius: 14px;
  margin-bottom: 18px;
  border-left: 4px solid var(--text-accent);
  box-shadow: 0 6px 22px rgba(0,0,0,0.08);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.available-jobs-page .job-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.12);
}

/* =========================================================
   PREMIUM JOBS
========================================================= */
.available-jobs-page .premium-job {
  border-left-color: var(--text-warning);
  background: linear-gradient(180deg, var(--bg-warning-soft), var(--bg-card));
}

/* =========================================================
   JOB CONTENT
========================================================= */
.available-jobs-page .job-title {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 6px;
  color: var(--text-accent);
}

.available-jobs-page .premium-job .job-title {
  color: var(--text-warning);
}

.available-jobs-page .job-meta,
.available-jobs-page .job-category,
.available-jobs-page .job-salary,
.available-jobs-page .job-expiry,
.available-jobs-page .job-posted {
  font-size: 14px;
  color: var(--text-muted);
  margin: 4px 0;
}

.available-jobs-page .icon {
  margin-right: 4px;
}

.available-jobs-page .location-map-wrap {
  position: relative;
  display: inline-flex;
  align-items: center;
}

.available-jobs-page .location-link {
  color: inherit;
  text-decoration: none;
}

.available-jobs-page .location-link:hover,
.available-jobs-page .location-link:focus {
  color: var(--text-accent);
}

.available-jobs-page .location-map-popover {
  position: absolute;
  left: 0;
  top: calc(100% + 8px);
  width: 260px;
  height: 180px;
  border-radius: 10px;
  overflow: hidden;
  border: 1px solid color-mix(in srgb, var(--text-muted) 35%, transparent);
  box-shadow: 0 10px 26px rgba(0,0,0,0.22);
  background: var(--bg-card);
  display: none;
  z-index: 15;
}

.available-jobs-page .location-map-wrap:hover .location-map-popover,
.available-jobs-page .location-map-wrap:focus-within .location-map-popover {
  display: block;
}

.available-jobs-page .location-map-popover iframe {
  width: 100%;
  height: 100%;
  border: 0;
}

.available-jobs-page .countdown-timer {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  margin-left: 8px;
  font-weight: 600;
}

.available-jobs-page .countdown-timer.urgent {
  color: var(--bg-danger);
}

.available-jobs-page .countdown-timer.expired {
  color: var(--bg-danger);
}

/* =========================================================
   PREMIUM BADGE
========================================================= */
.available-jobs-page .premium-badge {
  background: var(--bg-warning);
  color: var(--text-inverse);
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 14px;
  margin-left: 8px;
  font-weight: 600;
  vertical-align: middle;
}

/* =========================================================
   APPLY BUTTON
========================================================= */
.available-jobs-page .apply-link {
  display: inline-block;
  margin-top: 14px;
  padding: 10px 22px;
  border-radius: 22px;
  background: var(--text-accent);
  color: var(--text-inverse);
  font-weight: 600;
  font-size: 14px;
  text-decoration: none;
  transition: background 0.2s ease, transform 0.2s ease;
}

.available-jobs-page .apply-link:hover {
  background: var(--glow-accent);
  transform: translateY(-1px);
}

/* =========================================================
   FILTER BAR
========================================================= */
.available-jobs-page .filter-bar {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  background: var(--bg-card);
  padding: 14px;
  border-radius: 14px;
  box-shadow: 0 6px 22px rgba(0,0,0,0.08);
  margin-bottom: 24px;
}

.available-jobs-page .filter-bar input,
.available-jobs-page .filter-bar select,
.available-jobs-page .filter-bar button {
  padding: 11px 12px;
  border-radius: 10px;
  border: 1px solid var(--glow-accent);
  background: var(--bg-main);
  color: var(--text-main);
  font-size: 15px;
}

.available-jobs-page .filter-bar input {
  flex: 2 1 260px;
}

.available-jobs-page .filter-bar select {
  flex: 1 1 160px;
  background: var(--bg-card);
  border-color: color-mix(in srgb, var(--text-muted) 65%, var(--glow-accent));
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
  appearance: none;
}

.available-jobs-page .filter-bar button {
  background: var(--text-accent);
  color: var(--text-inverse);
  border: none;
  font-weight: 600;
  cursor: pointer;
}

.available-jobs-page .filter-bar button:hover {
  opacity: 0.9;
}

.available-jobs-page .filter-bar select:focus {
  border-color: var(--text-accent);
  box-shadow: 0 0 0 2px color-mix(in srgb, var(--glow-accent) 55%, transparent);
  outline: none;
}

.available-jobs-page .filter-bar select option {
  background: var(--bg-card);
  color: var(--text-main);
}
   
/* =========================================================
   MESSAGES
========================================================= */
.available-jobs-page .messages {
  text-align: center;
  margin-bottom: 20px;
}

.available-jobs-page .message-text {
  display: inline-block;
  padding: 10px 20px;
  border-radius: 20px;
  font-weight: 600;
  color: var(--text-inverse);
  font-size: 14px;
  margin-bottom: 10px;
}

.available-jobs-page .message-text.success {
  background: var(--bg-success);
}

.available-jobs-page .message-text.error {
  background: var(--bg-danger);
}

/* =========================================================
   EMPTY STATES
========================================================= */
.available-jobs-page .no-jobs,
.available-jobs-page .no-jobs-message {
  color: var(--text-muted);
  font-style: italic;
  margin-top: 12px;
}

/* =========================================================
   COMPANY LOGO
========================================================= */
.available-jobs-page .company-logo-img {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 1px solid color-mix(in srgb, var(--text-muted) 70%, transparent);
  object-fit: cover;
  vertical-align: middle;
  margin-right: 6px;
}

.available-jobs-page .company-logo-fallback {
  width: 22px;
  height: 22px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: color-mix(in srgb, var(--text-accent) 85%, #111);
  color: var(--text-inverse);
  font-size: 11px;
  font-weight: 700;
  margin-right: 6px;
}

.available-jobs-page .company-meta {
  display: inline-flex;
  align-items: center;
}

/* =========================================================
   LOADER
========================================================= */
.available-jobs-page .loader {
  text-align: center;
  padding: 16px;
  font-size: 14px;
  color: var(--text-muted);
}

/* =======================
   MOBILE FIRST IMPROVEMENTS
======================= */
@media (max-width: 640px) {

  /* --------------------------
     FILTER BAR
  -------------------------- */
  .available-jobs-page .filter-bar {
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;       /* stay on one line */
    gap: 6px;
    padding: 8px;
    overflow: hidden;        /* prevent scrollbars */
    background: var(--bg-card);
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  }

  .available-jobs-page .filter-bar input,
  .available-jobs-page .filter-bar select,
  .available-jobs-page .filter-bar button {
    font-size: 14px;
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid var(--glow-accent);
    background: var(--bg-main);
    color: var(--text-main);
    flex-shrink: 1;
    min-width: 0;
    transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease;
  }

  .available-jobs-page .filter-bar input:focus,
  .available-jobs-page .filter-bar select:focus {
    border-color: var(--text-accent);
    outline: none;
    transform: scale(1.02);
  }

  .available-jobs-page .filter-bar input::placeholder {
    font-size: 13px;
    color: var(--text-muted);
  }

  /* Input wider than select */
  .available-jobs-page .filter-bar input {
    flex: 2 1 auto;
  }

  .available-jobs-page .filter-bar select {
    flex: 1 1 auto;
     background: var(--bg-card);
  }

  /* Button fixed width, prevent wrapping text */
  .available-jobs-page .filter-bar button {
    flex: 0 0 auto;
    white-space: nowrap;
    background: var(--text-accent);
    color: var(--text-inverse);
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease, transform 0.2s ease;
  }

  .available-jobs-page .filter-bar button:hover {
    background: var(--text-accent);
    transform: translateY(-1px);
  }

  /* --------------------------
     JOB CARDS
  -------------------------- */
  .available-jobs-page .job-card {
    padding: 14px;
    border-radius: 14px;
    margin-bottom: 16px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .available-jobs-page .job-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 28px rgba(0,0,0,0.12);
  }

  .available-jobs-page .job-title {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .available-jobs-page .premium-job .job-title {
    color: var(--text-warning);
  }

  .available-jobs-page .job-meta,
  .available-jobs-page .job-category,
  .available-jobs-page .job-salary,
  .available-jobs-page .job-expiry,
  .available-jobs-page .job-posted {
    font-size: 13px;
    margin: 2px 0;
    color: var(--text-muted);
  }

  .available-jobs-page .apply-link {
    display: inline-block;
    padding: 8px 18px;
    font-size: 13px;
    border-radius: 20px;
  }

  .available-jobs-page .premium-badge {
    font-size: 10px;
    padding: 2px 8px;
  }

  /* --------------------------
     EMPTY STATES / MESSAGES
  -------------------------- */
  .available-jobs-page .message-text {
    font-size: 13px;
    padding: 8px 16px;
  }

  .available-jobs-page .no-jobs {
    font-size: 13px;
  }
}

/* =======================
   DESKTOP UPGRADES
======================= */
@media (min-width: 641px) {

  .available-jobs-page .job-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    cursor: pointer;
  }

  .available-jobs-page .job-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 14px 32px rgba(0,0,0,0.12);
  }

  .available-jobs-page .apply-link {
    transition: background 0.3s ease, transform 0.3s ease;
  }

  .available-jobs-page .apply-link:hover {
    transform: translateY(-2px);
  }
}

/* =======================
   UNIVERSAL IMPROVEMENTS
======================= */

/* Rounded & subtle shadows for all cards */
.available-jobs-page .job-card,
.available-jobs-page .filter-bar {
  border-radius: 14px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
}

/* Smooth transitions everywhere */
.available-jobs-page * {
  transition: all 0.2s ease;
}

/* Subtle hover glow for links */
.available-jobs-page a:hover {
  color: var(--text-accent);
  text-shadow: 0 0 6px var(--glow-accent);
}

/* Slightly compress spacing for sexy compact look */
.available-jobs-page h1,
.available-jobs-page h2 {
  margin-top: 18px;
  margin-bottom: 14px;
  font-weight: 700;
}
</style>

<div class="container">

  <!-- PAGE TITLE -->
  <h1>Available Jobs in Kenya</h1>

  {% if messages %}
    <div class="messages">
      {% for message in messages %}
        <p class="message-text {% if message.tags %}{{ message.tags }}{% endif %}">
          {{ message }}
        </p>
      {% endfor %}
    </div>
  {% endif %}

  <!-- üîç UNIFIED SEARCH BAR -->
  <form method="get" class="filter-bar" id="filterForm" novalidate>

    <!-- Unified search input -->
    <input
      type="text"
      name="q"
      id="searchInput"
      list="searchSuggestions"
      placeholder="Search job title, category, or location‚Ä¶"
      value="{{ q|default:'' }}"
      autocomplete="off"
      aria-label="Search jobs"
    >

    <datalist id="searchSuggestions"></datalist>

    <!-- Sort -->
    <select name="sort" id="sortSelect" aria-label="Sort jobs">
      <option value="">Sort results</option>
      <option value="newest" {% if sort == "newest" %}selected{% endif %}>
        Newest first
      </option>
      <option value="expiry_asc" {% if sort == "expiry_asc" %}selected{% endif %}>
        Expiring soon
      </option>
      <option value="expiry_desc" {% if sort == "expiry_desc" %}selected{% endif %}>
        Expiring later
      </option>
    </select>

    <!-- Fallback submit (hidden but accessible) -->
    <button type="submit" class="sr-only">
      Search
    </button>

  </form>

  <!-- ‚≠ê FEATURED JOBS -->
  <h2>Featured Jobs</h2>

  {% for job in premium_jobs %}
    <div class="job-card premium-job">

      <div class="job-title">
        {{ job.title }}
        <span class="premium-badge">Featured</span>
      </div>

      <p class="job-meta">
        <span class="company-meta">
          {% if job.company_logo %}
            <img src="{{ job.company_logo.url }}" alt="{{ job.company }} logo" class="company-logo-img" loading="lazy">
          {% elif job.employer.employer_company.company_website %}
            <img
              src="https://www.google.com/s2/favicons?domain_url={{ job.employer.employer_company.company_website|urlencode }}&sz=64"
              alt="{{ job.company }} logo"
              class="company-logo-img"
              loading="lazy"
            >
          {% else %}
            <span class="company-logo-fallback">{{ job.company|default:"C"|slice:":1"|upper }}</span>
          {% endif %}
          {{ job.company }}
        </span>
        &nbsp; | &nbsp;
        <span class="location-map-wrap">
          <a
            href="https://www.google.com/maps/search/?api=1&query={{ job.location|urlencode }}"
            target="_blank"
            rel="noopener noreferrer"
            class="location-link"
            aria-label="Open {{ job.location }} on Google Maps"
          >
            üìå {{ job.location }}
          </a>
          <span class="location-map-popover" aria-hidden="true"></span>
        </span>
      </p>

      {% if job.category %}
        <p class="job-category">
          Category: {{ job.category.name }}
        </p>
      {% endif %}

      {% if job.salary %}
        <p class="job-salary">
          Salary: KES {{ job.salary|intcomma }}
        </p>
      {% endif %}

      {% if job.expiry_date %}
        <p class="job-expiry">
          Expires: {{ job.expiry_date|date:"M d, Y" }}
          <span class="countdown-timer" data-expiry="{{ job.expiry_date|date:'c' }}">
            ‚è≥ Calculating time left...
          </span>
        </p>
      {% endif %}

      <p class="job-posted">
        Posted: {{ job.posted_on|date:"M d, Y" }}
      </p>

      <a href="{% url 'apply_job' job.id %}" class="apply-link">
        Apply Now
      </a>
    </div>
  {% empty %}
    <p class="no-jobs">
      No featured jobs available at the moment.
    </p>
  {% endfor %}

  <!-- üíº REGULAR JOBS -->
  <h2>Available Jobs</h2>

  <div id="jobResults">
    {% for job in jobs %}
      <div class="job-card normal-job {% if job.is_premium %}premium-job{% endif %}">

        <div class="job-title">
          {{ job.title }}
          {% if job.is_premium %}
            <span class="premium-badge">Featured</span>
          {% endif %}
        </div>

        <p class="job-meta">
          <span class="company-meta">
            {% if job.company_logo %}
              <img src="{{ job.company_logo.url }}" alt="{{ job.company }} logo" class="company-logo-img" loading="lazy">
            {% elif job.employer.employer_company.company_website %}
              <img
                src="https://www.google.com/s2/favicons?domain_url={{ job.employer.employer_company.company_website|urlencode }}&sz=64"
                alt="{{ job.company }} logo"
                class="company-logo-img"
                loading="lazy"
              >
            {% else %}
              <span class="company-logo-fallback">{{ job.company|default:"C"|slice:":1"|upper }}</span>
            {% endif %}
            {{ job.company }}
          </span>
          &nbsp; | &nbsp;
          <span class="location-map-wrap">
            <a
              href="https://www.google.com/maps/search/?api=1&query={{ job.location|urlencode }}"
              target="_blank"
              rel="noopener noreferrer"
              class="location-link"
              aria-label="Open {{ job.location }} on Google Maps"
            >
              üìå {{ job.location }}
            </a>
            <span class="location-map-popover" aria-hidden="true"></span>
          </span>
        </p>
         
        {% if job.category %}
          <p class="job-category">
            Category: {{ job.category.name }}
          </p>
        {% endif %}

        {% if job.salary %}
          <p class="job-salary">
            Salary: KES {{ job.salary|intcomma }}
          </p>
        {% endif %}

        {% if job.expiry_date %}
          <p class="job-expiry">
            Expires: {{ job.expiry_date|date:"M d, Y" }}
            <span class="countdown-timer" data-expiry="{{ job.expiry_date|date:'c' }}">
              ‚è≥ Calculating time left...
            </span>
          </p>
        {% endif %}

        <p class="job-posted">
          Posted: {{ job.posted_on|date:"M d, Y" }}
        </p>
         
        <a href="{% url 'apply_job' job.id %}" class="apply-link">
          Apply Now
        </a>
      </div>
    {% empty %}
      <p class="no-jobs">
        No jobs found. Try adjusting your search.
      </p>
    {% endfor %}
  </div>

</div>
  
<script>
document.addEventListener("DOMContentLoaded", () => {

  function renderRemainingTime(diffMs) {
    const totalMinutes = Math.floor(diffMs / (1000 * 60));
    const days = Math.floor(totalMinutes / (60 * 24));
    const hours = Math.floor((totalMinutes % (60 * 24)) / 60);
    const minutes = totalMinutes % 60;

    if (days > 0) return `${days}d ${hours}h left`;
    if (hours > 0) return `${hours}h ${minutes}m left`;
    return `${Math.max(minutes, 0)}m left`;
  }

  function initLocationMaps(scope = document) {
    scope.querySelectorAll('.location-map-wrap').forEach((wrap) => {
      const popover = wrap.querySelector('.location-map-popover');
      const link = wrap.querySelector('.location-link');
      if (!popover || !link || popover.dataset.loaded === 'true') return;

      const loadMap = () => {
        if (popover.dataset.loaded === 'true') return;
        const mapUrl = `https://www.google.com/maps?q=${encodeURIComponent(link.textContent.replace('üìå', '').trim())}&output=embed`;
        popover.innerHTML = `<iframe loading="lazy" referrerpolicy="no-referrer-when-downgrade" src="${mapUrl}" title="Map for ${link.textContent.trim()}"></iframe>`;
        popover.dataset.loaded = 'true';
      };

      wrap.addEventListener('mouseenter', loadMap, { once: true });
      wrap.addEventListener('focusin', loadMap, { once: true });
    });
  }

  function updateExpiryCountdowns(scope = document) {
    const timers = scope.querySelectorAll('.countdown-timer[data-expiry]');
    timers.forEach((timer) => {
      const expiryDate = new Date(timer.dataset.expiry);
      const diffMs = expiryDate - new Date();

      timer.classList.remove('urgent', 'expired');

      if (Number.isNaN(expiryDate.getTime())) {
        timer.textContent = '‚è≥ Expiry date unavailable';
        return;
      }

      if (diffMs <= 0) {
        timer.textContent = '‚è≥ Expired';
        timer.classList.add('expired');
        return;
      }

      const oneDayMs = 24 * 60 * 60 * 1000;
      if (diffMs <= oneDayMs) {
        timer.classList.add('urgent');
      }

      timer.textContent = `‚è≥ ${renderRemainingTime(diffMs)}`;
    });
  }

  /* =====================================================
     1. AUTO-DISMISS FLASH MESSAGES
  ===================================================== */
  const msgs = document.querySelectorAll('.available-jobs-page .message-text');
  if (msgs.length) {
    setTimeout(() => {
      msgs.forEach((msg, index) => {
        setTimeout(() => {
          msg.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
          msg.style.opacity = '0';
          msg.style.transform = 'translateY(-12px)';
          setTimeout(() => msg.remove(), 700);
        }, index * 120);
      });
    }, 3500);
  }

  /* =====================================================
     2. UNIFIED SEARCH AUTOCOMPLETE
        (Job Titles + Categories + Locations)
  ===================================================== */
  const searchInput = document.getElementById("searchInput");
  const searchData  = document.getElementById("searchSuggestions");
  let searchTimer;

  if (searchInput && searchData) {
    searchInput.addEventListener("keyup", e => {
      const q = e.target.value.trim();
      if (q.length < 2) return; // minimum 2 chars to trigger
      clearTimeout(searchTimer);

      searchTimer = setTimeout(async () => {
        searchData.innerHTML = "";
        try {
          const [titlesRes, categoriesRes, locationsRes] = await Promise.all([
            fetch("{% url 'api_job_titles' %}?q=" + encodeURIComponent(q)),
            fetch("{% url 'api_categories' %}?q=" + encodeURIComponent(q)),
            fetch("{% url 'api_locations' %}?q=" + encodeURIComponent(q))
          ]);

          const [titlesData, categoriesData, locationsData] = await Promise.all([
            titlesRes.json(),
            categoriesRes.json(),
            locationsRes.json()
          ]);

          const suggestions = [
            ...(titlesData.titles || []),
            ...(categoriesData.categories || []),
            ...(locationsData.locations || [])
          ];

          // Remove duplicates
          const uniqueSuggestions = [...new Set(suggestions)];

          uniqueSuggestions.forEach(item => {
            const option = document.createElement("option");
            option.value = item;
            searchData.appendChild(option);
          });

        } catch (err) {
          console.warn("Unified search autocomplete failed:", err);
        }
      }, 300);
    });
  }

  /* =====================================================
     3. FILTER SUBMISSION (AJAX SAFE)
  ===================================================== */
  async function submitFilters() {
    const form = document.getElementById("filterForm");
    const url = new URL(window.location.href);
    const fd = new FormData(form);

    url.search = ""; // reset old query params
    fd.forEach((v, k) => {
      if (v) url.searchParams.append(k, v);
    });

   if (submitFilters.controller) {
      submitFilters.controller.abort();
    }
    submitFilters.controller = new AbortController();
     
     try {
      const res = await fetch(url, {
        headers: { "X-Requested-With": "XMLHttpRequest" },
        signal: submitFilters.controller.signal
      });
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, "text/html");
      const newResults = doc.getElementById("jobResults");
      const container = document.getElementById("jobResults");

      if (newResults && container) {
        container.innerHTML = newResults.innerHTML;
        initLocationMaps(container);
        updateExpiryCountdowns(container);
      }

      // Update next-page-link for infinite scroll
      const next = document.getElementById("next-page-link");
      const newNext = doc.getElementById("next-page-link");
      if (next) {
        if (newNext) next.href = newNext.href;
        else next.remove();
      }

    } catch (err) {
      if (err.name === "AbortError") return;
      console.error("Filter submission failed:", err);
    }
  }

  /* =====================================================
     4. INFINITE SCROLL
  ===================================================== */
  let loading = false;
  window.addEventListener("scroll", async () => {
    if (loading) return;
    const next = document.getElementById("next-page-link");
    if (!next) return;

    if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 300)) {
      loading = true;
      try {
        const res = await fetch(next.href, { headers: { "X-Requested-With": "XMLHttpRequest" } });
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, "text/html");
        const newCards = doc.querySelectorAll(".job-card");
        const container = document.getElementById("jobResults");

        if (container) {
          newCards.forEach(c => container.appendChild(c));
          initLocationMaps(container);
          updateExpiryCountdowns(container);
        }

        // Update next-page-link
        const newNext = doc.getElementById("next-page-link");
        if (newNext) next.href = newNext.href;
        else next.remove();

      } catch (err) {
        console.error("Infinite scroll load failed:", err);
      } finally {
        loading = false;
      }
    }
  });

  /* =====================================================
     5. EVENT TRIGGERS
  ===================================================== */
  ["searchInput", "sortSelect"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("change", submitFilters);
  });

  // Live submit while typing (debounced)
  let typing;
  if (searchInput) {
    searchInput.addEventListener("input", () => {
      clearTimeout(typing);
      typing = setTimeout(submitFilters, 250);
    });
  }

  initLocationMaps();
  updateExpiryCountdowns();
  setInterval(updateExpiryCountdowns, 60000);

});
</script>

{% endblock %}
