{% extends "base.html" %}

{% block title %}Applied Jobs{% endblock %}

{% block content %}

<style>
.applications-container {
  background: var(--bg-card);
  border: 1px solid color-mix(in srgb, var(--text-muted) 35%, transparent);
  border-radius: 1rem;
  padding: 1.5rem;
  margin: 1.5rem auto;
  box-shadow: 0 10px 26px rgba(0, 0, 0, 0.15);
}

.glow-heading {
  font-size: 1.8rem;
  text-align: center;
  margin-bottom: 1.5rem;
  color: var(--text-main);
}

.applications-table {
  width: 100%;
  min-width: 700px;
  color: var(--text-main);
}

.applications-table thead th {
  background: var(--bg-surface-soft);
  color: var(--text-main);
  border-bottom: 1px solid color-mix(in srgb, var(--text-muted) 40%, transparent);
}

.applications-table tbody td {
  background: color-mix(in srgb, var(--bg-surface) 85%, transparent);
  color: var(--text-main);
  border-bottom: 1px solid color-mix(in srgb, var(--text-muted) 18%, transparent);
}

.applications-table tbody tr:hover td {
  background: var(--bg-surface-soft);
}

.applications-table a {
  color: var(--text-accent);
  font-weight: 600;
}

.applications-table a:hover {
  color: var(--text-link);
}

.status-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  font-weight: 600;
}

.application-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.empty-msg {
  text-align: center;
  font-size: 1.1rem;
  color: var(--text-muted);
  margin: 0;
}
</style>

<!-- SweetAlert CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="applications-container" data-aos="zoom-in">
  <h2 class="glow-heading">üíº My Job Applications</h2>

  {% if applications %}
    <div class="table-responsive">
    <table class="table applications-table align-middle mb-0">
      <thead>
        <tr>
          <th>Job Title</th>
          <th>Employer</th>
          <th>Status</th>
          <th>Applied On</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for app in applications %}
        <tr id="row-{{ app.id }}">
          <td><a href="{% url 'job_detail' app.job.id %}">{{ app.job.title }}</a></td>
          <td>{{ app.job.employer.username }}</td>
          <td>
            {% if app.status == "accepted" %}
              <span class="status-pill text-success">‚úÖ Accepted</span>
            {% elif app.status == "rejected" %}
              <span class="status-pill text-danger">‚ùå Rejected</span>
            {% else %}
              <span class="status-pill text-warning">‚è≥ Pending</span>
            {% endif %}
          </td>
          <td>{{ app.applied_on|date:"M d, Y H:i" }}</td>
          <td>
            <div class="application-actions">
              <a href="{% url 'job_chat' app.id %}" class="btn btn-sm btn-outline-info">üí¨ Chat</a>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteApplication({{ app.id }})">üóë Delete</button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  {% else %}
    <p class="empty-msg">üöÄ You haven‚Äôt applied for any jobs yet.</p>
  {% endif %}
</div>

<script>
function deleteApplication(appId) {
  const csrfToken = '{{ csrf_token }}';
  const styles = getComputedStyle(document.documentElement);
  const dangerColor = styles.getPropertyValue('--bg-danger').trim() || '#ff3b5c';
  const surfaceColor = styles.getPropertyValue('--bg-surface').trim() || '#555';
  
  Swal.fire({
    title: "Delete Application?",
    text: "This will move the application to the Recycle Bin. You can restore it within 7 days.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: dangerColor,
    cancelButtonColor: surfaceColor,
    confirmButtonText: "Yes, delete it!"
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/applications/delete/${appId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({})
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const row = document.getElementById(`row-${appId}`);
          row.style.opacity = "0";
          setTimeout(() => row.remove(), 400);
          Swal.fire("Deleted!", "Application moved to Recycle Bin.", "success");
        } else {
          Swal.fire("Error!", data.message || "Could not delete application.", "error");
        }
      })
      .catch(() => {
        Swal.fire("Error!", "Network or server error.", "error");
      });
    }
  });
}
</script>

{% endblock %}
