{% extends "base.html" %}
{% block title %}Chat â€” {{ application.job.title }}{% endblock %}
{% block content %}

<style>
/* --- Chat Styles --- */
.chat-wrap { max-width: 800px; margin: 30px auto; }
.chat-card { background: rgba(15,15,30,0.95); color: #fff; border-radius: 16px; box-shadow: 0 0 22px rgba(0,255,200,0.25); overflow: hidden; }
.chat-header { padding: 14px 18px; border-bottom: 1px solid rgba(0,255,200,0.2); display: flex; justify-content: space-between; align-items: center; }
.chat-box { height: 480px; overflow-y: auto; padding: 14px 16px; }
.bubble { max-width: 70%; margin: 8px 0; padding: 10px 12px; border-radius: 12px; word-wrap: break-word; animation: fadeIn 0.2s ease-in; }
.me { margin-left: auto; background: rgba(0,255,200,0.18); border: 1px solid rgba(0,255,200,0.4); }
.them { margin-right: auto; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); }
.meta { font-size: 11px; opacity: .7; margin-top: 4px; }
.chat-input { display: flex; gap: 10px; padding: 12px; border-top: 1px solid rgba(0,255,200,0.2); background: rgba(9,12,20,0.9); }
.chat-input input { flex:1; padding:12px; border-radius:10px; border:none; outline:none; background:#111; color:#fff; }
.chat-input button { padding:12px 18px; border:none; border-radius:10px; font-weight:700; cursor:pointer; background: linear-gradient(135deg,#00ffc6,#00ff88); color:#111; }
@keyframes fadeIn { from {opacity:0; transform: translateY(4px);} to {opacity:1; transform:none;} }

/* Floating Chat Popup */
#chat-popup-button { position: fixed; bottom: 20px; right: 20px; z-index: 999; }
#chat-popup-button button { padding:12px 16px; border-radius:50%; background:#00ffc6; border:none; cursor:pointer; font-size:18px; }
#chat-popup { display:none; position:fixed; bottom:70px; right:20px; width:400px; max-height:500px; background: rgba(15,15,30,0.95); border-radius:16px; box-shadow:0 0 22px rgba(0,255,200,0.25); overflow:hidden; z-index:999; }
#chat-popup-header { padding:12px; background:#111; color:#fff; font-weight:bold; display:flex; justify-content:space-between; align-items:center; }
#chat-popup-body { padding:12px; overflow-y:auto; height:350px; }
#chat-popup-form { display:flex; padding:12px; border-top:1px solid rgba(0,255,200,0.2); }
#chat-popup-form input { flex:1; padding:8px; border-radius:10px; border:none; outline:none; background:#111; color:#fff; }
#chat-popup-form button { padding:8px 12px; border:none; border-radius:10px; background:#00ffc6; color:#111; cursor:pointer; }
</style>

<div class="chat-wrap">
  <div class="chat-card">
    <div class="chat-header">
      <div>
        <div><strong>{{ application.job.title }}</strong>{% if application.job.company %} â€” {{ application.job.company }}{% endif %}</div>
        <small>Chat between <strong>{{ application.applicant.username }}</strong> and <strong>{{ application.job.employer.username }}</strong></small>
      </div>
    </div>

    <div id="chat-box" class="chat-box">
      {% for m in messages %}
        <div class="bubble {% if m.sender_id == request.user.id %}me{% else %}them{% endif %}" data-id="{{ m.id }}">
          <div><strong>{{ m.sender.username }}</strong></div>
          <div>{{ m.message }}</div>
          <div class="meta">{{ m.timestamp }}{% if m.is_read and m.sender_id == request.user.id %} âœ“{% endif %}</div>
        </div>
      {% empty %}
        <p style="opacity:.7;text-align:center;margin-top:16px;">No messages yet. Say hi ðŸ‘‹</p>
      {% endfor %}
    </div>

    <form id="chat-form" class="chat-input" onsubmit="return false;">
      {% csrf_token %}
      <input id="msg-input" type="text" placeholder="Type a messageâ€¦" autocomplete="off" maxlength="2000" />
      <button id="send-btn" type="button">Send</button>
    </form>
  </div>
</div>

<!-- Floating Chat Popup -->
<div id="chat-popup">
  <div id="chat-popup-header">
    Chat
    <span id="close-chat" style="cursor:pointer;">âœ–</span>
  </div>
  <div id="chat-popup-body">
    <p style="opacity:.7;text-align:center;margin-top:16px;">No messages yet. Say hi ðŸ‘‹</p>
  </div>
  <form id="chat-popup-form">
    {% csrf_token %}
    <input id="chat-popup-input" type="text" placeholder="Type a messageâ€¦" />
    <button type="button" id="chat-popup-send">Send</button>
  </form>
</div>

<button id="chat-popup-button"><span>ðŸ’¬</span></button>

<script>
(function(){
  const appId = {{ application.id }};
  const username = "{{ request.user.username|escapejs }}";
  const chatBox = document.getElementById("chat-box");
  const input = document.getElementById("msg-input");
  const sendBtn = document.getElementById("send-btn");

  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${appId}/`);

  function scrollBottom(el){ el.scrollTop = el.scrollHeight; }
  scrollBottom(chatBox);

  // Typing indicator
  const typingIndicator = document.createElement("div");
  typingIndicator.style.opacity = 0.7;
  typingIndicator.style.fontSize = "12px";
  typingIndicator.style.margin = "4px 0";
  chatBox.appendChild(typingIndicator);

  let typingTimeout;
  input.addEventListener("input", () => {
    socket.send(JSON.stringify({ typing:true }));
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(()=>socket.send(JSON.stringify({ typing:false })), 1000);
  });

  function sendMessage(msgInput=input){
    const text = msgInput.value.trim();
    if(!text || socket.readyState!==1) return;
    socket.send(JSON.stringify({ message:text }));
    msgInput.value = "";
    socket.send(JSON.stringify({ typing:false }));
  }

  sendBtn.addEventListener("click", ()=>sendMessage());
  input.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendMessage(); } });

  // Mark visible messages as read
  function markRead(){
    const unseen = Array.from(document.querySelectorAll(".bubble.them:not(.read)"));
    const ids = unseen.map(b=>b.dataset.id);
    if(!ids.length) return;
    unseen.forEach(b=>b.classList.add("read"));
    socket.send(JSON.stringify({ read_messages:ids }));
  }
  chatBox.addEventListener("scroll", markRead);
  markRead();

  // Popup chat
  const chatButton = document.getElementById("chat-popup-button");
  const chatPopup = document.getElementById("chat-popup");
  const chatClose = document.getElementById("close-chat");
  const popupInput = document.getElementById("chat-popup-input");
  const popupSend = document.getElementById("chat-popup-send");
  const popupBody = document.getElementById("chat-popup-body");

  chatButton.addEventListener("click", ()=>chatPopup.style.display="block");
  chatClose.addEventListener("click", ()=>chatPopup.style.display="none");
  popupSend.addEventListener("click", ()=>sendMessage(popupInput));
  popupInput.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); popupSend.click(); } });

  // WebSocket message handling
  socket.onmessage = function(e){
    const data = JSON.parse(e.data);

    if(data.typing!==undefined){
      if(data.sender!==username) typingIndicator.textContent = data.typing ? `${data.sender} is typingâ€¦` : "";
      return;
    }

    if(data.read_messages!==undefined){
      data.read_messages.forEach(id=>{
        const bubble = document.querySelector(`.bubble[data-id='${id}']`);
        if(bubble){
          const meta = bubble.querySelector(".meta");
          if(!meta.textContent.includes("âœ“")) meta.textContent += " âœ“";
        }
      });
      return;
    }

    const bubble = document.createElement("div");
    bubble.className = `bubble ${data.sender===username?"me":"them"}`;
    bubble.dataset.id = data.id;
    bubble.innerHTML = `<div><strong>${data.sender}</strong></div><div>${data.message}</div><div class="meta">${new Date(data.timestamp).toLocaleString()}</div>`;

    chatBox.appendChild(bubble);
    popupBody.appendChild(bubble.cloneNode(true));
    scrollBottom(chatBox);
    scrollBottom(popupBody);
    markRead();
  };
})();
</script>

{% endblock %}
