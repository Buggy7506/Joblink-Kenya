{% extends 'base.html' %}

{% block title %}Verification • JobLink Kenya{% endblock %}

{% block content %}

<style>
.verify-wrapper * { box-sizing: border-box; }

.verify-wrapper {
    width: 100%;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 30px 0;
    font-family: 'Segoe UI', sans-serif;
    transition: 0.4s ease;
}

.verify-wrapper .container {
    background: var(--bg-card);
    padding: 40px;
    width: 90%;
    max-width: 450px;
    border-radius: 20px;
    border: 1px solid rgba(255,255,255,0.1);
    backdrop-filter: blur(12px);
    text-align: center;
    animation: fadeIn 0.7s ease-in-out;
    color: var(--text-main);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.otp-container {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 25px;
}

.otp-input {
    width: 50px;
    height: 55px;
    font-size: 24px;
    border-radius: 10px;
    border: 1px solid var(--text-muted);
    background: var(--bg-main);
    text-align: center;
    color: var(--text-main);
    outline: none;
    transition: 0.25s;
}

.otp-input:focus {
    transform: scale(1.12);
    border-color: var(--glow-main);
}

button {
    width: 100%;
    padding: 12px;
    background: var(--glow-main);
    color: var(--text-main);
    border: none;
    font-size: 17px;
    border-radius: 10px;
    cursor: pointer;
    transition: 0.25s;
    opacity: 0.5;
    pointer-events: none;
    position: relative;
}

button.enabled {
    opacity: 1;
    pointer-events: auto;
}

button:hover.enabled {
    background: var(--glow-accent);
    transform: translateY(-2px);
}

.loading-dots {
    display: inline-block;
    margin-left: 6px;
}
.loading-dots span {
    display: inline-block;
    width: 4px;
    height: 4px;
    margin: 0 1px;
    background: var(--text-main);
    border-radius: 50%;
    animation: blink 1.2s infinite ease-in-out;
}
.loading-dots span:nth-child(1){animation-delay:0s;}
.loading-dots span:nth-child(2){animation-delay:0.2s;}
.loading-dots span:nth-child(3){animation-delay:0.4s;}
@keyframes blink{
    0%, 80%, 100%{opacity:0;}
    40%{opacity:1;}
}

.remember-device {
    margin-top: 15px;
    text-align: left;
    font-size: 14px;
}

.resend {
    margin-top: 15px;
    font-size: 14px;
    color: var(--text-muted);
}

.success-checkmark {
    display: none;
    font-size: 90px;
    color: var(--glow-main);
    animation: pop 0.6s ease-out;
    margin-bottom: 15px;
}

@keyframes pop {
    0% { transform: scale(0); opacity: 0; }
    70% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); }
}

.code-sent-msg {
    background: #d1fae5;
    color: #065f46;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: .95rem;
}

.error {
    background: #fee2e2;
    color: #b91c1c;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-size: .95rem;
}
</style>

<div class="verify-wrapper">
    <div class="container">

        {% if messages %}
            {% for msg in messages %}
                {% if msg.tags == 'success' %}
                    <div class="code-sent-msg">{{ msg }}</div>
                {% else %}
                    <div class="error">{{ msg }}</div>
                {% endif %}
            {% endfor %}
        {% endif %}

        <div class="success-checkmark" id="successMark">✔</div>

        <h2>Verify Your Device</h2>
        <p>Enter the 6-digit code sent to your email/phone.</p>

        <form method="POST" id="verifyForm">
            {% csrf_token %}

            <div class="otp-container">
                {% for i in "123456" %}
                    <input type="text" maxlength="1" class="otp-input">
                {% endfor %}
            </div>

            <input type="hidden" name="code" id="full_code">

            <label class="remember-device">
                <input type="checkbox" name="remember_device"> Remember this device for 30 days
            </label>

            <button type="submit" id="verifyBtn">Verify Device</button>
        </form>

        <div class="resend">
            Resend available in <span id="countdown">30</span>s  
            <br>
            <a href="{% url 'resend_device_code' %}" id="resendLink" style="display:none;">Resend Code</a>
        </div>

    </div>
</div>

<script>
// OTP inputs & hidden input
const inputs = document.querySelectorAll(".otp-input");
const hiddenInput = document.getElementById("full_code");
const form = document.getElementById("verifyForm");
const successMark = document.getElementById("successMark");
const verifyBtn = document.getElementById("verifyBtn");

function updateHiddenAndButton() {
    hiddenInput.value = [...inputs].map(i => i.value).join("");
    if(hiddenInput.value.length === inputs.length) {
        verifyBtn.classList.add("enabled");
        autoSubmit();
    } else {
        verifyBtn.classList.remove("enabled");
        verifyBtn.innerHTML = "Verify Device";
    }
}

// Auto-submit function with loading dots
function autoSubmit() {
    verifyBtn.disabled = true;
    verifyBtn.innerHTML = `Verifying <span class="loading-dots"><span></span><span></span><span></span></span>`;
    form.submit();
}

// Input navigation
inputs.forEach((input, idx) => {
    input.addEventListener("input", () => {
        if(input.value.length === 1 && idx < inputs.length -1) {
            inputs[idx+1].focus();
        }
        updateHiddenAndButton();
    });

    input.addEventListener("keydown", e => {
        if(e.key === "Backspace" && input.value === "" && idx > 0) {
            inputs[idx-1].focus();
        }
    });
});

inputs[0].focus();

// Resend logic
let seconds = 30;
const countdown = document.getElementById("countdown");
const resendLink = document.getElementById("resendLink");
let timer = setInterval(() => {
    seconds--;
    countdown.textContent = seconds;
    if(seconds <= 0){
        clearInterval(timer);
        countdown.style.display = "none";
        resendLink.style.display = "inline";
    }
}, 1000);
</script>

{% endblock %}
