{% extends 'base.html' %}
{% block title %}Employer Profile{% endblock %}
{% block content %}
<style>
/* ===================== Employer Profile ===================== */
.employer-profile-container {
  padding: 30px;
  display: flex;
  justify-content: center;
}
.profile-box {
  background: var(--bg-card);
  padding: 25px;
  border-radius: 15px;
  max-width: 500px;
  width: 100%;
  margin: auto;
  box-shadow: 0 0 15px var(--glow-accent);
  color: var(--text-main);
  text-align: center;
}
.profile-pic {
  display: flex;
  justify-content: center;
  margin-bottom: 30px;
}
.profile-pic img {
  width: 120px;
  height: 120px;
  object-fit: cover;
  border-radius: 50%;
  border: 3px solid var(--text-accent);
  box-shadow: 0 0 15px var(--glow-accent);
  cursor: pointer;
  transition: border 0.4s, box-shadow 0.4s;
}
.user-details {
  text-align: left;
  margin-top: 20px;
}
.user-details p {
  margin-bottom: 10px;
  color: var(--text-main);
}
.edit-button {
  margin-top: 40px;
}
.edit-button a {
  display: inline-block;
  background: var(--text-accent);
  color: var(--text-main);
  padding: 12px 30px;
  font-size: 16px;
  border-radius: 30px;
  text-decoration: none;
  box-shadow: 0 0 12px var(--glow-accent);
  transition: 0.3s;
}
.edit-button a:hover {
  background: var(--glow-accent);
  box-shadow: 0 0 20px var(--glow-accent);
}

/* Alien Image Viewer */
.alien-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  z-index: 5000;
  justify-content: center;
  align-items: center;
}
.alien-frame {
  position: relative;
  width: 90%;
  max-width: 500px;
  max-height: 90%;
  border-radius: 20px;
  overflow: hidden;
  background: black;
  box-shadow: 0 0 60px #22d3ee, 0 0 120px rgba(34,211,238,.4);
}
.alien-frame img {
  width: 100%;
  height: auto;
  object-fit: contain;
  cursor: zoom-in;
  transition: transform 0.3s ease;
}
.alien-frame img:hover { transform: scale(1.05); }

/* Buttons container */
.alien-controls {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}
.alien-controls button {
  flex: 1 1 auto;
  min-width: 70px;
  padding: 10px;
  background: rgba(0,0,0,0.7);
  border: 1px solid #22d3ee;
  border-radius: 12px;
  color: #22d3ee;
  font-weight: bold;
  box-shadow: 0 0 15px #22d3ee;
  cursor: pointer;
  transition: 0.25s;
  text-align: center;
  white-space: nowrap;
}
.alien-controls button:hover {
  background: #22d3ee;
  color: black;
  box-shadow: 0 0 30px #22d3ee;
}

.upload-ring {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 6px solid rgba(34,211,238,.2);
  border-top: 6px solid #22d3ee;
  transform: translate(-50%, -50%);
  display: none;
  justify-content: center;
  align-items: center;
  color: #22d3ee;
  font-weight: bold;
  animation: spin 1s linear infinite;
  backdrop-filter: blur(4px);
  background: rgba(0,0,0,0.4);
  z-index: 6000;
}
.message-box {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  color: #22d3ee;
  padding: 8px 15px;
  border-radius: 12px;
  font-weight: bold;
  text-align: center;
  display: none;
  z-index: 6001;
}

@keyframes spin {
  0% { transform: translate(-50%, -50%) rotate(0deg); }
  100% { transform: translate(-50%, -50%) rotate(360deg); }
}
.alien-frame.default img {
  filter: brightness(0.6);
  cursor: default;
}

/* Mobile adjustments */
@media (max-width: 480px) {
  .alien-controls {
    flex-wrap: wrap;
    gap: 5px;
  }
  .alien-controls button {
    font-size: 14px;
    min-width: 50px;
    padding: 8px;
  }
}
</style>

<div class="employer-profile-container">
  <div class="profile-box">
    <div class="profile-pic">
      {% if user.profile_pic %}
        <img id="profile-pic" src="{{ user.profile_pic.url }}" alt="Profile Picture">
      {% else %}
        <img id="profile-pic" src="https://res.cloudinary.com/dc6z1giw2/image/upload/v1754578015/jo2wvg1a0wgiava5be20.png" alt="Default Picture">
      {% endif %}
    </div>
    <div class="user-details">
      <p><strong>Username:</strong> {{ request.user.username }}</p>
      <p><strong>Email:</strong> {{ request.user.email }}</p>
      <p><strong>Date Joined:</strong> {{ request.user.date_joined }}</p>
    </div>
    <div class="edit-button">
      <a href="{% url 'edit_profile' %}">‚úèÔ∏è Edit Profile</a>
    </div>
  </div>
</div>

<!-- Profile Picture Modal -->
<div id="imgModal" class="alien-modal">
  <div class="alien-frame">
    <div id="modalMessage" class="message-box"></div>
    <img id="imgPreview" alt="Preview">
    <div id="uploadRing" class="upload-ring">0%</div>
    <div class="alien-controls">
      <button id="infoBtn">üëÅ INFO</button>
      <button id="editBtn">‚úèÔ∏è EDIT</button>
      <button id="deleteBtn">üóë DELETE</button>
      <button id="closeBtn">‚úï</button>
    </div>
    <input type="file" id="profilePicInputModal" style="display:none" accept="image/*">
  </div>
</div>

<script>
const DEFAULT_PIC = "{{ user.profile_pic.url|default:'https://res.cloudinary.com/dc6z1giw2/image/upload/v1754578015/jo2wvg1a0wgiava5be20.png' }}";
const profilePic = document.getElementById('profile-pic');
const alienModal = document.getElementById('imgModal');
const alienPreview = document.getElementById('imgPreview');
const closeBtn = document.getElementById('closeBtn');
const infoBtn = document.getElementById('infoBtn');
const editBtn = document.getElementById('editBtn');
const deleteBtn = document.getElementById('deleteBtn');
const profilePicInputModal = document.getElementById('profilePicInputModal');
const uploadRing = document.getElementById('uploadRing');
const modalMessage = document.getElementById('modalMessage');

function showMessage(msg, duration=2000){
  modalMessage.innerText = msg;
  modalMessage.style.display = 'block';
  setTimeout(()=>modalMessage.style.display='none', duration);
}

function updateModalButtons(){
  if(profilePic.src === DEFAULT_PIC || profilePic.src.endsWith('jo2wvg1a0wgiava5be20.png')){
    alienPreview.src = DEFAULT_PIC;
    alienModal.classList.add('default');
    infoBtn.style.opacity = 0.3; infoBtn.style.pointerEvents = "none";
    deleteBtn.style.opacity = 0.3; deleteBtn.style.pointerEvents = "none";
    editBtn.style.opacity = 1; editBtn.style.pointerEvents = "auto";
  } else {
    alienPreview.src = profilePic.src;
    alienModal.classList.remove('default');
    infoBtn.style.opacity = 1; infoBtn.style.pointerEvents = "auto";
    editBtn.style.opacity = 1; editBtn.style.pointerEvents = "auto";
    deleteBtn.style.opacity = 1; deleteBtn.style.pointerEvents = "auto";
  }
}

profilePic.addEventListener('click', ()=>{alienModal.style.display='flex'; updateModalButtons();});
closeBtn.onclick = ()=>alienModal.style.display='none';

infoBtn.onclick = ()=>{
  if(infoBtn.style.pointerEvents!=='none')
    showMessage(`üì∑ Profile Picture\nUploaded by: {{ user.username }}\nEmail: {{ user.email }}\nJoined: {{ user.date_joined }}`,4000);
};

deleteBtn.onclick = async ()=>{
  if(deleteBtn.style.pointerEvents==='none') return;
  if(!confirm("Delete your profile picture?")) return;

  try {
    const form = new FormData();
    form.append('modal_type','profile_pic_delete');

    const res = await fetch("{% url 'quick_profile_update' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' },
      body: form
    });

    const data = await res.json();
    if(data.success){
      profilePic.src = data.url;
      alienPreview.src = data.url;
      updateModalButtons();
      showMessage('Profile picture deleted',2000);
    } else {
      showMessage(data.error || 'Delete failed',2000);
    }
  } catch(e){
    showMessage('Delete failed',2000);
  }
};

editBtn.onclick = ()=>{ if(editBtn.style.pointerEvents!=='none') profilePicInputModal.click(); };

profilePicInputModal.onchange = async e=>{
  const file = e.target.files[0];
  if(!file) return;
  const compressedFile = await compressImage(file);
  const formData = new FormData();
  formData.append('modal_type','profile_pic');
  formData.append('profile_pic', compressedFile);

  uploadRing.style.display='flex';
  uploadRing.innerText='0%';

  try {
    const res = await fetch("{% url 'quick_profile_update' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' },
      body: formData
    });

    const data = await res.json();
    uploadRing.style.display='none';
    if(data.success){
      profilePic.src = data.url;
      alienPreview.src = data.url;
      updateModalButtons();
      showMessage('Upload successful!',2000);
    } else {
      showMessage(data.error || 'Upload failed',2000);
    }
  } catch(e){
    uploadRing.style.display='none';
    showMessage('Upload failed',2000);
  }
};

// Mobile swipe down to close modal
let startY = 0;
alienPreview.addEventListener('touchstart', e => startY = e.touches[0].clientY);
alienPreview.addEventListener('touchmove', e => {
  if(e.touches[0].clientY - startY > 120) alienModal.style.display='none';
});

async function compressImage(file){
  return new Promise(resolve=>{
    const img = new Image();
    img.onload = ()=>{
      const canvas = document.createElement('canvas');
      const scale = Math.min(1, 800 / img.width);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);
      canvas.toBlob(blob=>resolve(new File([blob],file.name,{type:'image/jpeg'})),'image/jpeg',0.7);
    };
    img.src = URL.createObjectURL(file);
  });
}
</script>
{% endblock %}
