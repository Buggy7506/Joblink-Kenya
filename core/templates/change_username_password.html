{% extends 'base.html' %}
{% block title %}Account Settings | JobLink Kenya{% endblock %}
{% block content %}

<style>
.settings-wrap {
  min-height:100vh;
  padding:2rem 0 6rem;
}

.settings-card {
  max-width:1100px;
  margin:auto;
  display:grid;
  grid-template-columns:240px 1fr;
  gap:0;
}

/* Sidebar */
.settings-sidebar {
  background: var(--bg-card);
  border-right:1px solid var(--text-muted);
  padding:1.5rem;
}

.settings-sidebar h3 {
  margin-bottom:1.5rem;
}

.settings-sidebar a {
  display:block;
  padding:0.75rem 1rem;
  margin-bottom:0.5rem;
  border-radius:0.5rem;
  font-weight:600;
  color: var(--text-main);
}

.settings-sidebar a.active,
.settings-sidebar a:hover {
  background: rgba(34,211,238,0.12);
  color: var(--text-accent);
}

/* Content */
.settings-content {
  background: var(--bg-card);
  padding:2rem;
}

.section { display:none; }
.section.active { display:block; }

/* Forms */
.form-group { margin-bottom:1.25rem; }

label {
  display:block;
  margin-bottom:0.4rem;
  font-weight:600;
}

.password-row {
  display:flex;
  gap:0.5rem;
}

.show-btn {
  background: transparent;
  border:1px solid var(--text-muted);
  color: var(--text-main);
  padding:0.5rem 0.75rem;
  border-radius:0.4rem;
  cursor:pointer;
}

.show-btn:hover {
  border-color: var(--text-accent);
  color: var(--text-accent);
}

.save-btn {
  width:100%;
  padding:0.75rem;
  margin-top:0.5rem;
  border-radius:0.6rem;
  font-weight:700;
  background: linear-gradient(45deg,var(--glow-accent),var(--text-accent));
  color:#000;
  border:none;
  cursor:pointer;
}

/* Danger zone */
.danger-box {
  border:1px solid var(--text-danger);
  background: rgba(248,113,113,0.1);
  padding:1.5rem;
  border-radius:0.75rem;
}

.delete-btn {
  width:100%;
  padding:0.75rem;
  border-radius:0.6rem;
  background: var(--text-danger);
  color:#000;
  border:none;
  font-weight:700;
  cursor:pointer;
}

/* Modal */
.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.modal-box {
  background: var(--bg-card);
  padding:2rem;
  border-radius:1rem;
  max-width:420px;
  width:100%;
  box-shadow:0 20px 40px rgba(0,0,0,0.5);
}

.modal-actions {
  display:flex;
  gap:0.75rem;
  margin-top:1.25rem;
}

.cancel-btn {
  flex:1;
  background: transparent;
  border:1px solid var(--text-muted);
  color: var(--text-main);
  padding:0.6rem;
  border-radius:0.5rem;
}

.confirm-btn {
  flex:1;
  background: var(--text-danger);
  color:#000;
  border:none;
  padding:0.6rem;
  border-radius:0.5rem;
  font-weight:700;
}

/* Responsive */
@media(max-width:900px){
  .settings-card { grid-template-columns:1fr; }
  .settings-sidebar { border-right:none; border-bottom:1px solid var(--text-muted); }
}
</style>

<div class="container settings-wrap">
  <div class="settings-card glass-card">

    <!-- SIDEBAR -->
    <aside class="settings-sidebar">
      <h3 class="glow">Settings</h3>
      <a href="#security" class="tab-link active">üîí Security</a>
      <a href="#danger" class="tab-link">‚ö†Ô∏è Danger Zone</a>
      <a href="{% url 'profile' %}" class="hover-glow">‚Üê Back to Profile</a>
    </aside>

    <!-- CONTENT -->
    <section class="settings-content">

      <!-- SECURITY -->
      <div id="security" class="section active">
        <h2 class="glow">Change Username & Password</h2><br>

        <form method="POST">
          {% csrf_token %}

          <div class="form-group">
            {{ form.username.label_tag }}
            {{ form.username }}
          </div>

          <div class="form-group">
            {{ form.old_password.label_tag }}
            <div class="password-row">
              {{ form.old_password }}
              <button type="button" class="show-btn" data-target="id_old_password">Show</button>
            </div>
          </div>

          <div class="form-group">
            {{ form.new_password1.label_tag }}
            <div class="password-row">
              {{ form.new_password1 }}
              <button type="button" class="show-btn" data-target="id_new_password1">Show</button>
            </div>
          </div>

          <div class="form-group">
            {{ form.new_password2.label_tag }}
            <div class="password-row">
              {{ form.new_password2 }}
              <button type="button" class="show-btn" data-target="id_new_password2">Show</button>
            </div>
          </div>

          <button class="save-btn glow-border">üíæ Save Changes</button>
        </form>
      </div>

      <!-- DANGER -->
      <div id="danger" class="section">
        <h2 class="glow">Delete Account</h2><br>

        <div class="danger-box">
          <p><strong>Warning:</strong> This action is permanent.</p>
          <button class="delete-btn" id="openModal">üóë Delete My Account</button>
        </div>
      </div>

    </section>
  </div>
</div>

<!-- MODAL -->
<div class="modal" id="deleteModal">
  <div class="modal-box">
    <h3 class="glow">Confirm Deletion</h3>
    <p>Please enter your password.</p>

    <form method="POST" action="{% url 'delete_account' %}">
      {% csrf_token %}
      <input type="password" name="password" placeholder="Your password" required>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" id="closeModal">Cancel</button>
        <button class="confirm-btn">Delete</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ============================
     Tabs
  ============================ */
  document.querySelectorAll('.tab-link').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      link.classList.add('active');
      document.querySelector(link.getAttribute('href')).classList.add('active');
    });
  });

  // Restore tab from URL hash
  const hash = window.location.hash;
  if (hash && document.querySelector(hash)) {
    document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelector(`a[href="${hash}"]`)?.classList.add('active');
    document.querySelector(hash).classList.add('active');
  }

  /* ============================
     Show / Hide Password
  ============================ */
  document.querySelectorAll('.show-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = document.getElementById(btn.dataset.target);
      if (!target) return;

      if (target.type === 'password') {
        target.type = 'text';
        btn.textContent = 'Hide';
      } else {
        target.type = 'password';
        btn.textContent = 'Show';
      }
    });
  });

  // Clear password fields & prevent autofill
  ['id_old_password','id_new_password1','id_new_password2'].forEach(id => {
    const field = document.getElementById(id);
    if (field) {
      field.value = '';
      field.autocomplete = 'new-password';
    }
  });

  /* ============================
     Messages Auto Hide
  ============================ */
  const popup = document.getElementById('messages-popup');
  if (popup) {
    setTimeout(() => popup.style.animation = 'fadeOut 0.5s forwards', 3000);
    setTimeout(() => popup.remove(), 3500);
  }

  /* ============================
     Delete Modal
  ============================ */
  const modal = document.getElementById('deleteModal');
  const openBtn = document.getElementById('openModal');
  const closeBtn = document.getElementById('closeModal');

  if (modal && openBtn && closeBtn) {
    openBtn.onclick = () => modal.style.display = 'flex';
    closeBtn.onclick = () => modal.style.display = 'none';

    // ESC to close
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') modal.style.display = 'none';
    });
  }

});
</script>

{% endblock %}
