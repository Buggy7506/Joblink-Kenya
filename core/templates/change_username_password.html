{% extends 'base.html' %}
{% block title %}Settings{% endblock %}
{% block content %}

<style>
/* Wrap everything under .settings-page */
.settings-page .settings-wrap {
  min-height:100vh;
  padding:2rem 0 5rem;
}

/* ================================
   GRID LAYOUT (NO CLIPPING)
================================ */
.settings-page .settings-card {
  width:100%;
  max-width:1100px;
  margin:auto;
  display:grid;
  grid-template-columns:240px 1fr;
  align-items:start;
  overflow:visible !important;
}

.settings-page .settings-content,
.settings-page .section {
  max-width:100%;
  overflow-x:visible;
}

/* ================================
   SIDEBAR
================================ */
.settings-page .settings-sidebar {
  background: var(--bg-card);
  border-right:1px solid var(--text-muted);
  padding:1.5rem;
}

.settings-page .settings-sidebar h3 {
  margin-bottom:1.5rem;
}

.settings-page .settings-sidebar a {
  all: unset;
  display:block;
  padding:0.75rem 1rem;
  margin-bottom:0.5rem;
  border-radius:0.6rem;
  font-weight:600;
  color: var(--text-main);
  cursor:pointer;
}

.settings-page .settings-sidebar a:hover,
.settings-page .settings-sidebar a.active {
  background: rgba(34,211,238,0.15);
  color: var(--text-accent);
}

/* ================================
   CONTENT
================================ */
.settings-page .settings-content {
  background: var(--bg-card);
  padding:2rem;
}

.settings-page .section { display:none; }
.settings-page .section.active { display:block; }

/* ================================
   FORMS
================================ */
.settings-page .form-group { margin-bottom:1.25rem; }

.settings-page label {
  display:block;
  margin-bottom:0.4rem;
  font-weight:600;
}

.settings-page .form-group input,
.settings-page .password-row input {
  width:100%;
  box-sizing:border-box;
}

.settings-page input,
.settings-page select,
.settings-page button {
  max-width:100%;
}

.settings-page .password-row {
  display:flex;
  gap:0.5rem;
}

.settings-page .show-btn {
  border:1px solid var(--text-muted);
  background:transparent;
  padding:0.55rem 0.75rem;
  border-radius:0.45rem;
  cursor:pointer;
}

.settings-page .show-btn:hover {
  border-color:var(--text-accent);
  color:var(--text-accent);
}

.settings-page .save-btn {
  width:100%;
  padding:0.75rem;
  border-radius:0.6rem;
  font-weight:700;
  background:linear-gradient(45deg,var(--glow-accent),var(--text-accent));
  color:#000;
  border:none;
  cursor:pointer;
}

/* ================================
   DANGER ZONE
================================ */
.settings-page .danger-box {
  border:1px solid var(--text-danger);
  background:rgba(248,113,113,0.12);
  padding:1.5rem;
  border-radius:0.8rem;
}

.settings-page .delete-btn {
  width:100%;
  padding:0.75rem;
  border-radius:0.6rem;
  background:var(--text-danger);
  color:#000;
  font-weight:700;
  border:none;
}

/* ================================
   MODAL
================================ */
.settings-page .modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.settings-page .modal-box {
  background:var(--bg-card);
  padding:2rem;
  border-radius:1rem;
  width:100%;
  max-width:420px;
}

.settings-page .modal-actions {
  display:flex;
  gap:0.75rem;
  margin-top:1.25rem;
}

.settings-page .cancel-btn,
.settings-page .confirm-btn {
  flex:1;
  padding:0.65rem;
  border-radius:0.55rem;
  font-weight:700;
}

.settings-page .cancel-btn {
  background:transparent;
  border:1px solid var(--text-muted);
}

.settings-page .confirm-btn {
  background:var(--text-danger);
  border:none;
}

/* ================================
   MOBILE OPTIMIZATION < 768px
================================ */
@media (max-width: 768px) {

  .settings-page .settings-wrap {
    padding:1rem 0 3rem;
  }

  .settings-page .settings-card {
    grid-template-columns:1fr;
  }

  .settings-page .settings-sidebar {
    display:flex;
    gap:0.5rem;
    overflow-x:auto;
    white-space:nowrap;
    border-right:none;
    border-bottom:1px solid var(--text-muted);
  }

  .settings-page .settings-sidebar h3 {
    display:none;
  }

  .settings-page .settings-sidebar a {
    margin:0;
    padding:0.6rem 0.9rem;
    font-size:0.9rem;
    flex-shrink:0;
  }

  .settings-page .settings-content {
    padding:1.3rem;
  }

  .settings-page .password-row {
    flex-direction:column;
  }

  .settings-page .show-btn {
    width:100%;
  }

  .settings-page .modal-box {
    width:92%;
    padding:1.5rem;
  }

  .settings-page .modal-actions {
    flex-direction:column;
  }
}

/* ================================
   RESPONSIVE RECAPTCHA
================================ */
.settings-page .g-recaptcha {
  transform: scale(1);
  transform-origin: 0 0;
}

/* ================================
   MOBILE < 480px ‚Äî shrink inputs
================================ */
@media (max-width: 480px) {

  .settings-page input[type="text"],
  .settings-page input[type="password"],
  .settings-page input[type="email"],
  .settings-page select {
    max-width: 280px;
    width:auto !important;
    margin: 0 auto;
    font-size: 0.9rem;
  }

  .settings-page .form-group {
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  .settings-page .password-row {
    width:auto !important;
    max-width:280px;
    align-items:stretch;
    flex-direction:column;
  }

  .settings-page .show-btn {
    max-width:280px;
    width:auto !important;
  }

  .settings-page .g-recaptcha {
    transform:scale(0.8);
    margin:0 auto;
  }
}

/* ================================
   EXTRA SMALL ‚Äî < 360px
================================ */
@media (max-width: 360px) {

  .settings-page input,
  .settings-page .password-row,
  .settings-page .show-btn {
    max-width:240px;
    width:auto !important;
  }

  .settings-page .g-recaptcha {
    transform:scale(0.7);
  }
}
</style>

<div class="settings-page">
  <div class="container settings-wrap">
    <div class="settings-card glass-card">

      <aside class="settings-sidebar">
        <h3 class="glow">Settings</h3>
        <a href="#security" class="tab-link active">üîí Security</a>
        <a href="#danger" class="tab-link">‚ö†Ô∏è Danger Zone</a>
        <a href="{% url 'dashboard' %}">‚Üê Dashboard</a>
      </aside>

      <section class="settings-content">

        <div id="security" class="section active">
          <h2 class="glow">Change Username & Password</h2><br>

          <form method="POST">
            {% csrf_token %}

            <div class="form-group">
              {{ form.username.label_tag }}
              {{ form.username }}
            </div>

            <div class="form-group">
              {{ form.old_password.label_tag }}
              <div class="password-row">
                {{ form.old_password }}
                <button type="button" class="show-btn" data-target="id_old_password">Show</button>
              </div>
            </div>

            <div class="form-group">
              {{ form.new_password1.label_tag }}
              <div class="password-row">
                {{ form.new_password1 }}
                <button type="button" class="show-btn" data-target="id_new_password1">Show</button>
              </div>
            </div>

            <div class="form-group">
              {{ form.new_password2.label_tag }}
              <div class="password-row">
                {{ form.new_password2 }}
                <button type="button" class="show-btn" data-target="id_new_password2">Show</button>
              </div>
            </div>

            <!-- reCAPTCHA -->
            <div class="form-group">
              <div class="g-recaptcha"
                   data-sitekey="6LcMGEQsAAAAAO1KJvmCwECWnpPpXg2HlHio_QJS">
              </div>
            </div>

            <button class="save-btn">Save Changes</button>
          </form>
        </div>

        <div id="danger" class="section">
          <h2 class="glow">Delete Account</h2><br>

          <div class="danger-box">
            <p><strong>Warning:</strong> This action is permanent.</p>
            <button class="delete-btn" id="openModal">Delete My Account</button>
          </div>
        </div>

      </section>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal" id="deleteModal">
    <div class="modal-box">
      <h3 class="glow">Confirm Deletion</h3>
      <p>Please enter your password.</p>

      <form method="POST" action="{% url 'delete_account' %}">
        {% csrf_token %}
        <input type="password" name="password" required>

        <!-- reCAPTCHA -->
        <div class="form-group">
          <div class="g-recaptcha"
               data-sitekey="6LcMGEQsAAAAAO1KJvmCwECWnpPpXg2HlHio_QJS">
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="cancel-btn" id="closeModal">Cancel</button>
          <button class="confirm-btn">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const page = document.querySelector('.settings-page');
  if (!page) return;  // Stop if not on this page

  /* ============================
     Tabs
  ============================ */
  page.querySelectorAll('.tab-link').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();

      const targetSelector = link.getAttribute('href');
      const target = page.querySelector(targetSelector);
      if (!target) return;

      page.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
      page.querySelectorAll('.section').forEach(s => s.classList.remove('active'));

      link.classList.add('active');
      target.classList.add('active');

      history.replaceState(null, null, targetSelector);
    });
  });

  // Restore tab from URL
  const hash = window.location.hash;
  if (hash) {
    const tab = page.querySelector(`a[href="${hash}"]`);
    const section = page.querySelector(hash);

    if (tab && section) {
      page.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
      page.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      tab.classList.add('active');
      section.classList.add('active');
    }
  }

  /* ============================
     Show / Hide Password
  ============================ */
  page.querySelectorAll('.show-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = page.querySelector(`#${btn.dataset.target}`);
      if (!target) return;

      const isPassword = target.type === 'password';
      target.type = isPassword ? 'text' : 'password';
      btn.textContent = isPassword ? 'Hide' : 'Show';
    });
  });

  // Clear password fields
  ['id_old_password','id_new_password1','id_new_password2'].forEach(id => {
    const field = page.querySelector(`#${id}`);
    if (field) {
      field.value = '';
      field.setAttribute('autocomplete', 'new-password');
    }
  });

  /* ============================
     Messages Auto Hide
  ============================ */
  const popup = page.querySelector('#messages-popup');
  if (popup) {
    setTimeout(() => popup.style.animation = 'fadeOut 0.5s forwards', 3000);
    setTimeout(() => popup.remove(), 3500);
  }

  /* ============================
     Delete Modal
  ============================ */
  const modal = page.querySelector('#deleteModal');
  const openBtn = page.querySelector('#openModal');
  const closeBtn = page.querySelector('#closeModal');

  if (modal && openBtn && closeBtn) {

    openBtn.addEventListener('click', () => {
      modal.style.display = 'flex';
    });

    closeBtn.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    // Close on outside click
    modal.addEventListener('click', e => {
      if (e.target === modal) modal.style.display = 'none';
    });

    // ESC key closes modal
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') modal.style.display = 'none';
    });
  }

});
</script>
{% endblock %}
