{% extends 'base.html' %}
{% block title %}Account Settings | JobLink Kenya{% endblock %}
{% block content %}

<style>
/* ================================
   LAYOUT
================================ */
.settings-wrap {
  min-height:100vh;
  padding:2rem 0 5rem;
}

.settings-card {
  max-width:1100px;
  margin:auto;
  display:grid;
  grid-template-columns:240px 1fr;
}

/* ================================
   SIDEBAR
================================ */
.settings-sidebar {
  background: var(--bg-card);
  border-right:1px solid var(--text-muted);
  padding:1.5rem;
}

.settings-sidebar h3 {
  margin-bottom:1.5rem;
}

.settings-sidebar a {
  display:block;
  padding:0.75rem 1rem;
  margin-bottom:0.5rem;
  border-radius:0.6rem;
  font-weight:600;
  color: var(--text-main);
}

.settings-sidebar a.active,
.settings-sidebar a:hover {
  background: rgba(34,211,238,0.15);
  color: var(--text-accent);
}

/* ================================
   CONTENT
================================ */
.settings-content {
  background: var(--bg-card);
  padding:2rem;
}

.section { display:none; }
.section.active { display:block; }

/* ================================
   FORMS
================================ */
.form-group { margin-bottom:1.25rem; }

label {
  display:block;
  margin-bottom:0.4rem;
  font-weight:600;
}

.password-row {
  display:flex;
  gap:0.5rem;
}

.show-btn {
  border:1px solid var(--text-muted);
  background:transparent;
  padding:0.55rem 0.75rem;
  border-radius:0.45rem;
  cursor:pointer;
}

.show-btn:hover {
  border-color:var(--text-accent);
  color:var(--text-accent);
}

.save-btn {
  width:100%;
  padding:0.75rem;
  border-radius:0.6rem;
  font-weight:700;
  background:linear-gradient(45deg,var(--glow-accent),var(--text-accent));
  color:#000;
  border:none;
  cursor:pointer;
}

/* ================================
   DANGER ZONE
================================ */
.danger-box {
  border:1px solid var(--text-danger);
  background:rgba(248,113,113,0.12);
  padding:1.5rem;
  border-radius:0.8rem;
}

.delete-btn {
  width:100%;
  padding:0.75rem;
  border-radius:0.6rem;
  background:var(--text-danger);
  color:#000;
  font-weight:700;
  border:none;
}

/* ================================
   MODAL
================================ */
.modal {
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.modal-box {
  background:var(--bg-card);
  padding:2rem;
  border-radius:1rem;
  width:100%;
  max-width:420px;
}

.modal-actions {
  display:flex;
  gap:0.75rem;
  margin-top:1.25rem;
}

.cancel-btn,
.confirm-btn {
  flex:1;
  padding:0.65rem;
  border-radius:0.55rem;
  font-weight:700;
}

.cancel-btn {
  background:transparent;
  border:1px solid var(--text-muted);
}

.confirm-btn {
  background:var(--text-danger);
  border:none;
}

/* ================================
   MOBILE OPTIMIZATION
================================ */
@media (max-width: 768px) {

  .settings-wrap {
    padding:1rem 0 3rem;
  }

  .settings-card {
    grid-template-columns:1fr;
  }

  /* Sidebar becomes horizontal tabs */
  .settings-sidebar {
    display:flex;
    gap:0.5rem;
    overflow-x:auto;
    white-space:nowrap;
    border-right:none;
    border-bottom:1px solid var(--text-muted);
  }

  .settings-sidebar h3 {
    display:none;
  }

  .settings-sidebar a {
    margin:0;
    padding:0.6rem 0.9rem;
    font-size:0.9rem;
    flex-shrink:0;
  }

  .settings-content {
    padding:1.3rem;
  }

  h2 {
    font-size:1.25rem;
  }

  /* Stack password input */
  .password-row {
    flex-direction:column;
  }

  .show-btn {
    width:100%;
  }

  /* Modal */
  .modal-box {
    width:92%;
    padding:1.5rem;
  }

  .modal-actions {
    flex-direction:column;
  }
}
</style>

<div class="container settings-wrap">
  <div class="settings-card glass-card">

    <aside class="settings-sidebar">
      <h3 class="glow">Settings</h3>
      <a href="#security" class="tab-link active">üîí Security</a>
      <a href="#danger" class="tab-link">‚ö†Ô∏è Danger Zone</a>
      <a href="{% url 'profile' %}">‚Üê Back</a>
    </aside>

    <section class="settings-content">

      <div id="security" class="section active">
        <h2 class="glow">Change Username & Password</h2><br>

        <form method="POST">
          {% csrf_token %}

          <div class="form-group">
            {{ form.username.label_tag }}
            {{ form.username }}
          </div>

          <div class="form-group">
            {{ form.old_password.label_tag }}
            <div class="password-row">
              {{ form.old_password }}
              <button type="button" class="show-btn" data-target="id_old_password">Show</button>
            </div>
          </div>

          <div class="form-group">
            {{ form.new_password1.label_tag }}
            <div class="password-row">
              {{ form.new_password1 }}
              <button type="button" class="show-btn" data-target="id_new_password1">Show</button>
            </div>
          </div>

          <div class="form-group">
            {{ form.new_password2.label_tag }}
            <div class="password-row">
              {{ form.new_password2 }}
              <button type="button" class="show-btn" data-target="id_new_password2">Show</button>
            </div>
          </div>

          <button class="save-btn">Save Changes</button>
        </form>
      </div>

      <div id="danger" class="section">
        <h2 class="glow">Delete Account</h2><br>

        <div class="danger-box">
          <p><strong>Warning:</strong> This action is permanent.</p>
          <button class="delete-btn" id="openModal">Delete My Account</button>
        </div>
      </div>

    </section>
  </div>
</div>

<!-- MODAL -->
<div class="modal" id="deleteModal">
  <div class="modal-box">
    <h3 class="glow">Confirm Deletion</h3>
    <p>Please enter your password.</p>

    <form method="POST" action="{% url 'delete_account' %}">
      {% csrf_token %}
      <input type="password" name="password" required>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" id="closeModal">Cancel</button>
        <button class="confirm-btn">Delete</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ============================
     Tabs
  ============================ */
  document.querySelectorAll('.tab-link').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      link.classList.add('active');
      document.querySelector(link.getAttribute('href')).classList.add('active');
    });
  });

  // Restore tab from URL hash
  const hash = window.location.hash;
  if (hash && document.querySelector(hash)) {
    document.querySelectorAll('.tab-link').forEach(l => l.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelector(`a[href="${hash}"]`)?.classList.add('active');
    document.querySelector(hash).classList.add('active');
  }

  /* ============================
     Show / Hide Password
  ============================ */
  document.querySelectorAll('.show-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = document.getElementById(btn.dataset.target);
      if (!target) return;

      if (target.type === 'password') {
        target.type = 'text';
        btn.textContent = 'Hide';
      } else {
        target.type = 'password';
        btn.textContent = 'Show';
      }
    });
  });

  // Clear password fields & prevent autofill
  ['id_old_password','id_new_password1','id_new_password2'].forEach(id => {
    const field = document.getElementById(id);
    if (field) {
      field.value = '';
      field.autocomplete = 'new-password';
    }
  });

  /* ============================
     Messages Auto Hide
  ============================ */
  const popup = document.getElementById('messages-popup');
  if (popup) {
    setTimeout(() => popup.style.animation = 'fadeOut 0.5s forwards', 3000);
    setTimeout(() => popup.remove(), 3500);
  }

  /* ============================
     Delete Modal
  ============================ */
  const modal = document.getElementById('deleteModal');
  const openBtn = document.getElementById('openModal');
  const closeBtn = document.getElementById('closeModal');

  if (modal && openBtn && closeBtn) {
    openBtn.onclick = () => modal.style.display = 'flex';
    closeBtn.onclick = () => modal.style.display = 'none';

    // ESC to close
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') modal.style.display = 'none';
    });
  }

});
</script>

{% endblock %}
