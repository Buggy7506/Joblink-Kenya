{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load humanize %}

{% block title %}Post Job{% endblock %}

{% block content %}

<style>
/* prevent inputs from overflowing */
* {
  box-sizing: border-box;
}

.post-job-container {
  max-width: 600px;
  margin: 60px auto;
  padding: 30px;
  background: var(--bg-card); /* theme-aware background */
  border-radius: 12px;
  box-shadow: 0 0 25px var(--glow-accent, rgba(128,0,255,0.4));
  color: var(--text-main); /* main text */
  overflow: hidden;
  transition: background 0.4s, color 0.4s, box-shadow 0.4s;
}

.glow-heading {
  text-align: center;
  font-size: 2.5rem;
  margin-bottom: 30px;
  color: var(--text-accent); /* accent color */
  text-shadow: 0 0 5px var(--glow-accent), 0 0 10px var(--glow-accent);
  transition: color 0.4s, text-shadow 0.4s;
}

.job-form .form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: bold;
  color: var(--text-accent);
  transition: color 0.4s;
}

input, select, textarea {
  width: 100%;
  padding: 10px 14px;
  border: 1px solid color-mix(in srgb, var(--text-muted) 30%, transparent);
  border-radius: 8px;
  background-color: color-mix(in srgb, var(--bg-surface, var(--bg-card)) 86%, transparent);
  color: var(--text-main);
  font-size: 1rem;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
  transition: box-shadow 0.2s ease, background 0.4s, color 0.4s, border-color 0.3s;
}

input::placeholder,
textarea::placeholder {
  color: color-mix(in srgb, var(--text-muted) 80%, var(--text-main) 20%);
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: color-mix(in srgb, var(--glow-accent) 75%, transparent);
  box-shadow: 0 0 10px var(--glow-accent);
}

.submit-btn {
  background: linear-gradient(45deg, var(--glow-accent), var(--text-accent));
  border: none;
  padding: 12px 20px;
  border-radius: 10px;
  width: 100%;
  color: var(--text-main);
  font-weight: bold;
  font-size: 1rem;
  cursor: pointer;
  box-shadow: 0 0 10px var(--glow-accent);
  transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s;
}

.submit-btn:hover {
  background: linear-gradient(45deg, var(--text-accent), var(--glow-accent));
  transform: scale(1.02);
}

.error {
  color: var(--text-danger);
  font-size: 0.875rem;
  margin-top: 4px;
}

.form-help {
  display: block;
  margin-top: 6px;
  color: var(--text-muted);
}

.category-suggestion-box {
  margin-top: 12px;
  padding: 12px;
  border: 1px solid color-mix(in srgb, var(--glow-accent) 35%, transparent);
  border-radius: 10px;
  background: color-mix(in srgb, var(--bg-card) 90%, transparent);
}

.category-suggestion-title {
  margin: 0 0 8px;
  font-weight: 700;
  color: var(--text-accent);
}

.category-suggestion-list {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.category-chip {
  border: 1px solid color-mix(in srgb, var(--glow-accent) 55%, transparent);
  background: color-mix(in srgb, var(--bg-surface, var(--bg-card)) 88%, transparent);
  color: var(--text-main);
  border-radius: 999px;
  padding: 5px 12px;
  font-size: 0.9rem;
  cursor: pointer;
}

.category-chip:hover,
.category-chip:focus-visible {
  color: var(--text-inverse);
  background: linear-gradient(45deg, var(--glow-accent), var(--text-accent));
}

/* Messages Popup */
#messages-popup {
  position: fixed;
  top: 0;
  left: 50%;
  transform: translateX(-50%) translateY(-100%);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
  animation: slideDown 0.5s forwards;
}

.message {
  background-color: var(--glow-accent, #ffb347);
  color: var(--text-main);
  padding: 12px 20px;
  border-radius: 25px;
  font-weight: bold;
  box-shadow: 0 0 10px var(--glow-accent), 0 0 20px var(--glow-accent);
  opacity: 0.95;
  transition: background 0.4s, color 0.4s, box-shadow 0.4s;
}

.message.error {
  background-color: var(--text-danger);
  color: var(--text-main);
  box-shadow: 0 0 10px var(--text-danger), 0 0 20px var(--text-danger);
}

@keyframes slideDown {
  to { transform: translateX(-50%) translateY(20px); }
}

@keyframes fadeOut {
  to { opacity: 0; transform: translateX(-50%) translateY(-50px); }
}


.logo-upload-shell {
  position: relative;
  border: 1px solid color-mix(in srgb, var(--glow-accent) 40%, transparent);
  border-radius: 16px;
  padding: 14px;
  background: linear-gradient(135deg, color-mix(in srgb, var(--bg-card) 72%, transparent), color-mix(in srgb, var(--glow-accent) 16%, transparent));
  box-shadow: 0 0 18px color-mix(in srgb, var(--glow-accent) 30%, transparent);
}

.logo-upload-shell::before {
  content: "✨ Brand it beautifully";
  display: block;
  font-size: 0.8rem;
  letter-spacing: 0.03em;
  margin-bottom: 10px;
  color: color-mix(in srgb, var(--text-accent) 86%, white);
}

.logo-upload-shell input[type="file"] {
  border: 1px dashed color-mix(in srgb, var(--glow-accent) 55%, transparent);
  padding: 12px;
  border-radius: 12px;
  background: color-mix(in srgb, var(--bg-main) 82%, transparent);
}

.logo-upload-shell input[type="file"]::file-selector-button {
  border: none;
  border-radius: 999px;
  padding: 8px 14px;
  margin-right: 10px;
  font-weight: 700;
  background: linear-gradient(45deg, var(--glow-accent), var(--text-accent));
  color: var(--text-main);
  cursor: pointer;
}

</style>

<div class="post-job-container">
  <h2 class="glow-heading">Post a Job</h2>

  <!-- Messages Popup -->
  {% if messages %}
    <div id="messages-popup">
      {% for message in messages %}
        <div class="message {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <form method="POST" enctype="multipart/form-data" class="job-form">
    {% csrf_token %}
    
    {% for field in form %}
      <div class="form-group">
        {% if field.name != "custom_category" %}<label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>{% endif %}

        {% if field.name == "location" %}
          {{ field|add_class:"form-input location-input" }}
          <input type="hidden" id="job-latitude" name="latitude" value="{{ form.instance.latitude|default:'' }}">
          <input type="hidden" id="job-longitude" name="longitude" value="{{ form.instance.longitude|default:'' }}">

        {% elif field.name == "salary" %}
          {% if field.value %}
            <strong style="display:block; margin-bottom:4px;">
              {{ field.value|floatformat:2|intcomma }}
            </strong>
          {% endif %}
          {{ field|add_class:"form-input" }}

        {% elif field.name == "category" %}
          <div style="display:none;">
            {{ field|add_class:"form-input" }}
          </div>

        {% elif field.name == "custom_category" %}
          <label class="form-label" for="{{ field.id_for_label }}">Category</label>
          {{ field|add_class:"form-input"|attr:"list:external-categories"|attr:"autocomplete:off" }}
          <small class="form-help">Start typing to see category suggestions.</small>
          <div class="category-suggestion-box">
            <p class="category-suggestion-title">Suggested categories</p>
            <ul id="category-suggestions" class="category-suggestion-list">
              <li class="form-help" id="category-suggestion-status">Loading categories…</li>
            </ul>
          </div>

        {% elif field.name == "company_logo" %}
          <div class="logo-upload-shell">
            {{ field }}
          </div>

        {% else %}
          {{ field|add_class:"form-input" }}
        {% endif %}

        {% if field.help_text %}
          <small class="form-help">{{ field.help_text }}</small>
        {% endif %}

        {% for error in field.errors %}
          <div class="error">{{ error }}</div>
        {% endfor %}
      </div>
    {% endfor %}
    
    <!-- Submit Button -->
    <button type="submit" class="submit-btn">Post Job</button>
  </form>

  <datalist id="external-categories"></datalist>
</div>

<script>
  // Automatically fade and remove messages
  setTimeout(() => {
    const popup = document.getElementById('messages-popup');
    if (popup) {
      popup.style.animation = 'fadeOut 0.5s forwards';
    }
  }, 3000);

  setTimeout(() => {
    const popup = document.getElementById('messages-popup');
    if (popup) popup.remove();
  }, 3500);

  const categoryInput = document.getElementById('id_custom_category');
  const categoryDatalist = document.getElementById('external-categories');
  const categorySuggestions = document.getElementById('category-suggestions');
  const categorySuggestionStatus = document.getElementById('category-suggestion-status');
  let categoryTimer;

  function renderSuggestionChips(categories) {
    if (!categorySuggestions) return;

    categorySuggestions.innerHTML = '';

    if (!categories.length) {
      const emptyItem = document.createElement('li');
      emptyItem.className = 'form-help';
      emptyItem.textContent = 'No matching categories found.';
      categorySuggestions.appendChild(emptyItem);
      return;
    }

    categories.slice(0, 10).forEach((name) => {
      const item = document.createElement('li');
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'category-chip';
      button.textContent = name;
      button.addEventListener('click', () => {
        if (categoryInput) {
          categoryInput.value = name;
          categoryInput.focus();
        }
      });
      item.appendChild(button);
      categorySuggestions.appendChild(item);
    });
  }

  async function fetchCategories(query = '') {
    if (!categoryInput || !categoryDatalist) return;

    try {
      const response = await fetch(`{% url "api_categories" %}?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      const categories = Array.isArray(data.categories) ? data.categories : [];

      categoryDatalist.innerHTML = '';
      categories.forEach((name) => {
        const option = document.createElement('option');
        option.value = name;
        categoryDatalist.appendChild(option);
      });
      renderSuggestionChips(categories);
      if (categorySuggestionStatus) categorySuggestionStatus.remove();
    } catch (error) {
      console.error('Unable to load external categories:', error);
      if (categorySuggestionStatus) {
        categorySuggestionStatus.textContent = 'Showing fallback categories.';
      }
    }
  }

  if (categoryInput && categoryDatalist) {
    fetchCategories('');
    categoryInput.addEventListener('input', (event) => {
      clearTimeout(categoryTimer);
      categoryTimer = setTimeout(() => {
        fetchCategories(event.target.value.trim());
      }, 250);
    });
  }
</script>
{% endblock %}
