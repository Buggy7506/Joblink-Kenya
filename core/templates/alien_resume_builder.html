{% extends "base.html" %}

{% block title %}Build Resume{% endblock %}

{% block content %}
<div class="container main">
  <div class="glass-card" style="padding: 2rem; max-width: 1000px; margin: auto;">
    <h1 style="text-align: center; color: var(--text-accent); margin-bottom: 1.5rem;">
      ðŸ’¼ Build Your Resume
    </h1>

    {% if messages %}
      {% for message in messages %}
        <div class="resume-messages {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <!-- Templates Button -->
    <div style="margin-bottom: 1rem; text-align: center;">
      <button id="template-btn" class="glow-btn" style="padding: 0.5rem 1.2rem; font-weight: bold;">
        ðŸ“„ Templates
      </button>
    </div>

    <form method="POST">
      {% csrf_token %}

      <!-- Quill Editor -->
      <div id="editor" style="
          min-height: 600px;
          background: var(--bg-card);
          border-radius: 1rem;
          padding: 1rem;
          overflow-y: auto;
          color: var(--text-main);
          font-family: 'Poppins', sans-serif;
          box-shadow: 0 0 20px rgba(0,0,0,0.15);
      ">
        {% if resume.content %}
          {{ resume.content|safe }}
        {% endif %}
      </div>

      <input type="hidden" name="content" id="resume-content">

      <!-- Save Button -->
      <button type="submit" id="save-btn" class="glow-btn" style="
          margin-top: 1.5rem;
          width: 100%;
          padding: 1rem;
          font-weight: bold;
          color: var(--text-main);
          background: var(--text-accent);
      ">
        Save Resume
      </button>
    </form>
  </div>
</div>

<!-- Template Modal -->
<div id="template-modal" style="
    display:none;
    position:fixed;
    inset:0;
    background: rgba(0,0,0,0.5);
    justify-content:center;
    align-items:center;
    z-index:999;
">
  <div style="
      background: var(--bg-card);
      padding: 2rem;
      border-radius: 1rem;
      max-width: 800px;
      width: 90%;
      text-align: center;
      max-height: 80vh;
      overflow-y: auto;
  ">
    <h2 style="color: var(--text-accent); margin-bottom: 1rem;">Choose a Template</h2>
    <div id="templates-list" style="display:flex; flex-direction:column; gap: 1rem;"></div>
    <button id="close-modal" class="glow-btn" style="margin-top:1rem;">Close</button>
  </div>
</div>

<!-- Quill.js -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>

<script>
// Initialize Quill editor
var quill = new Quill('#editor', {
  theme: 'snow',
  placeholder: 'Start building your professional resume...',
  modules: {
    toolbar: [
      [{ font: [] }],
      [{ size: ['small', false, 'large', 'huge'] }],
      [{ header: [1, 2, 3, 4, false] }],
      ['bold','italic','underline','strike'],
      [{ color: [] }, { background: [] }],
      [{ align: [] }],
      [{ list: 'ordered' }, { list: 'bullet' }],
      [{ indent: '-1' }, { indent: '+1' }],
      ['blockquote','code-block','link','image','video','formula'],
      ['clean']
    ]
  }
});

// Save content to hidden input
document.querySelector('form').onsubmit = function() {
  document.getElementById('resume-content').value = quill.root.innerHTML;
};

// Modal
var modal = document.getElementById('template-modal');
var listContainer = document.getElementById('templates-list');

document.getElementById('template-btn').onclick = async () => {
    modal.style.display = 'flex';
    listContainer.innerHTML = 'Loading templates...';

    try {
        // Fetch real templates from GitHub (HTML raw content)
        let templateUrls = [
            'https://gist.githubusercontent.com/theskumar/1877379/raw/resume.html',
            'https://gist.githubusercontent.com/1882510/raw/resume.html',
            'https://raw.githubusercontent.com/jiffyclub/html-css-resume-template/master/resume.html',
            'https://raw.githubusercontent.com/surajmandal/resume-templates/main/simple.html',
            'https://raw.githubusercontent.com/surajmandal/resume-templates/main/modern.html',
            'https://raw.githubusercontent.com/surajmandal/resume-templates/main/creative.html',
            'https://raw.githubusercontent.com/surajmandal/resume-templates/main/professional.html',
            'https://raw.githubusercontent.com/surajmandal/resume-templates/main/minimal-gray.html'
          ];


        listContainer.innerHTML = '';

        for(let url of templateUrls){
            let btn = document.createElement('button');
            btn.className = 'glow-btn';
            btn.style.margin = '0.2rem';
            let name = url.split('/').pop().replace('.html','').replace('-',' ');
            btn.innerText = name.charAt(0).toUpperCase() + name.slice(1);

            btn.onclick = async () => {
                let response = await fetch(url);
                let html = await response.text();
                quill.root.innerHTML = html;
                modal.style.display = 'none';
            };
            listContainer.appendChild(btn);
        }

    } catch(err) {
        listContainer.innerHTML = 'Failed to load templates.';
        console.error(err);
    }
};

// Close modal
document.getElementById('close-modal').onclick = () => modal.style.display = 'none';

// Auto-remove flash messages
document.addEventListener("DOMContentLoaded", function() {
  setTimeout(() => {
    document.querySelectorAll('.resume-messages').forEach(msg => msg.remove());
  }, 3000);
});
</script>

<style>
/* Glow buttons */
.glow-btn {
  border: none;
  border-radius: 0.5rem;
  background: linear-gradient(90deg, var(--text-accent), var(--glow-accent));
  color: var(--text-main);
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 0 10px var(--glow-accent), 0 0 20px var(--text-accent);
  transition: all 0.3s ease;
}

.glow-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 0 20px var(--glow-accent), 0 0 30px var(--text-accent) inset;
}
</style>
{% endblock %}
