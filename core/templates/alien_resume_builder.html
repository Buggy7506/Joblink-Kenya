{% extends "base.html" %}

{% block title %}Build Resume{% endblock %}

{% block content %}
<div class="resume-builder-shell">
  {% if messages %}
    <div class="builder-messages">
      {% for message in messages %}
        <div class="resume-messages {{ message.tags }}">{{ message }}</div>
      {% endfor %}
      {% for message in messages %}
        <div class="resume-messages {{ message.tags }}">{{ message }}</div>
      {% endfor %}
  {% endif %}

  <form method="POST" class="resume-builder">
    {% csrf_token %}
    </div>

    <header class="builder-topbar">
      <div class="builder-brand">
        <span class="brand-icon">ðŸ›¸</span>
        <div>
          <h1>Alien Resume Studio</h1>
          <p>Design like Canva, publish like a pro.</p>
        </div>
      </div>
      <div class="builder-actions">
        <button type="button" id="template-btn" class="builder-btn ghost">Templates</button>
        <button type="submit" id="save-btn" class="builder-btn primary">Save Resume</button>
      </div>
    </header>
      </div>

    <div class="builder-body">
      <aside class="builder-sidebar">
        <div class="sidebar-card">
          <h2>Design Tools</h2>
          <p>Pick a layout, then edit directly on the canvas with the toolbar.</p>
          <button type="button" class="builder-btn secondary" id="template-btn-sidebar">Browse Templates</button>
        </div>
        <div class="sidebar-card">
          <h3>Tips</h3>
          <ul>
            <li>Keep it to one page for most roles.</li>
            <li>Start bullet points with action verbs.</li>
            <li>Use numbers to show impact.</li>
          </ul>
        </div>
      </aside>

      <main class="builder-canvas">
        <div class="canvas-header">
          <span>Resume Canvas</span>
          <span class="canvas-hint">A4 â€¢ 8.27 Ã— 11.69 in</span>
        </div>

        <div id="editor" class="resume-editor">
          {% if resume.content %}
            {{ resume.content|safe }}
          {% endif %}
        </div>
      </main>
    </div>

    <input type="hidden" name="content" id="resume-content">
  </form>
</div>

<!-- Template Modal -->
<div id="template-modal" class="template-modal">
  <div class="template-modal-card">
    <div class="template-modal-header">
      <h2>Choose a Template</h2>
      <button type="button" id="close-modal" class="builder-btn ghost">Close</button>
    </div>
    <div id="templates-list" class="template-list"></div>
  </div>
</div>

<!-- Quill.js -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>

<script>
// Initialize Quill editor
var quill = new Quill('#editor', {
  theme: 'snow',
  placeholder: 'Start building your professional resume...',
  modules: {
    toolbar: [
      [{ font: [] }],
      [{ size: ['small', false, 'large', 'huge'] }],
      [{ header: [1, 2, 3, 4, false] }],
      ['bold','italic','underline','strike'],
      [{ color: [] }, { background: [] }],
      [{ align: [] }],
      [{ list: 'ordered' }, { list: 'bullet' }],
      [{ indent: '-1' }, { indent: '+1' }],
      ['blockquote','code-block','link','image','video','formula'],
      ['clean']
    ]
  }
});

function setTemplateStyles(cssText) {
  const existing = document.querySelector('style[data-template-style]');
  if (existing) {
    existing.remove();
  }
  if (!cssText) {
    return;
  }
  const styleTag = document.createElement('style');
  styleTag.setAttribute('data-template-style', 'true');
  styleTag.textContent = cssText;
  document.head.appendChild(styleTag);
}

function applyTemplateToCanvas(content) {
  const wrapped = `<div class="template-canvas">${content}</div>`;
  quill.setContents([]);
  quill.clipboard.dangerouslyPasteHTML(wrapped);
}
  
// Save content to hidden input
document.querySelector('form').onsubmit = function() {
  document.getElementById('resume-content').value = quill.root.innerHTML;
};

// Modal
var modal = document.getElementById('template-modal');
var listContainer = document.getElementById('templates-list');

const templateTriggers = [document.getElementById('template-btn'), document.getElementById('template-btn-sidebar')];
templateTriggers.forEach(trigger => {
  if(trigger){
    trigger.onclick = async () => {
    modal.style.display = 'flex';
    listContainer.innerHTML = 'Loading templates...';

    const templates = [
      {
        name: 'Resume Classic',
        description: 'Elegant, resume-first layout with strong hierarchy.',
        url: 'https://raw.githubusercontent.com/StartBootstrap/startbootstrap-resume/gh-pages/index.html',
        cssUrls: [
          'https://raw.githubusercontent.com/StartBootstrap/startbootstrap-resume/gh-pages/css/styles.css',
        ],
      },
      {
        name: 'Personal Profile',
        description: 'Modern profile template with bold sections and cards.',
        url: 'https://raw.githubusercontent.com/StartBootstrap/startbootstrap-personal/gh-pages/index.html',
        cssUrls: [
          'https://raw.githubusercontent.com/StartBootstrap/startbootstrap-personal/gh-pages/css/styles.css',
        ],
      },
      {
        name: 'Creative Portfolio',
        description: 'Visual-heavy layout with showcase sections.',
        url: 'https://raw.githubusercontent.com/StartBootstrap/startbootstrap-freelancer/gh-pages/index.html',
        cssUrls: [
          'https://raw.githubusercontent.com/StartBootstrap/startbootstrap-freelancer/gh-pages/css/styles.css',
        ],
      },
      {
        name: 'Agency',
        description: 'Canva-like hero sections with timeline styling.',
        url: 'https://raw.githubusercontent.com/StartBootstrap/startbootstrap-agency/gh-pages/index.html',
        cssUrls: [
          'https://raw.githubusercontent.com/StartBootstrap/startbootstrap-agency/gh-pages/css/styles.css',
        ],
      },
    ];

    listContainer.innerHTML = '';

        const loadTemplateAssets = async (template) => {
      if (template.__loaded) {
        return template;
      }
      const response = await fetch(template.url);
      if (!response.ok) {
        throw new Error('Failed to load template.');
      }
      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      doc.querySelectorAll('script').forEach(script => script.remove());
      const styles = Array.from(doc.querySelectorAll('style'))
        .map(style => style.textContent || '')
        .join('\n');
      const cssResponses = await Promise.all(
        (template.cssUrls || []).map(cssUrl => fetch(cssUrl))
      );
      const cssText = await Promise.all(
        cssResponses
          .filter(res => res.ok)
          .map(res => res.text())
      );
      const externalStyles = cssText.join('\n');
      template.__loaded = true;
      template.htmlContent = html;
      template.styleText = `${styles}\n${externalStyles}`;
      template.bodyContent = doc.body ? doc.body.innerHTML : '';
      return template;
    };

    const buildPreview = (template, previewContainer) => {
      const iframe = document.createElement('iframe');
      iframe.className = 'template-preview-frame';
      const previewStyles = `
        html, body { margin: 0; padding: 0; background: #fff; }
        body { transform: scale(0.38); transform-origin: top left; width: 900px; }
      `;
      iframe.srcdoc = `
        <html>
          <head>
            <style>${previewStyles}</style>
            <style>${template.styleText || ''}</style>
          </head>
          <body>${template.bodyContent || ''}</body>
        </html>
      `;
      previewContainer.innerHTML = '';
      previewContainer.appendChild(iframe);
    };

    templates.forEach(template => {
      const card = document.createElement('div');
      card.className = 'template-card';
      card.innerHTML = `
        <div class="template-card-header">
          <h3>${template.name}</h3>
          <span>${template.description}</span>
        </div>
        <div class="template-preview">
          <div class="template-preview-placeholder">
            <span>Loading preview...</span>
          </div>
        </div>
      `;

      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'builder-btn secondary template-select-btn';
      button.textContent = 'Use this template';
      button.onclick = async () => {
        button.disabled = true;
        button.textContent = 'Loading...';
        try {
          await loadTemplateAssets(template);
          setTemplateStyles(template.styleText);
          applyTemplateToCanvas(template.bodyContent);
          modal.style.display = 'none';
        } catch (err) {
          console.error(err);
          button.textContent = 'Failed. Try again';
          button.disabled = false;
        }
      };

      card.appendChild(button);
      listContainer.appendChild(card);

      const previewContainer = card.querySelector('.template-preview');
      loadTemplateAssets(template)
        .then(() => buildPreview(template, previewContainer))
        .catch(err => {
          console.error(err);
          previewContainer.innerHTML = `
            <div class="template-preview-placeholder">
              <span>Preview unavailable</span>
            </div>
          `;
        });
    });
  };
}
});

// Close modal
document.getElementById('close-modal').onclick = () => modal.style.display = 'none';

// Auto-remove flash messages
document.addEventListener("DOMContentLoaded", function() {
  setTimeout(() => {
    document.querySelectorAll('.resume-messages').forEach(msg => msg.remove());
  }, 3000);
});
</script>

<style>
/* Glow buttons */
.resume-builder-shell {
  padding: 2rem 1.5rem 3rem;
}

.builder-messages {
  max-width: 1200px;
  margin: 0 auto 1rem;
}

.resume-builder {
  max-width: 1200px;
  margin: 0 auto;
  background: var(--bg-card);
  border-radius: 20px;
  box-shadow: 0 20px 45px rgba(0, 0, 0, 0.2);
  overflow: hidden;
  border: 1px solid var(--bg-surface-soft);
}

.builder-topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem 2rem;
  background: linear-gradient(135deg, var(--bg-surface), var(--bg-card));
  border-bottom: 1px solid var(--bg-surface-soft);
}

.builder-brand {
  display: flex;
  align-items: center;
  gap: 1rem;
  color: var(--text-main);
}

.builder-brand h1 {
  margin: 0;
  font-size: 1.5rem;
}

.builder-brand p {
  margin: 0.25rem 0 0;
  color: var(--text-muted);
  font-size: 0.95rem;
}

.brand-icon {
  font-size: 2rem;
}

.builder-actions {
  display: flex;
  gap: 0.75rem;
}

.builder-btn {
  border: none;
  border-radius: 999px;
  padding: 0.6rem 1.4rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.builder-btn.primary {
  background: linear-gradient(135deg, var(--text-accent), var(--glow-accent));
  color: #fff;
  box-shadow: 0 10px 20px rgba(0, 255, 255, 0.25);
}

.builder-btn.secondary {
  background: var(--bg-surface);
  color: var(--text-main);
  border: 1px solid var(--bg-surface-soft);
}

.builder-btn.ghost {
  background: transparent;
  color: var(--text-main);
  border: 1px solid var(--bg-surface-soft);
}

.builder-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.2);
}

.builder-body {
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: 720px;
}

.builder-sidebar {
  padding: 1.5rem;
  background: var(--bg-surface);
  border-right: 1px solid var(--bg-surface-soft);
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  color: var(--text-main);
}

.sidebar-card {
  background: var(--bg-card);
  padding: 1.25rem;
  border-radius: 16px;
  box-shadow: inset 0 0 0 1px var(--bg-surface-soft);
}

.sidebar-card h2,
.sidebar-card h3 {
  margin-top: 0;
  color: var(--text-accent);
}

.sidebar-card p,
.sidebar-card li {
  color: var(--text-muted);
}

.sidebar-card ul {
  padding-left: 1.1rem;
  margin: 0;
  display: grid;
  gap: 0.4rem;
}

.builder-canvas {
  padding: 2rem;
  background: var(--bg-surface-soft);
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.canvas-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: var(--text-muted);
  font-size: 0.9rem;
}

.resume-editor {
  min-height: 640px;
  background: #ffffff;
  border-radius: 18px;
  padding: 2rem;
  overflow-y: auto;
  color: #0f172a;
  font-family: 'Poppins', sans-serif;
  box-shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
  border: 1px solid rgba(148, 163, 184, 0.35);
    position: relative;
}

.resume-editor .template-canvas {
  min-height: 640px;
  width: 100%;
}

.resume-editor .template-canvas img,
.resume-editor .template-canvas video,
.resume-editor .template-canvas iframe {
  max-width: 100%;
}

.ql-toolbar.ql-snow {
  border-radius: 16px 16px 0 0;
  border-color: rgba(148, 163, 184, 0.35);
  background: var(--bg-surface);
}

.ql-container.ql-snow {
  border-radius: 0 0 16px 16px;
  border-color: rgba(148, 163, 184, 0.35);
}

.template-modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(10, 12, 25, 0.5);
  justify-content: center;
  align-items: center;
  z-index: 999;
}

.template-modal-card {
  background: var(--bg-card);
  padding: 2rem;
  border-radius: 1.25rem;
  max-width: 860px;
  width: 92%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 45px rgba(0, 0, 0, 0.3);
}

.template-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.template-modal-header h2 {
  margin: 0;
  color: var(--text-accent);
}

.template-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 1rem;
}

.template-card {
  background: var(--bg-surface);
  border-radius: 16px;
  padding: 1rem;
  border: 1px solid var(--bg-surface-soft);
  display: flex;
  flex-direction: column;
  gap: 0.85rem;
}

.template-card-header h3 {
  margin: 0 0 0.35rem;
  color: var(--text-accent);
}

.template-card-header span {
  color: var(--text-muted);
  font-size: 0.85rem;
}

.template-preview {
  background: rgba(15, 23, 42, 0.05);
  border-radius: 12px;
  padding: 0.75rem;
  font-size: 0.82rem;
  color: var(--text-main);
  min-height: 180px;
  display: grid;
  place-items: center;
  position: relative;
  overflow: hidden;
  aspect-ratio: 3 / 4;
  border: 1px solid rgba(148, 163, 184, 0.4);
}

.template-preview span {
  color: var(--text-muted);
  font-size: 0.72rem;
}

.template-preview-placeholder {
  display: grid;
  place-items: center;
  width: 100%;
  height: 100%;
  color: var(--text-muted);
  font-size: 0.8rem;
  text-align: center;
}

.template-preview-frame {
  width: 100%;
  height: 100%;
  border: none;
  background: #fff;
}
  
.template-select-btn {
  width: 100%;
  border-radius: 12px;
}

@media (max-width: 980px) {
  .builder-body {
    grid-template-columns: 1fr;
  }

  .builder-sidebar {
    border-right: none;
    border-bottom: 1px solid var(--bg-surface-soft);
  }
}
</style>
{% endblock %}
