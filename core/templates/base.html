{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JobLink Kenya - {% block title %}{% endblock %}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script src="https://kit.fontawesome.com/a2c5a4f60f.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>

<style>
/* same CSS as yours (kept unchanged for brevity) */
</style>
</head>
<body>

<header class="nav-bg">
  <!-- nav kept unchanged -->
</header>

<main class="main container" data-aos="fade-up">
  {% block content %}{% endblock %}
</main>

<footer class="footer glow-border">
  <p>&copy; 2025 <span style="color:#22d3ee;">JobLink Kenya</span>. All rights reserved.</p>
</footer>

{% if user.is_authenticated %}
  {% if user.role in 'applicant employer' %}
    <!-- Chat Button -->
    <button id="chat-btn"><i class="fas fa-comments"></i></button>

    <div id="chat-modal" data-user-id="{{ user.id }}">
        <div id="chat-modal-header">
            Chat
            <span id="chat-close"><i class="fas fa-times"></i></span>
        </div>
        <div id="chat-modal-body">
            <div id="chat-jobs-list">
                {% if user.role == 'applicant' %}
                    {% for application in user.applications.all %}
                        {% if application.job.is_premium %}
                            <div class="chat-job-item" 
                                 data-chat-url="{% url 'chat_view' application_id=application.id %}">
                                {{ application.job.title }}
                            </div>
                        {% endif %}
                    {% empty %}
                        <p style="color:#ccc;">You haven't applied to any premium jobs yet.</p>
                    {% endfor %}
                {% elif user.role == 'employer' %}
                    {% for job in user.jobs_posted.all %}
                        <div class="chat-job-item" 
                             data-chat-url="{% url 'chat_view' job_id=job.id %}">
                            {{ job.title }}
                        </div>
                    {% empty %}
                        <p style="color:#ccc;">You haven't posted any jobs yet.</p>
                    {% endfor %}
                {% endif %}
            </div>
            <div id="chat-messages">
                <p style="color:#ccc;">Select a job above to load chat.</p>
            </div>
            <div id="chat-input-container">
                <input type="text" id="chat-input" placeholder="Type a message..." />
                <button id="chat-send"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
  {% endif %}
{% endif %}

<script>
AOS.init();

// Mobile menu toggle
document.getElementById('menuToggle').addEventListener('click', () => {
    const menu = document.getElementById('mobileMenu');
    menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'flex' : 'none';
});

// Chat modal toggle
const chatBtn = document.getElementById('chat-btn');
const chatModal = document.getElementById('chat-modal');
const chatClose = document.getElementById('chat-close');
const chatMessages = $('#chat-messages');
const chatInput = $('#chat-input');
const chatSend = $('#chat-send');

if(chatBtn && chatModal){
    chatBtn.addEventListener('click', () => {
        chatModal.style.display = chatModal.style.display === 'flex' ? 'none' : 'flex';
        chatModal.style.flexDirection = 'column';
    });

    chatClose.addEventListener('click', () => {
        chatModal.style.display = 'none';
    });

    // Load chat when clicking a job
    $('.chat-job-item').on('click', function(){
        const chatUrl = $(this).data('chat-url');
        chatModal.dataset.chatUrl = chatUrl;
        loadChat(chatUrl);
    });

    // Load chat dynamically (expects JSON response)
    function loadChat(chatUrl){
        $.get(chatUrl, {format: "json"}, function(data){
            chatMessages.html('');
            if(data.messages.length === 0){
                chatMessages.append('<p style="color:#ccc;">No messages yet.</p>');
            } else {
                data.messages.forEach(msg => {
                    const msgClass = msg.sender_id == {{ user.id }} ? 'sender' : 'receiver';
                    chatMessages.append(`<div class="chat-message ${msgClass}">${msg.text}</div>`);
                });
                chatMessages.scrollTop(chatMessages[0].scrollHeight);
            }
        });
    }

    // Send message
    chatSend.on('click', function(){
        const text = chatInput.val();
        if(!text) return;
        $.post(chatModal.dataset.chatUrl, {
            message: text,
            csrfmiddlewaretoken: '{{ csrf_token }}',
            format: "json"
        }, function(data){
            loadChat(chatModal.dataset.chatUrl);
            chatInput.val('');
        });
    });
}
</script>

</body>
</html>
