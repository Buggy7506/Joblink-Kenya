{% extends "base.html" %}
{% block title %}Employer Chat â€” {{ job.title }}{% endblock %}
{% block content %}

<!-- Floating Chat Button -->
<div id="chat-popup-button" style="position:fixed;bottom:20px;right:20px;z-index:999;">
  <button id="open-chat" style="padding:12px 16px;border-radius:50%;background:#00ffc6;border:none;cursor:pointer;">
    ðŸ’¬
  </button>
</div>

<!-- Chat Modal -->
<div id="chat-popup" style="display:none;position:fixed;bottom:70px;right:20px;width:400px;max-height:500px;background:rgba(15,15,30,0.95);border-radius:16px;box-shadow:0 0 22px rgba(0,255,200,0.25);overflow:hidden;z-index:999;">
  
  <div style="padding:12px;background:#111;color:#fff;font-weight:bold;display:flex;justify-content:space-between;align-items:center;">
    Chat with Applicants
    <span id="close-chat" style="cursor:pointer;">âœ–</span>
  </div>

  <!-- Applicants List -->
  <div id="applicants-list" style="padding:12px;max-height:150px;overflow-y:auto;border-bottom:1px solid rgba(0,255,200,0.2);">
    {% if applicants %}
      {% for app in applicants %}
        {% if app.job.is_premium %}
          <div class="applicant-item" data-appid="{{ app.id }}" style="padding:8px;margin-bottom:6px;background:#222;border-radius:8px;cursor:pointer;">
            {{ app.user.username }}
          </div>
        {% endif %}
      {% endfor %}
    {% else %}
      <p style="opacity:.7;text-align:center;">No premium applicants yet.</p>
    {% endif %}
  </div>

  <!-- Chat Body -->
  <div id="chat-popup-body" style="padding:12px;overflow-y:auto;height:250px;">
    <p style="opacity:.7;text-align:center;margin-top:16px;">Select an applicant to start chatting.</p>
  </div>

  <!-- Chat Input -->
  <form id="chat-popup-form" style="display:flex;padding:12px;border-top:1px solid rgba(0,255,200,0.2);">
    {% csrf_token %}
    <input id="chat-popup-input" type="text" placeholder="Type a messageâ€¦" style="flex:1;padding:8px;border-radius:10px;border:none;outline:none;background:#111;color:#fff;" disabled/>
    <button type="button" id="chat-popup-send" style="padding:8px 12px;border:none;border-radius:10px;background:#00ffc6;color:#111;cursor:pointer;" disabled>Send</button>
  </form>
</div>

<script>
(function() {
  const chatButton = document.getElementById("open-chat");
  const chatPopup = document.getElementById("chat-popup");
  const chatClose = document.getElementById("close-chat");
  const chatBody = document.getElementById("chat-popup-body");
  const input = document.getElementById("chat-popup-input");
  const sendBtn = document.getElementById("chat-popup-send");
  const applicantItems = document.querySelectorAll(".applicant-item");

  let socket;
  let currentAppId = null;
  const userName = "{{ request.user.username|escapejs }}";

  // Open / close popup
  chatButton.addEventListener("click", () => chatPopup.style.display = "block");
  chatClose.addEventListener("click", () => chatPopup.style.display = "none");

  // Select applicant to chat
  applicantItems.forEach(item => {
    item.addEventListener("click", () => {
      currentAppId = item.dataset.appid;
      chatBody.innerHTML = "<p style='opacity:.7;text-align:center;margin-top:16px;'>Loading chatâ€¦</p>";
      input.disabled = false;
      sendBtn.disabled = false;

      // Initialize WebSocket
      if (socket) socket.close();
      const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
      socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/chat/${currentAppId}/`);

      socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.message) {
          const bubble = document.createElement("div");
          bubble.className = data.sender === userName ? "me" : "them";
          bubble.style.padding = "6px 10px";
          bubble.style.margin = "4px 0";
          bubble.style.borderRadius = "10px";
          bubble.style.background = data.sender === userName ? "#00ffc6" : "#222";
          bubble.style.color = data.sender === userName ? "#111" : "#fff";
          bubble.innerHTML = `<strong>${data.sender}</strong>: ${data.message}`;
          chatBody.appendChild(bubble);
          chatBody.scrollTop = chatBody.scrollHeight;
        }
      };
    });
  });

  function sendMessage() {
    const text = input.value.trim();
    if (!text || !socket || socket.readyState !== 1) return;
    socket.send(JSON.stringify({ message: text }));
    input.value = "";
  }

  sendBtn.addEventListener("click", sendMessage);
  input.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); sendMessage(); } });

})();
</script>

{% endblock %}
