{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Change Personal Info{% endblock %}

{% block content %}
<div class="update-account-wrapper">
  <div class="form-container">
    <h2>Personal Info</h2>

    <form method="POST" enctype="multipart/form-data" id="profile-form">
      {% csrf_token %}

      {{ form.non_field_errors }}

        <!-- BASIC FIELDS -->
        <div class="form-group">
          {{ form.username.label_tag }} {{ form.username|add_class:"form-input" }}
        </div>
        <div class="form-group">
          {{ form.first_name.label_tag }} {{ form.first_name|add_class:"form-input" }}
        </div>
        <div class="form-group">
          {{ form.last_name.label_tag }} {{ form.last_name|add_class:"form-input" }}
        </div>
        <div class="form-group">
          {{ form.email.label_tag }} {{ form.email|add_class:"form-input" }}
        </div>
        <div class="form-group">
          {{ form.phone.label_tag }} {{ form.phone|add_class:"form-input" }}
        </div>
        
        <!-- LOCATION FIELD WITH OSM AUTOCOMPLETE -->
        <div class="form-group" style="position: relative;">
          {{ form.location.label_tag }}
          {{ form.location|add_class:"form-input location-input" 
                |attr:"data-lat-input=latitude,data-lon-input=longitude,placeholder=Enter your location" }}
          <input type="hidden" id="latitude" name="latitude" value="{{ form.instance.latitude|default:'' }}">
          <input type="hidden" id="longitude" name="longitude" value="{{ form.instance.longitude|default:'' }}">
        </div>

      {% if user.role == 'applicant' %}
        <div class="form-group">
          {{ form.skills.label_tag }} {{ form.skills|add_class:"form-input" }}
        </div>
      
        <!-- CV Upload + Delete -->
        <div class="cv-upload-wrapper">
          <label for="upload-cv" class="cv-upload-button">üìÑ Upload CV</label>
          <input type="file" id="upload-cv" name="{{ form.upload_cv.html_name }}" style="display:none;">
      
          <span id="cv-filename" class="cv-filename">
            {% if cv_filename %}
              {{ cv_filename }}
            {% else %}
              No file selected
            {% endif %}
          </span>
      
          {% if user_cv %}
            <button type="button" id="delete-cv-btn" class="cv-delete-button">üóë Delete</button>
          {% endif %}
        </div>
      {% endif %}

      <input type="submit" value="Save Changes" class="submit-btn">
    </form>

    <a href="{% if user.is_superuser or user.role == 'admin' %}{% url 'admin_dashboard' %}{% else %}{% url 'dashboard' %}{% endif %}" 
       class="button">‚Üê Dashboard</a>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Wrapper */
.update-account-wrapper {
  display:flex;
  justify-content:center;
  padding:50px 20px;
  background: var(--page-bg);
  font-family:'Segoe UI', sans-serif;
  color: var(--text);
}

.form-container {
  max-width:500px;
  width:100%;
  padding:30px;
  background: var(--card-bg);
  border-radius:20px;
  border:2px solid var(--accent);
  box-shadow:0 0 25px var(--glow-soft),0 0 40px var(--glow-strong);
}

.form-container h2 {
  text-align:center;
  color: var(--accent);
  margin-bottom:25px;
  text-shadow:0 0 12px var(--accent);
}

/* Profile Picture */
.profile-pic-wrapper {
  position:relative;
  display:flex;
  justify-content:center;
  margin-bottom:30px;
  perspective: 800px;
}

#profile-pic-preview {
  width:140px;
  height:140px;
  border-radius:50%;
  object-fit:cover;
  border:4px solid transparent;
  padding:5px;
  background: linear-gradient(45deg, #8e2de2, #4a00e0);
  box-shadow:0 0 15px #8e2de2,0 0 25px #4a00e0,0 0 50px rgba(142,45,226,0.4);
  cursor:pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.profile-pic-hover {
  position:absolute;
  bottom:-10px;
  font-size:14px;
  font-weight:bold;
  color:#fff;
  text-shadow:0 0 8px #8e2de2;
  pointer-events:none;
}

/* Inputs */
.form-input, .cv-upload-wrapper input[type="file"] {
  width:100%;
  padding:12px;
  margin-bottom:20px;
  border-radius:10px;
  border:1px solid var(--border);
  background:var(--input-bg);
  color:var(--text);
  box-shadow: inset 0 0 8px var(--glow-soft);
}

/* Submit button */
.submit-btn {
  width:100%;
  padding:12px;
  border-radius:10px;
  background: linear-gradient(90deg,var(--accent),var(--accent-alt));
  border:none;
  color: var(--btn-text);
  font-weight:bold;
  cursor:pointer;
  box-shadow:0 0 15px var(--glow-soft),0 0 25px var(--glow-strong);
  transition:0.3s;
}

.submit-btn:hover {
  transform:translateY(-2px);
  box-shadow:0 0 25px var(--glow-strong),0 0 45px var(--glow-strong);
}

/* Dashboard button */
.button {
  display:inline-block;
  margin-top:15px;
  padding:12px 20px;
  border-radius:10px;
  text-decoration:none;
  color: var(--btn-text);
  background: linear-gradient(90deg,var(--accent),var(--accent-alt));
  text-align:center;
  font-weight:bold;
  box-shadow:0 0 15px var(--glow-soft),0 0 25px var(--glow-strong);
  transition:0.3s;
}

.button:hover {
  transform:translateY(-2px);
  box-shadow:0 0 25px var(--glow-strong),0 0 45px var(--glow-strong);
}

/* CV Upload */
.cv-upload-wrapper {
  display:flex;
  align-items:center;
  margin-bottom:20px;
}

.cv-upload-button {
  padding:12px 20px;
  border-radius:10px;
  background: linear-gradient(45deg,#8e2de2,#4a00e0);
  color:#fff;
  font-weight:bold;
  cursor:pointer;
  margin-right:15px;
  text-align:center;
  box-shadow:0 0 15px #8e2de2,0 0 25px #4a00e0;
  transition:0.3s;
}

.cv-upload-button:hover {
  transform:translateY(-2px);
  box-shadow:0 0 25px #4a00e0,0 0 45px #8e2de2;
}

.cv-filename {
  font-size:14px;
  color: var(--text);
  font-style:italic;
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
  max-width:200px;
}

/* Responsive */
@media(max-width:600px){
  .update-account-wrapper{padding:30px 10px;}
  .form-container{padding:20px;border-radius:12px;}
  .form-container h2{font-size:20px;}
  .form-input{font-size:14px;padding:8px;}
  .submit-btn,.button{font-size:15px;padding:10px;}
}

.cv-delete-button {
  padding: 8px 12px;
  border-radius: 8px;
  background: #f87171;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  border: none;
  margin-left: 10px;
  box-shadow: 0 0 10px rgba(248, 113, 113, 0.5);
  transition: 0.3s;
}
.cv-delete-button:hover {
  background: #ef4444;
  box-shadow: 0 0 15px rgba(239, 68, 68, 0.6);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

  // -------------------------------
  // PROFILE PICTURE PREVIEW + 3D HOVER
  // -------------------------------
  const profilePic = document.getElementById('profile-pic-preview');
  const profileInput = document.getElementById('profile-pic-input');

  if (profilePic && profileInput) {
    profilePic.addEventListener('click', () => profileInput.click());
    profilePic.addEventListener('touchstart', () => profileInput.click());

    profileInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = e => profilePic.src = e.target.result;
        reader.readAsDataURL(this.files[0]);
      }
    });

    profilePic.addEventListener('mousemove', e => {
      const rect = profilePic.getBoundingClientRect();
      const dx = (e.clientX - rect.left - rect.width / 2) / (rect.width / 2);
      const dy = (e.clientY - rect.top - rect.height / 2) / (rect.height / 2);
      profilePic.style.transform = `rotateX(${-dy*15}deg) rotateY(${dx*15}deg) scale(1.08)`;
      profilePic.style.boxShadow = `${dx*30}px ${dy*30}px 35px #8e2de2, ${-dx*30}px ${-dy*30}px 50px #4a00e0, 0 0 70px rgba(142,45,226,0.6)`;
    });

    profilePic.addEventListener('mouseleave', () => {
      profilePic.style.transform = 'rotateX(0deg) rotateY(0deg) scale(1)';
      profilePic.style.boxShadow = '0 0 15px #8e2de2, 0 0 25px #4a00e0, 0 0 50px rgba(142,45,226,0.4)';
    });
  }

  // -------------------------------
  // CV UPLOAD FILENAME DISPLAY
  // -------------------------------
  const cvInput = document.getElementById('upload-cv');
  const cvFilename = document.getElementById('cv-filename');
  const deleteBtn = document.getElementById('delete-cv-btn');

  {% if cv_filename %}
    if(cvFilename) cvFilename.textContent = "{{ cv_filename }}";
  {% endif %}

  if (cvInput && cvFilename) {
    cvInput.addEventListener('change', () => {
      cvFilename.textContent = cvInput.files.length ? cvInput.files[0].name : 'No file selected';
    });
  }

  // -------------------------------
  // CV DELETE BUTTON FUNCTIONALITY
  // -------------------------------
  if (deleteBtn && cvFilename) {
    deleteBtn.addEventListener('click', function() {
      if (confirm('Are you sure you want to delete your CV?')) {
        fetch("{% url 'delete_cv' %}", {
          method: 'POST',
          headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'deleted') {
            cvFilename.textContent = 'No file selected';
            deleteBtn.remove();
          }
        });
      }
    });
  }

  // -------------------------------
  // OPENSTREETMAP / NOMINATIM AUTOCOMPLETE
  // -------------------------------
  const locationInput = document.querySelector('.location-input');
  if (locationInput) {
    const latField = document.getElementById(locationInput.dataset.latInput);
    const lonField = document.getElementById(locationInput.dataset.lonInput);
    
    // Create a dropdown container
    const dropdown = document.createElement('div');
    dropdown.classList.add('autocomplete-dropdown');
    dropdown.style.position = 'absolute';
    dropdown.style.top = (locationInput.offsetHeight + 5) + 'px';
    dropdown.style.left = '0';
    dropdown.style.width = '100%';
    dropdown.style.background = 'var(--bg-card)';
    dropdown.style.border = '1px solid var(--text-muted)';
    dropdown.style.borderRadius = '0.5rem';
    dropdown.style.zIndex = '1000';
    dropdown.style.maxHeight = '200px';
    dropdown.style.overflowY = 'auto';
    dropdown.style.display = 'none';
    locationInput.parentNode.style.position = 'relative';
    locationInput.parentNode.appendChild(dropdown);

    let debounceTimer;
    locationInput.addEventListener('input', function() {
      const query = this.value;
      if (debounceTimer) clearTimeout(debounceTimer);

      if (!query) {
        dropdown.style.display = 'none';
        return;
      }

      debounceTimer = setTimeout(() => {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`)
          .then(res => res.json())
          .then(data => {
            dropdown.innerHTML = '';
            if (data.length === 0) {
              dropdown.style.display = 'none';
              return;
            }

            data.forEach(item => {
              const option = document.createElement('div');
              option.textContent = item.display_name;
              option.style.padding = '0.5rem';
              option.style.cursor = 'pointer';
              option.addEventListener('click', () => {
                locationInput.value = item.display_name;
                if (latField) latField.value = item.lat;
                if (lonField) lonField.value = item.lon;
                dropdown.style.display = 'none';
              });
              dropdown.appendChild(option);
            });
            dropdown.style.display = 'block';
          });
      }, 350); // debounce 350ms
    });

    // Hide dropdown on click outside
    document.addEventListener('click', (e) => {
      if (!locationInput.parentNode.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });
  }

});
</script>
{% endblock %}
