{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}Change Personal Info{% endblock %}

{% block content %}
<div class="update-account-wrapper">
  <div class="form-container">
    <h2>Personal Info</h2>

    <form method="POST" enctype="multipart/form-data" id="profile-form">
      {% csrf_token %}

      {{ form.non_field_errors }}

        <!-- BASIC FIELDS -->
          <div class="form-group">
            {{ form.username.label_tag }} {{ form.username|add_class:"form-input" }}
          </div>
          <div class="form-group">
            {{ form.first_name.label_tag }} {{ form.first_name|add_class:"form-input" }}
          </div>
          <div class="form-group">
            {{ form.last_name.label_tag }} {{ form.last_name|add_class:"form-input" }}
          </div>
          <div class="form-group">
            {{ form.email.label_tag }} {{ form.email|add_class:"form-input" }}
          </div>
          <div class="form-group">
            {{ form.phone.label_tag }}
            {% render_field form.phone type="hidden" id="id_phone" %}
            <div class="phone-group" id="editPhoneGroup">
              <select id="edit_country" class="country-select" data-default="KE"></select>
              <button type="button" class="country-trigger" id="edit_country_trigger" aria-haspopup="listbox" aria-expanded="false">
                <img class="country-flag" id="edit_country_flag" src="https://flagsapi.com/KE/flat/64.png" alt="Kenya (+254)">
                <span class="country-caret">‚ñæ</span>
              </button>
              <div class="phone-input-wrapper">
                <span class="phone-dial" id="edit_phone_dial">+254</span>
                <input type="text" id="edit_phone_display" class="phone-number-input" inputmode="numeric" autocomplete="tel-national" placeholder="712 345 678">
              </div>
              <div class="country-menu hidden" id="edit_country_menu"></div>
            </div>
          </div>
          
         <!-- LOCATION FIELD WITH OSM AUTOCOMPLETE -->
        <div class="form-group" style="position: relative;">
            {{ form.location.label_tag }}
            <input
                type="text"
                name="{{ form.location.html_name }}"
                id="{{ form.location.id_for_label }}"
                value="{{ form.location.value|default_if_none:'' }}"
                class="form-input location-input"
                placeholder="Enter your location"
                data-lat-input="latitude"
                data-lon-input="longitude"
            >
            <input type="hidden" id="latitude" name="latitude" value="{{ form.instance.latitude|default_if_none:'' }}">
            <input type="hidden" id="longitude" name="longitude" value="{{ form.instance.longitude|default_if_none:'' }}">
        </div>


      {% if user.role == 'applicant' %}
        <div class="form-group">
          {{ form.skills.label_tag }} {{ form.skills|add_class:"form-input" }}
        </div>
      
        <!-- CV Upload + Delete -->
        <div class="cv-upload-wrapper">
          <label for="upload-cv" class="cv-upload-button">üìÑ Upload CV</label>
          <input type="file" id="upload-cv" name="{{ form.upload_cv.html_name }}" style="display:none;">
      
          <span id="cv-filename" class="cv-filename">
            {% if cv_filename %}
              {{ cv_filename }}
            {% else %}
              No file selected
            {% endif %}
          </span>
      
          {% if user_cv %}
            <button type="button" id="delete-cv-btn" class="cv-delete-button">üóë Delete</button>
          {% endif %}
        </div>
      {% endif %}

      <input type="submit" value="Save Changes" class="submit-btn">
    </form>

    <a href="{% if user.is_superuser or user.role == 'admin' %}{% url 'admin_dashboard' %}{% else %}{% url 'dashboard' %}{% endif %}" 
       class="button">‚Üê Dashboard</a>
  </div>
</div>

<div id="delete-cv-confirmation" class="django-confirm-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="delete-cv-title">
  <div class="django-confirm-modal">
    <h3 id="delete-cv-title">Delete CV</h3>
    <p>Are you sure you want to permanently delete your CV?</p>
    <div class="django-confirm-actions">
      <button type="button" id="cancel-delete-cv" class="django-btn">Cancel</button>
      <button type="button" id="confirm-delete-cv" class="django-btn django-btn-danger">Delete CV</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.update-account-wrapper {
  display: flex;
  justify-content: center;
  padding: 2.5rem 1rem;
}

.form-container {
  width: min(100%, 760px);
  background: var(--bg-card);
  border: 1px solid color-mix(in srgb, var(--text-accent), transparent 72%);
  border-radius: 1.2rem;
  padding: clamp(1.2rem, 2vw, 2rem);
  box-shadow: 0 18px 48px rgba(0, 0, 0, 0.22);
}

.form-container h2 {
  margin: 0 0 1.4rem;
  text-align: center;
  color: var(--text-accent);
  letter-spacing: 0.02em;
}

.form-group label {
  display: block;
  margin-bottom: 0.45rem;
  color: var(--text-muted);
  font-size: 0.92rem;
  font-weight: 600;
}

.form-input,
.phone-group,
.location-input,
.cv-upload-wrapper {
  margin-bottom: 1rem;
}

.form-input {
  width: 100%;
  border: 1px solid color-mix(in srgb, var(--text-muted), transparent 55%);
  border-radius: 0.8rem;
  background: var(--bg-surface-soft);
  color: var(--text-main);
  padding: 0.72rem 0.85rem;
  transition: border-color .2s ease, box-shadow .2s ease;
}

.form-input:focus,
.phone-number-input:focus {
  outline: none;
  border-color: var(--text-accent);
  box-shadow: 0 0 0 3px color-mix(in srgb, var(--bg-info-soft), transparent 25%);
}

.phone-group {
  display: flex;
  align-items: stretch;
  border: 1px solid color-mix(in srgb, var(--text-muted), transparent 45%);
  border-radius: 0.8rem;
  background: var(--bg-surface-soft);
  overflow: visible;
  position: relative;
}

.phone-group:focus-within {
  border-color: var(--text-accent);
  box-shadow: 0 0 0 3px color-mix(in srgb, var(--bg-info-soft), transparent 25%);
}

.country-select { display: none; }
.country-trigger {
  width: 4.4rem;
  border: none;
  border-right: 1px solid color-mix(in srgb, var(--text-muted), transparent 55%);
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: .35rem;
  cursor: pointer;
}
.country-flag { width: 22px; height: 16px; object-fit: cover; border-radius: 3px; }
.country-caret { color: var(--text-muted); font-size: .82rem; }
.phone-input-wrapper { flex: 1; display: flex; align-items: center; gap: .4rem; padding: .62rem .7rem; }
.phone-dial { color: var(--text-muted); font-weight: 600; font-size: .9rem; }
.phone-number-input { flex: 1; border: none; background: transparent; color: var(--text-main); outline: none; letter-spacing: .06em; }
.country-menu { position: absolute; top: calc(100% + .45rem); left: 0; right: 0; z-index: 20; border: 1px solid color-mix(in srgb, var(--text-muted), transparent 20%); border-radius: .9rem; background: var(--bg-card); box-shadow: 0 14px 28px rgba(0,0,0,.3); max-height: 240px; overflow: auto; }
.country-menu.hidden { display: none; }
.country-option { width: 100%; border: none; background: transparent; color: var(--text-main); text-align: left; display: flex; align-items: center; justify-content: space-between; padding: .65rem .85rem; cursor: pointer; }
.country-option-main { display: flex; align-items: center; gap: .55rem; }
.country-option-check { width: 18px; height: 18px; border-radius: 50%; border: 2px solid var(--text-muted); }
.country-option.active .country-option-check { border-color: var(--text-accent); box-shadow: inset 0 0 0 4px color-mix(in srgb, var(--text-accent), transparent 10%); }

.submit-btn,
.button,
.cv-upload-button {
  border: none;
  border-radius: 0.75rem;
  font-weight: 700;
  transition: transform .18s ease, box-shadow .2s ease, filter .2s ease;
}

.submit-btn {
  width: 100%;
  padding: .78rem 1rem;
  background: linear-gradient(135deg, var(--text-accent), var(--bg-info));
  color: var(--text-inverse);
  margin-top: .4rem;
  box-shadow: 0 10px 22px color-mix(in srgb, var(--text-accent), transparent 75%);
}

.submit-btn:hover,
.button:hover,
.cv-upload-button:hover {
  transform: translateY(-1px);
  filter: brightness(1.04);
}
  
.button {
  display: inline-block;
  margin-top: 1rem;
  padding: .7rem 1rem;
  color: var(--text-inverse);
  background: color-mix(in srgb, var(--text-accent), var(--bg-info) 30%);
}
  
.cv-upload-wrapper {
  display: flex;
  align-items: center;
  gap: 0.65rem;
  flex-wrap: wrap;
}

.cv-upload-button {
  padding: .65rem .9rem;
  background: color-mix(in srgb, var(--text-accent), var(--bg-info) 20%);
  color: var(--text-inverse);
  cursor: pointer;
}

.cv-filename {
  max-width: 280px;
  color: var(--text-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
  
.cv-delete-button {
  padding: .6rem .85rem;
  border-radius: .65rem;
  background: #d32f2f;
  color: #fff;
  font-weight: 700;
  border: none;
  cursor: pointer;
  box-shadow: 0 8px 16px rgba(211, 47, 47, 0.35);
}
  
.cv-delete-button:hover {
  background: #b71c1c;
}

.hidden { display: none; }

.django-confirm-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, .45);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1100;
  padding: 1rem;
}

.django-confirm-modal {
  width: min(100%, 420px);
  border: 1px solid #d4d4d4;
  border-radius: .4rem;
  background: #fff;
  color: #111;
  box-shadow: 0 12px 32px rgba(0, 0, 0, .22);
  padding: 1rem;
}

.django-confirm-modal h3 {
  margin: 0 0 .5rem;
  font-size: 1.15rem;
}

.django-confirm-modal p {
  margin: 0;
  color: #555;
}

.django-confirm-actions {
  margin-top: 1rem;
  display: flex;
  justify-content: flex-end;
  gap: .5rem;
}

.django-btn {
  padding: .45rem .8rem;
  border-radius: .35rem;
  border: 1px solid #d4d4d4;
  background: #f8f8f8;
  color: #333;
  cursor: pointer;
}

.django-btn-danger {
  border-color: #ba2121;
  background: #ba2121;
  color: #fff;
}

@media (max-width: 640px) {
  .update-account-wrapper { padding: 1.4rem .75rem; }
  .form-container { border-radius: .9rem; padding: 1rem; }
  .button,
  .submit-btn { width: 100%; text-align: center; }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {

  // -------------------------------
  // PROFILE PICTURE PREVIEW + 3D HOVER
  // -------------------------------
  const profilePic = document.getElementById('profile-pic-preview');
  const profileInput = document.getElementById('profile-pic-input');
  const themeStyles = getComputedStyle(document.documentElement);
  const glowAccent = themeStyles.getPropertyValue('--glow-accent').trim() || '#8e2de2';
  const glowAccentAlt = themeStyles.getPropertyValue('--text-accent').trim() || '#4a00e0';
  const glowShadow = themeStyles.getPropertyValue('--alien-shadow').trim() || 'rgba(142,45,226,0.6)';
  
  if (profilePic && profileInput) {
    profilePic.addEventListener('click', () => profileInput.click());
    profilePic.addEventListener('touchstart', () => profileInput.click());

    profileInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        const reader = new FileReader();
        reader.onload = e => profilePic.src = e.target.result;
        reader.readAsDataURL(this.files[0]);
      }
    });

    profilePic.addEventListener('mousemove', e => {
      const rect = profilePic.getBoundingClientRect();
      const dx = (e.clientX - rect.left - rect.width / 2) / (rect.width / 2);
      const dy = (e.clientY - rect.top - rect.height / 2) / (rect.height / 2);
      profilePic.style.transform = `rotateX(${-dy*15}deg) rotateY(${dx*15}deg) scale(1.08)`;
      profilePic.style.boxShadow = `${dx*30}px ${dy*30}px 35px ${glowAccent}, ${-dx*30}px ${-dy*30}px 50px ${glowAccentAlt}, 0 0 70px ${glowShadow}`;
    });

    profilePic.addEventListener('mouseleave', () => {
      profilePic.style.transform = 'rotateX(0deg) rotateY(0deg) scale(1)';
      profilePic.style.boxShadow = `0 0 15px ${glowAccent}, 0 0 25px ${glowAccentAlt}, 0 0 50px ${glowShadow}`;
    });
  }

  // -------------------------------
  // CV UPLOAD FILENAME DISPLAY
  // -------------------------------
  const cvInput = document.getElementById('upload-cv');
  const cvFilename = document.getElementById('cv-filename');
  const deleteBtn = document.getElementById('delete-cv-btn');
  const confirmOverlay = document.getElementById('delete-cv-confirmation');
  const cancelDeleteBtn = document.getElementById('cancel-delete-cv');
  const confirmDeleteBtn = document.getElementById('confirm-delete-cv');
  {% if cv_filename %}
    if(cvFilename) cvFilename.textContent = "{{ cv_filename }}";
  {% endif %}

  if (cvInput && cvFilename) {
    cvInput.addEventListener('change', () => {
      cvFilename.textContent = cvInput.files.length ? cvInput.files[0].name : 'No file selected';
    });
  }

  // -------------------------------
  // CV DELETE BUTTON FUNCTIONALITY
  // -------------------------------
  const closeDeleteModal = () => {
    if (confirmOverlay) {
      confirmOverlay.classList.add('hidden');
    }
  };

  if (deleteBtn && confirmOverlay) {
    deleteBtn.addEventListener('click', () => confirmOverlay.classList.remove('hidden'));
  }

  if (cancelDeleteBtn) {
    cancelDeleteBtn.addEventListener('click', closeDeleteModal);
  }

  if (confirmOverlay) {
    confirmOverlay.addEventListener('click', (event) => {
      if (event.target === confirmOverlay) closeDeleteModal();
    });
  }

  if (confirmDeleteBtn && deleteBtn && cvFilename) {
    confirmDeleteBtn.addEventListener('click', function() {
      fetch("{% url 'delete_cv' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'deleted') {
          cvFilename.textContent = 'No file selected';
          deleteBtn.remove();
          closeDeleteModal();
        }
      });
    });
  }

    const fallbackCountries = [
    { code: 'KE', name: 'Kenya', dial: '254' },
    { code: 'UG', name: 'Uganda', dial: '256' },
    { code: 'TZ', name: 'Tanzania', dial: '255' }
  ];

  function initPhoneControl() {
    const select = document.getElementById('edit_country');
    const trigger = document.getElementById('edit_country_trigger');
    const flag = document.getElementById('edit_country_flag');
    const menu = document.getElementById('edit_country_menu');
    const dial = document.getElementById('edit_phone_dial');
    const display = document.getElementById('edit_phone_display');
    const hidden = document.getElementById('id_phone');
    if (!select || !trigger || !flag || !menu || !dial || !display || !hidden) return;

    const getFlag = code => `https://flagsapi.com/${code}/flat/64.png`;
    const apply = () => {
      const option = select.selectedOptions[0];
      if (!option) return;
      const digits = display.value.replace(/\D/g, '').slice(0, 12);
      display.value = digits.replace(/(.{3})/g, '$1 ').trim();
      dial.textContent = `+${option.dataset.dial}`;
      flag.src = getFlag(option.value);
      flag.alt = option.dataset.label;
      hidden.value = digits ? `+${option.dataset.dial}${digits}` : '';
      menu.querySelectorAll('.country-option').forEach(btn => btn.classList.toggle('active', btn.dataset.code === option.value));
    };

    const renderMenu = () => {
      menu.innerHTML = '';
      Array.from(select.options).forEach(option => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'country-option';
        btn.dataset.code = option.value;
        btn.innerHTML = `<span class="country-option-main"><img class="country-flag" src="${getFlag(option.value)}" alt="${option.dataset.label}"><span>${option.textContent}</span></span><span class="country-option-check"></span>`;
        btn.onclick = () => { select.value = option.value; menu.classList.add('hidden'); trigger.setAttribute('aria-expanded', 'false'); apply(); };
        menu.appendChild(btn);
      });
      apply();
    };

    const setCountries = countries => {
      select.innerHTML = countries.map(c => `<option value="${c.code}" data-dial="${c.dial}" data-label="${c.name} (+${c.dial})">${c.name} (+${c.dial})</option>`).join('');
      select.value = select.dataset.default || 'KE';
      renderMenu();
      if (hidden.value.startsWith('+')) display.value = hidden.value.slice(1);
      apply();
    };

    fetch('https://restcountries.com/v3.1/all?fields=cca2,name,idd')
      .then(r => r.json())
      .then(data => data.map(c => ({ code: c.cca2, name: c.name?.common || c.cca2, dial: `${c.idd?.root || ''}${Array.isArray(c.idd?.suffixes) ? c.idd.suffixes[0] : ''}`.replace(/\D/g, '') }))
        .filter(c => c.code && c.dial)
        .sort((a,b) => a.name.localeCompare(b.name)))
      .then(setCountries)
      .catch(() => setCountries(fallbackCountries));

    trigger.addEventListener('click', () => {
      const hiddenMenu = menu.classList.toggle('hidden');
      trigger.setAttribute('aria-expanded', String(!hiddenMenu));
    });
    document.addEventListener('click', e => {
      if (!menu.contains(e.target) && !trigger.contains(e.target)) {
        menu.classList.add('hidden');
        trigger.setAttribute('aria-expanded', 'false');
      }
    });
    display.addEventListener('input', apply);
  }

  initPhoneControl();

  // -------------------------------
  // OPENSTREETMAP / NOMINATIM AUTOCOMPLETE
  // -------------------------------
  const locationInput = document.querySelector('.location-input');
  if (locationInput) {
    const latField = document.getElementById(locationInput.dataset.latInput);
    const lonField = document.getElementById(locationInput.dataset.lonInput);
    
    // Create a dropdown container
    const dropdown = document.createElement('div');
    dropdown.classList.add('autocomplete-dropdown');
    dropdown.style.position = 'absolute';
    dropdown.style.top = (locationInput.offsetHeight + 5) + 'px';
    dropdown.style.left = '0';
    dropdown.style.width = '100%';
    dropdown.style.background = 'var(--bg-card)';
    dropdown.style.border = '1px solid var(--text-muted)';
    dropdown.style.borderRadius = '0.5rem';
    dropdown.style.zIndex = '1000';
    dropdown.style.maxHeight = '200px';
    dropdown.style.overflowY = 'auto';
    dropdown.style.display = 'none';
    locationInput.parentNode.style.position = 'relative';
    locationInput.parentNode.appendChild(dropdown);

    let debounceTimer;
    locationInput.addEventListener('input', function() {
      const query = this.value;
      if (debounceTimer) clearTimeout(debounceTimer);

      if (!query) {
        dropdown.style.display = 'none';
        return;
      }

      debounceTimer = setTimeout(() => {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`)
          .then(res => res.json())
          .then(data => {
            dropdown.innerHTML = '';
            if (data.length === 0) {
              dropdown.style.display = 'none';
              return;
            }

            data.forEach(item => {
              const option = document.createElement('div');
              option.textContent = item.display_name;
              option.style.padding = '0.5rem';
              option.style.cursor = 'pointer';
              option.addEventListener('click', () => {
                locationInput.value = item.display_name;
                if (latField) latField.value = item.lat;
                if (lonField) lonField.value = item.lon;
                dropdown.style.display = 'none';
              });
              dropdown.appendChild(option);
            });
            dropdown.style.display = 'block';
          });
      }, 350); // debounce 350ms
    });

    // Hide dropdown on click outside
    document.addEventListener('click', (e) => {
      if (!locationInput.parentNode.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });
  }

});
</script>
{% endblock %}
